<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=theme-color content="#FFFFFF"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Weex 是如何在 iOS 客户端上跑起来的 | prometheus</title><meta name=description content="Explore in every moment of the hard thinking"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Weex 是如何在 iOS 客户端上跑起来的"><meta property="og:description" content="前言 2016年4月21日，阿里巴巴在Qcon大会上宣布跨平台移动开发工具Weex开放内测邀请。Weex能够完美兼顾性能与动态性，让移动开发者通过简捷的前端语法写出Native级别的性能体验，并支持iOS、安卓、YunOS及Web等多端部署。
近一年来，ReactNative 和 Weex 这些跨平台技术对Native开发者来说，冲击是巨大的。Native在开发App的时候存在一些弊端，比如客户端需要频繁更新，iOS更新时间还要受到审核的牵制；iOS、Android和前端同时开发同一个需求，在人员成本上消耗大；Hybrid的性能和Native相比又差了一点。
ReactNative 和 Weex的出现，就是为了解决这些痛点的。
从4月21号宣布内测以后，短短两周就有超过5000名开发者申请。
2016年6月30日阿里巴巴正式宣布Weex开源。号称可以用Web方式，开发Native级性能体验的亿级应用匠心打造跨平台移动开发工具Weex在开源首日就登上Github趋势榜首位，截止目前为止，Weex在GitHub上的Star数已经到达了13393了。成为中国2016年在Github上最热门的开源项目之一。
目录  1.Weex概述 2.Weex工作原理 3.Weex在iOS上是如何跑起来的 4.关于Weex，ReactNative，JSPatch  一. Weex概述 Weex从出生那天起，仿佛就是和ReactNative是“一对”。
ReactNative宣称“Learn once, write anywhere”，而Weex宣称“Write Once, Run Everywhere”。Weex从出生那天起，就被给予了一统三端的厚望。ReactNative可以支持iOS、Android，而Weex可以支持iOS、Android、HTML5。一统三端就解决了前言里面说的第二个痛点，同时开发浪费人员成本的问题。
Native移动开发者只需要在本地导入Weex的SDK，就可以通过HTML/CSS/JavaScript网页的这套编程语言来开发Native级别的Weex界面。这意味着可以直接用现有Web开发的编辑器和IDE的代码补全、提示、检查等功能。从而也给前端人员开发Native端，较低的开发成本和学习成本。
Weex是一种轻量级、可扩展、高性能框架。集成也很方便，可以直接在HTML5页面嵌入，也可嵌在原生UI中。由于和ReactNative一样，都会调用Native端的原生控件，所以在性能上比Hybrid高出一个层次。这就解决了前言里面所说的第三个痛点，性能问题。
Weex非常轻量，体积小巧，语法简单，方便接入和上手。ReactNative官方只允许将ReactNative基础JS库和业务JS一起打成一个JS bundle，没有提供分包的功能，所以如果想节约流量就必须制作分包打包工具。而Weex默认打的JS bundle只包含业务JS代码，体积小很多，基础JS库包含在Weex SDK中，这一点Weex与Facebook的React Native和微软的Cordova相比，Weex更加轻量，体积小巧。把Weex生成的JS bundle轻松部署到服务器端，然后Push到客户端，或者客户端请求新的资源即可完成发布。如此快速的迭代就解决了前言里面说的第一个痛点，发布无法控制时间，
Weex中Native组件和API都可以横向扩展，业务方可去中心化横向灵活化定制组件和功能模块。并且还可以直接复用Web前端的工程化管理和监控性能等工具。
知乎上有一个关于Weex 和 ReactNative很好的对比文章weex&ReactNative对比，推荐大家阅读。
Weex在2017年2月17日正式发布v0.10.0，这个里程碑的版本开始完美的兼容Vue.js开发Weex界面。
Weex又于2017年2月24 迁移至 Apache 基金会，阿里巴巴会基于 Apache 的基础设施继续迭代。并启用了全新的 GitHub 仓库：https://github.com/apache/incubator-weex
故以下源码分析都基于v0.10.0这个版本。
二. Weex工作原理 上图是官方给的一张原理图，Weex是如何把JS打包成JS Bundle的原理本篇文章暂时不涉及。本篇文章会详细分析Weex是如何在Native端工作的。笔者把Native端的原理再次细分，如下图：
Weex可以通过自己设计的DSL，书写.we文件或者.vue文件来开发界面，整个页面书写分成了3段，template、style、script，借鉴了成熟的MVVM的思想。
Weex在性能方面，为了尽可能的提升客户端的性能，DSL的Transformer全部都放在了服务器端实现，Weex会在服务器端将XML + CSS + JavaScript 代码全部都转换成JS Bundle。服务器将JS Bundle部署到Server上和CDN上。
Weex和React Native不同的是，Weex把JS Framework内置在SDK里面，用来解析从服务器上下载的JS Bundle，这样也减少了每个JS Bundle的体积，不再有React Native需要分包的问题。客户端请求完JS Bundle以后，传给JS Framework，JS Framework解析完成以后会输出Json格式的Virtual DOM，客户端Native只需要专心负责 Virtual DOM 的解析和布局、UI 渲染。然而这一套解析，布局，渲染的逻辑SDK基本实现了。"><meta property="og:type" content="article"><meta property="og:url" content="https://new.halfrost.com/weex_ios/"><meta property="article:published_time" content="2017-03-18T02:29:00+00:00"><meta property="article:modified_time" content="2017-03-18T02:29:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Weex 是如何在 iOS 客户端上跑起来的"><meta name=twitter:description content="前言 2016年4月21日，阿里巴巴在Qcon大会上宣布跨平台移动开发工具Weex开放内测邀请。Weex能够完美兼顾性能与动态性，让移动开发者通过简捷的前端语法写出Native级别的性能体验，并支持iOS、安卓、YunOS及Web等多端部署。
近一年来，ReactNative 和 Weex 这些跨平台技术对Native开发者来说，冲击是巨大的。Native在开发App的时候存在一些弊端，比如客户端需要频繁更新，iOS更新时间还要受到审核的牵制；iOS、Android和前端同时开发同一个需求，在人员成本上消耗大；Hybrid的性能和Native相比又差了一点。
ReactNative 和 Weex的出现，就是为了解决这些痛点的。
从4月21号宣布内测以后，短短两周就有超过5000名开发者申请。
2016年6月30日阿里巴巴正式宣布Weex开源。号称可以用Web方式，开发Native级性能体验的亿级应用匠心打造跨平台移动开发工具Weex在开源首日就登上Github趋势榜首位，截止目前为止，Weex在GitHub上的Star数已经到达了13393了。成为中国2016年在Github上最热门的开源项目之一。
目录  1.Weex概述 2.Weex工作原理 3.Weex在iOS上是如何跑起来的 4.关于Weex，ReactNative，JSPatch  一. Weex概述 Weex从出生那天起，仿佛就是和ReactNative是“一对”。
ReactNative宣称“Learn once, write anywhere”，而Weex宣称“Write Once, Run Everywhere”。Weex从出生那天起，就被给予了一统三端的厚望。ReactNative可以支持iOS、Android，而Weex可以支持iOS、Android、HTML5。一统三端就解决了前言里面说的第二个痛点，同时开发浪费人员成本的问题。
Native移动开发者只需要在本地导入Weex的SDK，就可以通过HTML/CSS/JavaScript网页的这套编程语言来开发Native级别的Weex界面。这意味着可以直接用现有Web开发的编辑器和IDE的代码补全、提示、检查等功能。从而也给前端人员开发Native端，较低的开发成本和学习成本。
Weex是一种轻量级、可扩展、高性能框架。集成也很方便，可以直接在HTML5页面嵌入，也可嵌在原生UI中。由于和ReactNative一样，都会调用Native端的原生控件，所以在性能上比Hybrid高出一个层次。这就解决了前言里面所说的第三个痛点，性能问题。
Weex非常轻量，体积小巧，语法简单，方便接入和上手。ReactNative官方只允许将ReactNative基础JS库和业务JS一起打成一个JS bundle，没有提供分包的功能，所以如果想节约流量就必须制作分包打包工具。而Weex默认打的JS bundle只包含业务JS代码，体积小很多，基础JS库包含在Weex SDK中，这一点Weex与Facebook的React Native和微软的Cordova相比，Weex更加轻量，体积小巧。把Weex生成的JS bundle轻松部署到服务器端，然后Push到客户端，或者客户端请求新的资源即可完成发布。如此快速的迭代就解决了前言里面说的第一个痛点，发布无法控制时间，
Weex中Native组件和API都可以横向扩展，业务方可去中心化横向灵活化定制组件和功能模块。并且还可以直接复用Web前端的工程化管理和监控性能等工具。
知乎上有一个关于Weex 和 ReactNative很好的对比文章weex&ReactNative对比，推荐大家阅读。
Weex在2017年2月17日正式发布v0.10.0，这个里程碑的版本开始完美的兼容Vue.js开发Weex界面。
Weex又于2017年2月24 迁移至 Apache 基金会，阿里巴巴会基于 Apache 的基础设施继续迭代。并启用了全新的 GitHub 仓库：https://github.com/apache/incubator-weex
故以下源码分析都基于v0.10.0这个版本。
二. Weex工作原理 上图是官方给的一张原理图，Weex是如何把JS打包成JS Bundle的原理本篇文章暂时不涉及。本篇文章会详细分析Weex是如何在Native端工作的。笔者把Native端的原理再次细分，如下图：
Weex可以通过自己设计的DSL，书写.we文件或者.vue文件来开发界面，整个页面书写分成了3段，template、style、script，借鉴了成熟的MVVM的思想。
Weex在性能方面，为了尽可能的提升客户端的性能，DSL的Transformer全部都放在了服务器端实现，Weex会在服务器端将XML + CSS + JavaScript 代码全部都转换成JS Bundle。服务器将JS Bundle部署到Server上和CDN上。
Weex和React Native不同的是，Weex把JS Framework内置在SDK里面，用来解析从服务器上下载的JS Bundle，这样也减少了每个JS Bundle的体积，不再有React Native需要分包的问题。客户端请求完JS Bundle以后，传给JS Framework，JS Framework解析完成以后会输出Json格式的Virtual DOM，客户端Native只需要专心负责 Virtual DOM 的解析和布局、UI 渲染。然而这一套解析，布局，渲染的逻辑SDK基本实现了。"><link rel=stylesheet href=/css/style-white.min.css><link rel=manifest href=/manifest.json><link rel=stylesheet href=/prism.css><link href=/images/apple-touch-icon-60x60.png rel=apple-touch-icon sizes=60x60><link href=/images/apple-touch-icon-76x76.png rel=apple-touch-icon sizes=76x76><link href=/images/apple-touch-icon-120x120.png rel=apple-touch-icon sizes=120x120><link href=/images/apple-touch-icon-152x152.png rel=apple-touch-icon sizes=152x152><link href=/images/apple-touch-icon-180x180.png rel=apple-touch-icon sizes=180x180><link href=/images/apple-touch-icon-512x512.png rel=apple-touch-icon sizes=512x512><link href=/images/apple-touch-icon-1024x1024.png rel=apple-touch-icon sizes=1024x1024><script async>if('serviceWorker'in navigator){navigator.serviceWorker.register("\/serviceworker-v1.min.a64912b78d282eab1ad3715a0943da21616e5f326f8afea27034784ad445043b.js").then(function(){if(navigator.serviceWorker.controller){console.log('Assets cached by the controlling service worker.');}else{console.log('Please reload this page to allow the service worker to handle network operations.');}}).catch(function(error){console.log('ERROR: '+error);});}else{console.log('Service workers are not supported in the current browser.');}</script><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://new.halfrost.com/images/favicon.ico><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-82753806-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="single-max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a><a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a><a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast');" style=display:none><i class="fas fa-chevron-up fa-lg"></i></a><span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=https://books.halfrost.com/>Books</a></li><li><a href=https://github.com/halfrost/Halfrost-Field>Github</a></li><li><a href=https://halfrost.me/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://new.halfrost.com/beehive/><i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li><li><a class=icon href=https://new.halfrost.com/weex_flexbox/><i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li><li><a class=icon href=#><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f"><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&text=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&title=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&is_video=false&description=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84&body=Check out this article: https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f"><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&title=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&title=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&title=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-stumbleupon" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&title=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-digg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&name=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84&description=%e5%89%8d%e8%a8%80%202016%e5%b9%b44%e6%9c%8821%e6%97%a5%ef%bc%8c%e9%98%bf%e9%87%8c%e5%b7%b4%e5%b7%b4%e5%9c%a8Qcon%e5%a4%a7%e4%bc%9a%e4%b8%8a%e5%ae%a3%e5%b8%83%e8%b7%a8%e5%b9%b3%e5%8f%b0%e7%a7%bb%e5%8a%a8%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7Weex%e5%bc%80%e6%94%be%e5%86%85%e6%b5%8b%e9%82%80%e8%af%b7%e3%80%82Weex%e8%83%bd%e5%a4%9f%e5%ae%8c%e7%be%8e%e5%85%bc%e9%a1%be%e6%80%a7%e8%83%bd%e4%b8%8e%e5%8a%a8%e6%80%81%e6%80%a7%ef%bc%8c%e8%ae%a9%e7%a7%bb%e5%8a%a8%e5%bc%80%e5%8f%91%e8%80%85%e9%80%9a%e8%bf%87%e7%ae%80%e6%8d%b7%e7%9a%84%e5%89%8d%e7%ab%af%e8%af%ad%e6%b3%95%e5%86%99%e5%87%baNative%e7%ba%a7%e5%88%ab%e7%9a%84%e6%80%a7%e8%83%bd%e4%bd%93%e9%aa%8c%ef%bc%8c%e5%b9%b6%e6%94%af%e6%8c%81iOS%e3%80%81%e5%ae%89%e5%8d%93%e3%80%81YunOS%e5%8f%8aWeb%e7%ad%89%e5%a4%9a%e7%ab%af%e9%83%a8%e7%bd%b2%e3%80%82%0a%e8%bf%91%e4%b8%80%e5%b9%b4%e6%9d%a5%ef%bc%8cReactNative%20%e5%92%8c%20Weex%20%e8%bf%99%e4%ba%9b%e8%b7%a8%e5%b9%b3%e5%8f%b0%e6%8a%80%e6%9c%af%e5%af%b9Native%e5%bc%80%e5%8f%91%e8%80%85%e6%9d%a5%e8%af%b4%ef%bc%8c%e5%86%b2%e5%87%bb%e6%98%af%e5%b7%a8%e5%a4%a7%e7%9a%84%e3%80%82Native%e5%9c%a8%e5%bc%80%e5%8f%91App%e7%9a%84%e6%97%b6%e5%80%99%e5%ad%98%e5%9c%a8%e4%b8%80%e4%ba%9b%e5%bc%8a%e7%ab%af%ef%bc%8c%e6%af%94%e5%a6%82%e5%ae%a2%e6%88%b7%e7%ab%af%e9%9c%80%e8%a6%81%e9%a2%91%e7%b9%81%e6%9b%b4%e6%96%b0%ef%bc%8ciOS%e6%9b%b4%e6%96%b0%e6%97%b6%e9%97%b4%e8%bf%98%e8%a6%81%e5%8f%97%e5%88%b0%e5%ae%a1%e6%a0%b8%e7%9a%84%e7%89%b5%e5%88%b6%ef%bc%9biOS%e3%80%81Android%e5%92%8c%e5%89%8d%e7%ab%af%e5%90%8c%e6%97%b6%e5%bc%80%e5%8f%91%e5%90%8c%e4%b8%80%e4%b8%aa%e9%9c%80%e6%b1%82%ef%bc%8c%e5%9c%a8%e4%ba%ba%e5%91%98%e6%88%90%e6%9c%ac%e4%b8%8a%e6%b6%88%e8%80%97%e5%a4%a7%ef%bc%9bHybrid%e7%9a%84%e6%80%a7%e8%83%bd%e5%92%8cNative%e7%9b%b8%e6%af%94%e5%8f%88%e5%b7%ae%e4%ba%86%e4%b8%80%e7%82%b9%e3%80%82%0aReactNative%20%e5%92%8c%20Weex%e7%9a%84%e5%87%ba%e7%8e%b0%ef%bc%8c%e5%b0%b1%e6%98%af%e4%b8%ba%e4%ba%86%e8%a7%a3%e5%86%b3%e8%bf%99%e4%ba%9b%e7%97%9b%e7%82%b9%e7%9a%84%e3%80%82%0a%e4%bb%8e4%e6%9c%8821%e5%8f%b7%e5%ae%a3%e5%b8%83%e5%86%85%e6%b5%8b%e4%bb%a5%e5%90%8e%ef%bc%8c%e7%9f%ad%e7%9f%ad%e4%b8%a4%e5%91%a8%e5%b0%b1%e6%9c%89%e8%b6%85%e8%bf%875000%e5%90%8d%e5%bc%80%e5%8f%91%e8%80%85%e7%94%b3%e8%af%b7%e3%80%82%0a2016%e5%b9%b46%e6%9c%8830%e6%97%a5%e9%98%bf%e9%87%8c%e5%b7%b4%e5%b7%b4%e6%ad%a3%e5%bc%8f%e5%ae%a3%e5%b8%83Weex%e5%bc%80%e6%ba%90%e3%80%82%e5%8f%b7%e7%a7%b0%e5%8f%af%e4%bb%a5%e7%94%a8Web%e6%96%b9%e5%bc%8f%ef%bc%8c%e5%bc%80%e5%8f%91Native%e7%ba%a7%e6%80%a7%e8%83%bd%e4%bd%93%e9%aa%8c%e7%9a%84%e4%ba%bf%e7%ba%a7%e5%ba%94%e7%94%a8%e5%8c%a0%e5%bf%83%e6%89%93%e9%80%a0%e8%b7%a8%e5%b9%b3%e5%8f%b0%e7%a7%bb%e5%8a%a8%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7Weex%e5%9c%a8%e5%bc%80%e6%ba%90%e9%a6%96%e6%97%a5%e5%b0%b1%e7%99%bb%e4%b8%8aGithub%e8%b6%8b%e5%8a%bf%e6%a6%9c%e9%a6%96%e4%bd%8d%ef%bc%8c%e6%88%aa%e6%ad%a2%e7%9b%ae%e5%89%8d%e4%b8%ba%e6%ad%a2%ef%bc%8cWeex%e5%9c%a8GitHub%e4%b8%8a%e7%9a%84Star%e6%95%b0%e5%b7%b2%e7%bb%8f%e5%88%b0%e8%be%be%e4%ba%8613393%e4%ba%86%e3%80%82%e6%88%90%e4%b8%ba%e4%b8%ad%e5%9b%bd2016%e5%b9%b4%e5%9c%a8Github%e4%b8%8a%e6%9c%80%e7%83%ad%e9%97%a8%e7%9a%84%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae%e4%b9%8b%e4%b8%80%e3%80%82%0a%e7%9b%ae%e5%bd%95%20%201.Weex%e6%a6%82%e8%bf%b0%202.Weex%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86%203.Weex%e5%9c%a8iOS%e4%b8%8a%e6%98%af%e5%a6%82%e4%bd%95%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84%204.%e5%85%b3%e4%ba%8eWeex%ef%bc%8cReactNative%ef%bc%8cJSPatch%20%20%e4%b8%80.%20Weex%e6%a6%82%e8%bf%b0%20Weex%e4%bb%8e%e5%87%ba%e7%94%9f%e9%82%a3%e5%a4%a9%e8%b5%b7%ef%bc%8c%e4%bb%bf%e4%bd%9b%e5%b0%b1%e6%98%af%e5%92%8cReactNative%e6%98%af%e2%80%9c%e4%b8%80%e5%af%b9%e2%80%9d%e3%80%82%0aReactNative%e5%ae%a3%e7%a7%b0%e2%80%9cLearn%20once%2c%20write%20anywhere%e2%80%9d%ef%bc%8c%e8%80%8cWeex%e5%ae%a3%e7%a7%b0%e2%80%9cWrite%20Once%2c%20Run%20Everywhere%e2%80%9d%e3%80%82Weex%e4%bb%8e%e5%87%ba%e7%94%9f%e9%82%a3%e5%a4%a9%e8%b5%b7%ef%bc%8c%e5%b0%b1%e8%a2%ab%e7%bb%99%e4%ba%88%e4%ba%86%e4%b8%80%e7%bb%9f%e4%b8%89%e7%ab%af%e7%9a%84%e5%8e%9a%e6%9c%9b%e3%80%82ReactNative%e5%8f%af%e4%bb%a5%e6%94%af%e6%8c%81iOS%e3%80%81Android%ef%bc%8c%e8%80%8cWeex%e5%8f%af%e4%bb%a5%e6%94%af%e6%8c%81iOS%e3%80%81Android%e3%80%81HTML5%e3%80%82%e4%b8%80%e7%bb%9f%e4%b8%89%e7%ab%af%e5%b0%b1%e8%a7%a3%e5%86%b3%e4%ba%86%e5%89%8d%e8%a8%80%e9%87%8c%e9%9d%a2%e8%af%b4%e7%9a%84%e7%ac%ac%e4%ba%8c%e4%b8%aa%e7%97%9b%e7%82%b9%ef%bc%8c%e5%90%8c%e6%97%b6%e5%bc%80%e5%8f%91%e6%b5%aa%e8%b4%b9%e4%ba%ba%e5%91%98%e6%88%90%e6%9c%ac%e7%9a%84%e9%97%ae%e9%a2%98%e3%80%82%0aNative%e7%a7%bb%e5%8a%a8%e5%bc%80%e5%8f%91%e8%80%85%e5%8f%aa%e9%9c%80%e8%a6%81%e5%9c%a8%e6%9c%ac%e5%9c%b0%e5%af%bc%e5%85%a5Weex%e7%9a%84SDK%ef%bc%8c%e5%b0%b1%e5%8f%af%e4%bb%a5%e9%80%9a%e8%bf%87HTML%2fCSS%2fJavaScript%e7%bd%91%e9%a1%b5%e7%9a%84%e8%bf%99%e5%a5%97%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80%e6%9d%a5%e5%bc%80%e5%8f%91Native%e7%ba%a7%e5%88%ab%e7%9a%84Weex%e7%95%8c%e9%9d%a2%e3%80%82%e8%bf%99%e6%84%8f%e5%91%b3%e7%9d%80%e5%8f%af%e4%bb%a5%e7%9b%b4%e6%8e%a5%e7%94%a8%e7%8e%b0%e6%9c%89Web%e5%bc%80%e5%8f%91%e7%9a%84%e7%bc%96%e8%be%91%e5%99%a8%e5%92%8cIDE%e7%9a%84%e4%bb%a3%e7%a0%81%e8%a1%a5%e5%85%a8%e3%80%81%e6%8f%90%e7%a4%ba%e3%80%81%e6%a3%80%e6%9f%a5%e7%ad%89%e5%8a%9f%e8%83%bd%e3%80%82%e4%bb%8e%e8%80%8c%e4%b9%9f%e7%bb%99%e5%89%8d%e7%ab%af%e4%ba%ba%e5%91%98%e5%bc%80%e5%8f%91Native%e7%ab%af%ef%bc%8c%e8%be%83%e4%bd%8e%e7%9a%84%e5%bc%80%e5%8f%91%e6%88%90%e6%9c%ac%e5%92%8c%e5%ad%a6%e4%b9%a0%e6%88%90%e6%9c%ac%e3%80%82%0aWeex%e6%98%af%e4%b8%80%e7%a7%8d%e8%bd%bb%e9%87%8f%e7%ba%a7%e3%80%81%e5%8f%af%e6%89%a9%e5%b1%95%e3%80%81%e9%ab%98%e6%80%a7%e8%83%bd%e6%a1%86%e6%9e%b6%e3%80%82%e9%9b%86%e6%88%90%e4%b9%9f%e5%be%88%e6%96%b9%e4%be%bf%ef%bc%8c%e5%8f%af%e4%bb%a5%e7%9b%b4%e6%8e%a5%e5%9c%a8HTML5%e9%a1%b5%e9%9d%a2%e5%b5%8c%e5%85%a5%ef%bc%8c%e4%b9%9f%e5%8f%af%e5%b5%8c%e5%9c%a8%e5%8e%9f%e7%94%9fUI%e4%b8%ad%e3%80%82%e7%94%b1%e4%ba%8e%e5%92%8cReactNative%e4%b8%80%e6%a0%b7%ef%bc%8c%e9%83%bd%e4%bc%9a%e8%b0%83%e7%94%a8Native%e7%ab%af%e7%9a%84%e5%8e%9f%e7%94%9f%e6%8e%a7%e4%bb%b6%ef%bc%8c%e6%89%80%e4%bb%a5%e5%9c%a8%e6%80%a7%e8%83%bd%e4%b8%8a%e6%af%94Hybrid%e9%ab%98%e5%87%ba%e4%b8%80%e4%b8%aa%e5%b1%82%e6%ac%a1%e3%80%82%e8%bf%99%e5%b0%b1%e8%a7%a3%e5%86%b3%e4%ba%86%e5%89%8d%e8%a8%80%e9%87%8c%e9%9d%a2%e6%89%80%e8%af%b4%e7%9a%84%e7%ac%ac%e4%b8%89%e4%b8%aa%e7%97%9b%e7%82%b9%ef%bc%8c%e6%80%a7%e8%83%bd%e9%97%ae%e9%a2%98%e3%80%82%0aWeex%e9%9d%9e%e5%b8%b8%e8%bd%bb%e9%87%8f%ef%bc%8c%e4%bd%93%e7%a7%af%e5%b0%8f%e5%b7%a7%ef%bc%8c%e8%af%ad%e6%b3%95%e7%ae%80%e5%8d%95%ef%bc%8c%e6%96%b9%e4%be%bf%e6%8e%a5%e5%85%a5%e5%92%8c%e4%b8%8a%e6%89%8b%e3%80%82ReactNative%e5%ae%98%e6%96%b9%e5%8f%aa%e5%85%81%e8%ae%b8%e5%b0%86ReactNative%e5%9f%ba%e7%a1%80JS%e5%ba%93%e5%92%8c%e4%b8%9a%e5%8a%a1JS%e4%b8%80%e8%b5%b7%e6%89%93%e6%88%90%e4%b8%80%e4%b8%aaJS%20bundle%ef%bc%8c%e6%b2%a1%e6%9c%89%e6%8f%90%e4%be%9b%e5%88%86%e5%8c%85%e7%9a%84%e5%8a%9f%e8%83%bd%ef%bc%8c%e6%89%80%e4%bb%a5%e5%a6%82%e6%9e%9c%e6%83%b3%e8%8a%82%e7%ba%a6%e6%b5%81%e9%87%8f%e5%b0%b1%e5%bf%85%e9%a1%bb%e5%88%b6%e4%bd%9c%e5%88%86%e5%8c%85%e6%89%93%e5%8c%85%e5%b7%a5%e5%85%b7%e3%80%82%e8%80%8cWeex%e9%bb%98%e8%ae%a4%e6%89%93%e7%9a%84JS%20bundle%e5%8f%aa%e5%8c%85%e5%90%ab%e4%b8%9a%e5%8a%a1JS%e4%bb%a3%e7%a0%81%ef%bc%8c%e4%bd%93%e7%a7%af%e5%b0%8f%e5%be%88%e5%a4%9a%ef%bc%8c%e5%9f%ba%e7%a1%80JS%e5%ba%93%e5%8c%85%e5%90%ab%e5%9c%a8Weex%20SDK%e4%b8%ad%ef%bc%8c%e8%bf%99%e4%b8%80%e7%82%b9Weex%e4%b8%8eFacebook%e7%9a%84React%20Native%e5%92%8c%e5%be%ae%e8%bd%af%e7%9a%84Cordova%e7%9b%b8%e6%af%94%ef%bc%8cWeex%e6%9b%b4%e5%8a%a0%e8%bd%bb%e9%87%8f%ef%bc%8c%e4%bd%93%e7%a7%af%e5%b0%8f%e5%b7%a7%e3%80%82%e6%8a%8aWeex%e7%94%9f%e6%88%90%e7%9a%84JS%20bundle%e8%bd%bb%e6%9d%be%e9%83%a8%e7%bd%b2%e5%88%b0%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%ab%af%ef%bc%8c%e7%84%b6%e5%90%8ePush%e5%88%b0%e5%ae%a2%e6%88%b7%e7%ab%af%ef%bc%8c%e6%88%96%e8%80%85%e5%ae%a2%e6%88%b7%e7%ab%af%e8%af%b7%e6%b1%82%e6%96%b0%e7%9a%84%e8%b5%84%e6%ba%90%e5%8d%b3%e5%8f%af%e5%ae%8c%e6%88%90%e5%8f%91%e5%b8%83%e3%80%82%e5%a6%82%e6%ad%a4%e5%bf%ab%e9%80%9f%e7%9a%84%e8%bf%ad%e4%bb%a3%e5%b0%b1%e8%a7%a3%e5%86%b3%e4%ba%86%e5%89%8d%e8%a8%80%e9%87%8c%e9%9d%a2%e8%af%b4%e7%9a%84%e7%ac%ac%e4%b8%80%e4%b8%aa%e7%97%9b%e7%82%b9%ef%bc%8c%e5%8f%91%e5%b8%83%e6%97%a0%e6%b3%95%e6%8e%a7%e5%88%b6%e6%97%b6%e9%97%b4%ef%bc%8c%0aWeex%e4%b8%adNative%e7%bb%84%e4%bb%b6%e5%92%8cAPI%e9%83%bd%e5%8f%af%e4%bb%a5%e6%a8%aa%e5%90%91%e6%89%a9%e5%b1%95%ef%bc%8c%e4%b8%9a%e5%8a%a1%e6%96%b9%e5%8f%af%e5%8e%bb%e4%b8%ad%e5%bf%83%e5%8c%96%e6%a8%aa%e5%90%91%e7%81%b5%e6%b4%bb%e5%8c%96%e5%ae%9a%e5%88%b6%e7%bb%84%e4%bb%b6%e5%92%8c%e5%8a%9f%e8%83%bd%e6%a8%a1%e5%9d%97%e3%80%82%e5%b9%b6%e4%b8%94%e8%bf%98%e5%8f%af%e4%bb%a5%e7%9b%b4%e6%8e%a5%e5%a4%8d%e7%94%a8Web%e5%89%8d%e7%ab%af%e7%9a%84%e5%b7%a5%e7%a8%8b%e5%8c%96%e7%ae%a1%e7%90%86%e5%92%8c%e7%9b%91%e6%8e%a7%e6%80%a7%e8%83%bd%e7%ad%89%e5%b7%a5%e5%85%b7%e3%80%82%0a%e7%9f%a5%e4%b9%8e%e4%b8%8a%e6%9c%89%e4%b8%80%e4%b8%aa%e5%85%b3%e4%ba%8eWeex%20%e5%92%8c%20ReactNative%e5%be%88%e5%a5%bd%e7%9a%84%e5%af%b9%e6%af%94%e6%96%87%e7%ab%a0weex%26amp%3bReactNative%e5%af%b9%e6%af%94%ef%bc%8c%e6%8e%a8%e8%8d%90%e5%a4%a7%e5%ae%b6%e9%98%85%e8%af%bb%e3%80%82%0aWeex%e5%9c%a82017%e5%b9%b42%e6%9c%8817%e6%97%a5%e6%ad%a3%e5%bc%8f%e5%8f%91%e5%b8%83v0.10.0%ef%bc%8c%e8%bf%99%e4%b8%aa%e9%87%8c%e7%a8%8b%e7%a2%91%e7%9a%84%e7%89%88%e6%9c%ac%e5%bc%80%e5%a7%8b%e5%ae%8c%e7%be%8e%e7%9a%84%e5%85%bc%e5%ae%b9Vue.js%e5%bc%80%e5%8f%91Weex%e7%95%8c%e9%9d%a2%e3%80%82%0aWeex%e5%8f%88%e4%ba%8e2017%e5%b9%b42%e6%9c%8824%20%e8%bf%81%e7%a7%bb%e8%87%b3%20Apache%20%e5%9f%ba%e9%87%91%e4%bc%9a%ef%bc%8c%e9%98%bf%e9%87%8c%e5%b7%b4%e5%b7%b4%e4%bc%9a%e5%9f%ba%e4%ba%8e%20Apache%20%e7%9a%84%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd%e7%bb%a7%e7%bb%ad%e8%bf%ad%e4%bb%a3%e3%80%82%e5%b9%b6%e5%90%af%e7%94%a8%e4%ba%86%e5%85%a8%e6%96%b0%e7%9a%84%20GitHub%20%e4%bb%93%e5%ba%93%ef%bc%9ahttps%3a%2f%2fgithub.com%2fapache%2fincubator-weex%0a%e6%95%85%e4%bb%a5%e4%b8%8b%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e9%83%bd%e5%9f%ba%e4%ba%8ev0.10.0%e8%bf%99%e4%b8%aa%e7%89%88%e6%9c%ac%e3%80%82%0a%e4%ba%8c.%20Weex%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86%20%e4%b8%8a%e5%9b%be%e6%98%af%e5%ae%98%e6%96%b9%e7%bb%99%e7%9a%84%e4%b8%80%e5%bc%a0%e5%8e%9f%e7%90%86%e5%9b%be%ef%bc%8cWeex%e6%98%af%e5%a6%82%e4%bd%95%e6%8a%8aJS%e6%89%93%e5%8c%85%e6%88%90JS%20Bundle%e7%9a%84%e5%8e%9f%e7%90%86%e6%9c%ac%e7%af%87%e6%96%87%e7%ab%a0%e6%9a%82%e6%97%b6%e4%b8%8d%e6%b6%89%e5%8f%8a%e3%80%82%e6%9c%ac%e7%af%87%e6%96%87%e7%ab%a0%e4%bc%9a%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90Weex%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8Native%e7%ab%af%e5%b7%a5%e4%bd%9c%e7%9a%84%e3%80%82%e7%ac%94%e8%80%85%e6%8a%8aNative%e7%ab%af%e7%9a%84%e5%8e%9f%e7%90%86%e5%86%8d%e6%ac%a1%e7%bb%86%e5%88%86%ef%bc%8c%e5%a6%82%e4%b8%8b%e5%9b%be%ef%bc%9a%0aWeex%e5%8f%af%e4%bb%a5%e9%80%9a%e8%bf%87%e8%87%aa%e5%b7%b1%e8%ae%be%e8%ae%a1%e7%9a%84DSL%ef%bc%8c%e4%b9%a6%e5%86%99.we%e6%96%87%e4%bb%b6%e6%88%96%e8%80%85.vue%e6%96%87%e4%bb%b6%e6%9d%a5%e5%bc%80%e5%8f%91%e7%95%8c%e9%9d%a2%ef%bc%8c%e6%95%b4%e4%b8%aa%e9%a1%b5%e9%9d%a2%e4%b9%a6%e5%86%99%e5%88%86%e6%88%90%e4%ba%863%e6%ae%b5%ef%bc%8ctemplate%e3%80%81style%e3%80%81script%ef%bc%8c%e5%80%9f%e9%89%b4%e4%ba%86%e6%88%90%e7%86%9f%e7%9a%84MVVM%e7%9a%84%e6%80%9d%e6%83%b3%e3%80%82%0aWeex%e5%9c%a8%e6%80%a7%e8%83%bd%e6%96%b9%e9%9d%a2%ef%bc%8c%e4%b8%ba%e4%ba%86%e5%b0%bd%e5%8f%af%e8%83%bd%e7%9a%84%e6%8f%90%e5%8d%87%e5%ae%a2%e6%88%b7%e7%ab%af%e7%9a%84%e6%80%a7%e8%83%bd%ef%bc%8cDSL%e7%9a%84Transformer%e5%85%a8%e9%83%a8%e9%83%bd%e6%94%be%e5%9c%a8%e4%ba%86%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%ab%af%e5%ae%9e%e7%8e%b0%ef%bc%8cWeex%e4%bc%9a%e5%9c%a8%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%ab%af%e5%b0%86XML%20%2b%20CSS%20%2b%20JavaScript%20%e4%bb%a3%e7%a0%81%e5%85%a8%e9%83%a8%e9%83%bd%e8%bd%ac%e6%8d%a2%e6%88%90JS%20Bundle%e3%80%82%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%b0%86JS%20Bundle%e9%83%a8%e7%bd%b2%e5%88%b0Server%e4%b8%8a%e5%92%8cCDN%e4%b8%8a%e3%80%82%0aWeex%e5%92%8cReact%20Native%e4%b8%8d%e5%90%8c%e7%9a%84%e6%98%af%ef%bc%8cWeex%e6%8a%8aJS%20Framework%e5%86%85%e7%bd%ae%e5%9c%a8SDK%e9%87%8c%e9%9d%a2%ef%bc%8c%e7%94%a8%e6%9d%a5%e8%a7%a3%e6%9e%90%e4%bb%8e%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%8a%e4%b8%8b%e8%bd%bd%e7%9a%84JS%20Bundle%ef%bc%8c%e8%bf%99%e6%a0%b7%e4%b9%9f%e5%87%8f%e5%b0%91%e4%ba%86%e6%af%8f%e4%b8%aaJS%20Bundle%e7%9a%84%e4%bd%93%e7%a7%af%ef%bc%8c%e4%b8%8d%e5%86%8d%e6%9c%89React%20Native%e9%9c%80%e8%a6%81%e5%88%86%e5%8c%85%e7%9a%84%e9%97%ae%e9%a2%98%e3%80%82%e5%ae%a2%e6%88%b7%e7%ab%af%e8%af%b7%e6%b1%82%e5%ae%8cJS%20Bundle%e4%bb%a5%e5%90%8e%ef%bc%8c%e4%bc%a0%e7%bb%99JS%20Framework%ef%bc%8cJS%20Framework%e8%a7%a3%e6%9e%90%e5%ae%8c%e6%88%90%e4%bb%a5%e5%90%8e%e4%bc%9a%e8%be%93%e5%87%baJson%e6%a0%bc%e5%bc%8f%e7%9a%84Virtual%20DOM%ef%bc%8c%e5%ae%a2%e6%88%b7%e7%ab%afNative%e5%8f%aa%e9%9c%80%e8%a6%81%e4%b8%93%e5%bf%83%e8%b4%9f%e8%b4%a3%20Virtual%20DOM%20%e7%9a%84%e8%a7%a3%e6%9e%90%e5%92%8c%e5%b8%83%e5%b1%80%e3%80%81UI%20%e6%b8%b2%e6%9f%93%e3%80%82%e7%84%b6%e8%80%8c%e8%bf%99%e4%b8%80%e5%a5%97%e8%a7%a3%e6%9e%90%ef%bc%8c%e5%b8%83%e5%b1%80%ef%bc%8c%e6%b8%b2%e6%9f%93%e7%9a%84%e9%80%bb%e8%be%91SDK%e5%9f%ba%e6%9c%ac%e5%ae%9e%e7%8e%b0%e4%ba%86%e3%80%82"><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&t=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#前言>前言</a></li><li><a href=#目录>目录</a></li><li><a href=#一-weex概述>一. Weex概述</a></li><li><a href=#二-weex工作原理>二. Weex工作原理</a></li><li><a href=#三-weex在ios上是如何跑起来的>三. Weex在iOS上是如何跑起来的</a><ul><li><a href=#一-weex-sdk初始化>（一）. Weex SDK初始化</a></li><li><a href=#1-wxmonitor监视器记录状态>1. WXMonitor监视器记录状态</a></li><li><a href=#2-加载本地的mainjs>2. 加载本地的main.js</a></li><li><a href=#3-wxsdkengine的初始化>3. WXSDKEngine的初始化</a></li><li><a href=#4-模拟器wxsimulatorshortcutmanager连接本地调试工具>4. 模拟器WXSimulatorShortcutManager连接本地调试工具</a></li><li><a href=#二-weex-是如何让js调起oc原生uiview的>（二）. Weex 是如何让JS调起OC原生UIView的？</a></li><li><a href=#1扫二维码的原理>1.扫二维码的原理</a></li><li><a href=#2js是如何调起oc原生view的>2.JS是如何调起OC原生View的</a></li></ul></li><li><a href=#四关于weexreactnativejspatch>四.关于Weex，ReactNative，JSPatch</a></li><li><a href=#最后>最后</a></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Weex 是如何在 iOS 客户端上跑起来的</h1><div class=meta><div class=postdate><time datetime="2017-03-18 02:29:00 +0000 UTC" itemprop=datePublished>Mar 18</time></div><div class=article-category><i class="fas fa-archive"></i><a class=category-link href=/categories/ios>iOS</a>
,
<a class=category-link href=/categories/weex>Weex</a></div><div class=article-tag><i class="fas fa-tag"></i><a class=tag-link href=/tags/ios rel=tag>iOS</a>
,
<a class=tag-link href=/tags/weex rel=tag>Weex</a></div></div></header><div class=content itemprop=articleBody><h3 id=前言>前言</h3><p>2016年4月21日，阿里巴巴在Qcon大会上宣布跨平台移动开发工具Weex开放内测邀请。Weex能够完美兼顾性能与动态性，让移动开发者通过简捷的前端语法写出Native级别的性能体验，并支持iOS、安卓、YunOS及Web等多端部署。</p><p>近一年来，ReactNative 和 Weex 这些跨平台技术对Native开发者来说，冲击是巨大的。Native在开发App的时候存在一些弊端，比如客户端需要频繁更新，iOS更新时间还要受到审核的牵制；iOS、Android和前端同时开发同一个需求，在人员成本上消耗大；Hybrid的性能和Native相比又差了一点。</p><p>ReactNative 和 Weex的出现，就是为了解决这些痛点的。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_1.png alt></p><p>从4月21号宣布内测以后，短短两周就有超过5000名开发者申请。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_2.png alt></p><p>2016年6月30日阿里巴巴正式宣布Weex开源。号称可以用Web方式，开发Native级性能体验的亿级应用匠心打造跨平台移动开发工具Weex在开源首日就登上Github趋势榜首位，截止目前为止，Weex在GitHub上的Star数已经到达了13393了。成为中国2016年在Github上最热门的开源项目之一。</p><h3 id=目录>目录</h3><ul><li>1.Weex概述</li><li>2.Weex工作原理</li><li>3.Weex在iOS上是如何跑起来的</li><li>4.关于Weex，ReactNative，JSPatch</li></ul><h3 id=一-weex概述>一. Weex概述</h3><p>Weex从出生那天起，仿佛就是和ReactNative是“一对”。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_3.png alt></p><p>ReactNative宣称“Learn once, write anywhere”，而Weex宣称“Write Once, Run Everywhere”。Weex从出生那天起，就被给予了一统三端的厚望。ReactNative可以支持iOS、Android，而Weex可以支持iOS、Android、HTML5。一统三端就解决了前言里面说的第二个痛点，同时开发浪费人员成本的问题。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_4.png alt></p><p>Native移动开发者只需要在本地导入Weex的SDK，就可以通过HTML/CSS/JavaScript网页的这套编程语言来开发Native级别的Weex界面。这意味着可以直接用现有Web开发的编辑器和IDE的代码补全、提示、检查等功能。从而也给前端人员开发Native端，较低的开发成本和学习成本。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_5.png alt></p><p>Weex是一种轻量级、可扩展、高性能框架。集成也很方便，可以直接在HTML5页面嵌入，也可嵌在原生UI中。由于和ReactNative一样，都会调用Native端的原生控件，所以在性能上比Hybrid高出一个层次。这就解决了前言里面所说的第三个痛点，性能问题。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_6.png alt></p><p>Weex非常轻量，体积小巧，语法简单，方便接入和上手。ReactNative官方只允许将ReactNative基础JS库和业务JS一起打成一个JS bundle，没有提供分包的功能，所以如果想节约流量就必须制作分包打包工具。而Weex默认打的JS bundle只包含业务JS代码，体积小很多，基础JS库包含在Weex SDK中，这一点Weex与Facebook的React Native和微软的Cordova相比，Weex更加轻量，体积小巧。把Weex生成的JS bundle轻松部署到服务器端，然后Push到客户端，或者客户端请求新的资源即可完成发布。如此快速的迭代就解决了前言里面说的第一个痛点，发布无法控制时间，</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_7.png alt></p><p>Weex中Native组件和API都可以横向扩展，业务方可去中心化横向灵活化定制组件和功能模块。并且还可以直接复用Web前端的工程化管理和监控性能等工具。</p><p>知乎上有一个关于Weex 和 ReactNative很好的对比文章<a href=https://zhuanlan.zhihu.com/p/21677103>weex&ReactNative对比</a>，推荐大家阅读。</p><p>Weex在2017年2月17日正式发布<a href=https://github.com/alibaba/weex/releases/tag/v0.10.0>v0.10.0</a>，这个里程碑的版本开始完美的兼容Vue.js开发Weex界面。</p><p>Weex又于2017年2月24 迁移至 Apache 基金会，阿里巴巴会基于 Apache 的基础设施继续迭代。并启用了全新的 GitHub 仓库：<a href=https://github.com/apache/incubator-weex>https://github.com/apache/incubator-weex</a></p><p>故以下源码分析都基于v0.10.0这个版本。</p><h3 id=二-weex工作原理>二. Weex工作原理</h3><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_8.png alt></p><p>上图是官方给的一张原理图，Weex是如何把JS打包成JS Bundle的原理本篇文章暂时不涉及。本篇文章会详细分析Weex是如何在Native端工作的。笔者把Native端的原理再次细分，如下图：</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_9.png alt></p><p>Weex可以通过自己设计的DSL，书写.we文件或者.vue文件来开发界面，整个页面书写分成了3段，template、style、script，借鉴了成熟的MVVM的思想。</p><p>Weex在性能方面，为了尽可能的提升客户端的性能，DSL的Transformer全部都放在了服务器端实现，Weex会在服务器端将XML + CSS + JavaScript 代码全部都转换成JS Bundle。服务器将JS Bundle部署到Server上和CDN上。</p><p>Weex和React Native不同的是，Weex把JS Framework内置在SDK里面，用来解析从服务器上下载的JS Bundle，这样也减少了每个JS Bundle的体积，不再有React Native需要分包的问题。客户端请求完JS Bundle以后，传给JS Framework，JS Framework解析完成以后会输出Json格式的Virtual DOM，客户端Native只需要专心负责 Virtual DOM 的解析和布局、UI 渲染。然而这一套解析，布局，渲染的逻辑SDK基本实现了。</p><p>最后Weex支持三端一致，服务器上的一份JS Bundle，通过解析，实现iOS/Android/HTML5 三端的一致性。</p><h3 id=三-weex在ios上是如何跑起来的>三. Weex在iOS上是如何跑起来的</h3><p>经过上一章的分析，我们知道了Weex的整体流程，由于笔者前端知识匮乏，所以从.we或者.vue文件到JS bundle前端这部分的源码分析本文暂时不涉及，等笔者熟悉前端以后，这块还会再补上来。</p><p>分析之前先说明一点，Weex的所有源码其实已经开源了，至于SDK的Demo里面还依赖了一个ATSDK.framework，这个是没有开源的。ATSDK.framework这个其实是Weex性能监控的插件。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_10.png alt></p><p>就是上图中的那个灰色的框框的插件。这个插件有些大厂有自己的APM，阿里暂时没有开源这块，但是对Weex所有功能是不影响的。</p><p>那么接下来就详细分析一下在iOS Native端，Weex是如何跑起来的。直接上源码分析。</p><h4 id=一-weex-sdk初始化>（一）. Weex SDK初始化</h4><p>这是Native端想把Weex跑起来的第一步。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>BOOL</span>)<span style=color:#a6e22e>application:</span>(UIApplication <span style=color:#f92672>*</span>)application <span style=color:#a6e22e>didFinishLaunchingWithOptions:</span>(NSDictionary <span style=color:#f92672>*</span>)launchOptions
{
    self.window <span style=color:#f92672>=</span> [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds];
    self.window.backgroundColor <span style=color:#f92672>=</span> [UIColor whiteColor];
    
    <span style=color:#75715e>// 在这里进行初始化SDK
</span><span style=color:#75715e></span>    [self initWeexSDK];
    
    self.window.rootViewController <span style=color:#f92672>=</span> [[WXRootViewController alloc] initWithRootViewController:[self demoController]];
    [self.window makeKeyAndVisible];
    
    <span style=color:#66d9ef>return</span> YES;
}



</code></pre></div><p>在application: didFinishLaunchingWithOptions:函数里面初始化SDK。这里会初始化很多东西。可能有人会问了，初始化写在这里，还初始化这么多东西，不会卡App的启动时间么？带着这个问题继续往下看吧。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>#pragma mark weex
</span><span style=color:#75715e></span>- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>initWeexSDK</span>
{
    [WXAppConfiguration setAppGroup:<span style=color:#e6db74>@&#34;AliApp&#34;</span>];
    [WXAppConfiguration setAppName:<span style=color:#e6db74>@&#34;WeexDemo&#34;</span>];
    [WXAppConfiguration setExternalUserAgent:<span style=color:#e6db74>@&#34;ExternalUA&#34;</span>];
    
    [WXSDKEngine initSDKEnvironment];
    
    [WXSDKEngine registerHandler:[WXImgLoaderDefaultImpl new] withProtocol:@protocol(WXImgLoaderProtocol)];
    [WXSDKEngine registerHandler:[WXEventModule new] withProtocol:@protocol(WXEventModuleProtocol)];
    
    [WXSDKEngine registerComponent:<span style=color:#e6db74>@&#34;select&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXSelectComponent&#34;</span>)];
    [WXSDKEngine registerModule:<span style=color:#e6db74>@&#34;event&#34;</span> withClass:[WXEventModule <span style=color:#66d9ef>class</span>]];
    [WXSDKEngine registerModule:<span style=color:#e6db74>@&#34;syncTest&#34;</span> withClass:[WXSyncTestModule <span style=color:#66d9ef>class</span>]];
    
<span style=color:#75715e>#if !(TARGET_IPHONE_SIMULATOR)
</span><span style=color:#75715e></span>    [self checkUpdate];
<span style=color:#75715e>#endif
</span><span style=color:#75715e></span>    
<span style=color:#75715e>#ifdef DEBUG
</span><span style=color:#75715e></span>    [self atAddPlugin];
    [WXDebugTool setDebug:YES];
    [WXLog setLogLevel:WXLogLevelLog];
    
    <span style=color:#75715e>#ifndef UITEST
</span><span style=color:#75715e></span>        [[ATManager shareInstance] show];
    <span style=color:#75715e>#endif
</span><span style=color:#75715e>#else
</span><span style=color:#75715e></span>    [WXDebugTool setDebug:NO];
    [WXLog setLogLevel:WXLogLevelError];
<span style=color:#75715e>#endif
</span><span style=color:#75715e></span>}

</code></pre></div><p>上述就是要在application: didFinishLaunchingWithOptions:里面初始化的全部内容。我们一行一行的来解读。</p><p>WXAppConfiguration是一个用来记录App配置信息的单例对象。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXAppConfiguration</span> : <span style=color:#a6e22e>NSObject</span>

<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSString <span style=color:#f92672>*</span> appGroup;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSString <span style=color:#f92672>*</span> appName;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSString <span style=color:#f92672>*</span> appVersion;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSString <span style=color:#f92672>*</span> externalUA;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSString <span style=color:#f92672>*</span> JSFrameworkVersion;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSArray  <span style=color:#f92672>*</span> customizeProtocolClasses;


<span style=color:#75715e>/**
</span><span style=color:#75715e> * AppGroup的名字或者公司组织名，默认值为nil
</span><span style=color:#75715e> */</span>
+ (NSString <span style=color:#f92672>*</span>)<span style=color:#a6e22e>appGroup</span>;
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>setAppGroup:</span>(NSString <span style=color:#f92672>*</span>) appGroup;

<span style=color:#75715e>/**
</span><span style=color:#75715e> * app的名字, 默认值是main bundle里面的CFBundleDisplayName 
</span><span style=color:#75715e> */</span>
+ (NSString <span style=color:#f92672>*</span>)<span style=color:#a6e22e>appName</span>;
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>setAppName:</span>(NSString <span style=color:#f92672>*</span>)appName;

<span style=color:#75715e>/**
</span><span style=color:#75715e> * app版本信息, 默认值是main bundle里面的CFBundleShortVersionString
</span><span style=color:#75715e> */</span>
+ (NSString <span style=color:#f92672>*</span>)<span style=color:#a6e22e>appVersion</span>;
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>setAppVersion:</span>(NSString <span style=color:#f92672>*</span>)appVersion;

<span style=color:#75715e>/**
</span><span style=color:#75715e> * app外面用户代理的名字, 所有Weex的请求头都会设置用户代理user agent字段，默认值为nil
</span><span style=color:#75715e> */</span>
+ (NSString <span style=color:#f92672>*</span>)<span style=color:#a6e22e>externalUserAgent</span>;
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>setExternalUserAgent:</span>(NSString <span style=color:#f92672>*</span>)userAgent;

<span style=color:#75715e>/**
</span><span style=color:#75715e> * JSFrameworkVersion的版本
</span><span style=color:#75715e> */</span>
+ (NSString <span style=color:#f92672>*</span>)<span style=color:#a6e22e>JSFrameworkVersion</span>;
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>setJSFrameworkVersion:</span>(NSString <span style=color:#f92672>*</span>)JSFrameworkVersion;


<span style=color:#75715e>/*
</span><span style=color:#75715e> *  自定义customizeProtocolClasses
</span><span style=color:#75715e> */</span>
+ (NSArray<span style=color:#f92672>*</span>)<span style=color:#a6e22e>customizeProtocolClasses</span>;
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>setCustomizeProtocolClasses:</span>(NSArray<span style=color:#f92672>*</span>)customizeProtocolClasses;

<span style=color:#66d9ef>@end</span>




</code></pre></div><p>注意WXAppConfiguration的所有方法都是加号的类方法，内部实现是用WXAppConfiguration的单例实现的，这里用类方法是为了我们方便调用。</p><p>接下来是初始化SDK的实质代码了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

[WXSDKEngine initSDKEnvironment];


</code></pre></div><p>关于初始化的具体实现，见下面，里面标注了注释：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>initSDKEnvironment</span>
{
    <span style=color:#75715e>// 打点记录状态
</span><span style=color:#75715e></span>    WX_MONITOR_PERF_START(WXPTInitalize)
    WX_MONITOR_PERF_START(WXPTInitalizeSync)
    
    <span style=color:#75715e>// 加载本地的main.js
</span><span style=color:#75715e></span>    NSString <span style=color:#f92672>*</span>filePath <span style=color:#f92672>=</span> [[NSBundle bundleForClass:self] pathForResource:<span style=color:#e6db74>@&#34;main&#34;</span> ofType:<span style=color:#e6db74>@&#34;js&#34;</span>];
    NSString <span style=color:#f92672>*</span>script <span style=color:#f92672>=</span> [NSString stringWithContentsOfFile:filePath encoding:NSUTF8StringEncoding error:nil];
    
    <span style=color:#75715e>// 初始化SDK环境
</span><span style=color:#75715e></span>    [WXSDKEngine initSDKEnvironment:script];
    
    <span style=color:#75715e>// 打点记录状态
</span><span style=color:#75715e></span>    WX_MONITOR_PERF_END(WXPTInitalizeSync)
    
    <span style=color:#75715e>// 模拟器版本特殊代码
</span><span style=color:#75715e></span><span style=color:#75715e>#if TARGET_OS_SIMULATOR
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> dispatch_once_t onceToken;
    dispatch_once(<span style=color:#f92672>&amp;</span>onceToken, <span style=color:#f92672>^</span>{
        [WXSimulatorShortcutManager registerSimulatorShortcutWithKey:<span style=color:#e6db74>@&#34;i&#34;</span> modifierFlags:UIKeyModifierCommand <span style=color:#f92672>|</span> UIKeyModifierAlternate action:<span style=color:#f92672>^</span>{
            NSURL <span style=color:#f92672>*</span>URL <span style=color:#f92672>=</span> [NSURL URLWithString:<span style=color:#e6db74>@&#34;http://localhost:8687/launchDebugger&#34;</span>];
            NSURLRequest <span style=color:#f92672>*</span>request <span style=color:#f92672>=</span> [NSURLRequest requestWithURL:URL];
            
            NSURLSession <span style=color:#f92672>*</span>session <span style=color:#f92672>=</span> [NSURLSession sharedSession];
            NSURLSessionDataTask <span style=color:#f92672>*</span>task <span style=color:#f92672>=</span> [session dataTaskWithRequest:request
                                                    completionHandler:
                                          <span style=color:#f92672>^</span>(NSData <span style=color:#f92672>*</span>data, NSURLResponse <span style=color:#f92672>*</span>response, NSError <span style=color:#f92672>*</span>error) {
                                              <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>                                          }];
            
            [task resume];
            WXLogInfo(<span style=color:#e6db74>@&#34;Launching browser...&#34;</span>);
            
            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> NSEC_PER_SEC)), dispatch_get_main_queue(), <span style=color:#f92672>^</span>{
                [self connectDebugServer:<span style=color:#e6db74>@&#34;ws://localhost:8687/debugger/0/renderer&#34;</span>];
            });
            
        }];
    });
<span style=color:#75715e>#endif
</span><span style=color:#75715e></span>}


</code></pre></div><p>这里整个SDKEnvironment的初始化分成了四个步骤，WXMonitor监视器记录状态，加载本地的main.js，WXSDKEngine的初始化，模拟器WXSimulatorShortcutManager连接本地server。接下来一步步的分析。</p><h4 id=1-wxmonitor监视器记录状态>1. WXMonitor监视器记录状态</h4><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_11.png alt></p><p>WXMonitor是一个普通的对象，它里面只存储了一个线程安全的字典WXThreadSafeMutableDictionary。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXThreadSafeMutableDictionary</span><span style=color:#f92672>&lt;</span>KeyType, ObjectType<span style=color:#f92672>&gt;</span> <span style=color:#f92672>:</span> NSMutableDictionary
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) dispatch_queue_t queue;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSMutableDictionary<span style=color:#f92672>*</span> dict;
<span style=color:#66d9ef>@end</span>


</code></pre></div><p>在这个字典初始化的时候会初始化一个queue。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>instancetype</span>)<span style=color:#a6e22e>init</span>
{
    self <span style=color:#f92672>=</span> [self initCommon];
    <span style=color:#66d9ef>if</span> (self) {
        _dict <span style=color:#f92672>=</span> [NSMutableDictionary dictionary];
    }
    <span style=color:#66d9ef>return</span> self;
}

- (<span style=color:#66d9ef>instancetype</span>)<span style=color:#a6e22e>initCommon</span>
{
    self <span style=color:#f92672>=</span> [super init];
    <span style=color:#66d9ef>if</span> (self) {
        NSString<span style=color:#f92672>*</span> uuid <span style=color:#f92672>=</span> [NSString stringWithFormat:<span style=color:#e6db74>@&#34;com.taobao.weex.dictionary_%p&#34;</span>, self];
        _queue <span style=color:#f92672>=</span> dispatch_queue_create([uuid UTF8String], DISPATCH_QUEUE_CONCURRENT);
    }
    <span style=color:#66d9ef>return</span> self;
}

</code></pre></div><p>每次生成一次WXThreadSafeMutableDictionary，就会有一个与之内存地址向对应的Concurrent的queue相对应。</p><p>这个queue就保证了线程安全。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (NSUInteger)<span style=color:#a6e22e>count</span>
{
    <span style=color:#66d9ef>__block</span> NSUInteger count;
    dispatch_sync(_queue, <span style=color:#f92672>^</span>{
        count <span style=color:#f92672>=</span> _dict.count;
    });
    <span style=color:#66d9ef>return</span> count;
}

- (<span style=color:#66d9ef>id</span>)<span style=color:#a6e22e>objectForKey:</span>(<span style=color:#66d9ef>id</span>)aKey
{
    <span style=color:#66d9ef>__block</span> <span style=color:#66d9ef>id</span> obj;
    dispatch_sync(_queue, <span style=color:#f92672>^</span>{
        obj <span style=color:#f92672>=</span> _dict[aKey];
    });
    <span style=color:#66d9ef>return</span> obj;
}

- (NSEnumerator <span style=color:#f92672>*</span>)<span style=color:#a6e22e>keyEnumerator</span>
{
    <span style=color:#66d9ef>__block</span> NSEnumerator <span style=color:#f92672>*</span>enu;
    dispatch_sync(_queue, <span style=color:#f92672>^</span>{
        enu <span style=color:#f92672>=</span> [_dict keyEnumerator];
    });
    <span style=color:#66d9ef>return</span> enu;
}

- (<span style=color:#66d9ef>id</span>)<span style=color:#a6e22e>copy</span>{
    <span style=color:#66d9ef>__block</span> <span style=color:#66d9ef>id</span> copyInstance;
    dispatch_sync(_queue, <span style=color:#f92672>^</span>{
        copyInstance <span style=color:#f92672>=</span> [_dict <span style=color:#66d9ef>copy</span>];
    });
    <span style=color:#66d9ef>return</span> copyInstance;
}

</code></pre></div><p>count、objectForKey:、keyEnumerator、copy这四个操作都是同步操作，用dispatch_sync保护线程安全。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>setObject:</span>(<span style=color:#66d9ef>id</span>)anObject <span style=color:#a6e22e>forKey:</span>(<span style=color:#66d9ef>id</span><span style=color:#f92672>&lt;</span>NSCopying<span style=color:#f92672>&gt;</span>)aKey
{
    aKey <span style=color:#f92672>=</span> [aKey copyWithZone:NULL];
    dispatch_barrier_async(_queue, <span style=color:#f92672>^</span>{
        _dict[aKey] <span style=color:#f92672>=</span> anObject;
    });
}

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>removeObjectForKey:</span>(<span style=color:#66d9ef>id</span>)aKey
{
    dispatch_barrier_async(_queue, <span style=color:#f92672>^</span>{
        [_dict removeObjectForKey:aKey];
    });
}

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>removeAllObjects</span>{
    dispatch_barrier_async(_queue, <span style=color:#f92672>^</span>{
        [_dict removeAllObjects];
    });
}

</code></pre></div><p>setObject:forKey:、removeObjectForKey:、removeAllObjects这三个操作加上了dispatch_barrier_async。</p><p>WXMonitor在整个Weex里面担任的职责是记录下各个操作的tag值和记录成功和失败的原因。WXMonitor封装了各种宏来方便方法的调用。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

<span style=color:#75715e>#define WX_MONITOR_PERF_START(tag) [WXMonitor performancePoint:tag willStartWithInstance:nil];
</span><span style=color:#75715e>#define WX_MONITOR_PERF_END(tag) [WXMonitor performancePoint:tag didEndWithInstance:nil];
</span><span style=color:#75715e>#define WX_MONITOR_INSTANCE_PERF_START(tag, instance) [WXMonitor performancePoint:tag willStartWithInstance:instance];
</span><span style=color:#75715e>#define WX_MONITOR_INSTANCE_PERF_END(tag, instance) [WXMonitor performancePoint:tag didEndWithInstance:instance];
</span><span style=color:#75715e>#define WX_MONITOR_PERF_SET(tag, value, instance) [WXMonitor performancePoint:tag didSetValue:value withInstance:instance];
</span><span style=color:#75715e>#define WX_MONITOR_INSTANCE_PERF_IS_RECORDED(tag, instance) [WXMonitor performancePoint:tag isRecordedWithInstance:instance]
</span><span style=color:#75715e></span>
<span style=color:#75715e>// 上面这些宏都会分别对应下面这些具体的方法实现。
</span><span style=color:#75715e></span>+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>performancePoint:</span>(WXPerformanceTag)tag <span style=color:#a6e22e>willStartWithInstance:</span>(WXSDKInstance <span style=color:#f92672>*</span>)instance;
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>performancePoint:</span>(WXPerformanceTag)tag <span style=color:#a6e22e>didEndWithInstance:</span>(WXSDKInstance <span style=color:#f92672>*</span>)instance;
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>performancePoint:</span>(WXPerformanceTag)tag <span style=color:#a6e22e>didSetValue:</span>(<span style=color:#66d9ef>double</span>)value <span style=color:#a6e22e>withInstance:</span>(WXSDKInstance <span style=color:#f92672>*</span>)instance;
+ (<span style=color:#66d9ef>BOOL</span>)<span style=color:#a6e22e>performancePoint:</span>(WXPerformanceTag)tag <span style=color:#a6e22e>isRecordedWithInstance:</span>(WXSDKInstance <span style=color:#f92672>*</span>)instance;

</code></pre></div><p>整个操作被定义成2类，一个是全局的操作，一个是具体的操作。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>enum</span> <span style=color:#f92672>:</span> NSUInteger {
    <span style=color:#75715e>// global
</span><span style=color:#75715e></span>    WXPTInitalize <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
    WXPTInitalizeSync,
    WXPTFrameworkExecute,
    <span style=color:#75715e>// instance
</span><span style=color:#75715e></span>    WXPTJSDownload,
    WXPTJSCreateInstance,
    WXPTFirstScreenRender,
    WXPTAllRender,
    WXPTBundleSize,
    WXPTEnd
} WXPerformanceTag;


</code></pre></div><p>在WXSDKInstance初始化之前，所有的全局的global操作都会放在WXMonitor的WXThreadSafeMutableDictionary中。当WXSDKInstance初始化之后，即WXPerformanceTag中instance以下的所有操作都会放在WXSDKInstance的performanceDict中，注意performanceDict并不是线程安全的。</p><p>举个例子：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>performancePoint:</span>(WXPerformanceTag)tag <span style=color:#a6e22e>willStartWithInstance:</span>(WXSDKInstance <span style=color:#f92672>*</span>)instance
{
    NSMutableDictionary <span style=color:#f92672>*</span>performanceDict <span style=color:#f92672>=</span> [self performanceDictForInstance:instance];
    NSMutableDictionary <span style=color:#f92672>*</span>dict <span style=color:#f92672>=</span> [[NSMutableDictionary alloc] initWithCapacity:<span style=color:#ae81ff>2</span>];
    dict[kStartKey] <span style=color:#f92672>=</span> <span style=color:#ae81ff>@(</span>CACurrentMediaTime() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span><span style=color:#ae81ff>)</span>;
    performanceDict[<span style=color:#ae81ff>@(</span>tag<span style=color:#ae81ff>)</span>] <span style=color:#f92672>=</span> dict;
}


</code></pre></div><p>所有的操作都会按照时间被记录下来：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
    WX_MONITOR_PERF_START(WXPTInitalize)
    WX_MONITOR_PERF_START(WXPTInitalizeSync)


</code></pre></div><p>WXThreadSafeMutableDictionary字典里面会存类似这些数据：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

{
    <span style=color:#ae81ff>0</span> <span style=color:#f92672>=</span>     {
        start <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;146297522.903652&#34;</span>;
    };
    <span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span>     {
        start <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;146578019.356428&#34;</span>;
    };
}


</code></pre></div><p>字典里面会根据操作的tag作为key值。一般WX_MONITOR_PERF_START和WX_MONITOR_PERF_END是成对出现的，初始化结束以后就会调用WX_MONITOR_PERF_END。最终字典里面会保存成下面的样子：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
{
    <span style=color:#ae81ff>0</span> <span style=color:#f92672>=</span>     {
        end <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;148750673.312226&#34;</span>;
        start <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;148484241.723654&#34;</span>;
    };
    <span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span>     {
        end <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;148950673.312226&#34;</span>;
        start <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;148485865.699819&#34;</span>;
    };
}


</code></pre></div><p>WXMonitor里面还会记录一些成功和失败的信息：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>#define WX_MONITOR_SUCCESS_ON_PAGE(tag, pageName) [WXMonitor monitoringPointDidSuccess:tag onPage:pageName];
</span><span style=color:#75715e>#define WX_MONITOR_FAIL_ON_PAGE(tag, errorCode, errorMessage, pageName) \
</span><span style=color:#75715e>NSError *error = [NSError errorWithDomain:WX_ERROR_DOMAIN \
</span><span style=color:#75715e>                                     code:errorCode \
</span><span style=color:#75715e>                                 userInfo:@{NSLocalizedDescriptionKey:(errorMessage?:@&#34;No message&#34;)}]; \
</span><span style=color:#75715e>[WXMonitor monitoringPoint:tag didFailWithError:error onPage:pageName];
</span><span style=color:#75715e></span>
<span style=color:#75715e>#define WX_MONITOR_SUCCESS(tag) WX_MONITOR_SUCCESS_ON_PAGE(tag, nil)
</span><span style=color:#75715e>#define WX_MONITOR_FAIL(tag, errorCode, errorMessage) WX_MONITOR_FAIL_ON_PAGE(tag, errorCode, errorMessage, nil)
</span><span style=color:#75715e></span>
<span style=color:#75715e>// 上面这些宏都会分别对应下面这些具体的方法实现。
</span><span style=color:#75715e></span>+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>monitoringPointDidSuccess:</span>(WXMonitorTag)tag <span style=color:#a6e22e>onPage:</span>(NSString <span style=color:#f92672>*</span>)pageName;
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>monitoringPoint:</span>(WXMonitorTag)tag <span style=color:#a6e22e>didFailWithError:</span>(NSError <span style=color:#f92672>*</span>)error <span style=color:#a6e22e>onPage:</span>(NSString <span style=color:#f92672>*</span>)pageName;

</code></pre></div><p>这些函数暂时这里没有用到，暂时先不解析了。</p><h4 id=2-加载本地的mainjs>2. 加载本地的main.js</h4><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_12.gif alt></p><p>SDK里面会带一个main.js，直接打开这个文件会看到一堆经过webpack压缩之后的文件。这个文件的源文件在<a href=https://github.com/apache/incubator-weex/tree/master/html5>https://github.com/apache/incubator-weex/tree/master/html5</a>目录下。对应的入口文件是 <a href=https://github.com/apache/incubator-weex/blob/master/html5/render/native/index.js>html5/render/native/index.js</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>
<span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>subversion</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../../../package.json&#39;</span>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>runtime</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../../runtime&#39;</span>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>frameworks</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../../frameworks/index&#39;</span>
<span style=color:#66d9ef>import</span> <span style=color:#a6e22e>services</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../../services/index&#39;</span>

<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>init</span>, <span style=color:#a6e22e>config</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>runtime</span>
<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>frameworks</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>frameworks</span>
<span style=color:#66d9ef>const</span> { <span style=color:#66d9ef>native</span>, <span style=color:#a6e22e>transformer</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>subversion</span>

<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>services</span>) {
  <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>register</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>serviceName</span>])
}

<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>freezePrototype</span>()
<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>setNativeConsole</span>()

<span style=color:#75715e>// register framework meta info
</span><span style=color:#75715e></span><span style=color:#a6e22e>global</span>.<span style=color:#a6e22e>frameworkVersion</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>native</span>
<span style=color:#a6e22e>global</span>.<span style=color:#a6e22e>transformerVersion</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>transformer</span>

<span style=color:#75715e>// init frameworks
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>globalMethods</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>config</span>)

<span style=color:#75715e>// set global methods
</span><span style=color:#75715e></span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>methodName</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>globalMethods</span>) {
  <span style=color:#a6e22e>global</span>[<span style=color:#a6e22e>methodName</span>] <span style=color:#f92672>=</span> (...<span style=color:#a6e22e>args</span>) =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ret</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>globalMethods</span>[<span style=color:#a6e22e>methodName</span>](...<span style=color:#a6e22e>args</span>)
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>ret</span> <span style=color:#66d9ef>instanceof</span> Error) {
      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>ret</span>.<span style=color:#a6e22e>toString</span>())
    }
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ret</span>
  }
}



</code></pre></div><p>这一段JS是会被当做入参传递给WXSDKManager。它也就是Native这边的JSFramework。</p><h4 id=3-wxsdkengine的初始化>3. WXSDKEngine的初始化</h4><p>WXSDKEngine的初始化就是整个SDK初始化的关键。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>initSDKEnvironment:</span>(NSString <span style=color:#f92672>*</span>)script
{
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>script <span style=color:#f92672>||</span> script.length <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
        WX_MONITOR_FAIL(WXMTJSFramework, WX_ERR_JSFRAMEWORK_LOAD, <span style=color:#e6db74>@&#34;framework loading is failure!&#34;</span>);
        <span style=color:#66d9ef>return</span>;
    }
    
    <span style=color:#75715e>// 注册Components，Modules，Handlers
</span><span style=color:#75715e></span>    [self registerDefaults];
    
    <span style=color:#75715e>// 执行JsFramework
</span><span style=color:#75715e></span>    [[WXSDKManager bridgeMgr] executeJsFramework:script];
}

</code></pre></div><p>总共干了两件事情，注册Components，Modules，Handlers 和 执行JSFramework。</p><p>先来看看是怎么注册的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerDefaults</span>
{
    <span style=color:#66d9ef>static</span> dispatch_once_t onceToken;
    dispatch_once(<span style=color:#f92672>&amp;</span>onceToken, <span style=color:#f92672>^</span>{
        [self _registerDefaultComponents];
        [self _registerDefaultModules];
        [self _registerDefaultHandlers];
    });
}

</code></pre></div><p>在WXSDKEngine初始化的时候就分别注册了这三样东西，Components，Modules，Handlers。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_13.png alt></p><p>先看Components：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>_registerDefaultComponents</span>
{
    [self registerComponent:<span style=color:#e6db74>@&#34;container&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXDivComponent&#34;</span>) withProperties:nil];
    [self registerComponent:<span style=color:#e6db74>@&#34;div&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXComponent&#34;</span>) withProperties:nil];
    [self registerComponent:<span style=color:#e6db74>@&#34;text&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXTextComponent&#34;</span>) withProperties:nil];
    [self registerComponent:<span style=color:#e6db74>@&#34;image&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXImageComponent&#34;</span>) withProperties:nil];
    [self registerComponent:<span style=color:#e6db74>@&#34;scroller&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXScrollerComponent&#34;</span>) withProperties:nil];
    [self registerComponent:<span style=color:#e6db74>@&#34;list&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXListComponent&#34;</span>) withProperties:nil];
    
    [self registerComponent:<span style=color:#e6db74>@&#34;header&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXHeaderComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;cell&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXCellComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;embed&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXEmbedComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;a&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXAComponent&#34;</span>)];
    
    [self registerComponent:<span style=color:#e6db74>@&#34;select&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXSelectComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;switch&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXSwitchComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;input&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXTextInputComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;video&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXVideoComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;indicator&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXIndicatorComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;slider&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXSliderComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;web&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXWebComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;loading&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXLoadingComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;loading-indicator&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXLoadingIndicator&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;refresh&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXRefreshComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;textarea&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXTextAreaComponent&#34;</span>)];
	[self registerComponent:<span style=color:#e6db74>@&#34;canvas&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXCanvasComponent&#34;</span>)];
    [self registerComponent:<span style=color:#e6db74>@&#34;slider-neighbor&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXSliderNeighborComponent&#34;</span>)];
}



</code></pre></div><p>在WXSDKEngine初始化的时候会默认注册这23种基础组件。这里就举一个最复杂的组件WXWebComponent，来看看它是如何被注册的。</p><p>首先需要说明的一点，</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerComponent:</span>(NSString <span style=color:#f92672>*</span>)name <span style=color:#a6e22e>withClass:</span>(<span style=color:#66d9ef>Class</span>)clazz
{
    [self registerComponent:name withClass:clazz withProperties: <span style=color:#ae81ff>@{</span><span style=color:#e6db74>@&#34;append&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>@&#34;tree&#34;</span><span style=color:#ae81ff>}</span>];
}

</code></pre></div><p>registerComponent:withClass:方法和registerComponent:withClass:withProperties:方法的区别在于最后一个入参是否传@{@&ldquo;append&rdquo;:@&ldquo;tree&rdquo;}，如果被标记成了@&ldquo;tree&rdquo;，那么在syncQueue堆积了很多任务的时候，会被强制执行一次layout。</p><p>所以上面23种基本组件里面，只有前5种，container，div，text，image，scroller，list是没有被标记成@&ldquo;tree&rdquo;，剩下的18种都是有可能强制执行一次layout。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>


+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerComponent:</span>(NSString <span style=color:#f92672>*</span>)name <span style=color:#a6e22e>withClass:</span>(<span style=color:#66d9ef>Class</span>)clazz <span style=color:#a6e22e>withProperties:</span>(NSDictionary <span style=color:#f92672>*</span>)properties
{
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>name <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>clazz) {
        <span style=color:#66d9ef>return</span>;
    }
    WXAssert(name <span style=color:#f92672>&amp;&amp;</span> clazz, <span style=color:#e6db74>@&#34;Fail to register the component, please check if the parameters are correct ！&#34;</span>);
    
    <span style=color:#75715e>// 1.WXComponentFactory注册组件的方法
</span><span style=color:#75715e></span>    [WXComponentFactory registerComponent:name withClass:clazz withPros:properties];
    <span style=color:#75715e>// 2.遍历出所有异步的方法
</span><span style=color:#75715e></span>    NSMutableDictionary <span style=color:#f92672>*</span>dict <span style=color:#f92672>=</span> [WXComponentFactory componentMethodMapsWithName:name];
    dict[<span style=color:#e6db74>@&#34;type&#34;</span>] <span style=color:#f92672>=</span> name;
    
    <span style=color:#75715e>// 3.把组件注册到WXBridgeManager中
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (properties) {
        NSMutableDictionary <span style=color:#f92672>*</span>props <span style=color:#f92672>=</span> [properties mutableCopy];
        <span style=color:#66d9ef>if</span> ([dict[<span style=color:#e6db74>@&#34;methods&#34;</span>] count]) {
            [props addEntriesFromDictionary:dict];
        }
        [[WXSDKManager bridgeMgr] registerComponents:<span style=color:#ae81ff>@[</span>props<span style=color:#ae81ff>]</span>];
    } <span style=color:#66d9ef>else</span> {
        [[WXSDKManager bridgeMgr] registerComponents:<span style=color:#ae81ff>@[</span>dict<span style=color:#ae81ff>]</span>];
    }
}



</code></pre></div><p>注册组件全部都是通过WXComponentFactory完成注册的。WXComponentFactory是一个单例。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXComponentFactory</span> : <span style=color:#a6e22e>NSObject</span>
{
    NSMutableDictionary <span style=color:#f92672>*</span>_componentConfigs;
    NSLock <span style=color:#f92672>*</span>_configLock;
}
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSDictionary <span style=color:#f92672>*</span>properties;
<span style=color:#66d9ef>@end</span>

</code></pre></div><p>在WXComponentFactory中，_componentConfigs会存储所有的组件配置，注册的过程也是生成_componentConfigs的过程。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerComponent:</span>(NSString <span style=color:#f92672>*</span>)name <span style=color:#a6e22e>withClass:</span>(<span style=color:#66d9ef>Class</span>)clazz <span style=color:#a6e22e>withPros:</span>(NSDictionary <span style=color:#f92672>*</span>)pros
{
    WXAssert(name <span style=color:#f92672>&amp;&amp;</span> clazz, <span style=color:#e6db74>@&#34;name or clazz must not be nil for registering component.&#34;</span>);
    
    WXComponentConfig <span style=color:#f92672>*</span>config <span style=color:#f92672>=</span> nil;
    [_configLock lock];
    config <span style=color:#f92672>=</span> [_componentConfigs objectForKey:name];
    
    <span style=color:#75715e>// 如果组件已经注册过，会提示重复注册，并且覆盖原先的注册行为
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span>(config){
        WXLogInfo(<span style=color:#e6db74>@&#34;Overrider component name:%@ class:%@, to name:%@ class:%@&#34;</span>,
                  config.name, config.<span style=color:#66d9ef>class</span>, name, clazz);
    }
    
    config <span style=color:#f92672>=</span> [[WXComponentConfig alloc] initWithName:name <span style=color:#66d9ef>class</span><span style=color:#f92672>:</span>NSStringFromClass(clazz) pros:pros];
    [_componentConfigs setValue:config forKey:name];

    <span style=color:#75715e>// 注册类方法
</span><span style=color:#75715e></span>    [config registerMethods];
    [_configLock unlock];
}

</code></pre></div><p>在WXComponentFactory的_componentConfigs字典中会按照组件的名字作为key，WXComponentConfig作为value存储各个组件的配置。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXComponentConfig</span> : <span style=color:#a6e22e>WXInvocationConfig</span>
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSDictionary <span style=color:#f92672>*</span>properties;
<span style=color:#66d9ef>@end</span>


<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXInvocationConfig</span> : <span style=color:#a6e22e>NSObject</span>
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSString <span style=color:#f92672>*</span>name;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSString <span style=color:#f92672>*</span>clazz;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSMutableDictionary <span style=color:#f92672>*</span>asyncMethods;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSMutableDictionary <span style=color:#f92672>*</span>syncMethods;
<span style=color:#66d9ef>@end</span>

</code></pre></div><p>WXComponentConfig继承自WXInvocationConfig，在WXInvocationConfig中存储了组件名name，类名clazz，类里面的同步方法字典syncMethods和异步方法字典asyncMethods。</p><p>组件注册这里比较关键的一点是注册类方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerMethods</span>
{
    <span style=color:#66d9ef>Class</span> currentClass <span style=color:#f92672>=</span> NSClassFromString(_clazz);
    
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>currentClass) {
        WXLogWarning(<span style=color:#e6db74>@&#34;The module class [%@] doesn&#39;t exit！&#34;</span>, _clazz);
        <span style=color:#66d9ef>return</span>;
    }
    
    <span style=color:#66d9ef>while</span> (currentClass <span style=color:#f92672>!=</span> [NSObject <span style=color:#66d9ef>class</span>]) {
        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> methodCount <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
        <span style=color:#75715e>// 获取类的方法列表
</span><span style=color:#75715e></span>        Method <span style=color:#f92672>*</span>methodList <span style=color:#f92672>=</span> class_copyMethodList(object_getClass(currentClass), <span style=color:#f92672>&amp;</span>methodCount);
        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> methodCount; i<span style=color:#f92672>++</span>) {
            <span style=color:#75715e>// 获取SEL的字符串名称
</span><span style=color:#75715e></span>            NSString <span style=color:#f92672>*</span>selStr <span style=color:#f92672>=</span> [NSString stringWithCString:sel_getName(method_getName(methodList[i])) encoding:NSUTF8StringEncoding];
            
            <span style=color:#66d9ef>BOOL</span> isSyncMethod <span style=color:#f92672>=</span> NO;
            <span style=color:#75715e>// 如果是SEL名字带sync，就是同步方法
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> ([selStr hasPrefix:<span style=color:#e6db74>@&#34;wx_export_method_sync_&#34;</span>]) {
                isSyncMethod <span style=color:#f92672>=</span> YES;
            <span style=color:#75715e>// 如果是SEL名字不带sync，就是异步方法
</span><span style=color:#75715e></span>            } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> ([selStr hasPrefix:<span style=color:#e6db74>@&#34;wx_export_method_&#34;</span>]) {
                isSyncMethod <span style=color:#f92672>=</span> NO;
            } <span style=color:#66d9ef>else</span> {
                <span style=color:#75715e>// 如果名字里面不带wx_export_method_前缀的方法，那么都不算是暴露出来的方法，直接continue，进行下一轮的筛选
</span><span style=color:#75715e></span>                <span style=color:#66d9ef>continue</span>;
            }
            
            NSString <span style=color:#f92672>*</span>name <span style=color:#f92672>=</span> nil, <span style=color:#f92672>*</span>method <span style=color:#f92672>=</span> nil;
            <span style=color:#66d9ef>SEL</span> selector <span style=color:#f92672>=</span> NSSelectorFromString(selStr);
            <span style=color:#66d9ef>if</span> ([currentClass respondsToSelector:selector]) {
                method <span style=color:#f92672>=</span> ((NSString<span style=color:#f92672>*</span> (<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>SEL</span>))[currentClass methodForSelector:selector])(currentClass, selector);
            }
            
            <span style=color:#66d9ef>if</span> (method.length <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
                WXLogWarning(<span style=color:#e6db74>@&#34;The module class [%@] doesn&#39;t has any method！&#34;</span>, _clazz);
                <span style=color:#66d9ef>continue</span>;
            }
            
            <span style=color:#75715e>// 去掉方法名里面带的：号
</span><span style=color:#75715e></span>            NSRange range <span style=color:#f92672>=</span> [method rangeOfString:<span style=color:#e6db74>@&#34;:&#34;</span>];
            <span style=color:#66d9ef>if</span> (range.location <span style=color:#f92672>!=</span> NSNotFound) {
                name <span style=color:#f92672>=</span> [method substringToIndex:range.location];
            } <span style=color:#66d9ef>else</span> {
                name <span style=color:#f92672>=</span> method;
            }
            
            <span style=color:#75715e>// 最终字典里面会按照异步方法和同步方法保存到最终的方法字典里
</span><span style=color:#75715e></span>            NSMutableDictionary <span style=color:#f92672>*</span>methods <span style=color:#f92672>=</span> isSyncMethod <span style=color:#f92672>?</span> _syncMethods : _asyncMethods;
            [methods setObject:method forKey:name];
        }
        
        free(methodList);
        currentClass <span style=color:#f92672>=</span> class_getSuperclass(currentClass);
    }
    
}



</code></pre></div><p>这里的做法也比较常规，找到对应的类方法，判断名字里面是否带有“sync”来判断方法是同步还是异步方法。这里重点需要解析的是组件的方法是如何转换成类方法的暴露出去的。</p><p>Weex是通过里面通过WX_EXPORT_METHOD宏做到对外暴露类方法的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>#define WX_EXPORT_METHOD(method) WX_EXPORT_METHOD_INTERNAL(method,wx_export_method_)
</span><span style=color:#75715e></span>

<span style=color:#75715e>#define WX_EXPORT_METHOD_INTERNAL(method, token) \
</span><span style=color:#75715e>+ (NSString *)WX_CONCAT_WRAPPER(token, __LINE__) { \
</span><span style=color:#75715e>    return NSStringFromSelector(method); \
</span><span style=color:#75715e>}
</span><span style=color:#75715e></span>
<span style=color:#75715e>#define WX_CONCAT_WRAPPER(a, b)    WX_CONCAT(a, b)
</span><span style=color:#75715e></span>
<span style=color:#75715e>#define WX_CONCAT(a, b)   a ## b
</span><span style=color:#75715e></span>
</code></pre></div><p>WX_EXPORT_METHOD宏会完全展开成下面这个样子：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>#define WX_EXPORT_METHOD(method)
</span><span style=color:#75715e></span>
+ (NSString <span style=color:#f92672>*</span>)<span style=color:#a6e22e>wx_export_method_</span> __LINE__ { \
    <span style=color:#66d9ef>return</span> NSStringFromSelector(method); \
}


</code></pre></div><p>举个例子，在WXWebComponent的第52行里面写了下面这一行代码：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
WX_EXPORT_METHOD(<span style=color:#66d9ef>@selector</span>(goBack))

</code></pre></div><p>那么这个宏在预编译的时候就会被展开成下面这个样子：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

+ (NSString <span style=color:#f92672>*</span>)<span style=color:#a6e22e>wx_export_method_52</span> {
    <span style=color:#66d9ef>return</span> NSStringFromSelector(<span style=color:#66d9ef>@selector</span>(goBack));
}

</code></pre></div><p>于是乎在WXWebComponent的类方法里面就多了一个wx_export_method_52的方法。由于在同一个文件里面，WX_EXPORT_METHOD宏是不允许写在同一行的，所以转换出来的方法名字肯定不会相同。但是不同类里面行数就没有规定，行数是可能相同的，从而不同类里面可能就有相同的方法名。</p><p>比如在WXScrollerComponent里面的第58行</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
WX_EXPORT_METHOD(<span style=color:#66d9ef>@selector</span>(resetLoadmore))

</code></pre></div><p>WXTextAreaComponent里面的第58行</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

WX_EXPORT_METHOD(<span style=color:#66d9ef>@selector</span>(focus))

</code></pre></div><p>这两个是不同的组件，但是宏展开之后的方法名是一样的，这两个不同的类的类方法，是有重名的，但是完全不会有什么影响，因为获取类方法的时候是通过class_copyMethodList，保证这个list里面都是唯一的名字即可。</p><p>还有一点需要说明的是，虽然用class_copyMethodList会获取所有的类方法(+号方法)，但是可能有人疑问了，那不通过WX_EXPORT_METHOD宏对外暴露的普通的+号方法，不是也会被筛选进来么？</p><p>回答：是的，会被class_copyMethodList获取到，但是这里有一个判断条件，会避开这些不通过WX_EXPORT_METHOD宏对外暴露的普通的+号类方法。</p><p>如果不通过WX_EXPORT_METHOD宏来申明对外暴露的普通的+号类方法，那么名字里面就不会带wx_export_method_的前缀的方法，那么都不算是暴露出来的方法，上面筛选的代码里面会直接continue，进行下一轮的筛选，所以不必担心那些普通的+号类方法会进来干扰。</p><p>回到WXWebComponent注册，通过上述方法获取完类方法之后，字典里面就存储的如下信息：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
methods <span style=color:#f92672>=</span> {
    goBack <span style=color:#f92672>=</span> goBack;
    goForward <span style=color:#f92672>=</span> goForward;
    reload <span style=color:#f92672>=</span> reload;
}

</code></pre></div><p>这就完成了组件注册的第一步，完成了注册配置WXComponentConfig。</p><p>组件注册的第二步，遍历所有的异步方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (NSMutableDictionary <span style=color:#f92672>*</span>)<span style=color:#a6e22e>_componentMethodMapsWithName:</span>(NSString <span style=color:#f92672>*</span>)name
{
    NSMutableDictionary <span style=color:#f92672>*</span>dict <span style=color:#f92672>=</span> [NSMutableDictionary dictionary];
    NSMutableArray <span style=color:#f92672>*</span>methods <span style=color:#f92672>=</span> [NSMutableArray array];
    
    [_configLock lock];
    [dict setValue:methods forKey:<span style=color:#e6db74>@&#34;methods&#34;</span>];
    
    WXComponentConfig <span style=color:#f92672>*</span>config <span style=color:#f92672>=</span> _componentConfigs[name];
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>mBlock)(<span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>BOOL</span> <span style=color:#f92672>*</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(<span style=color:#66d9ef>id</span> mKey, <span style=color:#66d9ef>id</span> mObj, <span style=color:#66d9ef>BOOL</span> <span style=color:#f92672>*</span> mStop) {
        [methods addObject:mKey];
    };
    [config.asyncMethods enumerateKeysAndObjectsUsingBlock:mBlock];
    [_configLock unlock];
    <span style=color:#66d9ef>return</span> dict;
}

</code></pre></div><p>这里依旧是调用了WXComponentFactory的方法_componentMethodMapsWithName:。这里就是遍历出异步方法，并放入字典中，返回异步方法的字典。</p><p>还是以最复杂的WXWebComponent为例，这里就会返回如下的异步方法字典：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

{
    methods <span style=color:#f92672>=</span>     (
        goForward,
        goBack,
        reload
    );
}


</code></pre></div><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_14.png alt></p><p>注册组件的最后一步会在JSFrame中注册组件。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXSDKManager</span> ()
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) WXBridgeManager <span style=color:#f92672>*</span>bridgeMgr;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) WXThreadSafeMutableDictionary <span style=color:#f92672>*</span>instanceDict;
<span style=color:#66d9ef>@end</span>

</code></pre></div><p>在WXSDKManager里面会强持有一个WXBridgeManager。这个WXBridgeManager就是用来和JS交互的Bridge。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXBridgeManager</span> : <span style=color:#a6e22e>NSObject</span>
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>weak</span>, <span style=color:#66d9ef>readonly</span>) WXSDKInstance <span style=color:#f92672>*</span>topInstance;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) WXBridgeContext   <span style=color:#f92672>*</span>bridgeCtx;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>assign</span>) <span style=color:#66d9ef>BOOL</span>  stopRunning;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSMutableArray <span style=color:#f92672>*</span>instanceIdStack;
<span style=color:#66d9ef>@end</span>

</code></pre></div><p>WXBridgeManager中会弱引用WXSDKInstance实例，是为了能调用WXSDKInstance的一些属性和方法。WXBridgeManager里面最重要的一个属性就是WXBridgeContext。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXBridgeContext</span> ()
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>weak</span>, <span style=color:#66d9ef>readonly</span>) WXSDKInstance <span style=color:#f92672>*</span>topInstance;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) <span style=color:#66d9ef>id</span><span style=color:#f92672>&lt;</span>WXBridgeProtocol<span style=color:#f92672>&gt;</span>  jsBridge;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) WXDebugLoggerBridge <span style=color:#f92672>*</span>devToolSocketBridge;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>assign</span>) <span style=color:#66d9ef>BOOL</span>  debugJS;
<span style=color:#75715e>// 存储native要即将调用js的一些方法
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSMutableDictionary   <span style=color:#f92672>*</span>sendQueue;
<span style=color:#75715e>// 实例的一些堆栈
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) WXThreadSafeMutableArray    <span style=color:#f92672>*</span>insStack;
<span style=color:#75715e>// 标识JSFramework是否已经加载完成
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>) <span style=color:#66d9ef>BOOL</span> frameworkLoadFinished;
<span style=color:#75715e>// 在JSFramework加载完成之前，临时存储一些方法
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSMutableArray <span style=color:#f92672>*</span>methodQueue;
<span style=color:#75715e>// 存储js模板的service
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSMutableArray <span style=color:#f92672>*</span>jsServiceQueue;
<span style=color:#66d9ef>@end</span>


</code></pre></div><p>在WXBridgeContext中强持有了一个jsBridge。这个就是用来和js进行交互的Bridge。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_15.png alt></p><p>三者的关系用图表示出来如上图。由于是弱引用，所以用虚的线框表示。</p><p>回到注册的步骤中来，在WXSDKEngine中调用如下方法：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
[[WXSDKManager bridgeMgr] registerComponents:<span style=color:#ae81ff>@[</span>dict<span style=color:#ae81ff>]</span>];

</code></pre></div><p>WXBridgeManager调用registerComponents方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerComponents:</span>(NSArray <span style=color:#f92672>*</span>)components
{
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>components) <span style=color:#66d9ef>return</span>;
    
    <span style=color:#66d9ef>__weak</span> <span style=color:#66d9ef>typeof</span>(self) weakSelf <span style=color:#f92672>=</span> self;
    WXPerformBlockOnBridgeThread(<span style=color:#f92672>^</span>(){
        [weakSelf.bridgeCtx registerComponents:components];
    });
}


</code></pre></div><p>最终是WXBridgeManager里面的WXBridgeContext 调用registerComponents，进行组件的注册。但是注册组件的这一步是在一个特殊的线程中执行的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>WXPerformBlockOnBridgeThread</span>(<span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>block)())
{
    [WXBridgeManager _performBlockOnBridgeThread:block];
}

+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>_performBlockOnBridgeThread:</span>(<span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>)())block
{
    <span style=color:#66d9ef>if</span> ([NSThread currentThread] <span style=color:#f92672>==</span> [self jsThread]) {
        block();
    } <span style=color:#66d9ef>else</span> {
        [self performSelector:<span style=color:#66d9ef>@selector</span>(_performBlockOnBridgeThread:)
                     onThread:[self jsThread]
                   withObject:[block <span style=color:#66d9ef>copy</span>]
                waitUntilDone:NO];
    }
}


</code></pre></div><p>这里就可以看到，block闭包是在jsThread的线程中执行的，并非主线程。WXBridgeManager会新建一个名为@&ldquo;com.taobao.weex.bridge"的jsThread线程，所有的组件注册都在这个子线程中执行的。这个jsThread也是一个单例，全局唯一。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

+ (NSThread <span style=color:#f92672>*</span>)<span style=color:#a6e22e>jsThread</span>
{
    <span style=color:#66d9ef>static</span> dispatch_once_t onceToken;
    dispatch_once(<span style=color:#f92672>&amp;</span>onceToken, <span style=color:#f92672>^</span>{
        
        WXBridgeThread <span style=color:#f92672>=</span> [[NSThread alloc] initWithTarget:[[self <span style=color:#66d9ef>class</span>]sharedManager] selector:<span style=color:#66d9ef>@selector</span>(_runLoopThread) object:nil];
        [WXBridgeThread setName:WX_BRIDGE_THREAD_NAME];
        <span style=color:#66d9ef>if</span>(WX_SYS_VERSION_GREATER_THAN_OR_EQUAL_TO(<span style=color:#e6db74>@&#34;8.0&#34;</span>)) {
            [WXBridgeThread setQualityOfService:[[NSThread mainThread] qualityOfService]];
        } <span style=color:#66d9ef>else</span> {
            [WXBridgeThread setThreadPriority:[[NSThread mainThread] threadPriority]];
        }
        
        [WXBridgeThread start];
    });
    
    <span style=color:#66d9ef>return</span> WXBridgeThread;
}


</code></pre></div><p>这里就是创建jsThread的代码，jsThread会把@selector(_runLoopThread)作为selector。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>_runLoopThread</span>
{
    [[NSRunLoop currentRunLoop] addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];
    
    <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span>_stopRunning) {
        <span style=color:#66d9ef>@autoreleasepool</span> {
            [[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];
        }
    }
}



</code></pre></div><p>于是这里就给jsThread开启了一个runloop。这里是用[NSMachPort port]的方式开启的runloop，之后再也无法获取到这个port了，而且这个runloop不是CFRunloop，所以用官方文档上的那3个方法已经不能停止这个runloop了，只能自己通过while的方式来停止。上述代码是一种写法，当然StackOverFlow上面推荐的是下面的写法，下面的写法也是我常用的写法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>BOOL</span> shouldKeepRunning <span style=color:#f92672>=</span> YES;        <span style=color:#75715e>// global 
</span><span style=color:#75715e></span>NSRunLoop <span style=color:#f92672>*</span>theRL <span style=color:#f92672>=</span> [NSRunLoop currentRunLoop]; 
<span style=color:#66d9ef>while</span> (shouldKeepRunning <span style=color:#f92672>&amp;&amp;</span> [theRL runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]]);



</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>


- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerComponents:</span>(NSArray <span style=color:#f92672>*</span>)components
{
    WXAssertBridgeThread();
    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>components) <span style=color:#66d9ef>return</span>;
    [self callJSMethod:<span style=color:#e6db74>@&#34;registerComponents&#34;</span> args:<span style=color:#ae81ff>@[</span>components<span style=color:#ae81ff>]</span>];
}

</code></pre></div><p>在WXBridgeContext中注册组件，其实调用的是js的方法"registerComponents&rdquo;。</p><p>这里有一个需要注意的一点，由于是在子线程上注册组件，那么JSFramework如果没有加载完成，native去调用js的方法，必定调用失败。所以需要在JSFramework加载完成之前，把native调用JS的方法都缓存起来，一旦JSFramework加载完成，把缓存里面的方法都丢给JSFramework去加载。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>callJSMethod:</span>(NSString <span style=color:#f92672>*</span>)method <span style=color:#a6e22e>args:</span>(NSArray <span style=color:#f92672>*</span>)args
{
    <span style=color:#66d9ef>if</span> (self.frameworkLoadFinished) {
        [self.jsBridge callJSMethod:method args:args];
    } <span style=color:#66d9ef>else</span> {
        [_methodQueue addObject:<span style=color:#ae81ff>@{</span><span style=color:#e6db74>@&#34;method&#34;</span><span style=color:#f92672>:</span>method, <span style=color:#e6db74>@&#34;args&#34;</span><span style=color:#f92672>:</span>args<span style=color:#ae81ff>}</span>];
    }
}


</code></pre></div><p>所以在WXBridgeContext中需要一个NSMutableArray，用来缓存在JSFramework加载完成之前，调用JS的方法。这里是保存在_methodQueue里面。如果JSFramework加载完成，那么就会调用callJSMethod:args:方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (JSValue <span style=color:#f92672>*</span>)<span style=color:#a6e22e>callJSMethod:</span>(NSString <span style=color:#f92672>*</span>)method <span style=color:#a6e22e>args:</span>(NSArray <span style=color:#f92672>*</span>)args
{
    WXLogDebug(<span style=color:#e6db74>@&#34;Calling JS... method:%@, args:%@&#34;</span>, method, args);
    <span style=color:#66d9ef>return</span> [[_jsContext globalObject] invokeMethod:method withArguments:args];
}


</code></pre></div><p>由于这些注册的方法的定义是全局函数，那么很显然应该在JSContext的globalObject对象上调用该方法。(目前流程进行到这里还看不到定义的全局函数，往后看就会看到)</p><p>还是用WXWebComponent来举例，那么这里注册组件的method就是@“registerComponents”，args参数如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
        (
                {
            append <span style=color:#f92672>=</span> tree;
            methods <span style=color:#f92672>=</span>             (
                goForward,
                goBack,
                reload
            );
            type <span style=color:#f92672>=</span> web;
        }
    )


</code></pre></div><p>实际上程序运行到这里，并不会去执行callJSMethod:args:，因为现在JSFramework还没有加载完成。</p><p>注册组件的全部流程如下：</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_16.png alt></p><p>再注册Modules</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_17.png alt></p><p>注册Modules的流程和上面注册Components非常类似。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>


+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>_registerDefaultModules</span>
{
    [self registerModule:<span style=color:#e6db74>@&#34;dom&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXDomModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;navigator&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXNavigatorModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;stream&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXStreamModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;animation&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXAnimationModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;modal&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXModalUIModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;webview&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXWebViewModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;instanceWrap&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXInstanceWrap&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;timer&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXTimerModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;storage&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXStorageModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;clipboard&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXClipboardModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;globalEvent&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXGlobalEventModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;canvas&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXCanvasModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;picker&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXPickerModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;meta&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXMetaModule&#34;</span>)];
    [self registerModule:<span style=color:#e6db74>@&#34;webSocket&#34;</span> withClass:NSClassFromString(<span style=color:#e6db74>@&#34;WXWebSocketModule&#34;</span>)];
}


</code></pre></div><p>WXSDKEngine会默认注册这15种基础模块。这里就以比较复杂的模块WXWebSocketModule为例，来看看它是如何被注册的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerModule:</span>(NSString <span style=color:#f92672>*</span>)name <span style=color:#a6e22e>withClass:</span>(<span style=color:#66d9ef>Class</span>)clazz
{
    WXAssert(name <span style=color:#f92672>&amp;&amp;</span> clazz, <span style=color:#e6db74>@&#34;Fail to register the module, please check if the parameters are correct ！&#34;</span>);
    
    <span style=color:#75715e>// 1. WXModuleFactory注册模块
</span><span style=color:#75715e></span>    NSString <span style=color:#f92672>*</span>moduleName <span style=color:#f92672>=</span> [WXModuleFactory registerModule:name withClass:clazz];
    <span style=color:#75715e>// 2.遍历所有同步和异步方法
</span><span style=color:#75715e></span>    NSDictionary <span style=color:#f92672>*</span>dict <span style=color:#f92672>=</span> [WXModuleFactory moduleMethodMapsWithName:moduleName];
    <span style=color:#75715e>// 3.把模块注册到WXBridgeManager中
</span><span style=color:#75715e></span>    [[WXSDKManager bridgeMgr] registerModules:dict];
}


</code></pre></div><p>注册模块也分3步，第一步是在WXModuleFactory中注册。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXModuleFactory</span> ()
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>)  NSMutableDictionary  <span style=color:#f92672>*</span>moduleMap;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>)  NSLock   <span style=color:#f92672>*</span>moduleLock;
<span style=color:#66d9ef>@end</span>

</code></pre></div><p>在WXModuleFactory中，moduleMap会存储所有的模块的配置信息，注册的过程也是生成moduleMap的过程。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (NSString <span style=color:#f92672>*</span>)<span style=color:#a6e22e>_registerModule:</span>(NSString <span style=color:#f92672>*</span>)name <span style=color:#a6e22e>withClass:</span>(<span style=color:#66d9ef>Class</span>)clazz
{
    WXAssert(name <span style=color:#f92672>&amp;&amp;</span> clazz, <span style=color:#e6db74>@&#34;Fail to register the module, please check if the parameters are correct ！&#34;</span>);
    
    [_moduleLock lock];
    <span style=color:#75715e>// 这里需要注意的是：注册模块是允许同名模块的
</span><span style=color:#75715e></span>    WXModuleConfig <span style=color:#f92672>*</span>config <span style=color:#f92672>=</span> [[WXModuleConfig alloc] init];
    config.name <span style=color:#f92672>=</span> name;
    config.clazz <span style=color:#f92672>=</span> NSStringFromClass(clazz);
    [config registerMethods];
    [_moduleMap setValue:config forKey:name];
    [_moduleLock unlock];
    
    <span style=color:#66d9ef>return</span> name;
}


</code></pre></div><p>整个注册的过程就是把WXModuleConfig为value，name为key，存入_moduleMap字典里。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXModuleConfig</span> : <span style=color:#a6e22e>WXInvocationConfig</span>
<span style=color:#66d9ef>@end</span>


</code></pre></div><p>WXModuleConfig仅仅只是继承自WXInvocationConfig，所以它和WXInvocationConfig是完全一样的。[config registerMethods]这个方法和注册组件的方法是同一个方法，具体注册流程这里就不再赘述了。</p><p>在WXModuleFactory中会记录下一个个的WXModuleConfig：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>_moduleMap</span> = {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>animation</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x60000024a230&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>canvas</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x608000259ce0&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>clipboard</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x608000259b30&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>dom</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x608000259440&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>event</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x60800025a280&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>globalEvent</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x60000024a560&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>instanceWrap</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x608000259a70&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>meta</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x60000024a7a0&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>modal</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x6080002597d0&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>navigator</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x600000249fc0&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>picker</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x608000259e60&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>storage</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x60000024a4a0&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>stream</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x6080002596e0&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>syncTest</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x60800025a520&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>timer</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x60000024a380&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>webSocket</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x608000259fb0&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>webview</span> = <span style=color:#e6db74>&#34;&lt;WXModuleConfig: 0x6080002598f0&gt;&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>每个WXModuleConfig中会记录下所有的同步和异步的方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>name</span> = <span style=color:#a6e22e>dom</span>,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>clazz</span> = <span style=color:#a6e22e>WXDomModule</span>,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>asyncMethods</span> = {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>addElement</span> = <span style=color:#e6db74>&#34;addElement:element:atIndex:&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>addEvent</span> = <span style=color:#e6db74>&#34;addEvent:event:&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>addRule</span> = <span style=color:#e6db74>&#34;addRule:rule:&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>createBody</span> = <span style=color:#e6db74>&#34;createBody:&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>createFinish</span> = <span style=color:#a6e22e>createFinish</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>getComponentRect</span> = <span style=color:#e6db74>&#34;getComponentRect:callback:&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>moveElement</span> = <span style=color:#e6db74>&#34;moveElement:parentRef:index:&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>refreshFinish</span> = <span style=color:#a6e22e>refreshFinish</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>removeElement</span> = <span style=color:#e6db74>&#34;removeElement:&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>removeEvent</span> = <span style=color:#e6db74>&#34;removeEvent:event:&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>scrollToElement</span> = <span style=color:#e6db74>&#34;scrollToElement:options:&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>updateAttrs</span> = <span style=color:#e6db74>&#34;updateAttrs:attrs:&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>updateFinish</span> = <span style=color:#a6e22e>updateFinish</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#a6e22e>updateStyle</span> = <span style=color:#e6db74>&#34;updateStyle:styles:&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>},<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>syncMethods</span> = {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>第二步遍历所有的方法列表。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (NSMutableDictionary <span style=color:#f92672>*</span>)<span style=color:#a6e22e>_moduleMethodMapsWithName:</span>(NSString <span style=color:#f92672>*</span>)name
{
    NSMutableDictionary <span style=color:#f92672>*</span>dict <span style=color:#f92672>=</span> [NSMutableDictionary dictionary];
    NSMutableArray <span style=color:#f92672>*</span>methods <span style=color:#f92672>=</span> [self _defaultModuleMethod];
  
    [_moduleLock lock];
    [dict setValue:methods forKey:name];
    WXModuleConfig <span style=color:#f92672>*</span>config <span style=color:#f92672>=</span> _moduleMap[name];
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>mBlock)(<span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>BOOL</span> <span style=color:#f92672>*</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(<span style=color:#66d9ef>id</span> mKey, <span style=color:#66d9ef>id</span> mObj, <span style=color:#66d9ef>BOOL</span> <span style=color:#f92672>*</span> mStop) {
        [methods addObject:mKey];
    };
    [config.syncMethods enumerateKeysAndObjectsUsingBlock:mBlock];
    [config.asyncMethods enumerateKeysAndObjectsUsingBlock:mBlock];
    [_moduleLock unlock];
    <span style=color:#66d9ef>return</span> dict;
}


</code></pre></div><p>这里遍历模块的方法列表和组件的有所不同。首先模块是有默认方法的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (NSMutableArray<span style=color:#f92672>*</span>)<span style=color:#a6e22e>_defaultModuleMethod</span>
{
    <span style=color:#66d9ef>return</span> [NSMutableArray arrayWithObjects:<span style=color:#e6db74>@&#34;addEventListener&#34;</span>,<span style=color:#e6db74>@&#34;removeAllEventListeners&#34;</span>, nil];
}

</code></pre></div><p>所有的模块都有addEventListener和removeAllEventListeners方法。第二个不同就是模块会遍历所有的同步和异步方法，(组件只会遍历异步方法)。最终返回生成模块的所有方法的字典。</p><p>以dom模块为例，它返回的字典如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

{
    dom <span style=color:#f92672>=</span>     (
        addEventListener,
        removeAllEventListeners,
        addEvent,
        removeElement,
        updateFinish,
        getComponentRect,
        scrollToElement,
        addRule,
        updateAttrs,
        addElement,
        createFinish,
        createBody,
        updateStyle,
        removeEvent,
        refreshFinish,
        moveElement
    );
}


</code></pre></div><p>最后一步也是在WXBridgeManager注册模块。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerModules:</span>(NSDictionary <span style=color:#f92672>*</span>)modules
{
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>modules) <span style=color:#66d9ef>return</span>;
    
    <span style=color:#66d9ef>__weak</span> <span style=color:#66d9ef>typeof</span>(self) weakSelf <span style=color:#f92672>=</span> self;
    WXPerformBlockOnBridgeThread(<span style=color:#f92672>^</span>(){
        [weakSelf.bridgeCtx registerModules:modules];
    });
}


</code></pre></div><p>这里注册过程和组件是完全一样的，也是在子线程@&ldquo;com.taobao.weex.bridge"的jsThread中操作的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerModules:</span>(NSDictionary <span style=color:#f92672>*</span>)modules
{
    WXAssertBridgeThread();
    <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span>modules) <span style=color:#66d9ef>return</span>;
    [self callJSMethod:<span style=color:#e6db74>@&#34;registerModules&#34;</span> args:<span style=color:#ae81ff>@[</span>modules<span style=color:#ae81ff>]</span>];
}


</code></pre></div><p>这里调用JS的方法名变为了@&ldquo;registerModules&rdquo;，入参args就是第二步产生的方法字典。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

    args <span style=color:#f92672>=</span>     (
                {
            dom <span style=color:#f92672>=</span>             (
                addEventListener,
                removeAllEventListeners,
                addEvent,
                removeElement,
                updateFinish,
                getComponentRect,
                scrollToElement,
                addRule,
                updateAttrs,
                addElement,
                createFinish,
                createBody,
                updateStyle,
                removeEvent,
                refreshFinish,
                moveElement
            );
        }
    )


</code></pre></div><p>同样，此时模块并不会真正的被注册上，因为JSFramework还没有加载完成，这里也会被添加进methodQueue缓存起来。</p><p>注册模块的全部流程如下：</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_18.png alt></p><p>最后是注册Handlers。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_19.png alt></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>


+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>_registerDefaultHandlers</span>
{
    [self registerHandler:[WXResourceRequestHandlerDefaultImpl new] withProtocol:@protocol(WXResourceRequestHandler)];
    [self registerHandler:[WXNavigationDefaultImpl new] withProtocol:@protocol(WXNavigationProtocol)];
    [self registerHandler:[WXURLRewriteDefaultImpl new] withProtocol:@protocol(WXURLRewriteProtocol)];
    [self registerHandler:[WXWebSocketDefaultImpl new] withProtocol:@protocol(WXWebSocketHandler)];

}

</code></pre></div><p>WXSDKEngine中默认注册4个Handler。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerHandler:</span>(<span style=color:#66d9ef>id</span>)handler <span style=color:#a6e22e>withProtocol:</span>(Protocol <span style=color:#f92672>*</span>)protocol
{
    WXAssert(handler <span style=color:#f92672>&amp;&amp;</span> protocol, <span style=color:#e6db74>@&#34;Fail to register the handler, please check if the parameters are correct ！&#34;</span>);
    
    [WXHandlerFactory registerHandler:handler withProtocol:protocol];
}


</code></pre></div><p>WXSDKEngine会继续调用WXHandlerFactory的registerHandler:withProtocol:方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXHandlerFactory</span> : <span style=color:#a6e22e>NSObject</span>
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) WXThreadSafeMutableDictionary <span style=color:#f92672>*</span>handlers;
+ (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerHandler:</span>(<span style=color:#66d9ef>id</span>)handler <span style=color:#a6e22e>withProtocol:</span>(Protocol <span style=color:#f92672>*</span>)protocol;
+ (<span style=color:#66d9ef>id</span>)<span style=color:#a6e22e>handlerForProtocol:</span>(Protocol <span style=color:#f92672>*</span>)protocol;
+ (NSDictionary <span style=color:#f92672>*</span>)<span style=color:#a6e22e>handlerConfigs</span>;
<span style=color:#66d9ef>@end</span>

</code></pre></div><p>WXHandlerFactory也是一个单例，里面有一个线程安全的字典handlers，用来保存实例和Protocol名的映射表。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_20.png alt></p><p>WXSDKEngine初始化的最后一步就是执行JSFramework。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
[[WXSDKManager bridgeMgr] executeJsFramework:script];

</code></pre></div><p>WXSDKManager会调用WXBridgeManager去执行SDK里面的main.js文件。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>executeJsFramework:</span>(NSString <span style=color:#f92672>*</span>)script
{
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>script) <span style=color:#66d9ef>return</span>;
    
    <span style=color:#66d9ef>__weak</span> <span style=color:#66d9ef>typeof</span>(self) weakSelf <span style=color:#f92672>=</span> self;
    WXPerformBlockOnBridgeThread(<span style=color:#f92672>^</span>(){
        [weakSelf.bridgeCtx executeJsFramework:script];
    });
}

</code></pre></div><p>WXBridgeManager通过WXBridgeContext调用executeJsFramework:方法。这里方法调用也是在子线程中进行的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>


- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>executeJsFramework:</span>(NSString <span style=color:#f92672>*</span>)script
{
    WXAssertBridgeThread();
    WXAssertParam(script);
    
    WX_MONITOR_PERF_START(WXPTFrameworkExecute);
    
    [self.jsBridge executeJSFramework:script];
    
    WX_MONITOR_PERF_END(WXPTFrameworkExecute);
    
    <span style=color:#66d9ef>if</span> ([self.jsBridge exception]) {
        NSString <span style=color:#f92672>*</span>message <span style=color:#f92672>=</span> [NSString stringWithFormat:<span style=color:#e6db74>@&#34;JSFramework executes error: %@&#34;</span>, [self.jsBridge exception]];
        WX_MONITOR_FAIL(WXMTJSFramework, WX_ERR_JSFRAMEWORK_EXECUTE, message);
    } <span style=color:#66d9ef>else</span> {
        WX_MONITOR_SUCCESS(WXMTJSFramework);
        <span style=color:#75715e>// 至此JSFramework算完全加载完成了
</span><span style=color:#75715e></span>        self.frameworkLoadFinished <span style=color:#f92672>=</span> YES;
        
        <span style=color:#75715e>// 执行所有注册的JsService
</span><span style=color:#75715e></span>        [self executeAllJsService];
        
         <span style=color:#75715e>// 获取JSFramework版本号
</span><span style=color:#75715e></span>        JSValue <span style=color:#f92672>*</span>frameworkVersion <span style=color:#f92672>=</span> [self.jsBridge callJSMethod:<span style=color:#e6db74>@&#34;getJSFMVersion&#34;</span> args:nil];
        <span style=color:#66d9ef>if</span> (frameworkVersion <span style=color:#f92672>&amp;&amp;</span> [frameworkVersion isString]) {
            <span style=color:#75715e>// 把版本号存入WXAppConfiguration中
</span><span style=color:#75715e></span>            [WXAppConfiguration setJSFrameworkVersion:[frameworkVersion toString]];
        }
        
        <span style=color:#75715e>// 执行之前缓存在_methodQueue数组里面的所有方法
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>for</span> (NSDictionary <span style=color:#f92672>*</span>method <span style=color:#66d9ef>in</span> _methodQueue) {
            [self callJSMethod:method[<span style=color:#e6db74>@&#34;method&#34;</span>] args:method[<span style=color:#e6db74>@&#34;args&#34;</span>]];
        }
        
        [_methodQueue removeAllObjects];
        
        <span style=color:#75715e>// 至此，初始化工作算完成了。
</span><span style=color:#75715e></span>        WX_MONITOR_PERF_END(WXPTInitalize);
    };
}


</code></pre></div><p>WX_MONITOR_PERF_START是在操作之前标记WXPTFrameworkExecute。执行完JSFramework以后，用WX_MONITOR_PERF_END标记执行完成。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>executeJSFramework:</span>(NSString <span style=color:#f92672>*</span>)frameworkScript
{
    WXAssertParam(frameworkScript);
    <span style=color:#66d9ef>if</span> (WX_SYS_VERSION_GREATER_THAN_OR_EQUAL_TO(<span style=color:#e6db74>@&#34;8.0&#34;</span>)) {
        [_jsContext evaluateScript:frameworkScript withSourceURL:[NSURL URLWithString:<span style=color:#e6db74>@&#34;main.js&#34;</span>]];
    }<span style=color:#66d9ef>else</span>{
        [_jsContext evaluateScript:frameworkScript];
    }
}


</code></pre></div><p>加载JSFramework的核心代码在这里，通过JSContext执行evaluateScript:来加载JSFramework。由于这里并没有返回值，所以加载的JSFramework的目的仅仅是声明了里面的所有方法，并没有调用。这也符合OC加载其他Framework的过程，加载只是加载到内存中，Framework里面的方法可以随时被调用，而不是一加载就调用其所有的方法。</p><p>加载完成JSFramework以后，就要开始加载之前缓存的JSService和JSMethod。JSService是在jsServiceQueue中缓存的。JSMethod是在methodQueue中缓存的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>executeAllJsService</span>
{
    <span style=color:#66d9ef>for</span>(NSDictionary <span style=color:#f92672>*</span>service <span style=color:#66d9ef>in</span> _jsServiceQueue) {
        NSString <span style=color:#f92672>*</span>script <span style=color:#f92672>=</span> [service valueForKey:<span style=color:#e6db74>@&#34;script&#34;</span>];
        NSString <span style=color:#f92672>*</span>name <span style=color:#f92672>=</span> [service valueForKey:<span style=color:#e6db74>@&#34;name&#34;</span>];
        [self executeJsService:script withName:name];
    }
    
    [_jsServiceQueue removeAllObjects];
}

</code></pre></div><p>JSService由于是直接js转成NSString，所以这里直接运行executeJsService:withName即可。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
   <span style=color:#66d9ef>for</span> (NSDictionary <span style=color:#f92672>*</span>method <span style=color:#66d9ef>in</span> _methodQueue) {
       [self callJSMethod:method[<span style=color:#e6db74>@&#34;method&#34;</span>] args:method[<span style=color:#e6db74>@&#34;args&#34;</span>]];
     }
        
    [_methodQueue removeAllObjects];

- (JSValue <span style=color:#f92672>*</span>)<span style=color:#a6e22e>callJSMethod:</span>(NSString <span style=color:#f92672>*</span>)method <span style=color:#a6e22e>args:</span>(NSArray <span style=color:#f92672>*</span>)args
{
    WXLogDebug(<span style=color:#e6db74>@&#34;Calling JS... method:%@, args:%@&#34;</span>, method, args);
    
    NSLog(<span style=color:#e6db74>@&#34;WXJSCoreBridge jsContext 正要调用方法&#34;</span>);
    
    <span style=color:#66d9ef>return</span> [[_jsContext globalObject] invokeMethod:method withArguments:args];
}


</code></pre></div><p>由于_methodQueue里面装的都是全局的js方法，所以需要调用invokeMethod: withArguments:去执行。</p><p>当这一切都加载完成，SDK的初始化工作就基本完成了，这里就会标记上WXPTInitalize结束。</p><p>这里还需要说明的是，jsBridge第一次是如何被加载进来的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>id</span><span style=color:#f92672>&lt;</span>WXBridgeProtocol<span style=color:#f92672>&gt;</span>)<span style=color:#a6e22e>jsBridge</span>
{
    WXAssertBridgeThread();
    _debugJS <span style=color:#f92672>=</span> [WXDebugTool isDevToolDebug];
    
    <span style=color:#66d9ef>Class</span> bridgeClass <span style=color:#f92672>=</span> _debugJS <span style=color:#f92672>?</span> NSClassFromString(<span style=color:#e6db74>@&#34;WXDebugger&#34;</span>) <span style=color:#f92672>:</span> [WXJSCoreBridge <span style=color:#66d9ef>class</span>];
    
    <span style=color:#66d9ef>if</span> (_jsBridge <span style=color:#f92672>&amp;&amp;</span> [_jsBridge isKindOfClass:bridgeClass]) {
        <span style=color:#66d9ef>return</span> _jsBridge;
    }
    
    <span style=color:#66d9ef>if</span> (_jsBridge) {
        [_methodQueue removeAllObjects];
        _frameworkLoadFinished <span style=color:#f92672>=</span> NO;
    }
    
    _jsBridge <span style=color:#f92672>=</span> _debugJS <span style=color:#f92672>?</span> [NSClassFromString(<span style=color:#e6db74>@&#34;WXDebugger&#34;</span>) alloc] <span style=color:#f92672>:</span> [[WXJSCoreBridge alloc] init];
    
    [self registerGlobalFunctions];
    
    <span style=color:#66d9ef>return</span> _jsBridge;
}

</code></pre></div><p>第一次进入这个函数没有jsBridge实例的时候，会先生成WXJSCoreBridge的实例，然后紧接着注册全局的函数。等第二次再调用这个函数的时候，_jsBridge已经是WXJSCoreBridge类型了，就会直接return，下面的语句也不会再重复执行了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>NSInteger</span>(<span style=color:#f92672>^</span>WXJSCallNative)(NSString <span style=color:#f92672>*</span>instance, NSArray <span style=color:#f92672>*</span>tasks, NSString <span style=color:#f92672>*</span>callback);
<span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>NSInteger</span>(<span style=color:#f92672>^</span>WXJSCallAddElement)(NSString <span style=color:#f92672>*</span>instanceId,  NSString <span style=color:#f92672>*</span>parentRef, NSDictionary <span style=color:#f92672>*</span>elementData, NSInteger index);
<span style=color:#66d9ef>typedef</span> NSInvocation <span style=color:#f92672>*</span>(<span style=color:#f92672>^</span>WXJSCallNativeModule)(NSString <span style=color:#f92672>*</span>instanceId, NSString <span style=color:#f92672>*</span>moduleName, NSString <span style=color:#f92672>*</span>methodName, NSArray <span style=color:#f92672>*</span>args, NSDictionary <span style=color:#f92672>*</span>options);
<span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>void</span> (<span style=color:#f92672>^</span>WXJSCallNativeComponent)(NSString <span style=color:#f92672>*</span>instanceId, NSString <span style=color:#f92672>*</span>componentRef, NSString <span style=color:#f92672>*</span>methodName, NSArray <span style=color:#f92672>*</span>args, NSDictionary <span style=color:#f92672>*</span>options);

</code></pre></div><p>这4个闭包就是OC封装暴露给JS的4个全局函数。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerCallNative:</span>(WXJSCallNative)callNative
{
    JSValue<span style=color:#f92672>*</span> (<span style=color:#f92672>^</span>callNativeBlock)(JSValue <span style=color:#f92672>*</span>, JSValue <span style=color:#f92672>*</span>, JSValue <span style=color:#f92672>*</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>JSValue<span style=color:#f92672>*</span>(JSValue <span style=color:#f92672>*</span>instance, JSValue <span style=color:#f92672>*</span>tasks, JSValue <span style=color:#f92672>*</span>callback){
        NSString <span style=color:#f92672>*</span>instanceId <span style=color:#f92672>=</span> [instance toString];
        NSArray <span style=color:#f92672>*</span>tasksArray <span style=color:#f92672>=</span> [tasks toArray];
        NSString <span style=color:#f92672>*</span>callbackId <span style=color:#f92672>=</span> [callback toString];
        
        WXLogDebug(<span style=color:#e6db74>@&#34;Calling native... instance:%@, tasks:%@, callback:%@&#34;</span>, instanceId, tasksArray, callbackId);
        <span style=color:#66d9ef>return</span> [JSValue valueWithInt32:(int32_t)callNative(instanceId, tasksArray, callbackId) inContext:[JSContext currentContext]];
    };
    
    _jsContext[<span style=color:#e6db74>@&#34;callNative&#34;</span>] <span style=color:#f92672>=</span> callNativeBlock;
}



</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerCallAddElement:</span>(WXJSCallAddElement)callAddElement
{   
    <span style=color:#66d9ef>id</span> callAddElementBlock <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(JSValue <span style=color:#f92672>*</span>instanceId, JSValue <span style=color:#f92672>*</span>ref, JSValue <span style=color:#f92672>*</span>element, JSValue <span style=color:#f92672>*</span>index, JSValue <span style=color:#f92672>*</span>ifCallback) {
        
        NSString <span style=color:#f92672>*</span>instanceIdString <span style=color:#f92672>=</span> [instanceId toString];
        NSDictionary <span style=color:#f92672>*</span>componentData <span style=color:#f92672>=</span> [element toDictionary];
        NSString <span style=color:#f92672>*</span>parentRef <span style=color:#f92672>=</span> [ref toString];
        NSInteger insertIndex <span style=color:#f92672>=</span> [[index toNumber] integerValue];
        
         WXLogDebug(<span style=color:#e6db74>@&#34;callAddElement...%@, %@, %@, %ld&#34;</span>, instanceIdString, parentRef, componentData, (<span style=color:#66d9ef>long</span>)insertIndex);
        
        <span style=color:#66d9ef>return</span> [JSValue valueWithInt32:(int32_t)callAddElement(instanceIdString, parentRef, componentData, insertIndex) inContext:[JSContext currentContext]];
    };

    _jsContext[<span style=color:#e6db74>@&#34;callAddElement&#34;</span>] <span style=color:#f92672>=</span> callAddElementBlock;
}


</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerCallNativeModule:</span>(WXJSCallNativeModule)callNativeModuleBlock
{   
    _jsContext[<span style=color:#e6db74>@&#34;callNativeModule&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>JSValue <span style=color:#f92672>*</span>(JSValue <span style=color:#f92672>*</span>instanceId, JSValue <span style=color:#f92672>*</span>moduleName, JSValue <span style=color:#f92672>*</span>methodName, JSValue <span style=color:#f92672>*</span>args, JSValue <span style=color:#f92672>*</span>options) {
        NSString <span style=color:#f92672>*</span>instanceIdString <span style=color:#f92672>=</span> [instanceId toString];
        NSString <span style=color:#f92672>*</span>moduleNameString <span style=color:#f92672>=</span> [moduleName toString];
        NSString <span style=color:#f92672>*</span>methodNameString <span style=color:#f92672>=</span> [methodName toString];
        NSArray <span style=color:#f92672>*</span>argsArray <span style=color:#f92672>=</span> [args toArray];
        NSDictionary <span style=color:#f92672>*</span>optionsDic <span style=color:#f92672>=</span> [options toDictionary];
        
        WXLogDebug(<span style=color:#e6db74>@&#34;callNativeModule...%@,%@,%@,%@&#34;</span>, instanceIdString, moduleNameString, methodNameString, argsArray);
        
        NSInvocation <span style=color:#f92672>*</span>invocation <span style=color:#f92672>=</span> callNativeModuleBlock(instanceIdString, moduleNameString, methodNameString, argsArray, optionsDic);
        JSValue <span style=color:#f92672>*</span>returnValue <span style=color:#f92672>=</span> [JSValue wx_valueWithReturnValueFromInvocation:invocation inContext:[JSContext currentContext]];
        <span style=color:#66d9ef>return</span> returnValue;
    };
}


</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>registerCallNativeComponent:</span>(WXJSCallNativeComponent)callNativeComponentBlock
{ 
    _jsContext[<span style=color:#e6db74>@&#34;callNativeComponent&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#f92672>^</span><span style=color:#66d9ef>void</span>(JSValue <span style=color:#f92672>*</span>instanceId, JSValue <span style=color:#f92672>*</span>componentName, JSValue <span style=color:#f92672>*</span>methodName, JSValue <span style=color:#f92672>*</span>args, JSValue <span style=color:#f92672>*</span>options) {
        NSString <span style=color:#f92672>*</span>instanceIdString <span style=color:#f92672>=</span> [instanceId toString];
        NSString <span style=color:#f92672>*</span>componentNameString <span style=color:#f92672>=</span> [componentName toString];
        NSString <span style=color:#f92672>*</span>methodNameString <span style=color:#f92672>=</span> [methodName toString];
        NSArray <span style=color:#f92672>*</span>argsArray <span style=color:#f92672>=</span> [args toArray];
        NSDictionary <span style=color:#f92672>*</span>optionsDic <span style=color:#f92672>=</span> [options toDictionary];
        
        WXLogDebug(<span style=color:#e6db74>@&#34;callNativeComponent...%@,%@,%@,%@&#34;</span>, instanceIdString, componentNameString, methodNameString, argsArray);
        
        callNativeComponentBlock(instanceIdString, componentNameString, methodNameString, argsArray, optionsDic);
    };
}


</code></pre></div><p>由于JS的方法的写法，多个参数是依次写在小括号里面的，和OC多个参数中间用：号隔开是不一样的，所有在暴露给JS的时候，需要把Block再包装一层。包装的4个方法如上，最后把这4个方法注入到JSContext中。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_21.png alt></p><p>如上图，灰色的就是OC本地传入的Block，外面在包一层，变成JS的方法，注入到JSContext中。</p><h4 id=4-模拟器wxsimulatorshortcutmanager连接本地调试工具>4. 模拟器WXSimulatorShortcutManager连接本地调试工具</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

<span style=color:#75715e>#if TARGET_OS_SIMULATOR
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>static</span> dispatch_once_t onceToken;
    dispatch_once(<span style=color:#f92672>&amp;</span>onceToken, <span style=color:#f92672>^</span>{
        [WXSimulatorShortcutManager registerSimulatorShortcutWithKey:<span style=color:#e6db74>@&#34;i&#34;</span> modifierFlags:UIKeyModifierCommand <span style=color:#f92672>|</span> UIKeyModifierAlternate action:<span style=color:#f92672>^</span>{
            NSURL <span style=color:#f92672>*</span>URL <span style=color:#f92672>=</span> [NSURL URLWithString:<span style=color:#e6db74>@&#34;http://localhost:8687/launchDebugger&#34;</span>];
            NSURLRequest <span style=color:#f92672>*</span>request <span style=color:#f92672>=</span> [NSURLRequest requestWithURL:URL];
            
            NSURLSession <span style=color:#f92672>*</span>session <span style=color:#f92672>=</span> [NSURLSession sharedSession];
            NSURLSessionDataTask <span style=color:#f92672>*</span>task <span style=color:#f92672>=</span> [session dataTaskWithRequest:request
                                                    completionHandler:
                                          <span style=color:#f92672>^</span>(NSData <span style=color:#f92672>*</span>data, NSURLResponse <span style=color:#f92672>*</span>response, NSError <span style=color:#f92672>*</span>error) {
                                              <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>                                          }];
            
            [task resume];
            WXLogInfo(<span style=color:#e6db74>@&#34;Launching browser...&#34;</span>);
            
            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> NSEC_PER_SEC)), dispatch_get_main_queue(), <span style=color:#f92672>^</span>{

                <span style=color:#75715e>// 连接websocket调试器
</span><span style=color:#75715e></span>                [self connectDebugServer:<span style=color:#e6db74>@&#34;ws://localhost:8687/debugger/0/renderer&#34;</span>];
            });
            
        }];
    });
<span style=color:#75715e>#endif
</span><span style=color:#75715e></span>

</code></pre></div><p>由于平时开发可能用到模拟器，那么调试的时候就会连接到本地的浏览器(Chrome，Safari)进行调试界面。这里就是在开启模拟的时候，启动浏览器，并且连接websocket调试器。</p><p>WXSDKEngine初始化的全部流程可以大概描述如下图：</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_22.png alt></p><h4 id=二-weex-是如何让js调起oc原生uiview的>（二）. Weex 是如何让JS调起OC原生UIView的？</h4><p>上一章节我们分析了WXSDKEngine是如何初始化的，那么初始化完成之后，iOS Native客户端是如何接收到JS的页面并调用OC生成UIView的呢？这一章节我们来分析分析。</p><p>在分析这个问题之前，先来看看AppStore上面Weex官方为我们提供的实例程序WeexPlayground的扫码功能是怎么实现扫描二维码就可以进入到一个页面的。</p><h4 id=1扫二维码的原理>1.扫二维码的原理</h4><p>首先看一下扫码界面的一些属性：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXScannerVC</span> : <span style=color:#a6e22e>UIViewController</span> <span style=color:#f92672>&lt;</span>AVCaptureMetadataOutputObjectsDelegate<span style=color:#f92672>&gt;</span>
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) AVCaptureSession <span style=color:#f92672>*</span> session;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) AVCaptureVideoPreviewLayer <span style=color:#f92672>*</span>captureLayer;
<span style=color:#66d9ef>@end</span>

</code></pre></div><p>这个页面没有额外的配置，就是一些调用摄像头的代理。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>captureOutput:</span>(AVCaptureOutput <span style=color:#f92672>*</span>)captureOutput <span style=color:#a6e22e>didOutputMetadataObjects:</span>(NSArray <span style=color:#f92672>*</span>)metadataObjects <span style=color:#a6e22e>fromConnection:</span>(AVCaptureConnection <span style=color:#f92672>*</span>)connection
{
    [_captureLayer removeFromSuperlayer];
    [_session stopRunning];
    AudioServicesPlaySystemSound(kSystemSoundID_Vibrate);
    <span style=color:#66d9ef>if</span> (metadataObjects.count <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
        AVMetadataMachineReadableCodeObject <span style=color:#f92672>*</span> metadataObject <span style=color:#f92672>=</span> [metadataObjects objectAtIndex : <span style=color:#ae81ff>0</span> ];
        [self openURL:metadataObject.stringValue];
    }
}


</code></pre></div><p>当扫描到二维码以后，代理会调用上面这个函数，扫描出来的URL就是metadataObject.stringValue。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>openURL:</span>(NSString<span style=color:#f92672>*</span>)URL
{
    NSString <span style=color:#f92672>*</span>transformURL <span style=color:#f92672>=</span> URL;
    NSArray<span style=color:#f92672>*</span> elts <span style=color:#f92672>=</span> [URL componentsSeparatedByString:<span style=color:#e6db74>@&#34;?&#34;</span>];
    <span style=color:#66d9ef>if</span> (elts.count <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>2</span>) {
        NSArray <span style=color:#f92672>*</span>urls <span style=color:#f92672>=</span> [elts.lastObject componentsSeparatedByString:<span style=color:#e6db74>@&#34;=&#34;</span>];
        <span style=color:#66d9ef>for</span> (NSString <span style=color:#f92672>*</span>param <span style=color:#66d9ef>in</span> urls) {
            <span style=color:#66d9ef>if</span> ([param isEqualToString:<span style=color:#e6db74>@&#34;_wx_tpl&#34;</span>]) {
                transformURL <span style=color:#f92672>=</span> [[urls lastObject]  stringByReplacingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
                <span style=color:#66d9ef>break</span>;
            }
        }
    }
    NSURL <span style=color:#f92672>*</span>url <span style=color:#f92672>=</span> [NSURL URLWithString:transformURL];
    <span style=color:#66d9ef>if</span> ([self remoteDebug:url]) {
        <span style=color:#66d9ef>return</span>;
    }
    [self jsReplace:url];
    WXDemoViewController <span style=color:#f92672>*</span> controller <span style=color:#f92672>=</span> [[WXDemoViewController alloc] init];
    controller.url <span style=color:#f92672>=</span> url;
    controller.source <span style=color:#f92672>=</span> <span style=color:#e6db74>@&#34;scan&#34;</span>;
    
    NSMutableDictionary <span style=color:#f92672>*</span>queryDict <span style=color:#f92672>=</span> [NSMutableDictionary new];
    <span style=color:#66d9ef>if</span> (WX_SYS_VERSION_GREATER_THAN_OR_EQUAL_TO(<span style=color:#e6db74>@&#34;8.0&#34;</span>)) {
        NSURLComponents <span style=color:#f92672>*</span>components <span style=color:#f92672>=</span> [NSURLComponents componentsWithURL:url resolvingAgainstBaseURL:NO];
        NSArray <span style=color:#f92672>*</span>queryItems <span style=color:#f92672>=</span> [components queryItems];
    
        <span style=color:#66d9ef>for</span> (NSURLQueryItem <span style=color:#f92672>*</span>item <span style=color:#66d9ef>in</span> queryItems)
            [queryDict setObject:item.value forKey:item.name];
    }<span style=color:#66d9ef>else</span> {
        queryDict <span style=color:#f92672>=</span> [self queryWithURL:url];
    }
    NSString <span style=color:#f92672>*</span>wsport <span style=color:#f92672>=</span> queryDict[<span style=color:#e6db74>@&#34;wsport&#34;</span>] <span style=color:#f92672>?:</span> <span style=color:#e6db74>@&#34;8082&#34;</span>;
    NSURL <span style=color:#f92672>*</span>socketURL <span style=color:#f92672>=</span> [NSURL URLWithString:[NSString stringWithFormat:<span style=color:#e6db74>@&#34;ws://%@:%@&#34;</span>, url.host, wsport]];
    controller.hotReloadSocket <span style=color:#f92672>=</span> [[SRWebSocket alloc] initWithURL:socketURL protocols:<span style=color:#ae81ff>@[</span><span style=color:#e6db74>@&#34;echo-protocol&#34;</span><span style=color:#ae81ff>]</span>];
    controller.hotReloadSocket.delegate <span style=color:#f92672>=</span> controller;
    [controller.hotReloadSocket open];
    
    [[self navigationController] pushViewController:controller animated:YES];
}


</code></pre></div><p>上面这段是完成的打开二维码页面的代码，里面包含判断URL的query参数的一些处理。稍微简化一下，简化成下面的样子：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>openURL:</span>(NSString<span style=color:#f92672>*</span>)URL
{
    <span style=color:#75715e>// 1.获取URL
</span><span style=color:#75715e></span>    NSString <span style=color:#f92672>*</span>transformURL <span style=color:#f92672>=</span> URL;
    NSURL <span style=color:#f92672>*</span>url <span style=color:#f92672>=</span> [NSURL URLWithString:transformURL];
    <span style=color:#75715e>// 2.配置新页面的url
</span><span style=color:#75715e></span>    WXDemoViewController <span style=color:#f92672>*</span> controller <span style=color:#f92672>=</span> [[WXDemoViewController alloc] init];
    controller.url <span style=color:#f92672>=</span> url;
    controller.source <span style=color:#f92672>=</span> <span style=color:#e6db74>@&#34;scan&#34;</span>;
    <span style=color:#75715e>// 3.连接websocket
</span><span style=color:#75715e></span>    NSString <span style=color:#f92672>*</span>wsport <span style=color:#f92672>=</span> queryDict[<span style=color:#e6db74>@&#34;wsport&#34;</span>] <span style=color:#f92672>?:</span> <span style=color:#e6db74>@&#34;8082&#34;</span>;
    NSURL <span style=color:#f92672>*</span>socketURL <span style=color:#f92672>=</span> [NSURL URLWithString:[NSString stringWithFormat:<span style=color:#e6db74>@&#34;ws://%@:%@&#34;</span>, url.host, wsport]];
    controller.hotReloadSocket <span style=color:#f92672>=</span> [[SRWebSocket alloc] initWithURL:socketURL protocols:<span style=color:#ae81ff>@[</span><span style=color:#e6db74>@&#34;echo-protocol&#34;</span><span style=color:#ae81ff>]</span>];
    controller.hotReloadSocket.delegate <span style=color:#f92672>=</span> controller;
    [controller.hotReloadSocket open];
    <span style=color:#75715e>// 4.页面跳转
</span><span style=color:#75715e></span>    [[self navigationController] pushViewController:controller animated:YES];
}


</code></pre></div><p>openURL：其实就干了上面注释说的4件事情。最重要的就是给新的界面配置了URL，至于连接websocket是为了更改.we文件或者.vue文件能及时的在手机上看见更改。最后一步就是页面跳转。所以扫描二维码能打开一个新的页面，原因只是给这个新的页面配置了一个URL，仅此而已。</p><h4 id=2js是如何调起oc原生view的>2.JS是如何调起OC原生View的</h4><p>再次回到我们的主题上来，JS究竟是如何调起OC原生View的？</p><p>所有的秘密都在WXSDKInstance这个类里面。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXSDKInstance</span> : <span style=color:#a6e22e>NSObject</span>

<span style=color:#75715e>// 当前需要渲染的viewController
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>weak</span>) UIViewController <span style=color:#f92672>*</span>viewController;
<span style=color:#75715e>// Native根容器的View是完全受WXSDKInstance控制，开发者无法更改
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) UIView <span style=color:#f92672>*</span>rootView;
<span style=color:#75715e>// 如果组件想固定rootview的frame，可以把这个属性设置为YES，当weex进行layout的时候，就不会改变rootview的frame了。反之设置为NO
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>assign</span>) <span style=color:#66d9ef>BOOL</span> isRootViewFrozen;
<span style=color:#75715e>// weex bundle的scriptURL
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSURL <span style=color:#f92672>*</span>scriptURL;
<span style=color:#75715e>// 父Instance
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>weak</span>) WXSDKInstance <span style=color:#f92672>*</span>parentInstance;
<span style=color:#75715e>// 父Instance节点的引用
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>weak</span>) NSString <span style=color:#f92672>*</span>parentNodeRef;
<span style=color:#75715e>// 用来标识当前weex instance独一无二的ID
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSString <span style=color:#f92672>*</span>instanceId;
<span style=color:#75715e>// 当前weex instance的状态
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>assign</span>) WXState state;
<span style=color:#75715e>// 当weex instance完成rootView的创建时的回调block
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>onCreate)(UIView <span style=color:#f92672>*</span>);
<span style=color:#75715e>// 根容器的frame改变时候的回调
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>onLayoutChange)(UIView <span style=color:#f92672>*</span>);
<span style=color:#75715e>// 当weex instance完成渲染时的回调block
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>renderFinish)(UIView <span style=color:#f92672>*</span>);
<span style=color:#75715e>// 当weex instance刷新完成时的回调block
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>refreshFinish)(UIView <span style=color:#f92672>*</span>);
<span style=color:#75715e>// 当weex instance渲染失败时的回调block
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>onFailed)(NSError <span style=color:#f92672>*</span>error);
<span style=color:#75715e>// 当weex instance页面滚动时的回调block
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>onScroll)(CGPoint contentOffset);
<span style=color:#75715e>// 当weex instance渲染进行中的回调block
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>onRenderProgress)(CGRect renderRect);
<span style=color:#75715e>// 当前weex instance的frame
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>assign</span>) CGRect frame;
<span style=color:#75715e>// user存储的一些Info信息
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSMutableDictionary <span style=color:#f92672>*</span>userInfo;
<span style=color:#75715e>// css单元和设备像素的换算比例因子
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>assign</span>, <span style=color:#66d9ef>readonly</span>) CGFloat pixelScaleFactor;
<span style=color:#75715e>// 是否监测组件的渲染
</span><span style=color:#75715e></span><span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>assign</span>)<span style=color:#66d9ef>BOOL</span> trackComponent;

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>renderWithURL:</span>(NSURL <span style=color:#f92672>*</span>)url;
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>renderWithURL:</span>(NSURL <span style=color:#f92672>*</span>)url <span style=color:#a6e22e>options:</span>(NSDictionary <span style=color:#f92672>*</span>)options <span style=color:#a6e22e>data:</span>(<span style=color:#66d9ef>id</span>)data;
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>renderView:</span>(NSString <span style=color:#f92672>*</span>)source <span style=color:#a6e22e>options:</span>(NSDictionary <span style=color:#f92672>*</span>)options <span style=color:#a6e22e>data:</span>(<span style=color:#66d9ef>id</span>)data;
<span style=color:#75715e>// forcedReload为YES，每次加载都会从URL重新读取，为NO，会从缓存中读取
</span><span style=color:#75715e></span>- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>reload:</span>(<span style=color:#66d9ef>BOOL</span>)forcedReload;
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>refreshInstance:</span>(<span style=color:#66d9ef>id</span>)data;
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>destroyInstance</span>;
- (<span style=color:#66d9ef>id</span>)<span style=color:#a6e22e>moduleForClass:</span>(<span style=color:#66d9ef>Class</span>)moduleClass;
- (WXComponent <span style=color:#f92672>*</span>)<span style=color:#a6e22e>componentForRef:</span>(NSString <span style=color:#f92672>*</span>)ref;
- (NSUInteger)<span style=color:#a6e22e>numberOfComponents</span>;
- (<span style=color:#66d9ef>BOOL</span>)<span style=color:#a6e22e>checkModuleEventRegistered:</span>(NSString<span style=color:#f92672>*</span>)event <span style=color:#a6e22e>moduleClassName:</span>(NSString<span style=color:#f92672>*</span>)moduleClassName;
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>fireModuleEvent:</span>(<span style=color:#66d9ef>Class</span>)module <span style=color:#a6e22e>eventName:</span>(NSString <span style=color:#f92672>*</span>)eventName <span style=color:#a6e22e>params:</span>(NSDictionary<span style=color:#f92672>*</span>)params;
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>fireGlobalEvent:</span>(NSString <span style=color:#f92672>*</span>)eventName <span style=color:#a6e22e>params:</span>(NSDictionary <span style=color:#f92672>*</span>)params;
- (NSURL <span style=color:#f92672>*</span>)<span style=color:#a6e22e>completeURL:</span>(NSString <span style=color:#f92672>*</span>)url;

<span style=color:#66d9ef>@end</span>

</code></pre></div><p>一个WXSDKInstance就对应一个UIViewController，所以每个Weex的页面都有一个与之对应的WXSDKInstance。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) WXSDKInstance <span style=color:#f92672>*</span>instance;

</code></pre></div><p>WXSDKInstance主要用来渲染页面，一般通过调用renderWithURL方法。</p><p>一个Weex界面的主动渲染的过程如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>render</span>
{
    CGFloat width <span style=color:#f92672>=</span> self.view.frame.size.width;
    [_instance destroyInstance];
    _instance <span style=color:#f92672>=</span> [[WXSDKInstance alloc] init];
    _instance.viewController <span style=color:#f92672>=</span> self;
    _instance.frame <span style=color:#f92672>=</span> CGRectMake(self.view.frame.size.width<span style=color:#f92672>-</span>width, <span style=color:#ae81ff>0</span>, width, _weexHeight);
    
    <span style=color:#66d9ef>__weak</span> <span style=color:#66d9ef>typeof</span>(self) weakSelf <span style=color:#f92672>=</span> self;
    _instance.onCreate <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(UIView <span style=color:#f92672>*</span>view) {
        [weakSelf.weexView removeFromSuperview];
        weakSelf.weexView <span style=color:#f92672>=</span> view;
        [weakSelf.view addSubview:weakSelf.weexView];
        UIAccessibilityPostNotification(UIAccessibilityScreenChangedNotification, weakSelf.weexView);
    };
    _instance.onFailed <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(NSError <span style=color:#f92672>*</span>error) {
      
    };
    
    _instance.renderFinish <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(UIView <span style=color:#f92672>*</span>view) {
        [weakSelf updateInstanceState:WeexInstanceAppear];
    };
    
    _instance.updateFinish <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(UIView <span style=color:#f92672>*</span>view) {

    };

    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>self.url) {
        WXLogError(<span style=color:#e6db74>@&#34;error: render url is nil&#34;</span>);
        <span style=color:#66d9ef>return</span>;
    }
    NSURL <span style=color:#f92672>*</span>URL <span style=color:#f92672>=</span> [self testURL: [self.url absoluteString]];
    NSString <span style=color:#f92672>*</span>randomURL <span style=color:#f92672>=</span> [NSString stringWithFormat:<span style=color:#e6db74>@&#34;%@%@random=%d&#34;</span>,URL.absoluteString,URL.query<span style=color:#f92672>?</span><span style=color:#e6db74>@&#34;&amp;&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>@&#34;?&#34;</span>,arc4random()];
    [_instance renderWithURL:[NSURL URLWithString:randomURL] options:<span style=color:#ae81ff>@{</span><span style=color:#e6db74>@&#34;bundleUrl&#34;</span><span style=color:#f92672>:</span>URL.absoluteString<span style=color:#ae81ff>}</span> data:nil];
}


</code></pre></div><p>由于WXSDKInstance是支持实时刷新，所以在创建的时候需要先销毁掉原来的，再创建一个新的。</p><p>WXSDKInstance支持设置各种状态时候的回调callback函数，具体支持哪些状态，可以看上面WXSDKInstance的定义。</p><p>Weex支持从本地加载JS，也支持从服务器加载JS。如果从本地加载，那么可以用下面的方法，从本地加载一个JSBundle。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>loadLocalBundle:</span>(NSURL <span style=color:#f92672>*</span>)url
{
    NSURL <span style=color:#f92672>*</span> localPath <span style=color:#f92672>=</span> nil;
    NSMutableArray <span style=color:#f92672>*</span> pathComponents <span style=color:#f92672>=</span> nil;
    <span style=color:#66d9ef>if</span> (self.url) {
        pathComponents <span style=color:#f92672>=</span>[NSMutableArray arrayWithArray:[url.absoluteString pathComponents]];
        [pathComponents removeObjectsInRange:NSRangeFromString(<span style=color:#e6db74>@&#34;0 3&#34;</span>)];
        [pathComponents replaceObjectAtIndex:<span style=color:#ae81ff>0</span> withObject:<span style=color:#e6db74>@&#34;bundlejs&#34;</span>];
        
        NSString <span style=color:#f92672>*</span>filePath <span style=color:#f92672>=</span> [NSString stringWithFormat:<span style=color:#e6db74>@&#34;%@/%@&#34;</span>,[NSBundle mainBundle].bundlePath,[pathComponents componentsJoinedByString:<span style=color:#e6db74>@&#34;/&#34;</span>]];
        localPath <span style=color:#f92672>=</span> [NSURL fileURLWithPath:filePath];
    }<span style=color:#66d9ef>else</span> {
        NSString <span style=color:#f92672>*</span>filePath <span style=color:#f92672>=</span> [NSString stringWithFormat:<span style=color:#e6db74>@&#34;%@/bundlejs/index.js&#34;</span>,[NSBundle mainBundle].bundlePath];
        localPath <span style=color:#f92672>=</span> [NSURL fileURLWithPath:filePath];
    }
    
    NSString <span style=color:#f92672>*</span>bundleUrl <span style=color:#f92672>=</span> [NSURL fileURLWithPath:[NSString stringWithFormat:<span style=color:#e6db74>@&#34;%@/bundlejs/&#34;</span>,[NSBundle mainBundle].bundlePath]].absoluteString;
     [_instance renderWithURL:localPath options:<span style=color:#ae81ff>@{</span><span style=color:#e6db74>@&#34;bundleUrl&#34;</span><span style=color:#f92672>:</span>bundleUrl<span style=color:#ae81ff>}</span> data:nil];
}

</code></pre></div><p>最后渲染页面就是通过调用renderWithURL:options:data:做到的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>renderWithURL:</span>(NSURL <span style=color:#f92672>*</span>)url <span style=color:#a6e22e>options:</span>(NSDictionary <span style=color:#f92672>*</span>)options <span style=color:#a6e22e>data:</span>(<span style=color:#66d9ef>id</span>)data
{
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>url) {
        WXLogError(<span style=color:#e6db74>@&#34;Url must be passed if you use renderWithURL&#34;</span>);
        <span style=color:#66d9ef>return</span>;
    }
    
    WXResourceRequest <span style=color:#f92672>*</span>request <span style=color:#f92672>=</span> [WXResourceRequest requestWithURL:url resourceType:WXResourceTypeMainBundle referrer:<span style=color:#e6db74>@&#34;&#34;</span> cachePolicy:NSURLRequestUseProtocolCachePolicy];
    [self _renderWithRequest:request options:options data:data];
}


</code></pre></div><p>在WXSDKInstance调用renderWithURL:options:data:方法的时候，会生成一个WXResourceRequest。NSMutableURLRequest定义如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXResourceRequest</span> : <span style=color:#a6e22e>NSMutableURLRequest</span>
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) <span style=color:#66d9ef>id</span> taskIdentifier;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>assign</span>) WXResourceType type;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSString <span style=color:#f92672>*</span>referrer;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) NSString <span style=color:#f92672>*</span>userAgent;
<span style=color:#66d9ef>@end</span>


</code></pre></div><p>WXResourceRequest其实也就是对NSMutableURLRequest的一层封装。</p><p>下面来分析一下最核心的函数renderWithURL:options:data:（以下的代码实现在源码的基础上略有删减，源码太长，删减以后并不影响阅读）</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>


- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>_renderWithRequest:</span>(WXResourceRequest <span style=color:#f92672>*</span>)request <span style=color:#a6e22e>options:</span>(NSDictionary <span style=color:#f92672>*</span>)options <span style=color:#a6e22e>data:</span>(<span style=color:#66d9ef>id</span>)data;
{
    NSURL <span style=color:#f92672>*</span>url <span style=color:#f92672>=</span> request.URL;
    _scriptURL <span style=color:#f92672>=</span> url;
    _options <span style=color:#f92672>=</span> options;
    _jsData <span style=color:#f92672>=</span> data;
    NSMutableDictionary <span style=color:#f92672>*</span>newOptions <span style=color:#f92672>=</span> [options mutableCopy] <span style=color:#f92672>?:</span> [NSMutableDictionary new];
    
    WX_MONITOR_INSTANCE_PERF_START(WXPTJSDownload, self);
    <span style=color:#66d9ef>__weak</span> <span style=color:#a6e22e>typeof</span>(self) weakSelf <span style=color:#f92672>=</span> self;
    _mainBundleLoader <span style=color:#f92672>=</span> [[WXResourceLoader alloc] initWithRequest:request];

      <span style=color:#75715e>// 请求完成的回调
</span><span style=color:#75715e></span>    _mainBundleLoader.onFinished <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(WXResourceResponse <span style=color:#f92672>*</span>response, NSData <span style=color:#f92672>*</span>data) {
        <span style=color:#66d9ef>__strong</span> <span style=color:#66d9ef>typeof</span>(weakSelf) strongSelf <span style=color:#f92672>=</span> weakSelf;
        
        <span style=color:#66d9ef>if</span> ([response isKindOfClass:[NSHTTPURLResponse <span style=color:#66d9ef>class</span>]] <span style=color:#f92672>&amp;&amp;</span> ((NSHTTPURLResponse <span style=color:#f92672>*</span>)response).statusCode <span style=color:#f92672>!=</span> <span style=color:#ae81ff>200</span>) {
            NSError <span style=color:#f92672>*</span>error <span style=color:#f92672>=</span> [NSError errorWithDomain:WX_ERROR_DOMAIN
                                                 code:((NSHTTPURLResponse <span style=color:#f92672>*</span>)response).statusCode
                                             userInfo:<span style=color:#ae81ff>@{</span><span style=color:#e6db74>@&#34;message&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>@&#34;status code error.&#34;</span><span style=color:#ae81ff>}</span>];
            <span style=color:#66d9ef>if</span> (strongSelf.onFailed) {
                strongSelf.onFailed(error);
            }
            <span style=color:#66d9ef>return</span> ;
        }
        
        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>data) {
            
            <span style=color:#66d9ef>if</span> (strongSelf.onFailed) {
                strongSelf.onFailed(error);
            }
            <span style=color:#66d9ef>return</span>;
        }
        
        NSString <span style=color:#f92672>*</span>jsBundleString <span style=color:#f92672>=</span> [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
        
        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>jsBundleString) {
            <span style=color:#66d9ef>return</span>;
        }
        
        [strongSelf _renderWithMainBundleString:jsBundleString];
    };
    
    <span style=color:#75715e>// 请求失败的回调
</span><span style=color:#75715e></span>    _mainBundleLoader.onFailed <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(NSError <span style=color:#f92672>*</span>loadError) {

        <span style=color:#66d9ef>if</span> (weakSelf.onFailed) {
            weakSelf.onFailed(loadError);
        }
    };
    
    [_mainBundleLoader start];
}



</code></pre></div><p>上面代码只要就是干了2件事情，第一步，生成了WXResourceLoader，并设置了它的onFinished和onFailed回调。第二步调用了start方法。</p><p>在WXSDKInstance中强持有了一个WXResourceLoader，WXResourceLoader的定义如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>@interface</span> <span style=color:#a6e22e>WXResourceLoader</span> : <span style=color:#a6e22e>NSObject</span>

<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>strong</span>) WXResourceRequest <span style=color:#f92672>*</span>request;
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>onDataSent)(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>long</span> <span style=color:#75715e>/* bytesSent */</span>, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>long</span> <span style=color:#75715e>/* totalBytesToBeSent */</span>);
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>onResponseReceived)(<span style=color:#66d9ef>const</span> WXResourceResponse <span style=color:#f92672>*</span>);
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>onDataReceived)(NSData <span style=color:#f92672>*</span>);
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>onFinished)(<span style=color:#66d9ef>const</span> WXResourceResponse <span style=color:#f92672>*</span>, NSData <span style=color:#f92672>*</span>);
<span style=color:#66d9ef>@property</span> (<span style=color:#66d9ef>nonatomic</span>, <span style=color:#66d9ef>copy</span>) <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>onFailed)(NSError <span style=color:#f92672>*</span>);

- (<span style=color:#66d9ef>instancetype</span>)<span style=color:#a6e22e>initWithRequest:</span>(WXResourceRequest <span style=color:#f92672>*</span>)request;
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>start</span>;
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>cancel:</span>(NSError <span style=color:#f92672>**</span>)error;
<span style=color:#66d9ef>@end</span>


</code></pre></div><p>WXResourceLoader里面含有一个WXResourceRequest，所以WXResourceRequest也可以看出对网络请求的封装，并且提供了5种不同状态的callback回调函数。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>start</span>
{
    <span style=color:#66d9ef>if</span> ([_request.URL isFileURL]) {
        [self _handleFileURL:_request.URL];
        <span style=color:#66d9ef>return</span>;
    }
    
    <span style=color:#66d9ef>id</span><span style=color:#f92672>&lt;</span>WXResourceRequestHandler<span style=color:#f92672>&gt;</span> requestHandler <span style=color:#f92672>=</span> [WXHandlerFactory handlerForProtocol:@protocol(WXResourceRequestHandler)];
    <span style=color:#66d9ef>if</span> (requestHandler) {
        [requestHandler sendRequest:_request withDelegate:self];
    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> ([WXHandlerFactory handlerForProtocol:NSProtocolFromString(<span style=color:#e6db74>@&#34;WXNetworkProtocol&#34;</span>)]){
        <span style=color:#75715e>// deprecated logic
</span><span style=color:#75715e></span>        [self _handleDEPRECATEDNetworkHandler];
    } <span style=color:#66d9ef>else</span> {
        WXLogError(<span style=color:#e6db74>@&#34;No resource request handler found!&#34;</span>);
    }
}

</code></pre></div><p>在调用了WXResourceLoader的start方法以后，会先判断是不是本地的url，如果是本地的文件，那么就直接开始加载。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>_handleFileURL:</span>(NSURL <span style=color:#f92672>*</span>)url
{
    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span style=color:#ae81ff>0</span>), <span style=color:#f92672>^</span>{
        NSData <span style=color:#f92672>*</span>fileData <span style=color:#f92672>=</span> [[NSFileManager defaultManager] contentsAtPath:[url path]];
        <span style=color:#66d9ef>if</span> (self.onFinished) {
            self.onFinished([WXResourceResponse new], fileData);
        }
    });
}

</code></pre></div><p>本地文件就直接回调onFinished函数。</p><p>如果不是本地的文件，就开始发起网络请求，请求服务器端的js文件。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>sendRequest:</span>(WXResourceRequest <span style=color:#f92672>*</span>)request <span style=color:#a6e22e>withDelegate:</span>(<span style=color:#66d9ef>id</span><span style=color:#f92672>&lt;</span>WXResourceRequestDelegate<span style=color:#f92672>&gt;</span>)delegate
{
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>_session) {
        NSURLSessionConfiguration <span style=color:#f92672>*</span>urlSessionConfig <span style=color:#f92672>=</span> [NSURLSessionConfiguration defaultSessionConfiguration];
        <span style=color:#66d9ef>if</span> ([WXAppConfiguration customizeProtocolClasses].count <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
            NSArray <span style=color:#f92672>*</span>defaultProtocols <span style=color:#f92672>=</span> urlSessionConfig.protocolClasses;
            urlSessionConfig.protocolClasses <span style=color:#f92672>=</span> [[WXAppConfiguration customizeProtocolClasses] arrayByAddingObjectsFromArray:defaultProtocols];
        }
        _session <span style=color:#f92672>=</span> [NSURLSession sessionWithConfiguration:urlSessionConfig
                                                 delegate:self
                                            delegateQueue:[NSOperationQueue mainQueue]];
        _delegates <span style=color:#f92672>=</span> [WXThreadSafeMutableDictionary new];
    }
    
    NSURLSessionDataTask <span style=color:#f92672>*</span>task <span style=color:#f92672>=</span> [_session dataTaskWithRequest:request];
    request.taskIdentifier <span style=color:#f92672>=</span> task;
    [_delegates setObject:delegate forKey:task];
    [task resume];
}

</code></pre></div><p>这里的网络请求就是普通的正常的NSURLSession网络请求。</p><p>如果成功，最终都会执行onFinished的回调函数。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
_mainBundleLoader.onFinished <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>(WXResourceResponse <span style=color:#f92672>*</span>response, NSData <span style=color:#f92672>*</span>data) {
        <span style=color:#66d9ef>__strong</span> <span style=color:#66d9ef>typeof</span>(weakSelf) strongSelf <span style=color:#f92672>=</span> weakSelf;
        
        <span style=color:#66d9ef>if</span> ([response isKindOfClass:[NSHTTPURLResponse <span style=color:#66d9ef>class</span>]] <span style=color:#f92672>&amp;&amp;</span> ((NSHTTPURLResponse <span style=color:#f92672>*</span>)response).statusCode <span style=color:#f92672>!=</span> <span style=color:#ae81ff>200</span>) {
            NSError <span style=color:#f92672>*</span>error <span style=color:#f92672>=</span> [NSError errorWithDomain:WX_ERROR_DOMAIN
                                        code:((NSHTTPURLResponse <span style=color:#f92672>*</span>)response).statusCode
                                    userInfo:<span style=color:#ae81ff>@{</span><span style=color:#e6db74>@&#34;message&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>@&#34;status code error.&#34;</span><span style=color:#ae81ff>}</span>];
            <span style=color:#66d9ef>if</span> (strongSelf.onFailed) {
                strongSelf.onFailed(error);
            }
            <span style=color:#66d9ef>return</span> ;
        }

        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>data) {
            NSString <span style=color:#f92672>*</span>errorMessage <span style=color:#f92672>=</span> [NSString stringWithFormat:<span style=color:#e6db74>@&#34;Request to %@ With no data return&#34;</span>, request.URL];
            WX_MONITOR_FAIL_ON_PAGE(WXMTJSDownload, WX_ERR_JSBUNDLE_DOWNLOAD, errorMessage, strongSelf.pageName);

            <span style=color:#66d9ef>if</span> (strongSelf.onFailed) {
                strongSelf.onFailed(error);
            }
            <span style=color:#66d9ef>return</span>;
        }
        
        NSString <span style=color:#f92672>*</span>jsBundleString <span style=color:#f92672>=</span> [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
        
        
        NSLog(<span style=color:#e6db74>@&#34;下载下来的 jsBundleString = %@&#34;</span>,jsBundleString);
        
        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>jsBundleString) {
            WX_MONITOR_FAIL_ON_PAGE(WXMTJSDownload, WX_ERR_JSBUNDLE_STRING_CONVERT, <span style=color:#e6db74>@&#34;data converting to string failed.&#34;</span>, strongSelf.pageName)
            <span style=color:#66d9ef>return</span>;
        }

        WX_MONITOR_SUCCESS_ON_PAGE(WXMTJSDownload, strongSelf.pageName);
        WX_MONITOR_INSTANCE_PERF_END(WXPTJSDownload, strongSelf);

        [strongSelf _renderWithMainBundleString:jsBundleString];
    };


</code></pre></div><p>在onFinished的回调中，还会有3种错误判断，status code error，no data return，data converting to string failed。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
NSString <span style=color:#f92672>*</span>jsBundleString <span style=color:#f92672>=</span> [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
[strongSelf _renderWithMainBundleString:jsBundleString];

</code></pre></div><p>如果一切正常，那么在onFinished的回调中其实就是拿到jsBundleString，并执行渲染操作。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>_renderWithMainBundleString:</span>(NSString <span style=color:#f92672>*</span>)mainBundleString
{
<span style=color:#75715e>//以下代码有删减，去除了一些错误判断，但是不影响阅读
</span><span style=color:#75715e></span>    
    NSMutableDictionary <span style=color:#f92672>*</span>dictionary <span style=color:#f92672>=</span> [_options mutableCopy];
    
    <span style=color:#75715e>//生成WXRootView
</span><span style=color:#75715e></span>    WXPerformBlockOnMainThread(<span style=color:#f92672>^</span>{
        _rootView <span style=color:#f92672>=</span> [[WXRootView alloc] initWithFrame:self.frame];
        _rootView.instance <span style=color:#f92672>=</span> self;
        <span style=color:#66d9ef>if</span>(self.onCreate) {
            self.onCreate(_rootView);
        }
    });
    
    <span style=color:#75715e>// 再次注册默认的模块modules、组件components、handlers，以确保在创建instance之前它们都被注册了
</span><span style=color:#75715e></span>    [WXSDKEngine registerDefaults];
    
    <span style=color:#75715e>// 开始createInstance
</span><span style=color:#75715e></span>    [[WXSDKManager bridgeMgr] createInstance:self.instanceId template:mainBundleString options:dictionary data:_jsData];
    
}


</code></pre></div><p>这里WXSDKEngine还会重新再次注册一遍模块modules、组件components、handlers，以确保在创建instance之前它们都被注册了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>createInstance:</span>(NSString <span style=color:#f92672>*</span>)instance
              <span style=color:#a6e22e>template:</span>(NSString <span style=color:#f92672>*</span>)temp
               <span style=color:#a6e22e>options:</span>(NSDictionary <span style=color:#f92672>*</span>)options
                  <span style=color:#a6e22e>data:</span>(<span style=color:#66d9ef>id</span>)data
{
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>instance <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>temp) <span style=color:#66d9ef>return</span>;
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>[self.instanceIdStack containsObject:instance]) {
        <span style=color:#66d9ef>if</span> ([options[<span style=color:#e6db74>@&#34;RENDER_IN_ORDER&#34;</span>] boolValue]) {
            [self.instanceIdStack addObject:instance];
        } <span style=color:#66d9ef>else</span> {
            [self.instanceIdStack insertObject:instance atIndex:<span style=color:#ae81ff>0</span>];
        }
    }
    <span style=color:#66d9ef>__weak</span> <span style=color:#66d9ef>typeof</span>(self) weakSelf <span style=color:#f92672>=</span> self;
    WXPerformBlockOnBridgeThread(<span style=color:#f92672>^</span>(){     
        [weakSelf.bridgeCtx createInstance:instance
                                  template:temp
                                   options:options
                                      data:data];
    });
}


</code></pre></div><p>WXSDKManager中会调用createInstance:template:options:data:方法，这个方法也必须在JSThread中执行。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
- (<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>createInstance:</span>(NSString <span style=color:#f92672>*</span>)instance
              <span style=color:#a6e22e>template:</span>(NSString <span style=color:#f92672>*</span>)temp
               <span style=color:#a6e22e>options:</span>(NSDictionary <span style=color:#f92672>*</span>)options
                  <span style=color:#a6e22e>data:</span>(<span style=color:#66d9ef>id</span>)data
{
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>[self.insStack containsObject:instance]) {
        <span style=color:#66d9ef>if</span> ([options[<span style=color:#e6db74>@&#34;RENDER_IN_ORDER&#34;</span>] boolValue]) {
            [self.insStack addObject:instance];
        } <span style=color:#66d9ef>else</span> {
            [self.insStack insertObject:instance atIndex:<span style=color:#ae81ff>0</span>];
        }
    }
    
    <span style=color:#75715e>//create a sendQueue bind to the current instance
</span><span style=color:#75715e></span>    NSMutableArray <span style=color:#f92672>*</span>sendQueue <span style=color:#f92672>=</span> [NSMutableArray array];
    [self.sendQueue setValue:sendQueue forKey:instance];
    
    NSArray <span style=color:#f92672>*</span>args <span style=color:#f92672>=</span> nil;
    <span style=color:#66d9ef>if</span> (data){
        args <span style=color:#f92672>=</span> <span style=color:#ae81ff>@[</span>instance, temp, options <span style=color:#f92672>?:</span> <span style=color:#ae81ff>@{}</span>, data<span style=color:#ae81ff>]</span>;
    } <span style=color:#66d9ef>else</span> {
        args <span style=color:#f92672>=</span> <span style=color:#ae81ff>@[</span>instance, temp, options <span style=color:#f92672>?:</span> <span style=color:#ae81ff>@{}]</span>;
    }
    
    [self callJSMethod:<span style=color:#e6db74>@&#34;createInstance&#34;</span> args:args];
}


</code></pre></div><p>最终还是WXJSCoreBridge里面的JSContext调用</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
[[_jsContext globalObject] invokeMethod:method withArguments:args];

</code></pre></div><p>调用JS的"createInstance"方法。从此处开始，就开始和JSFramework进行相互调用了。</p><p>在举例之前，我们先把前面的流程画图总结一下：</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_23.png alt></p><p>接下来用一个例子来说明JS是如何调用起OC原生的View的。</p><p>先用JS写一个页面：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>

<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>template</span><span style=color:#f92672>&gt;</span>
    <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>div</span> <span style=color:#66d9ef>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;container&#34;</span><span style=color:#f92672>&gt;</span>
        <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>image</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://9.pic.paopaoche.net/up/2016-7/201671315341.png&#34;</span> <span style=color:#66d9ef>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;pic&#34;</span> <span style=color:#a6e22e>onclick</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;picClick&#34;</span><span style=color:#f92672>&gt;&lt;</span><span style=color:#960050;background-color:#1e0010>/image&gt;</span>
        <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>text</span> <span style=color:#66d9ef>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span><span style=color:#f92672>&gt;</span>{{<span style=color:#a6e22e>title</span>}}<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/text&gt;</span>
    <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/div&gt;</span>
<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/template&gt;</span>

<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>style</span><span style=color:#f92672>&gt;</span>

    .<span style=color:#a6e22e>container</span>{
        <span style=color:#a6e22e>align</span><span style=color:#f92672>-</span><span style=color:#a6e22e>items</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>center</span>;
    }
    .<span style=color:#a6e22e>pic</span>{
        <span style=color:#a6e22e>width</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span><span style=color:#a6e22e>px</span>;
        <span style=color:#a6e22e>height</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span><span style=color:#a6e22e>px</span>;
    }
    .<span style=color:#a6e22e>text</span>{
        <span style=color:#a6e22e>font</span><span style=color:#f92672>-</span><span style=color:#a6e22e>size</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>40</span><span style=color:#a6e22e>px</span>;
        <span style=color:#a6e22e>color</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>black</span>;
    }

<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/style&gt;</span>

<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>script</span><span style=color:#f92672>&gt;</span>
    <span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
        <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span>{
            <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;Hello World&#39;</span>,
            <span style=color:#a6e22e>toggle</span><span style=color:#f92672>:</span><span style=color:#66d9ef>false</span>,
        },
        <span style=color:#a6e22e>ready</span><span style=color:#f92672>:</span><span style=color:#66d9ef>function</span>(){
            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;this.title == &#39;</span><span style=color:#f92672>+</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>title</span>);
            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>title</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;hello Weex&#39;</span>;
            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;this.title == &#39;</span><span style=color:#f92672>+</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>title</span>);
        },
        <span style=color:#a6e22e>methods</span><span style=color:#f92672>:</span>{
            <span style=color:#a6e22e>picClick</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> () {
                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>toggle</span> <span style=color:#f92672>=</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>toggle</span>;
                <span style=color:#66d9ef>if</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>toggle</span>){
                    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>title</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;图片被点击&#39;</span>;
                }<span style=color:#66d9ef>else</span>{
                    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>title</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Hello Weex&#39;</span>;
                }

            }
        }
    }
<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/script&gt;</span>




</code></pre></div><p>这个页面跑起来长下面这个样子：</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_24.png alt></p><p>上面是我的.we源文件，经过Weex编译以后，就变成了index.js，里面的代码如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>

<span style=color:#75715e>// { &#34;framework&#34;: &#34;Weex&#34; }
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> (<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>modules</span>) { <span style=color:#75715e>// webpackBootstrap
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 	<span style=color:#75715e>// The module cache
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>installedModules</span> <span style=color:#f92672>=</span> {};

<span style=color:#75715e>/******/</span> 	<span style=color:#75715e>// The require function
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 	<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>__webpack_require__</span>(<span style=color:#a6e22e>moduleId</span>) {

<span style=color:#75715e>/******/</span> 		<span style=color:#75715e>// Check if module is in cache
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 		<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>installedModules</span>[<span style=color:#a6e22e>moduleId</span>])
<span style=color:#75715e>/******/</span> 			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>installedModules</span>[<span style=color:#a6e22e>moduleId</span>].<span style=color:#a6e22e>exports</span>;

<span style=color:#75715e>/******/</span> 		<span style=color:#75715e>// Create a new module (and put it into the cache)
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>module</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>installedModules</span>[<span style=color:#a6e22e>moduleId</span>] <span style=color:#f92672>=</span> {
<span style=color:#75715e>/******/</span> 			<span style=color:#a6e22e>exports</span><span style=color:#f92672>:</span> {},
<span style=color:#75715e>/******/</span> 			<span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>moduleId</span>,
<span style=color:#75715e>/******/</span> 			<span style=color:#a6e22e>loaded</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>
<span style=color:#75715e>/******/</span> 		};

<span style=color:#75715e>/******/</span> 		<span style=color:#75715e>// Execute the module function
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 		<span style=color:#a6e22e>modules</span>[<span style=color:#a6e22e>moduleId</span>].<span style=color:#a6e22e>call</span>(<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>, <span style=color:#a6e22e>module</span>, <span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>, <span style=color:#a6e22e>__webpack_require__</span>);

<span style=color:#75715e>/******/</span> 		<span style=color:#75715e>// Flag the module as loaded
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 		<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>loaded</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;

<span style=color:#75715e>/******/</span> 		<span style=color:#75715e>// Return the exports of the module
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>;
<span style=color:#75715e>/******/</span> 	}


<span style=color:#75715e>/******/</span> 	<span style=color:#75715e>// expose the modules object (__webpack_modules__)
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 	<span style=color:#a6e22e>__webpack_require__</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>modules</span>;

<span style=color:#75715e>/******/</span> 	<span style=color:#75715e>// expose the module cache
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 	<span style=color:#a6e22e>__webpack_require__</span>.<span style=color:#a6e22e>c</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>installedModules</span>;

<span style=color:#75715e>/******/</span> 	<span style=color:#75715e>// __webpack_public_path__
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 	<span style=color:#a6e22e>__webpack_require__</span>.<span style=color:#a6e22e>p</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;

<span style=color:#75715e>/******/</span> 	<span style=color:#75715e>// Load entry module and return exports
</span><span style=color:#75715e></span><span style=color:#75715e>/******/</span> 	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>__webpack_require__</span>(<span style=color:#ae81ff>0</span>);
<span style=color:#75715e>/******/</span> })
<span style=color:#75715e>/************************************************************************/</span>
<span style=color:#75715e>/******/</span> ([
<span style=color:#75715e>/* 0 */</span>
<span style=color:#75715e>/***/</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>module</span>, <span style=color:#a6e22e>exports</span>, <span style=color:#a6e22e>__webpack_require__</span>) {

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>__weex_template__</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>__webpack_require__</span>(<span style=color:#ae81ff>1</span>)
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>__weex_style__</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>__webpack_require__</span>(<span style=color:#ae81ff>2</span>)
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>__weex_script__</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>__webpack_require__</span>(<span style=color:#ae81ff>3</span>)

	<span style=color:#a6e22e>__weex_define__</span>(<span style=color:#e6db74>&#39;@weex-component/916f9ecb075bbff1f4ea98389a4bb514&#39;</span>, [], <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>__weex_require__</span>, <span style=color:#a6e22e>__weex_exports__</span>, <span style=color:#a6e22e>__weex_module__</span>) {

	    <span style=color:#a6e22e>__weex_script__</span>(<span style=color:#a6e22e>__weex_module__</span>, <span style=color:#a6e22e>__weex_exports__</span>, <span style=color:#a6e22e>__weex_require__</span>)
	    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>__weex_exports__</span>.<span style=color:#a6e22e>__esModule</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>__weex_exports__</span>.<span style=color:#66d9ef>default</span>) {
	      <span style=color:#a6e22e>__weex_module__</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>__weex_exports__</span>.<span style=color:#66d9ef>default</span>
	    }

	    <span style=color:#a6e22e>__weex_module__</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>template</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>__weex_template__</span>

	    <span style=color:#a6e22e>__weex_module__</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>style</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>__weex_style__</span>

	})

	<span style=color:#a6e22e>__weex_bootstrap__</span>(<span style=color:#e6db74>&#39;@weex-component/916f9ecb075bbff1f4ea98389a4bb514&#39;</span>,<span style=color:#66d9ef>undefined</span>,<span style=color:#66d9ef>undefined</span>)

<span style=color:#75715e>/***/</span> },
<span style=color:#75715e>/* 1 */</span>
<span style=color:#75715e>/***/</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>module</span>, <span style=color:#a6e22e>exports</span>) {

	<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
	  <span style=color:#e6db74>&#34;type&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;div&#34;</span>,
	  <span style=color:#e6db74>&#34;classList&#34;</span><span style=color:#f92672>:</span> [
	    <span style=color:#e6db74>&#34;container&#34;</span>
	  ],
	  <span style=color:#e6db74>&#34;children&#34;</span><span style=color:#f92672>:</span> [
	    {
	      <span style=color:#e6db74>&#34;type&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;image&#34;</span>,
	      <span style=color:#e6db74>&#34;attr&#34;</span><span style=color:#f92672>:</span> {
	        <span style=color:#e6db74>&#34;src&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;http://9.pic.paopaoche.net/up/2016-7/201671315341.png&#34;</span>
	      },
	      <span style=color:#e6db74>&#34;classList&#34;</span><span style=color:#f92672>:</span> [
	        <span style=color:#e6db74>&#34;pic&#34;</span>
	      ],
	      <span style=color:#e6db74>&#34;events&#34;</span><span style=color:#f92672>:</span> {
	        <span style=color:#e6db74>&#34;click&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;picClick&#34;</span>
	      }
	    },
	    {
	      <span style=color:#e6db74>&#34;type&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;text&#34;</span>,
	      <span style=color:#e6db74>&#34;classList&#34;</span><span style=color:#f92672>:</span> [
	        <span style=color:#e6db74>&#34;text&#34;</span>
	      ],
	      <span style=color:#e6db74>&#34;attr&#34;</span><span style=color:#f92672>:</span> {
	        <span style=color:#e6db74>&#34;value&#34;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> () {<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>title</span>}
	      }
	    }
	  ]
	}

<span style=color:#75715e>/***/</span> },
<span style=color:#75715e>/* 2 */</span>
<span style=color:#75715e>/***/</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>module</span>, <span style=color:#a6e22e>exports</span>) {

	<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
	  <span style=color:#e6db74>&#34;container&#34;</span><span style=color:#f92672>:</span> {
	    <span style=color:#e6db74>&#34;alignItems&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;center&#34;</span>
	  },
	  <span style=color:#e6db74>&#34;pic&#34;</span><span style=color:#f92672>:</span> {
	    <span style=color:#e6db74>&#34;width&#34;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span>,
	    <span style=color:#e6db74>&#34;height&#34;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span>
	  },
	  <span style=color:#e6db74>&#34;text&#34;</span><span style=color:#f92672>:</span> {
	    <span style=color:#e6db74>&#34;fontSize&#34;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>40</span>,
	    <span style=color:#e6db74>&#34;color&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;#000000&#34;</span>
	  }
	}

<span style=color:#75715e>/***/</span> },
<span style=color:#75715e>/* 3 */</span>
<span style=color:#75715e>/***/</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>module</span>, <span style=color:#a6e22e>exports</span>) {

	<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>module</span>, <span style=color:#a6e22e>exports</span>, <span style=color:#a6e22e>__weex_require__</span>){<span style=color:#e6db74>&#39;use strict&#39;</span>;

	<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
	    <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> () {<span style=color:#66d9ef>return</span> {
	        <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Hello World&#39;</span>,
	        <span style=color:#a6e22e>toggle</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>
	    }},
	    <span style=color:#a6e22e>ready</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>ready</span>() {
	        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;this.title == &#39;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>title</span>);
	        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>title</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;hello Weex&#39;</span>;
	        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;this.title == &#39;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>title</span>);
	    },
	    <span style=color:#a6e22e>methods</span><span style=color:#f92672>:</span> {
	        <span style=color:#a6e22e>picClick</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>picClick</span>() {
	            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>toggle</span> <span style=color:#f92672>=</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>toggle</span>;
	            <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>toggle</span>) {
	                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>title</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;图片被点击&#39;</span>;
	            } <span style=color:#66d9ef>else</span> {
	                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>title</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Hello Weex&#39;</span>;
	            }
	        }
	    }
	};}
	<span style=color:#75715e>/* generated by weex-loader */</span>


<span style=color:#75715e>/***/</span> }
<span style=color:#75715e>/******/</span> ]);



</code></pre></div><p>看上去一堆代码，实际上仔细看看，就能看出门道。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>
(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>modules</span>) { <span style=color:#75715e>// webpackBootstrap
</span><span style=color:#75715e></span>
<span style=color:#960050;background-color:#1e0010>……</span>  <span style=color:#960050;background-color:#1e0010>……</span>
}

</code></pre></div><p>这段代码是自动加的，暂时不管。然后下面有4段代码，开头都分别编了序号，0，1，2，3。1，2，3段代码就是分别对应<code>&lt;template></code>，<code>&lt;style></code>，<code>&lt;script></code>。上述这段代码就是从服务器请求下来的代码。</p><p>那服务器拿到JS以后，OC会调用JS的方法createInstance(id, code, config, data)方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>args</span>:(<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#ae81ff>0</span>,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    “（<span style=color:#a6e22e>这里是网络上下载的JS</span>，<span style=color:#a6e22e>由于太长了</span>，<span style=color:#a6e22e>省略</span>）”,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>        {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#a6e22e>bundleUrl</span> = <span style=color:#e6db74>&#34;http://192.168.31.117:8081/HelloWeex.js&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>        <span style=color:#a6e22e>debug</span> = <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    }<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>) <span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>接着会在JSFramework里面执行一些转换的操作：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>an</span> <span style=color:#a6e22e>Weex</span>@<span style=color:#a6e22e>undefined</span> <span style=color:#a6e22e>instance</span> <span style=color:#a6e22e>from</span> <span style=color:#a6e22e>undefined</span>  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>Intialize</span> <span style=color:#a6e22e>an</span> <span style=color:#a6e22e>instance</span> <span style=color:#a6e22e>with</span>: <span style=color:#a6e22e>undefined</span>  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>define</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>component</span> @<span style=color:#a6e22e>weex</span>-<span style=color:#a6e22e>component</span>/<span style=color:#ae81ff>916</span>f<span style=color:#ae81ff>9</span>ecb<span style=color:#ae81ff>075</span>bbff<span style=color:#ae81ff>1</span>f<span style=color:#ae81ff>4</span>ea<span style=color:#ae81ff>98389</span>a<span style=color:#ae81ff>4</span>bb<span style=color:#ae81ff>514</span>  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>bootstrap</span> <span style=color:#a6e22e>for</span> @<span style=color:#a6e22e>weex</span>-<span style=color:#a6e22e>component</span>/<span style=color:#ae81ff>916</span>f<span style=color:#ae81ff>9</span>ecb<span style=color:#ae81ff>075</span>bbff<span style=color:#ae81ff>1</span>f<span style=color:#ae81ff>4</span>ea<span style=color:#ae81ff>98389</span>a<span style=color:#ae81ff>4</span>bb<span style=color:#ae81ff>514</span>  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#e6db74>&#34;init&#34;</span> <span style=color:#a6e22e>lifecycle</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>Vm</span>(<span style=color:#ae81ff>916</span>f<span style=color:#ae81ff>9</span>ecb<span style=color:#ae81ff>075</span>bbff<span style=color:#ae81ff>1</span>f<span style=color:#ae81ff>4</span>ea<span style=color:#ae81ff>98389</span>a<span style=color:#ae81ff>4</span>bb<span style=color:#ae81ff>514</span>)  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#e6db74>&#34;created&#34;</span> <span style=color:#a6e22e>lifecycle</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>Vm</span>(<span style=color:#ae81ff>916</span>f<span style=color:#ae81ff>9</span>ecb<span style=color:#ae81ff>075</span>bbff<span style=color:#ae81ff>1</span>f<span style=color:#ae81ff>4</span>ea<span style=color:#ae81ff>98389</span>a<span style=color:#ae81ff>4</span>bb<span style=color:#ae81ff>514</span>)  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>compile</span> <span style=color:#a6e22e>native</span> <span style=color:#a6e22e>component</span> <span style=color:#a6e22e>by</span> {<span style=color:#e6db74>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;div&#34;</span>,<span style=color:#e6db74>&#34;classList&#34;</span>:[<span style=color:#e6db74>&#34;container&#34;</span>],<span style=color:#e6db74>&#34;children&#34;</span>:[{<span style=color:#e6db74>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;image&#34;</span>,<span style=color:#e6db74>&#34;attr&#34;</span>:{<span style=color:#e6db74>&#34;src&#34;</span>:<span style=color:#e6db74>&#34;http://9.pic.paopaoche.net/up/2016-7/201671315341.png&#34;</span>},<span style=color:#e6db74>&#34;classList&#34;</span>:[<span style=color:#e6db74>&#34;pic&#34;</span>],<span style=color:#e6db74>&#34;events&#34;</span>:{<span style=color:#e6db74>&#34;click&#34;</span>:<span style=color:#e6db74>&#34;picClick&#34;</span>}},{<span style=color:#e6db74>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;text&#34;</span>,<span style=color:#e6db74>&#34;classList&#34;</span>:[<span style=color:#e6db74>&#34;text&#34;</span>],<span style=color:#e6db74>&#34;attr&#34;</span>:{}}]}  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>compile</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>body</span> <span style=color:#a6e22e>for</span> <span style=color:#a6e22e>div</span>  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>compile</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>append</span> <span style=color:#a6e22e>single</span> <span style=color:#a6e22e>node</span> <span style=color:#a6e22e>for</span> {<span style=color:#e6db74>&#34;ref&#34;</span>:<span style=color:#e6db74>&#34;_root&#34;</span>,<span style=color:#e6db74>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;div&#34;</span>,<span style=color:#e6db74>&#34;attr&#34;</span>:{},<span style=color:#e6db74>&#34;style&#34;</span>:{<span style=color:#e6db74>&#34;alignItems&#34;</span>:<span style=color:#e6db74>&#34;center&#34;</span>}} <span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>接下来JSFramework就会调用OC的callNative方法。调用dom模块的createBody方法，创建rootView。参数如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

(
        {
        args <span style=color:#f92672>=</span>         (
                        {
                attr <span style=color:#f92672>=</span>                 {
                };
                ref <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;_root&#34;</span>;
                style <span style=color:#f92672>=</span>                 {
                    alignItems <span style=color:#f92672>=</span> center;
                };
                type <span style=color:#f92672>=</span> div;
            }
        );
        method <span style=color:#f92672>=</span> createBody;
        module <span style=color:#f92672>=</span> dom;
    }
)

</code></pre></div><p>创建好rootView以后，接着要继续添加View了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>compile</span> <span style=color:#a6e22e>native</span> <span style=color:#a6e22e>component</span> <span style=color:#a6e22e>by</span> {<span style=color:#e6db74>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;image&#34;</span>,<span style=color:#e6db74>&#34;attr&#34;</span>:{<span style=color:#e6db74>&#34;src&#34;</span>:<span style=color:#e6db74>&#34;http://9.pic.paopaoche.net/up/2016-7/201671315341.png&#34;</span>},<span style=color:#e6db74>&#34;classList&#34;</span>:[<span style=color:#e6db74>&#34;pic&#34;</span>],<span style=color:#e6db74>&#34;events&#34;</span>:{<span style=color:#e6db74>&#34;click&#34;</span>:<span style=color:#e6db74>&#34;picClick&#34;</span>}}  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>compile</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>element</span> <span style=color:#a6e22e>for</span> <span style=color:#a6e22e>image</span>  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>compile</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>append</span> <span style=color:#a6e22e>single</span> <span style=color:#a6e22e>node</span> <span style=color:#a6e22e>for</span> {<span style=color:#e6db74>&#34;ref&#34;</span>:<span style=color:#e6db74>&#34;3&#34;</span>,<span style=color:#e6db74>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;image&#34;</span>,<span style=color:#e6db74>&#34;attr&#34;</span>:{<span style=color:#e6db74>&#34;src&#34;</span>:<span style=color:#e6db74>&#34;http://9.pic.paopaoche.net/up/2016-7/201671315341.png&#34;</span>},<span style=color:#e6db74>&#34;style&#34;</span>:{<span style=color:#e6db74>&#34;width&#34;</span>:<span style=color:#ae81ff>200</span>,<span style=color:#e6db74>&#34;height&#34;</span>:<span style=color:#ae81ff>200</span>},<span style=color:#e6db74>&#34;event&#34;</span>:[<span style=color:#e6db74>&#34;click&#34;</span>]}<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>JSFramework继续调用OC的callAddElement方法添加View。参数如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>

{
    attr <span style=color:#f92672>=</span>     {
        src <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://9.pic.paopaoche.net/up/2016-7/201671315341.png&#34;</span>;
    };
    event <span style=color:#f92672>=</span>     (
        click
    );
    ref <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
    style <span style=color:#f92672>=</span>     {
        height <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>;
        width <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>;
    };
    type <span style=color:#f92672>=</span> image;
}


</code></pre></div><p>UIImage添加完成以后，再接着添加UILabel。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>compile</span> <span style=color:#a6e22e>native</span> <span style=color:#a6e22e>component</span> <span style=color:#a6e22e>by</span> {<span style=color:#e6db74>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;text&#34;</span>,<span style=color:#e6db74>&#34;classList&#34;</span>:[<span style=color:#e6db74>&#34;text&#34;</span>],<span style=color:#e6db74>&#34;attr&#34;</span>:{}}  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>compile</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>create</span> <span style=color:#a6e22e>element</span> <span style=color:#a6e22e>for</span> <span style=color:#a6e22e>text</span>  [;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#a6e22e>compile</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>append</span> <span style=color:#a6e22e>single</span> <span style=color:#a6e22e>node</span> <span style=color:#a6e22e>for</span> {<span style=color:#e6db74>&#34;ref&#34;</span>:<span style=color:#e6db74>&#34;4&#34;</span>,<span style=color:#e6db74>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;text&#34;</span>,<span style=color:#e6db74>&#34;attr&#34;</span>:{<span style=color:#e6db74>&#34;value&#34;</span>:<span style=color:#e6db74>&#34;Hello World&#34;</span>},<span style=color:#e6db74>&#34;style&#34;</span>:{<span style=color:#e6db74>&#34;fontSize&#34;</span>:<span style=color:#ae81ff>40</span>,<span style=color:#e6db74>&#34;color&#34;</span>:<span style=color:#e6db74>&#34;#000000&#34;</span>}}<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>JSFramework继续调用OC的callAddElement方法添加View。参数如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
{
    attr <span style=color:#f92672>=</span>     {
        value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello World&#34;</span>;
    };
    ref <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
    style <span style=color:#f92672>=</span>     {
        color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#000000&#34;</span>;
        fontSize <span style=color:#f92672>=</span> <span style=color:#ae81ff>40</span>;
    };
    type <span style=color:#f92672>=</span> text;
}

</code></pre></div><p>当ready以后：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>[<span style=color:#a6e22e>JS</span> <span style=color:#a6e22e>Framework</span>] <span style=color:#e6db74>&#34;ready&#34;</span> <span style=color:#a6e22e>lifecycle</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>Vm</span>(<span style=color:#ae81ff>916</span>f<span style=color:#ae81ff>9</span>ecb<span style=color:#ae81ff>075</span>bbff<span style=color:#ae81ff>1</span>f<span style=color:#ae81ff>4</span>ea<span style=color:#ae81ff>98389</span>a<span style=color:#ae81ff>4</span>bb<span style=color:#ae81ff>514</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>JSFramework继续调用OC的callNative方法，参数如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
(
        {
        args <span style=color:#f92672>=</span>         (
            <span style=color:#ae81ff>4</span>,
                        {
                value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello Weex&#34;</span>;
            }
        );
        method <span style=color:#f92672>=</span> updateAttrs;
        module <span style=color:#f92672>=</span> dom;
    }
)

</code></pre></div><p>至此，所有的布局已经完成。JSFramework会继续调用OC的callNative方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
(
        {
        args <span style=color:#f92672>=</span>         (
        );
        method <span style=color:#f92672>=</span> createFinish;
        module <span style=color:#f92672>=</span> dom;
    }
)



</code></pre></div><p>到此为止，所有的View都已经创建完成了。最终整个布局如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>{<span style=color:#a6e22e>layout</span>: {<span style=color:#a6e22e>width</span>: <span style=color:#ae81ff>414</span>, <span style=color:#a6e22e>height</span>: <span style=color:#ae81ff>672</span>, <span style=color:#a6e22e>top</span>: <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>left</span>: <span style=color:#ae81ff>0</span>}, <span style=color:#a6e22e>flexDirection</span>: <span style=color:#e6db74>&#39;column&#39;</span>, <span style=color:#a6e22e>alignItems</span>: <span style=color:#e6db74>&#39;stretch&#39;</span>, <span style=color:#a6e22e>flex</span>: <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>width</span>: <span style=color:#ae81ff>414</span>, <span style=color:#a6e22e>height</span>: <span style=color:#ae81ff>672</span>, <span style=color:#a6e22e>left</span>: <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>top</span>: <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>children</span>: [<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  {<span style=color:#a6e22e>_root</span>:<span style=color:#a6e22e>div</span> <span style=color:#a6e22e>layout</span>: {<span style=color:#a6e22e>width</span>: <span style=color:#ae81ff>414</span>, <span style=color:#a6e22e>height</span>: <span style=color:#ae81ff>672</span>, <span style=color:#a6e22e>top</span>: <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>left</span>: <span style=color:#ae81ff>0</span>}, <span style=color:#a6e22e>flexDirection</span>: <span style=color:#e6db74>&#39;column&#39;</span>, <span style=color:#a6e22e>alignItems</span>: <span style=color:#e6db74>&#39;center&#39;</span>, <span style=color:#a6e22e>flex</span>: <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>width</span>: <span style=color:#ae81ff>414</span>, <span style=color:#a6e22e>height</span>: <span style=color:#ae81ff>672</span>, <span style=color:#a6e22e>children</span>: [<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    {<span style=color:#ae81ff>3</span>:<span style=color:#a6e22e>image</span> <span style=color:#a6e22e>layout</span>: {<span style=color:#a6e22e>width</span>: <span style=color:#ae81ff>110</span>.<span style=color:#ae81ff>4</span>, <span style=color:#a6e22e>height</span>: <span style=color:#ae81ff>110</span>.<span style=color:#ae81ff>4</span>, <span style=color:#a6e22e>top</span>: <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>left</span>: <span style=color:#ae81ff>151</span>.<span style=color:#ae81ff>8</span>}, <span style=color:#a6e22e>flexDirection</span>: <span style=color:#e6db74>&#39;column&#39;</span>, <span style=color:#a6e22e>alignItems</span>: <span style=color:#e6db74>&#39;stretch&#39;</span>, <span style=color:#a6e22e>flex</span>: <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>width</span>: <span style=color:#ae81ff>110</span>.<span style=color:#ae81ff>4</span>, <span style=color:#a6e22e>height</span>: <span style=color:#ae81ff>110</span>.<span style=color:#ae81ff>4</span>, },<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    {<span style=color:#ae81ff>4</span>:<span style=color:#a6e22e>text</span> <span style=color:#a6e22e>layout</span>: {<span style=color:#a6e22e>width</span>: <span style=color:#ae81ff>107</span>.<span style=color:#ae81ff>333</span>, <span style=color:#a6e22e>height</span>: <span style=color:#ae81ff>26</span>.<span style=color:#ae81ff>6667</span>, <span style=color:#a6e22e>top</span>: <span style=color:#ae81ff>110</span>.<span style=color:#ae81ff>4</span>, <span style=color:#a6e22e>left</span>: <span style=color:#ae81ff>153</span>.<span style=color:#ae81ff>333</span>}, <span style=color:#a6e22e>flexDirection</span>: <span style=color:#e6db74>&#39;column&#39;</span>, <span style=color:#a6e22e>alignItems</span>: <span style=color:#e6db74>&#39;stretch&#39;</span>, <span style=color:#a6e22e>flex</span>: <span style=color:#ae81ff>0</span>, },<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  ]},<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>]}<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>从最终的layout来看，我们可以看出，每一个module，component都有其对应的独一无二的id。</p><p>接着下一步操作是WXImageComponent更新图片。更新结束以后，整个Render就算彻底完成了。</p><p>JSFramework在整个过程中扮演的角色是根据输入的JSBundle，不断的输出Json格式的Virtual DOM，然后通过JSCore调用OC原生方法，生成View。</p><p>上面这个例子中，JSFramework的工作原理基本就展现出来了。大体流程如下图：</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_25.png alt></p><p>接下来详细总结一下JSFramework在整个Native端是如何工作的。</p><ol><li><p>首先JSFramework的初始化只会在App启动时初始化一次，多个页面都共享这一份JSFramework。这个设计也提高了Weex所有页面的打开速度， JS Framework 的启动过程几百毫秒，相当于每个页面打开的时候，这几百毫秒都被节省下来了。</p></li><li><p>虽然JSFramework全局只有一个，那么Weex是如何避免多个Weex在同一个JS Runtime里面相互互不影响？Weex采取了2方面的措施，一是要求每个Weex页面都必须要创建一个全局唯一的 instance ID，通过这个ID直接能对应一个Weex页面。二是JS与Native进行相互调用的时候，每个方法都要求第一个参数是ID。比如createInstance(id, code, config, data)，sendTasks(id, tasks)，receiveTasks(id, tasks)。这样不同页面的状态就被隔离到了不同的闭包中了，这样就做到了相互不影响。</p></li><li><p>当Native需要渲染页面的时候，会主动调用createInstance(id, code, config, data)方法，其中code参数就是JS Bundle转换成的String。JSFramework接收到了这段入参以后，就会开始解析，并开始sendTasks(id, tasks)。</p></li><li><p>sendTasks(id, tasks)会通过JSBridge调用OC Native方法。tasks里面会指定功能的模块名、方法名以及参数。比如：<code>sendTasks(id, [{ module: 'dom', method: 'removeElement', args: [elementRef]}])</code>这里就会调用之前注册到JSContext的OC方法。</p></li><li><p>客户端也会调用receiveTasks(id, tasks)方法，调用JS的方法。receiveTasks 中有两种方式，一种是fireEvent，对应的是客户端在某个DOM元素上触发的事件，比如fireEvent(titleElementRef, &lsquo;click&rsquo;, eventObject)；另一种则是callback，即前面功能模块调用之后产生的回调，比如我们通过fetch接口向Native端发送一个 HTTP 请求，并设置了一个回调函数，这个时候，先在JS端为这个回调函数生成一个callbackID，比如字符串 &ldquo;123&rdquo;，这个是发送给Native端的是这个callbackID，当请求结束之后，native需要把请求结果返还给JS Runtime，为了能够前后对得上，这个回调最终会成为类似 callback(callbackID, result) 的格式。</p></li></ol><h3 id=四关于weexreactnativejspatch>四.关于Weex，ReactNative，JSPatch</h3><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_26.png alt></p><p>这一章本来是不在这个文章之中的，但是由于近期苹果审核，带来了一些审核风波，于是打算在这里稍微提提。</p><p>在各位读者看到这篇文章的时候，纯的ReactNative和纯的Weex的项目已经可以完美通过审核了，JSPatch依旧处于被封杀的状态。</p><p>既然本篇文章分析了Weex的工作原理，那么就稍微谈谈RN，Weex和JSpatch的区别。</p><p>首先他们三者都是基于JS来进行热修复的，但是RN，Weex和JSPatch有一个最大的不同是，如果Native没有提供可以供JS调用的方法接口的话，那么在RN和Weex界面怎么也无法实现Native的一些方法的。</p><p>但是JSPatch不同，虽然它也是一套基于JSCore的bridge，但是它是基于Runtime的，基于OC的Runtime，可以实现各种需求，即使预先Native没有暴露出来的接口，都可以添加方法实现需求，也可以更改已经实现的方法。</p><p>从热更新的能力来看，RN和Weex的能力仅仅只是中等能力，而JSPatch是几乎无所不能，Runtime都实现的，它都能实现。</p><p>所以从热更新的能力上看，RN和Weex都不能改变Native原生代码，也无法动态调用Native系统私有API。所以苹果审核允许RN和Weex通过。</p><h3 id=最后>最后</h3><p><img src=https://img.halfrost.com/Blog/ArticleImage/42_27.png alt></p><p>本篇文章只讲述了Weex是如何在iOS Native端跑起来的原理，但是关于Weex其实还有很多没有解释，比如说在Vue.js页面更改了一个页面元素，是怎么能让Native页面及时的变更？Weex的页面是怎么通过FlexBox算法进行渲染的？前端页面是如何打包成JS bundle的？.we和.vue文件是怎么通过DSL被翻译的？如何利用JS的Runtime写一些强大的JSService？webpackBootstrap和weex-loader是如何生成最终的JS代码的，中间有哪些优化？……</p><p>以上的这些问题都会在接下来一系列的Weex文章里面一一详解，希望大家多多指点！</p><blockquote><p>GitHub Repo：<a href=https://github.com/halfrost/Halfrost-Field>Halfrost-Field</a></p><p>Follow: <a href=https://github.com/halfrost>halfrost · GitHub</a></p><p>Source: <a href=https://halfrost.com/weex_ios/>https://halfrost.com/weex_ios/</a></p></blockquote><img src=https://img.halfrost.com/wechat-qr-code.png></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=https://books.halfrost.com/>Books</a></li><li><a href=https://github.com/halfrost/Halfrost-Field>Github</a></li><li><a href=https://halfrost.me/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><ul><li><a href=#前言>前言</a></li><li><a href=#目录>目录</a></li><li><a href=#一-weex概述>一. Weex概述</a></li><li><a href=#二-weex工作原理>二. Weex工作原理</a></li><li><a href=#三-weex在ios上是如何跑起来的>三. Weex在iOS上是如何跑起来的</a><ul><li><a href=#一-weex-sdk初始化>（一）. Weex SDK初始化</a></li><li><a href=#1-wxmonitor监视器记录状态>1. WXMonitor监视器记录状态</a></li><li><a href=#2-加载本地的mainjs>2. 加载本地的main.js</a></li><li><a href=#3-wxsdkengine的初始化>3. WXSDKEngine的初始化</a></li><li><a href=#4-模拟器wxsimulatorshortcutmanager连接本地调试工具>4. 模拟器WXSimulatorShortcutManager连接本地调试工具</a></li><li><a href=#二-weex-是如何让js调起oc原生uiview的>（二）. Weex 是如何让JS调起OC原生UIView的？</a></li><li><a href=#1扫二维码的原理>1.扫二维码的原理</a></li><li><a href=#2js是如何调起oc原生view的>2.JS是如何调起OC原生View的</a></li></ul></li><li><a href=#四关于weexreactnativejspatch>四.关于Weex，ReactNative，JSPatch</a></li><li><a href=#最后>最后</a></li></ul></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f"><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&text=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&title=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&is_video=false&description=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84&body=Check out this article: https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f"><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&title=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&title=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&title=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-stumbleupon fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&title=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-digg fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&name=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84&description=%e5%89%8d%e8%a8%80%202016%e5%b9%b44%e6%9c%8821%e6%97%a5%ef%bc%8c%e9%98%bf%e9%87%8c%e5%b7%b4%e5%b7%b4%e5%9c%a8Qcon%e5%a4%a7%e4%bc%9a%e4%b8%8a%e5%ae%a3%e5%b8%83%e8%b7%a8%e5%b9%b3%e5%8f%b0%e7%a7%bb%e5%8a%a8%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7Weex%e5%bc%80%e6%94%be%e5%86%85%e6%b5%8b%e9%82%80%e8%af%b7%e3%80%82Weex%e8%83%bd%e5%a4%9f%e5%ae%8c%e7%be%8e%e5%85%bc%e9%a1%be%e6%80%a7%e8%83%bd%e4%b8%8e%e5%8a%a8%e6%80%81%e6%80%a7%ef%bc%8c%e8%ae%a9%e7%a7%bb%e5%8a%a8%e5%bc%80%e5%8f%91%e8%80%85%e9%80%9a%e8%bf%87%e7%ae%80%e6%8d%b7%e7%9a%84%e5%89%8d%e7%ab%af%e8%af%ad%e6%b3%95%e5%86%99%e5%87%baNative%e7%ba%a7%e5%88%ab%e7%9a%84%e6%80%a7%e8%83%bd%e4%bd%93%e9%aa%8c%ef%bc%8c%e5%b9%b6%e6%94%af%e6%8c%81iOS%e3%80%81%e5%ae%89%e5%8d%93%e3%80%81YunOS%e5%8f%8aWeb%e7%ad%89%e5%a4%9a%e7%ab%af%e9%83%a8%e7%bd%b2%e3%80%82%0a%e8%bf%91%e4%b8%80%e5%b9%b4%e6%9d%a5%ef%bc%8cReactNative%20%e5%92%8c%20Weex%20%e8%bf%99%e4%ba%9b%e8%b7%a8%e5%b9%b3%e5%8f%b0%e6%8a%80%e6%9c%af%e5%af%b9Native%e5%bc%80%e5%8f%91%e8%80%85%e6%9d%a5%e8%af%b4%ef%bc%8c%e5%86%b2%e5%87%bb%e6%98%af%e5%b7%a8%e5%a4%a7%e7%9a%84%e3%80%82Native%e5%9c%a8%e5%bc%80%e5%8f%91App%e7%9a%84%e6%97%b6%e5%80%99%e5%ad%98%e5%9c%a8%e4%b8%80%e4%ba%9b%e5%bc%8a%e7%ab%af%ef%bc%8c%e6%af%94%e5%a6%82%e5%ae%a2%e6%88%b7%e7%ab%af%e9%9c%80%e8%a6%81%e9%a2%91%e7%b9%81%e6%9b%b4%e6%96%b0%ef%bc%8ciOS%e6%9b%b4%e6%96%b0%e6%97%b6%e9%97%b4%e8%bf%98%e8%a6%81%e5%8f%97%e5%88%b0%e5%ae%a1%e6%a0%b8%e7%9a%84%e7%89%b5%e5%88%b6%ef%bc%9biOS%e3%80%81Android%e5%92%8c%e5%89%8d%e7%ab%af%e5%90%8c%e6%97%b6%e5%bc%80%e5%8f%91%e5%90%8c%e4%b8%80%e4%b8%aa%e9%9c%80%e6%b1%82%ef%bc%8c%e5%9c%a8%e4%ba%ba%e5%91%98%e6%88%90%e6%9c%ac%e4%b8%8a%e6%b6%88%e8%80%97%e5%a4%a7%ef%bc%9bHybrid%e7%9a%84%e6%80%a7%e8%83%bd%e5%92%8cNative%e7%9b%b8%e6%af%94%e5%8f%88%e5%b7%ae%e4%ba%86%e4%b8%80%e7%82%b9%e3%80%82%0aReactNative%20%e5%92%8c%20Weex%e7%9a%84%e5%87%ba%e7%8e%b0%ef%bc%8c%e5%b0%b1%e6%98%af%e4%b8%ba%e4%ba%86%e8%a7%a3%e5%86%b3%e8%bf%99%e4%ba%9b%e7%97%9b%e7%82%b9%e7%9a%84%e3%80%82%0a%e4%bb%8e4%e6%9c%8821%e5%8f%b7%e5%ae%a3%e5%b8%83%e5%86%85%e6%b5%8b%e4%bb%a5%e5%90%8e%ef%bc%8c%e7%9f%ad%e7%9f%ad%e4%b8%a4%e5%91%a8%e5%b0%b1%e6%9c%89%e8%b6%85%e8%bf%875000%e5%90%8d%e5%bc%80%e5%8f%91%e8%80%85%e7%94%b3%e8%af%b7%e3%80%82%0a2016%e5%b9%b46%e6%9c%8830%e6%97%a5%e9%98%bf%e9%87%8c%e5%b7%b4%e5%b7%b4%e6%ad%a3%e5%bc%8f%e5%ae%a3%e5%b8%83Weex%e5%bc%80%e6%ba%90%e3%80%82%e5%8f%b7%e7%a7%b0%e5%8f%af%e4%bb%a5%e7%94%a8Web%e6%96%b9%e5%bc%8f%ef%bc%8c%e5%bc%80%e5%8f%91Native%e7%ba%a7%e6%80%a7%e8%83%bd%e4%bd%93%e9%aa%8c%e7%9a%84%e4%ba%bf%e7%ba%a7%e5%ba%94%e7%94%a8%e5%8c%a0%e5%bf%83%e6%89%93%e9%80%a0%e8%b7%a8%e5%b9%b3%e5%8f%b0%e7%a7%bb%e5%8a%a8%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7Weex%e5%9c%a8%e5%bc%80%e6%ba%90%e9%a6%96%e6%97%a5%e5%b0%b1%e7%99%bb%e4%b8%8aGithub%e8%b6%8b%e5%8a%bf%e6%a6%9c%e9%a6%96%e4%bd%8d%ef%bc%8c%e6%88%aa%e6%ad%a2%e7%9b%ae%e5%89%8d%e4%b8%ba%e6%ad%a2%ef%bc%8cWeex%e5%9c%a8GitHub%e4%b8%8a%e7%9a%84Star%e6%95%b0%e5%b7%b2%e7%bb%8f%e5%88%b0%e8%be%be%e4%ba%8613393%e4%ba%86%e3%80%82%e6%88%90%e4%b8%ba%e4%b8%ad%e5%9b%bd2016%e5%b9%b4%e5%9c%a8Github%e4%b8%8a%e6%9c%80%e7%83%ad%e9%97%a8%e7%9a%84%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae%e4%b9%8b%e4%b8%80%e3%80%82%0a%e7%9b%ae%e5%bd%95%20%201.Weex%e6%a6%82%e8%bf%b0%202.Weex%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86%203.Weex%e5%9c%a8iOS%e4%b8%8a%e6%98%af%e5%a6%82%e4%bd%95%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84%204.%e5%85%b3%e4%ba%8eWeex%ef%bc%8cReactNative%ef%bc%8cJSPatch%20%20%e4%b8%80.%20Weex%e6%a6%82%e8%bf%b0%20Weex%e4%bb%8e%e5%87%ba%e7%94%9f%e9%82%a3%e5%a4%a9%e8%b5%b7%ef%bc%8c%e4%bb%bf%e4%bd%9b%e5%b0%b1%e6%98%af%e5%92%8cReactNative%e6%98%af%e2%80%9c%e4%b8%80%e5%af%b9%e2%80%9d%e3%80%82%0aReactNative%e5%ae%a3%e7%a7%b0%e2%80%9cLearn%20once%2c%20write%20anywhere%e2%80%9d%ef%bc%8c%e8%80%8cWeex%e5%ae%a3%e7%a7%b0%e2%80%9cWrite%20Once%2c%20Run%20Everywhere%e2%80%9d%e3%80%82Weex%e4%bb%8e%e5%87%ba%e7%94%9f%e9%82%a3%e5%a4%a9%e8%b5%b7%ef%bc%8c%e5%b0%b1%e8%a2%ab%e7%bb%99%e4%ba%88%e4%ba%86%e4%b8%80%e7%bb%9f%e4%b8%89%e7%ab%af%e7%9a%84%e5%8e%9a%e6%9c%9b%e3%80%82ReactNative%e5%8f%af%e4%bb%a5%e6%94%af%e6%8c%81iOS%e3%80%81Android%ef%bc%8c%e8%80%8cWeex%e5%8f%af%e4%bb%a5%e6%94%af%e6%8c%81iOS%e3%80%81Android%e3%80%81HTML5%e3%80%82%e4%b8%80%e7%bb%9f%e4%b8%89%e7%ab%af%e5%b0%b1%e8%a7%a3%e5%86%b3%e4%ba%86%e5%89%8d%e8%a8%80%e9%87%8c%e9%9d%a2%e8%af%b4%e7%9a%84%e7%ac%ac%e4%ba%8c%e4%b8%aa%e7%97%9b%e7%82%b9%ef%bc%8c%e5%90%8c%e6%97%b6%e5%bc%80%e5%8f%91%e6%b5%aa%e8%b4%b9%e4%ba%ba%e5%91%98%e6%88%90%e6%9c%ac%e7%9a%84%e9%97%ae%e9%a2%98%e3%80%82%0aNative%e7%a7%bb%e5%8a%a8%e5%bc%80%e5%8f%91%e8%80%85%e5%8f%aa%e9%9c%80%e8%a6%81%e5%9c%a8%e6%9c%ac%e5%9c%b0%e5%af%bc%e5%85%a5Weex%e7%9a%84SDK%ef%bc%8c%e5%b0%b1%e5%8f%af%e4%bb%a5%e9%80%9a%e8%bf%87HTML%2fCSS%2fJavaScript%e7%bd%91%e9%a1%b5%e7%9a%84%e8%bf%99%e5%a5%97%e7%bc%96%e7%a8%8b%e8%af%ad%e8%a8%80%e6%9d%a5%e5%bc%80%e5%8f%91Native%e7%ba%a7%e5%88%ab%e7%9a%84Weex%e7%95%8c%e9%9d%a2%e3%80%82%e8%bf%99%e6%84%8f%e5%91%b3%e7%9d%80%e5%8f%af%e4%bb%a5%e7%9b%b4%e6%8e%a5%e7%94%a8%e7%8e%b0%e6%9c%89Web%e5%bc%80%e5%8f%91%e7%9a%84%e7%bc%96%e8%be%91%e5%99%a8%e5%92%8cIDE%e7%9a%84%e4%bb%a3%e7%a0%81%e8%a1%a5%e5%85%a8%e3%80%81%e6%8f%90%e7%a4%ba%e3%80%81%e6%a3%80%e6%9f%a5%e7%ad%89%e5%8a%9f%e8%83%bd%e3%80%82%e4%bb%8e%e8%80%8c%e4%b9%9f%e7%bb%99%e5%89%8d%e7%ab%af%e4%ba%ba%e5%91%98%e5%bc%80%e5%8f%91Native%e7%ab%af%ef%bc%8c%e8%be%83%e4%bd%8e%e7%9a%84%e5%bc%80%e5%8f%91%e6%88%90%e6%9c%ac%e5%92%8c%e5%ad%a6%e4%b9%a0%e6%88%90%e6%9c%ac%e3%80%82%0aWeex%e6%98%af%e4%b8%80%e7%a7%8d%e8%bd%bb%e9%87%8f%e7%ba%a7%e3%80%81%e5%8f%af%e6%89%a9%e5%b1%95%e3%80%81%e9%ab%98%e6%80%a7%e8%83%bd%e6%a1%86%e6%9e%b6%e3%80%82%e9%9b%86%e6%88%90%e4%b9%9f%e5%be%88%e6%96%b9%e4%be%bf%ef%bc%8c%e5%8f%af%e4%bb%a5%e7%9b%b4%e6%8e%a5%e5%9c%a8HTML5%e9%a1%b5%e9%9d%a2%e5%b5%8c%e5%85%a5%ef%bc%8c%e4%b9%9f%e5%8f%af%e5%b5%8c%e5%9c%a8%e5%8e%9f%e7%94%9fUI%e4%b8%ad%e3%80%82%e7%94%b1%e4%ba%8e%e5%92%8cReactNative%e4%b8%80%e6%a0%b7%ef%bc%8c%e9%83%bd%e4%bc%9a%e8%b0%83%e7%94%a8Native%e7%ab%af%e7%9a%84%e5%8e%9f%e7%94%9f%e6%8e%a7%e4%bb%b6%ef%bc%8c%e6%89%80%e4%bb%a5%e5%9c%a8%e6%80%a7%e8%83%bd%e4%b8%8a%e6%af%94Hybrid%e9%ab%98%e5%87%ba%e4%b8%80%e4%b8%aa%e5%b1%82%e6%ac%a1%e3%80%82%e8%bf%99%e5%b0%b1%e8%a7%a3%e5%86%b3%e4%ba%86%e5%89%8d%e8%a8%80%e9%87%8c%e9%9d%a2%e6%89%80%e8%af%b4%e7%9a%84%e7%ac%ac%e4%b8%89%e4%b8%aa%e7%97%9b%e7%82%b9%ef%bc%8c%e6%80%a7%e8%83%bd%e9%97%ae%e9%a2%98%e3%80%82%0aWeex%e9%9d%9e%e5%b8%b8%e8%bd%bb%e9%87%8f%ef%bc%8c%e4%bd%93%e7%a7%af%e5%b0%8f%e5%b7%a7%ef%bc%8c%e8%af%ad%e6%b3%95%e7%ae%80%e5%8d%95%ef%bc%8c%e6%96%b9%e4%be%bf%e6%8e%a5%e5%85%a5%e5%92%8c%e4%b8%8a%e6%89%8b%e3%80%82ReactNative%e5%ae%98%e6%96%b9%e5%8f%aa%e5%85%81%e8%ae%b8%e5%b0%86ReactNative%e5%9f%ba%e7%a1%80JS%e5%ba%93%e5%92%8c%e4%b8%9a%e5%8a%a1JS%e4%b8%80%e8%b5%b7%e6%89%93%e6%88%90%e4%b8%80%e4%b8%aaJS%20bundle%ef%bc%8c%e6%b2%a1%e6%9c%89%e6%8f%90%e4%be%9b%e5%88%86%e5%8c%85%e7%9a%84%e5%8a%9f%e8%83%bd%ef%bc%8c%e6%89%80%e4%bb%a5%e5%a6%82%e6%9e%9c%e6%83%b3%e8%8a%82%e7%ba%a6%e6%b5%81%e9%87%8f%e5%b0%b1%e5%bf%85%e9%a1%bb%e5%88%b6%e4%bd%9c%e5%88%86%e5%8c%85%e6%89%93%e5%8c%85%e5%b7%a5%e5%85%b7%e3%80%82%e8%80%8cWeex%e9%bb%98%e8%ae%a4%e6%89%93%e7%9a%84JS%20bundle%e5%8f%aa%e5%8c%85%e5%90%ab%e4%b8%9a%e5%8a%a1JS%e4%bb%a3%e7%a0%81%ef%bc%8c%e4%bd%93%e7%a7%af%e5%b0%8f%e5%be%88%e5%a4%9a%ef%bc%8c%e5%9f%ba%e7%a1%80JS%e5%ba%93%e5%8c%85%e5%90%ab%e5%9c%a8Weex%20SDK%e4%b8%ad%ef%bc%8c%e8%bf%99%e4%b8%80%e7%82%b9Weex%e4%b8%8eFacebook%e7%9a%84React%20Native%e5%92%8c%e5%be%ae%e8%bd%af%e7%9a%84Cordova%e7%9b%b8%e6%af%94%ef%bc%8cWeex%e6%9b%b4%e5%8a%a0%e8%bd%bb%e9%87%8f%ef%bc%8c%e4%bd%93%e7%a7%af%e5%b0%8f%e5%b7%a7%e3%80%82%e6%8a%8aWeex%e7%94%9f%e6%88%90%e7%9a%84JS%20bundle%e8%bd%bb%e6%9d%be%e9%83%a8%e7%bd%b2%e5%88%b0%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%ab%af%ef%bc%8c%e7%84%b6%e5%90%8ePush%e5%88%b0%e5%ae%a2%e6%88%b7%e7%ab%af%ef%bc%8c%e6%88%96%e8%80%85%e5%ae%a2%e6%88%b7%e7%ab%af%e8%af%b7%e6%b1%82%e6%96%b0%e7%9a%84%e8%b5%84%e6%ba%90%e5%8d%b3%e5%8f%af%e5%ae%8c%e6%88%90%e5%8f%91%e5%b8%83%e3%80%82%e5%a6%82%e6%ad%a4%e5%bf%ab%e9%80%9f%e7%9a%84%e8%bf%ad%e4%bb%a3%e5%b0%b1%e8%a7%a3%e5%86%b3%e4%ba%86%e5%89%8d%e8%a8%80%e9%87%8c%e9%9d%a2%e8%af%b4%e7%9a%84%e7%ac%ac%e4%b8%80%e4%b8%aa%e7%97%9b%e7%82%b9%ef%bc%8c%e5%8f%91%e5%b8%83%e6%97%a0%e6%b3%95%e6%8e%a7%e5%88%b6%e6%97%b6%e9%97%b4%ef%bc%8c%0aWeex%e4%b8%adNative%e7%bb%84%e4%bb%b6%e5%92%8cAPI%e9%83%bd%e5%8f%af%e4%bb%a5%e6%a8%aa%e5%90%91%e6%89%a9%e5%b1%95%ef%bc%8c%e4%b8%9a%e5%8a%a1%e6%96%b9%e5%8f%af%e5%8e%bb%e4%b8%ad%e5%bf%83%e5%8c%96%e6%a8%aa%e5%90%91%e7%81%b5%e6%b4%bb%e5%8c%96%e5%ae%9a%e5%88%b6%e7%bb%84%e4%bb%b6%e5%92%8c%e5%8a%9f%e8%83%bd%e6%a8%a1%e5%9d%97%e3%80%82%e5%b9%b6%e4%b8%94%e8%bf%98%e5%8f%af%e4%bb%a5%e7%9b%b4%e6%8e%a5%e5%a4%8d%e7%94%a8Web%e5%89%8d%e7%ab%af%e7%9a%84%e5%b7%a5%e7%a8%8b%e5%8c%96%e7%ae%a1%e7%90%86%e5%92%8c%e7%9b%91%e6%8e%a7%e6%80%a7%e8%83%bd%e7%ad%89%e5%b7%a5%e5%85%b7%e3%80%82%0a%e7%9f%a5%e4%b9%8e%e4%b8%8a%e6%9c%89%e4%b8%80%e4%b8%aa%e5%85%b3%e4%ba%8eWeex%20%e5%92%8c%20ReactNative%e5%be%88%e5%a5%bd%e7%9a%84%e5%af%b9%e6%af%94%e6%96%87%e7%ab%a0weex%26amp%3bReactNative%e5%af%b9%e6%af%94%ef%bc%8c%e6%8e%a8%e8%8d%90%e5%a4%a7%e5%ae%b6%e9%98%85%e8%af%bb%e3%80%82%0aWeex%e5%9c%a82017%e5%b9%b42%e6%9c%8817%e6%97%a5%e6%ad%a3%e5%bc%8f%e5%8f%91%e5%b8%83v0.10.0%ef%bc%8c%e8%bf%99%e4%b8%aa%e9%87%8c%e7%a8%8b%e7%a2%91%e7%9a%84%e7%89%88%e6%9c%ac%e5%bc%80%e5%a7%8b%e5%ae%8c%e7%be%8e%e7%9a%84%e5%85%bc%e5%ae%b9Vue.js%e5%bc%80%e5%8f%91Weex%e7%95%8c%e9%9d%a2%e3%80%82%0aWeex%e5%8f%88%e4%ba%8e2017%e5%b9%b42%e6%9c%8824%20%e8%bf%81%e7%a7%bb%e8%87%b3%20Apache%20%e5%9f%ba%e9%87%91%e4%bc%9a%ef%bc%8c%e9%98%bf%e9%87%8c%e5%b7%b4%e5%b7%b4%e4%bc%9a%e5%9f%ba%e4%ba%8e%20Apache%20%e7%9a%84%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bd%e7%bb%a7%e7%bb%ad%e8%bf%ad%e4%bb%a3%e3%80%82%e5%b9%b6%e5%90%af%e7%94%a8%e4%ba%86%e5%85%a8%e6%96%b0%e7%9a%84%20GitHub%20%e4%bb%93%e5%ba%93%ef%bc%9ahttps%3a%2f%2fgithub.com%2fapache%2fincubator-weex%0a%e6%95%85%e4%bb%a5%e4%b8%8b%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90%e9%83%bd%e5%9f%ba%e4%ba%8ev0.10.0%e8%bf%99%e4%b8%aa%e7%89%88%e6%9c%ac%e3%80%82%0a%e4%ba%8c.%20Weex%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86%20%e4%b8%8a%e5%9b%be%e6%98%af%e5%ae%98%e6%96%b9%e7%bb%99%e7%9a%84%e4%b8%80%e5%bc%a0%e5%8e%9f%e7%90%86%e5%9b%be%ef%bc%8cWeex%e6%98%af%e5%a6%82%e4%bd%95%e6%8a%8aJS%e6%89%93%e5%8c%85%e6%88%90JS%20Bundle%e7%9a%84%e5%8e%9f%e7%90%86%e6%9c%ac%e7%af%87%e6%96%87%e7%ab%a0%e6%9a%82%e6%97%b6%e4%b8%8d%e6%b6%89%e5%8f%8a%e3%80%82%e6%9c%ac%e7%af%87%e6%96%87%e7%ab%a0%e4%bc%9a%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90Weex%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8Native%e7%ab%af%e5%b7%a5%e4%bd%9c%e7%9a%84%e3%80%82%e7%ac%94%e8%80%85%e6%8a%8aNative%e7%ab%af%e7%9a%84%e5%8e%9f%e7%90%86%e5%86%8d%e6%ac%a1%e7%bb%86%e5%88%86%ef%bc%8c%e5%a6%82%e4%b8%8b%e5%9b%be%ef%bc%9a%0aWeex%e5%8f%af%e4%bb%a5%e9%80%9a%e8%bf%87%e8%87%aa%e5%b7%b1%e8%ae%be%e8%ae%a1%e7%9a%84DSL%ef%bc%8c%e4%b9%a6%e5%86%99.we%e6%96%87%e4%bb%b6%e6%88%96%e8%80%85.vue%e6%96%87%e4%bb%b6%e6%9d%a5%e5%bc%80%e5%8f%91%e7%95%8c%e9%9d%a2%ef%bc%8c%e6%95%b4%e4%b8%aa%e9%a1%b5%e9%9d%a2%e4%b9%a6%e5%86%99%e5%88%86%e6%88%90%e4%ba%863%e6%ae%b5%ef%bc%8ctemplate%e3%80%81style%e3%80%81script%ef%bc%8c%e5%80%9f%e9%89%b4%e4%ba%86%e6%88%90%e7%86%9f%e7%9a%84MVVM%e7%9a%84%e6%80%9d%e6%83%b3%e3%80%82%0aWeex%e5%9c%a8%e6%80%a7%e8%83%bd%e6%96%b9%e9%9d%a2%ef%bc%8c%e4%b8%ba%e4%ba%86%e5%b0%bd%e5%8f%af%e8%83%bd%e7%9a%84%e6%8f%90%e5%8d%87%e5%ae%a2%e6%88%b7%e7%ab%af%e7%9a%84%e6%80%a7%e8%83%bd%ef%bc%8cDSL%e7%9a%84Transformer%e5%85%a8%e9%83%a8%e9%83%bd%e6%94%be%e5%9c%a8%e4%ba%86%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%ab%af%e5%ae%9e%e7%8e%b0%ef%bc%8cWeex%e4%bc%9a%e5%9c%a8%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%ab%af%e5%b0%86XML%20%2b%20CSS%20%2b%20JavaScript%20%e4%bb%a3%e7%a0%81%e5%85%a8%e9%83%a8%e9%83%bd%e8%bd%ac%e6%8d%a2%e6%88%90JS%20Bundle%e3%80%82%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%b0%86JS%20Bundle%e9%83%a8%e7%bd%b2%e5%88%b0Server%e4%b8%8a%e5%92%8cCDN%e4%b8%8a%e3%80%82%0aWeex%e5%92%8cReact%20Native%e4%b8%8d%e5%90%8c%e7%9a%84%e6%98%af%ef%bc%8cWeex%e6%8a%8aJS%20Framework%e5%86%85%e7%bd%ae%e5%9c%a8SDK%e9%87%8c%e9%9d%a2%ef%bc%8c%e7%94%a8%e6%9d%a5%e8%a7%a3%e6%9e%90%e4%bb%8e%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%8a%e4%b8%8b%e8%bd%bd%e7%9a%84JS%20Bundle%ef%bc%8c%e8%bf%99%e6%a0%b7%e4%b9%9f%e5%87%8f%e5%b0%91%e4%ba%86%e6%af%8f%e4%b8%aaJS%20Bundle%e7%9a%84%e4%bd%93%e7%a7%af%ef%bc%8c%e4%b8%8d%e5%86%8d%e6%9c%89React%20Native%e9%9c%80%e8%a6%81%e5%88%86%e5%8c%85%e7%9a%84%e9%97%ae%e9%a2%98%e3%80%82%e5%ae%a2%e6%88%b7%e7%ab%af%e8%af%b7%e6%b1%82%e5%ae%8cJS%20Bundle%e4%bb%a5%e5%90%8e%ef%bc%8c%e4%bc%a0%e7%bb%99JS%20Framework%ef%bc%8cJS%20Framework%e8%a7%a3%e6%9e%90%e5%ae%8c%e6%88%90%e4%bb%a5%e5%90%8e%e4%bc%9a%e8%be%93%e5%87%baJson%e6%a0%bc%e5%bc%8f%e7%9a%84Virtual%20DOM%ef%bc%8c%e5%ae%a2%e6%88%b7%e7%ab%afNative%e5%8f%aa%e9%9c%80%e8%a6%81%e4%b8%93%e5%bf%83%e8%b4%9f%e8%b4%a3%20Virtual%20DOM%20%e7%9a%84%e8%a7%a3%e6%9e%90%e5%92%8c%e5%b8%83%e5%b1%80%e3%80%81UI%20%e6%b8%b2%e6%9f%93%e3%80%82%e7%84%b6%e8%80%8c%e8%bf%99%e4%b8%80%e5%a5%97%e8%a7%a3%e6%9e%90%ef%bc%8c%e5%b8%83%e5%b1%80%ef%bc%8c%e6%b8%b2%e6%9f%93%e7%9a%84%e9%80%bb%e8%be%91SDK%e5%9f%ba%e6%9c%ac%e5%ae%9e%e7%8e%b0%e4%ba%86%e3%80%82"><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fnew.halfrost.com%2fweex_ios%2f&t=Weex%20%e6%98%af%e5%a6%82%e4%bd%95%e5%9c%a8%20iOS%20%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e8%b7%91%e8%b5%b7%e6%9d%a5%e7%9a%84"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu class=icon href=# onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden=true></i>Menu</a>
<a id=toc class=icon href=# onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden=true></i>TOC</a>
<a id=share class=icon href=# onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden=true></i>share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i>Top</a></div></div></div><footer id=footer><div class=footer-left><p class=copyright style=float:left;margin-bottom:0><a href=https://github.com/halfrost/Halfrost-Field class=github-repo style=height:18px><span class=gadget-github></span>Star</a>
Copyright &copy;halfrost 2016 - 2021
<a href=http://www.miit.gov.cn/>鄂ICP备16014744号</a></p><br><p class="copyright statistics" style=margin-bottom:20px><span id=busuanzi_container_site_pv>Cumulative Page Views <span id=busuanzi_value_site_pv></span>| Unique Visitors <span id=busuanzi_value_site_uv></span></span></p></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/main.min.f870a4d110314b9e50e65f8ac982dc1c9c376c8f1a5083d39c62cfc49073f011.js></script><script async src=/prism.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}};</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>