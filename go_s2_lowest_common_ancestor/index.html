<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=theme-color content="#FFFFFF"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Google S2 中的四叉树求 LCA 最近公共祖先 | prometheus</title><meta name=description content="Explore in every moment of the hard thinking"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Google S2 中的四叉树求 LCA 最近公共祖先"><meta property="og:description" content="一. 寻找父亲节点和孩子节点 首先需要回顾一下希尔伯特曲线的生成方式，具体代码见笔者上篇文章的分析，在这个分析中，有4个方向比较重要，接下来的分析需要，所以把这4个方向的图搬过来。
在举例之前还需要说明一点，有些网站提供的二进制转换，并没有标明有符号还是无符号的转换，这样就会导致使用者的一些误解。笔者开始并没有发现这个问题，导致掉入了这个坑，好一会才转过弯来。笔者在网上查询了很多在线转换计算器的工具，都发现了这个问题。比如常见的在线进制转换http://tool.oschina.net/hexconvert，随便找两个64位的二进制数，有符号的和无符号的分别转换成十进制，或者反过来转换，你会惊喜的发现，两次结果居然相同！例如你输入 3932700003016900608 和 3932700003016900600，你会发现转换成二进制以后结果都是 11011010010011110000011101000100000000000000000000000000000000。但是很明显这两个数不同。
假如 3932700003016900608 是无符号的，3932700003016900600 是有符号的，正确的结果应该如下：
// 3932700003016900608 11011010010011110000011101000100000000000000000000000000000000 // 3932700003016900600 11011010010011110000011101000011111111111111111111111111111000 差距明显很大。这种例子其实还有很多，随便再举出几组：无符号的 3932700011606835200 和有符号的 3932700011606835000；无符号的 3932700020196769792 和有符号的 3932700020196770000；无符号的 3932700028786704384 和有符号的 3932700028786704400……可以举的例子很多，这里就不再举了。
利用网上的这个工具，十进制转二进制是无符号的转换，二进制转十进制就会变成有符号的转换了。而 Google S2 默认是无符号的 CellID，所以用有符号的 CellID 会出现错误。所以转换中需要注意一下。笔者之前没有发现这一点的时候出现了一些问题，后来突然发现了这一点，茅塞顿开。
好了，进入正题。接下来直接看一个例子，笔者用例子来说明每个 Cell 之间的关系，以及如何查找父亲节点的。
假设有上图这4个连在一起的 Cell。先根据经纬度把 CellID 计算出来。
对应的4个 CellID 分别是：
由于前两位都是0，所以其实可以省略，但是为了读者看的更清晰，笔者还是补全了64位，前面2个0还是补上 // 3932700003016900608 右上 0011011010010011110000011101000100000000000000000000000000000000 // 3932700011606835200 左上 0011011010010011110000011101001100000000000000000000000000000000 // 3932700020196769792 左下 0011011010010011110000011101010100000000000000000000000000000000 // 3932700028786704384 右下 0011011010010011110000011101011100000000000000000000000000000000 在前篇文章里面我们也分析了 Cell 64位的结构，这里是4个 Level 14的 Cell，所以末尾有 64 - 3 - 1 - 14 * 2 = 32 个 0 。从末尾往前的第33位是一个1，第34位，第35位是我们重点需要关注的。可以看到分别是00，01，10，11 。正好是连续的4个二进制。"><meta property="og:type" content="article"><meta property="og:url" content="https://new.halfrost.com/go_s2_lowest_common_ancestor/"><meta property="article:published_time" content="2017-10-20T03:18:00+00:00"><meta property="article:modified_time" content="2017-10-20T03:18:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Google S2 中的四叉树求 LCA 最近公共祖先"><meta name=twitter:description content="一. 寻找父亲节点和孩子节点 首先需要回顾一下希尔伯特曲线的生成方式，具体代码见笔者上篇文章的分析，在这个分析中，有4个方向比较重要，接下来的分析需要，所以把这4个方向的图搬过来。
在举例之前还需要说明一点，有些网站提供的二进制转换，并没有标明有符号还是无符号的转换，这样就会导致使用者的一些误解。笔者开始并没有发现这个问题，导致掉入了这个坑，好一会才转过弯来。笔者在网上查询了很多在线转换计算器的工具，都发现了这个问题。比如常见的在线进制转换http://tool.oschina.net/hexconvert，随便找两个64位的二进制数，有符号的和无符号的分别转换成十进制，或者反过来转换，你会惊喜的发现，两次结果居然相同！例如你输入 3932700003016900608 和 3932700003016900600，你会发现转换成二进制以后结果都是 11011010010011110000011101000100000000000000000000000000000000。但是很明显这两个数不同。
假如 3932700003016900608 是无符号的，3932700003016900600 是有符号的，正确的结果应该如下：
// 3932700003016900608 11011010010011110000011101000100000000000000000000000000000000 // 3932700003016900600 11011010010011110000011101000011111111111111111111111111111000 差距明显很大。这种例子其实还有很多，随便再举出几组：无符号的 3932700011606835200 和有符号的 3932700011606835000；无符号的 3932700020196769792 和有符号的 3932700020196770000；无符号的 3932700028786704384 和有符号的 3932700028786704400……可以举的例子很多，这里就不再举了。
利用网上的这个工具，十进制转二进制是无符号的转换，二进制转十进制就会变成有符号的转换了。而 Google S2 默认是无符号的 CellID，所以用有符号的 CellID 会出现错误。所以转换中需要注意一下。笔者之前没有发现这一点的时候出现了一些问题，后来突然发现了这一点，茅塞顿开。
好了，进入正题。接下来直接看一个例子，笔者用例子来说明每个 Cell 之间的关系，以及如何查找父亲节点的。
假设有上图这4个连在一起的 Cell。先根据经纬度把 CellID 计算出来。
对应的4个 CellID 分别是：
由于前两位都是0，所以其实可以省略，但是为了读者看的更清晰，笔者还是补全了64位，前面2个0还是补上 // 3932700003016900608 右上 0011011010010011110000011101000100000000000000000000000000000000 // 3932700011606835200 左上 0011011010010011110000011101001100000000000000000000000000000000 // 3932700020196769792 左下 0011011010010011110000011101010100000000000000000000000000000000 // 3932700028786704384 右下 0011011010010011110000011101011100000000000000000000000000000000 在前篇文章里面我们也分析了 Cell 64位的结构，这里是4个 Level 14的 Cell，所以末尾有 64 - 3 - 1 - 14 * 2 = 32 个 0 。从末尾往前的第33位是一个1，第34位，第35位是我们重点需要关注的。可以看到分别是00，01，10，11 。正好是连续的4个二进制。"><link rel=stylesheet href=/css/style-white.min.css><link rel=manifest href=/manifest.json><link rel=stylesheet href=/prism.css><link href=/images/apple-touch-icon-60x60.png rel=apple-touch-icon sizes=60x60><link href=/images/apple-touch-icon-76x76.png rel=apple-touch-icon sizes=76x76><link href=/images/apple-touch-icon-120x120.png rel=apple-touch-icon sizes=120x120><link href=/images/apple-touch-icon-152x152.png rel=apple-touch-icon sizes=152x152><link href=/images/apple-touch-icon-180x180.png rel=apple-touch-icon sizes=180x180><link href=/images/apple-touch-icon-512x512.png rel=apple-touch-icon sizes=512x512><link href=/images/apple-touch-icon-1024x1024.png rel=apple-touch-icon sizes=1024x1024><script async>if('serviceWorker'in navigator){navigator.serviceWorker.register("\/serviceworker-v1.min.a64912b78d282eab1ad3715a0943da21616e5f326f8afea27034784ad445043b.js").then(function(){if(navigator.serviceWorker.controller){console.log('Assets cached by the controlling service worker.');}else{console.log('Please reload this page to allow the service worker to handle network operations.');}}).catch(function(error){console.log('ERROR: '+error);});}else{console.log('Service workers are not supported in the current browser.');}</script><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://new.halfrost.com/images/favicon.ico><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-82753806-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="single-max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a><a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a><a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast');" style=display:none><i class="fas fa-chevron-up fa-lg"></i></a><span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=https://books.halfrost.com/>Books</a></li><li><a href=https://github.com/halfrost/Halfrost-Field>Github</a></li><li><a href=https://halfrost.me/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://new.halfrost.com/go_map_chapter_two/><i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li><li><a class=icon href=https://new.halfrost.com/go_s2_de_bruijn/><i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li><li><a class=icon href=#><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f"><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&text=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&title=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&is_video=false&description=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88&body=Check out this article: https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f"><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&title=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&title=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&title=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-stumbleupon" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&title=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-digg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&name=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88&description=%e4%b8%80.%20%e5%af%bb%e6%89%be%e7%88%b6%e4%ba%b2%e8%8a%82%e7%82%b9%e5%92%8c%e5%ad%a9%e5%ad%90%e8%8a%82%e7%82%b9%20%e9%a6%96%e5%85%88%e9%9c%80%e8%a6%81%e5%9b%9e%e9%a1%be%e4%b8%80%e4%b8%8b%e5%b8%8c%e5%b0%94%e4%bc%af%e7%89%b9%e6%9b%b2%e7%ba%bf%e7%9a%84%e7%94%9f%e6%88%90%e6%96%b9%e5%bc%8f%ef%bc%8c%e5%85%b7%e4%bd%93%e4%bb%a3%e7%a0%81%e8%a7%81%e7%ac%94%e8%80%85%e4%b8%8a%e7%af%87%e6%96%87%e7%ab%a0%e7%9a%84%e5%88%86%e6%9e%90%ef%bc%8c%e5%9c%a8%e8%bf%99%e4%b8%aa%e5%88%86%e6%9e%90%e4%b8%ad%ef%bc%8c%e6%9c%894%e4%b8%aa%e6%96%b9%e5%90%91%e6%af%94%e8%be%83%e9%87%8d%e8%a6%81%ef%bc%8c%e6%8e%a5%e4%b8%8b%e6%9d%a5%e7%9a%84%e5%88%86%e6%9e%90%e9%9c%80%e8%a6%81%ef%bc%8c%e6%89%80%e4%bb%a5%e6%8a%8a%e8%bf%994%e4%b8%aa%e6%96%b9%e5%90%91%e7%9a%84%e5%9b%be%e6%90%ac%e8%bf%87%e6%9d%a5%e3%80%82%0a%e5%9c%a8%e4%b8%be%e4%be%8b%e4%b9%8b%e5%89%8d%e8%bf%98%e9%9c%80%e8%a6%81%e8%af%b4%e6%98%8e%e4%b8%80%e7%82%b9%ef%bc%8c%e6%9c%89%e4%ba%9b%e7%bd%91%e7%ab%99%e6%8f%90%e4%be%9b%e7%9a%84%e4%ba%8c%e8%bf%9b%e5%88%b6%e8%bd%ac%e6%8d%a2%ef%bc%8c%e5%b9%b6%e6%b2%a1%e6%9c%89%e6%a0%87%e6%98%8e%e6%9c%89%e7%ac%a6%e5%8f%b7%e8%bf%98%e6%98%af%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%e8%bd%ac%e6%8d%a2%ef%bc%8c%e8%bf%99%e6%a0%b7%e5%b0%b1%e4%bc%9a%e5%af%bc%e8%87%b4%e4%bd%bf%e7%94%a8%e8%80%85%e7%9a%84%e4%b8%80%e4%ba%9b%e8%af%af%e8%a7%a3%e3%80%82%e7%ac%94%e8%80%85%e5%bc%80%e5%a7%8b%e5%b9%b6%e6%b2%a1%e6%9c%89%e5%8f%91%e7%8e%b0%e8%bf%99%e4%b8%aa%e9%97%ae%e9%a2%98%ef%bc%8c%e5%af%bc%e8%87%b4%e6%8e%89%e5%85%a5%e4%ba%86%e8%bf%99%e4%b8%aa%e5%9d%91%ef%bc%8c%e5%a5%bd%e4%b8%80%e4%bc%9a%e6%89%8d%e8%bd%ac%e8%bf%87%e5%bc%af%e6%9d%a5%e3%80%82%e7%ac%94%e8%80%85%e5%9c%a8%e7%bd%91%e4%b8%8a%e6%9f%a5%e8%af%a2%e4%ba%86%e5%be%88%e5%a4%9a%e5%9c%a8%e7%ba%bf%e8%bd%ac%e6%8d%a2%e8%ae%a1%e7%ae%97%e5%99%a8%e7%9a%84%e5%b7%a5%e5%85%b7%ef%bc%8c%e9%83%bd%e5%8f%91%e7%8e%b0%e4%ba%86%e8%bf%99%e4%b8%aa%e9%97%ae%e9%a2%98%e3%80%82%e6%af%94%e5%a6%82%e5%b8%b8%e8%a7%81%e7%9a%84%e5%9c%a8%e7%ba%bf%e8%bf%9b%e5%88%b6%e8%bd%ac%e6%8d%a2http%3a%2f%2ftool.oschina.net%2fhexconvert%ef%bc%8c%e9%9a%8f%e4%be%bf%e6%89%be%e4%b8%a4%e4%b8%aa64%e4%bd%8d%e7%9a%84%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%95%b0%ef%bc%8c%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%e5%92%8c%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%e5%88%86%e5%88%ab%e8%bd%ac%e6%8d%a2%e6%88%90%e5%8d%81%e8%bf%9b%e5%88%b6%ef%bc%8c%e6%88%96%e8%80%85%e5%8f%8d%e8%bf%87%e6%9d%a5%e8%bd%ac%e6%8d%a2%ef%bc%8c%e4%bd%a0%e4%bc%9a%e6%83%8a%e5%96%9c%e7%9a%84%e5%8f%91%e7%8e%b0%ef%bc%8c%e4%b8%a4%e6%ac%a1%e7%bb%93%e6%9e%9c%e5%b1%85%e7%84%b6%e7%9b%b8%e5%90%8c%ef%bc%81%e4%be%8b%e5%a6%82%e4%bd%a0%e8%be%93%e5%85%a5%203932700003016900608%20%e5%92%8c%203932700003016900600%ef%bc%8c%e4%bd%a0%e4%bc%9a%e5%8f%91%e7%8e%b0%e8%bd%ac%e6%8d%a2%e6%88%90%e4%ba%8c%e8%bf%9b%e5%88%b6%e4%bb%a5%e5%90%8e%e7%bb%93%e6%9e%9c%e9%83%bd%e6%98%af%2011011010010011110000011101000100000000000000000000000000000000%e3%80%82%e4%bd%86%e6%98%af%e5%be%88%e6%98%8e%e6%98%be%e8%bf%99%e4%b8%a4%e4%b8%aa%e6%95%b0%e4%b8%8d%e5%90%8c%e3%80%82%0a%e5%81%87%e5%a6%82%203932700003016900608%20%e6%98%af%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%ef%bc%8c3932700003016900600%20%e6%98%af%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%ef%bc%8c%e6%ad%a3%e7%a1%ae%e7%9a%84%e7%bb%93%e6%9e%9c%e5%ba%94%e8%af%a5%e5%a6%82%e4%b8%8b%ef%bc%9a%0a%2f%2f%203932700003016900608%2011011010010011110000011101000100000000000000000000000000000000%20%2f%2f%203932700003016900600%2011011010010011110000011101000011111111111111111111111111111000%20%e5%b7%ae%e8%b7%9d%e6%98%8e%e6%98%be%e5%be%88%e5%a4%a7%e3%80%82%e8%bf%99%e7%a7%8d%e4%be%8b%e5%ad%90%e5%85%b6%e5%ae%9e%e8%bf%98%e6%9c%89%e5%be%88%e5%a4%9a%ef%bc%8c%e9%9a%8f%e4%be%bf%e5%86%8d%e4%b8%be%e5%87%ba%e5%87%a0%e7%bb%84%ef%bc%9a%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700011606835200%20%e5%92%8c%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700011606835000%ef%bc%9b%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700020196769792%20%e5%92%8c%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700020196770000%ef%bc%9b%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700028786704384%20%e5%92%8c%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700028786704400%e2%80%a6%e2%80%a6%e5%8f%af%e4%bb%a5%e4%b8%be%e7%9a%84%e4%be%8b%e5%ad%90%e5%be%88%e5%a4%9a%ef%bc%8c%e8%bf%99%e9%87%8c%e5%b0%b1%e4%b8%8d%e5%86%8d%e4%b8%be%e4%ba%86%e3%80%82%0a%e5%88%a9%e7%94%a8%e7%bd%91%e4%b8%8a%e7%9a%84%e8%bf%99%e4%b8%aa%e5%b7%a5%e5%85%b7%ef%bc%8c%e5%8d%81%e8%bf%9b%e5%88%b6%e8%bd%ac%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%98%af%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%e8%bd%ac%e6%8d%a2%ef%bc%8c%e4%ba%8c%e8%bf%9b%e5%88%b6%e8%bd%ac%e5%8d%81%e8%bf%9b%e5%88%b6%e5%b0%b1%e4%bc%9a%e5%8f%98%e6%88%90%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%e8%bd%ac%e6%8d%a2%e4%ba%86%e3%80%82%e8%80%8c%20Google%20S2%20%e9%bb%98%e8%ae%a4%e6%98%af%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%20CellID%ef%bc%8c%e6%89%80%e4%bb%a5%e7%94%a8%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%20CellID%20%e4%bc%9a%e5%87%ba%e7%8e%b0%e9%94%99%e8%af%af%e3%80%82%e6%89%80%e4%bb%a5%e8%bd%ac%e6%8d%a2%e4%b8%ad%e9%9c%80%e8%a6%81%e6%b3%a8%e6%84%8f%e4%b8%80%e4%b8%8b%e3%80%82%e7%ac%94%e8%80%85%e4%b9%8b%e5%89%8d%e6%b2%a1%e6%9c%89%e5%8f%91%e7%8e%b0%e8%bf%99%e4%b8%80%e7%82%b9%e7%9a%84%e6%97%b6%e5%80%99%e5%87%ba%e7%8e%b0%e4%ba%86%e4%b8%80%e4%ba%9b%e9%97%ae%e9%a2%98%ef%bc%8c%e5%90%8e%e6%9d%a5%e7%aa%81%e7%84%b6%e5%8f%91%e7%8e%b0%e4%ba%86%e8%bf%99%e4%b8%80%e7%82%b9%ef%bc%8c%e8%8c%85%e5%a1%9e%e9%a1%bf%e5%bc%80%e3%80%82%0a%e5%a5%bd%e4%ba%86%ef%bc%8c%e8%bf%9b%e5%85%a5%e6%ad%a3%e9%a2%98%e3%80%82%e6%8e%a5%e4%b8%8b%e6%9d%a5%e7%9b%b4%e6%8e%a5%e7%9c%8b%e4%b8%80%e4%b8%aa%e4%be%8b%e5%ad%90%ef%bc%8c%e7%ac%94%e8%80%85%e7%94%a8%e4%be%8b%e5%ad%90%e6%9d%a5%e8%af%b4%e6%98%8e%e6%af%8f%e4%b8%aa%20Cell%20%e4%b9%8b%e9%97%b4%e7%9a%84%e5%85%b3%e7%b3%bb%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%a6%82%e4%bd%95%e6%9f%a5%e6%89%be%e7%88%b6%e4%ba%b2%e8%8a%82%e7%82%b9%e7%9a%84%e3%80%82%0a%e5%81%87%e8%ae%be%e6%9c%89%e4%b8%8a%e5%9b%be%e8%bf%994%e4%b8%aa%e8%bf%9e%e5%9c%a8%e4%b8%80%e8%b5%b7%e7%9a%84%20Cell%e3%80%82%e5%85%88%e6%a0%b9%e6%8d%ae%e7%bb%8f%e7%ba%ac%e5%ba%a6%e6%8a%8a%20CellID%20%e8%ae%a1%e7%ae%97%e5%87%ba%e6%9d%a5%e3%80%82%0a%e5%af%b9%e5%ba%94%e7%9a%844%e4%b8%aa%20CellID%20%e5%88%86%e5%88%ab%e6%98%af%ef%bc%9a%0a%e7%94%b1%e4%ba%8e%e5%89%8d%e4%b8%a4%e4%bd%8d%e9%83%bd%e6%98%af0%ef%bc%8c%e6%89%80%e4%bb%a5%e5%85%b6%e5%ae%9e%e5%8f%af%e4%bb%a5%e7%9c%81%e7%95%a5%ef%bc%8c%e4%bd%86%e6%98%af%e4%b8%ba%e4%ba%86%e8%af%bb%e8%80%85%e7%9c%8b%e7%9a%84%e6%9b%b4%e6%b8%85%e6%99%b0%ef%bc%8c%e7%ac%94%e8%80%85%e8%bf%98%e6%98%af%e8%a1%a5%e5%85%a8%e4%ba%8664%e4%bd%8d%ef%bc%8c%e5%89%8d%e9%9d%a22%e4%b8%aa0%e8%bf%98%e6%98%af%e8%a1%a5%e4%b8%8a%20%2f%2f%203932700003016900608%20%e5%8f%b3%e4%b8%8a%200011011010010011110000011101000100000000000000000000000000000000%20%2f%2f%203932700011606835200%20%e5%b7%a6%e4%b8%8a%200011011010010011110000011101001100000000000000000000000000000000%20%2f%2f%203932700020196769792%20%e5%b7%a6%e4%b8%8b%200011011010010011110000011101010100000000000000000000000000000000%20%2f%2f%203932700028786704384%20%e5%8f%b3%e4%b8%8b%200011011010010011110000011101011100000000000000000000000000000000%20%e5%9c%a8%e5%89%8d%e7%af%87%e6%96%87%e7%ab%a0%e9%87%8c%e9%9d%a2%e6%88%91%e4%bb%ac%e4%b9%9f%e5%88%86%e6%9e%90%e4%ba%86%20Cell%2064%e4%bd%8d%e7%9a%84%e7%bb%93%e6%9e%84%ef%bc%8c%e8%bf%99%e9%87%8c%e6%98%af4%e4%b8%aa%20Level%2014%e7%9a%84%20Cell%ef%bc%8c%e6%89%80%e4%bb%a5%e6%9c%ab%e5%b0%be%e6%9c%89%2064%20-%203%20-%201%20-%2014%20%2a%202%20%3d%2032%20%e4%b8%aa%200%20%e3%80%82%e4%bb%8e%e6%9c%ab%e5%b0%be%e5%be%80%e5%89%8d%e7%9a%84%e7%ac%ac33%e4%bd%8d%e6%98%af%e4%b8%80%e4%b8%aa1%ef%bc%8c%e7%ac%ac34%e4%bd%8d%ef%bc%8c%e7%ac%ac35%e4%bd%8d%e6%98%af%e6%88%91%e4%bb%ac%e9%87%8d%e7%82%b9%e9%9c%80%e8%a6%81%e5%85%b3%e6%b3%a8%e7%9a%84%e3%80%82%e5%8f%af%e4%bb%a5%e7%9c%8b%e5%88%b0%e5%88%86%e5%88%ab%e6%98%af00%ef%bc%8c01%ef%bc%8c10%ef%bc%8c11%20%e3%80%82%e6%ad%a3%e5%a5%bd%e6%98%af%e8%bf%9e%e7%bb%ad%e7%9a%844%e4%b8%aa%e4%ba%8c%e8%bf%9b%e5%88%b6%e3%80%82"><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&t=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#一-寻找父亲节点和孩子节点>一. 寻找父亲节点和孩子节点</a><ul><li><a href=#1-查找孩子节点>1. 查找孩子节点</a></li><li><a href=#2-判断是否是叶子节点>2. 判断是否是叶子节点</a></li><li><a href=#3-查找当前孩子位置关系>3. 查找当前孩子位置关系</a></li><li><a href=#4-查找父亲节点>4. 查找父亲节点</a></li></ul></li><li><a href=#二-lca-查找最近公共祖先>二. LCA 查找最近公共祖先</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Google S2 中的四叉树求 LCA 最近公共祖先</h1><div class=meta><div class=postdate><time datetime="2017-10-20 03:18:00 +0000 UTC" itemprop=datePublished>Oct 20</time></div><div class=article-category><i class="fas fa-archive"></i><a class=category-link href=/categories/go>Go</a>
,
<a class=category-link href=/categories/lca>LCA</a></div><div class=article-tag><i class="fas fa-tag"></i><a class=tag-link href=/tags/go rel=tag>Go</a>
,
<a class=tag-link href=/tags/lca rel=tag>LCA</a></div></div></header><div class=content itemprop=articleBody><h2 id=一-寻找父亲节点和孩子节点>一. 寻找父亲节点和孩子节点</h2><p>首先需要回顾一下希尔伯特曲线的生成方式，具体代码见笔者<a href=https://github.com/halfrost/Halfrost-Field/blob/master/contents/Go/go_spatial_search.md#5-%E5%9D%90%E6%A0%87%E8%BD%B4%E7%82%B9%E4%B8%8E%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF-cell-id-%E7%9B%B8%E4%BA%92%E8%BD%AC%E6%8D%A2>上篇文章的分析</a>，在这个分析中，有4个方向比较重要，接下来的分析需要，所以把这4个方向的图搬过来。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_1.png alt></p><p>在举例之前还需要说明一点，有些网站提供的二进制转换，并没有标明有符号还是无符号的转换，这样就会导致使用者的一些误解。笔者开始并没有发现这个问题，导致掉入了这个坑，好一会才转过弯来。笔者在网上查询了很多在线转换计算器的工具，都发现了这个问题。比如常见的<a href=http://tool.oschina.net/hexconvert>在线进制转换http://tool.oschina.net/hexconvert</a>，随便找两个64位的二进制数，有符号的和无符号的分别转换成十进制，或者反过来转换，你会惊喜的发现，两次结果居然相同！例如你输入 3932700003016900608 和 3932700003016900600，你会发现转换成二进制以后结果都是 11011010010011110000011101000100000000000000000000000000000000。但是很明显这两个数不同。</p><p>假如 3932700003016900608 是无符号的，3932700003016900600 是有符号的，正确的结果应该如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#75715e>// 3932700003016900608
</span><span style=color:#75715e></span><span style=color:#ae81ff>11011010010011110000011101000100000000000000000000000000000000</span>

<span style=color:#75715e>// 3932700003016900600
</span><span style=color:#75715e></span><span style=color:#ae81ff>11011010010011110000011101000011111111111111111111111111111000</span>

</code></pre></div><p>差距明显很大。这种例子其实还有很多，随便再举出几组：无符号的 3932700011606835200 和有符号的 3932700011606835000；无符号的 3932700020196769792 和有符号的 3932700020196770000；无符号的 3932700028786704384 和有符号的 3932700028786704400……可以举的例子很多，这里就不再举了。</p><p>利用网上的这个工具，十进制转二进制是无符号的转换，二进制转十进制就会变成有符号的转换了。而 <strong>Google S2 默认是无符号的 CellID</strong>，所以用有符号的 CellID 会出现错误。所以转换中需要注意一下。笔者之前没有发现这一点的时候出现了一些问题，后来突然发现了这一点，茅塞顿开。</p><p>好了，进入正题。接下来直接看一个例子，笔者用例子来说明每个 Cell 之间的关系，以及如何查找父亲节点的。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_2.png alt></p><p>假设有上图这4个连在一起的 Cell。先根据经纬度把 CellID 计算出来。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_3.png alt></p><p>对应的4个 CellID 分别是：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#a6e22e>由于前两位都是0</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>所以其实可以省略</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>但是为了读者看的更清晰</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>笔者还是补全了64位</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>前面2个0还是补上</span>

<span style=color:#75715e>// 3932700003016900608 右上
</span><span style=color:#75715e></span><span style=color:#ae81ff>0011011010010011110000011101000100000000000000000000000000000000</span>      

<span style=color:#75715e>// 3932700011606835200 左上
</span><span style=color:#75715e></span><span style=color:#ae81ff>0011011010010011110000011101001100000000000000000000000000000000</span> 

<span style=color:#75715e>// 3932700020196769792 左下
</span><span style=color:#75715e></span><span style=color:#ae81ff>0011011010010011110000011101010100000000000000000000000000000000</span>

<span style=color:#75715e>// 3932700028786704384 右下
</span><span style=color:#75715e></span><span style=color:#ae81ff>0011011010010011110000011101011100000000000000000000000000000000</span>


</code></pre></div><p>在前篇文章里面我们也分析了 Cell 64位的结构，这里是4个 Level 14的 Cell，所以末尾有 64 - 3 - 1 - 14 * 2 = 32 个 0 。从末尾往前的第33位是一个1，第34位，第35位是我们重点需要关注的。可以看到分别是00，01，10，11 。正好是连续的4个二进制。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_4.png alt></p><p>根据这个顺序，我们可以匹配到当前这4个 Level 14 的 Cell 对应的顺序是上图图中的图0 。只不过当前方向旋转了45°左右。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_5.png alt></p><p>右上的 CellID 是 3932700003016900608 ，从右往左的第34位和第35位是00，从右上这个 Cell 想找到希尔伯特曲线的下一个 Cell，由于它目前方向是图0的方向，所以右上的 Cell 的下一个 Cell 是左上那个 Cell，那么第34位和第35位就应该是01，变换成01以后，就3932700011606835200，这也就是对应的 CellID。右数第34位增加了一个1，对应十进制就增加了 2^33^ = 8589934592，算一下两个 CellID 对应十进制的差值，也正好是这个数。目前一切都是正确的。</p><p>同理可得，左上的 Cell 的下一个 Cell 就是左下的 Cell，也是相同的第34位和第35位上变成10，对应十进制增加 2^33^ = 8589934592，得到左下的 CellID 为 3932700020196769792。继续同理可以得到最后一个 CellID，右下的 CellID，为 3932700028786704384。</p><p>看到这里，读者应该对查找同 Level 的兄弟节点的方法清清楚楚了。可能有人有疑问了，要查找父亲节点和孩子节点和兄弟有啥关系？他们之间的联系就在这一章节开头说的4个方向图上面。</p><p>回顾一下希尔伯特曲线的生成方式，在递归生成希尔伯特曲线的时候，保存了一个 posToIJ 数组，这个数组里面记录着4个方向。希尔伯特曲线生成的形式和这4个方向是密切相关的。如果忘记了这部分，还请回看之前笔者的<a href=https://github.com/halfrost/Halfrost-Field/blob/master/contents/Go/go_spatial_search.md#5-%E5%9D%90%E6%A0%87%E8%BD%B4%E7%82%B9%E4%B8%8E%E5%B8%8C%E5%B0%94%E4%BC%AF%E7%89%B9%E6%9B%B2%E7%BA%BF-cell-id-%E7%9B%B8%E4%BA%92%E8%BD%AC%E6%8D%A2>文章分析</a>。</p><p>所以同一级的 Level 想查找孩子节点，首先要找到在这一级中，当前 Cell 所处的位置以及当前 Cell 所在的4个方向中的哪一个方向。这个方向决定了要查找孩子位于下一级或者下几级的哪个位置。因为希尔伯特曲线相当于是一个颗四叉树，每个根节点有4个孩子，虽然按层可以很轻松的遍历到孩子所在的层级，但是同一个根节点的孩子有4个，究竟要选哪一个就需要父亲节点的方向一级级的来判断了。</p><p>举个例子来说明这个问题：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>testS2</span>() {

	<span style=color:#a6e22e>latlng</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>LatLngFromDegrees</span>(<span style=color:#ae81ff>29.323773</span>, <span style=color:#ae81ff>107.727194</span>)
	<span style=color:#a6e22e>cellID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>CellIDFromLatLng</span>(<span style=color:#a6e22e>latlng</span>)
	<span style=color:#a6e22e>cell</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>CellFromCellID</span>(<span style=color:#a6e22e>cellID</span>) <span style=color:#75715e>//9279882742634381312
</span><span style=color:#75715e></span>
	<span style=color:#75715e>// cell.Level()
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;latlng = &#34;</span>, <span style=color:#a6e22e>latlng</span>)
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;cell level = &#34;</span>, <span style=color:#a6e22e>cellID</span>.<span style=color:#a6e22e>Level</span>())
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;cell = %d %b\n&#34;</span>, <span style=color:#a6e22e>cellID</span>, <span style=color:#a6e22e>cellID</span>)
	<span style=color:#a6e22e>smallCell</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s2</span>.<span style=color:#a6e22e>CellFromCellID</span>(<span style=color:#a6e22e>cellID</span>.<span style=color:#a6e22e>Parent</span>(<span style=color:#ae81ff>13</span>))
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;smallCell level = %d\n&#34;</span>, <span style=color:#a6e22e>smallCell</span>.<span style=color:#a6e22e>Level</span>())
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;smallCell id = %d / cellID = %d /smallCell(14).Parent = %d (level = %d)/smallCell(15).Parent = %d (level = %d)/cellID(13).Parent = %d (level = %d)/cellID(14).Parent = %d (level = %d)/cellID(15).Parent = %d (level = %d)/ %b \n&#34;</span>, <span style=color:#a6e22e>smallCell</span>.<span style=color:#a6e22e>ID</span>(), <span style=color:#a6e22e>cellID</span>, <span style=color:#a6e22e>smallCell</span>.<span style=color:#a6e22e>ID</span>().<span style=color:#a6e22e>Parent</span>(<span style=color:#ae81ff>14</span>), (<span style=color:#a6e22e>smallCell</span>.<span style=color:#a6e22e>ID</span>().<span style=color:#a6e22e>Parent</span>(<span style=color:#ae81ff>14</span>).<span style=color:#a6e22e>Level</span>()), <span style=color:#a6e22e>smallCell</span>.<span style=color:#a6e22e>ID</span>().<span style=color:#a6e22e>Parent</span>(<span style=color:#ae81ff>15</span>), (<span style=color:#a6e22e>smallCell</span>.<span style=color:#a6e22e>ID</span>().<span style=color:#a6e22e>Parent</span>(<span style=color:#ae81ff>15</span>).<span style=color:#a6e22e>Level</span>()), <span style=color:#a6e22e>cellID</span>.<span style=color:#a6e22e>Parent</span>(<span style=color:#ae81ff>13</span>), (<span style=color:#a6e22e>cellID</span>.<span style=color:#a6e22e>Parent</span>(<span style=color:#ae81ff>13</span>)).<span style=color:#a6e22e>Level</span>(), <span style=color:#a6e22e>cellID</span>.<span style=color:#a6e22e>Parent</span>(<span style=color:#ae81ff>14</span>), (<span style=color:#a6e22e>cellID</span>.<span style=color:#a6e22e>Parent</span>(<span style=color:#ae81ff>14</span>)).<span style=color:#a6e22e>Level</span>(), <span style=color:#a6e22e>cellID</span>.<span style=color:#a6e22e>Parent</span>(<span style=color:#ae81ff>15</span>), (<span style=color:#a6e22e>cellID</span>.<span style=color:#a6e22e>Parent</span>(<span style=color:#ae81ff>15</span>)).<span style=color:#a6e22e>Level</span>(), <span style=color:#a6e22e>smallCell</span>.<span style=color:#a6e22e>ID</span>())

}


</code></pre></div><p>读者考虑一下上述的程序会输出什么呢？或者这样问，同一个节点，先找它的 Level 13 的父亲节点，再通过 Level 13 的这个节点再找它的 Level 15 的父亲节点得到的 Level 15 的节点，和，直接找它的 Level 15 的父亲节点，最终结果一样么？</p><p>当然，这里先找 Level 13，再找 Level 15，得到的结果不是 Level 28，这里不是相加的关系，结果还是 Level 15 的父亲节点。所以上面两种方式得到的结果都是 Level 15的。那么两种做法得到的结果是一样的么？读者可以先猜一猜。</p><p>实际得到的结果如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>

<span style=color:#a6e22e>latlng</span> =  [<span style=color:#ae81ff>29.3237730</span>, <span style=color:#ae81ff>107.7271940</span>]
<span style=color:#a6e22e>cell</span> <span style=color:#a6e22e>level</span> =  <span style=color:#ae81ff>30</span>
<span style=color:#a6e22e>cell</span> = <span style=color:#ae81ff>3932700032807325499</span> <span style=color:#ae81ff>11011010010011110000011101011111101111101001011100111100111011</span>
<span style=color:#a6e22e>smallCell</span> <span style=color:#a6e22e>level</span> = <span style=color:#ae81ff>13</span>
<span style=color:#a6e22e>smallCell</span> <span style=color:#a6e22e>id</span> = <span style=color:#ae81ff>3932700015901802496</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>cellID</span> = <span style=color:#ae81ff>3932700032807325499</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>smallCell</span>(<span style=color:#ae81ff>14</span>).<span style=color:#a6e22e>Parent</span> = <span style=color:#ae81ff>3932700020196769792</span> (<span style=color:#a6e22e>level</span> = <span style=color:#ae81ff>14</span>)<span style=color:#f92672>/</span><span style=color:#a6e22e>smallCell</span>(<span style=color:#ae81ff>15</span>).<span style=color:#a6e22e>Parent</span> = <span style=color:#ae81ff>3932700016975544320</span> (<span style=color:#a6e22e>level</span> = <span style=color:#ae81ff>15</span>)<span style=color:#f92672>/</span><span style=color:#a6e22e>cellID</span>(<span style=color:#ae81ff>13</span>).<span style=color:#a6e22e>Parent</span> = <span style=color:#ae81ff>3932700015901802496</span> (<span style=color:#a6e22e>level</span> = <span style=color:#ae81ff>13</span>)<span style=color:#f92672>/</span><span style=color:#a6e22e>cellID</span>(<span style=color:#ae81ff>14</span>).<span style=color:#a6e22e>Parent</span> = <span style=color:#ae81ff>3932700028786704384</span> (<span style=color:#a6e22e>level</span> = <span style=color:#ae81ff>14</span>)<span style=color:#f92672>/</span><span style=color:#a6e22e>cellID</span>(<span style=color:#ae81ff>15</span>).<span style=color:#a6e22e>Parent</span> = <span style=color:#ae81ff>3932700032007929856</span> (<span style=color:#a6e22e>level</span> = <span style=color:#ae81ff>15</span>)<span style=color:#f92672>/</span> <span style=color:#ae81ff>11011010010011110000011101010000000000000000000000000000000000</span>

</code></pre></div><p>可以看到，两种做法得到的结果是不同的。但是究竟哪里不同呢？直接看 CellID 不够直观，那把它们俩画出来看看。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_6.png alt></p><p>可以看到两者虽然 Level 是相同的，但是位置是不同的，为何会这样呢？原因就是之前说的，四叉树4个孩子，究竟选择哪一个，是由于父亲节点所在方向决定的。</p><h3 id=1-查找孩子节点>1. 查找孩子节点</h3><p>还是继续按照上面程序举的例子，看看如何查找孩子节点的。</p><p>我们把 Level 13 - Level 17 的节点都打印出来。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#a6e22e>smallCell</span> <span style=color:#a6e22e>id</span> = <span style=color:#ae81ff>3932700015901802496</span> (<span style=color:#a6e22e>level</span> = <span style=color:#ae81ff>13</span>)<span style=color:#f92672>/</span>
<span style=color:#a6e22e>smallCell</span>(<span style=color:#ae81ff>14</span>).<span style=color:#a6e22e>Parent</span> = <span style=color:#ae81ff>3932700020196769792</span> (<span style=color:#a6e22e>level</span> = <span style=color:#ae81ff>14</span>)<span style=color:#f92672>/</span> 
<span style=color:#a6e22e>smallCell</span>(<span style=color:#ae81ff>15</span>).<span style=color:#a6e22e>Parent</span> = <span style=color:#ae81ff>3932700016975544320</span> (<span style=color:#a6e22e>level</span> = <span style=color:#ae81ff>15</span>)<span style=color:#f92672>/</span>
<span style=color:#a6e22e>smallCell</span>(<span style=color:#ae81ff>16</span>).<span style=color:#a6e22e>Parent</span> = <span style=color:#ae81ff>3932700016170237952</span> (<span style=color:#a6e22e>level</span> = <span style=color:#ae81ff>16</span>)<span style=color:#f92672>/</span>
<span style=color:#a6e22e>smallCell</span>(<span style=color:#ae81ff>17</span>).<span style=color:#a6e22e>Parent</span> = <span style=color:#ae81ff>3932700015968911360</span> (<span style=color:#a6e22e>level</span> = <span style=color:#ae81ff>17</span>)<span style=color:#f92672>/</span>

</code></pre></div><p>画在图上，</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_7.png alt></p><p>从 Level 13 是如何变换到 Level 14 的呢？我们知道当前选择的是图0的方向。那么当前 Level 14是图0 中的2号的位置。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_8.png alt></p><p>所以从右往左数 64 - 3 - 1 - 13 * 2 = 34位和35位，应该分别填上01，从前往后就是10，对应的就是上图中的2的位置，并且末尾的那个标志位1往后再挪2位。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#ae81ff>11011010010011110000011101010000000000000000000000000000000000</span>   <span style=color:#ae81ff>13</span>
<span style=color:#ae81ff>11011010010011110000011101010100000000000000000000000000000000</span>   <span style=color:#ae81ff>14</span>  

</code></pre></div><p>即可从 Level 13 变换到 Level 14 。这就是从父亲节点到孩子节点的变换方法。</p><p>同理在看看 Level 15，Level 16，Level 17 的变换方法。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_9.png alt></p><p>前面说过，查看孩子节点的时候需要知道当前节点的其他3个兄弟节点的方向。</p><p>根据下图，Level 14 对应的是图0，并且当前选择了2号位置，从下图中可以看到图0中的2号位置的下一级的图是“U”形的，说明还是图0的样子。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_10.png alt></p><p>所以可以知道当前 Level 14 所处的方向依旧是图0 。按照方向标识在图上，如下图。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_11.png alt></p><p>所以如果还是选择上图中0号的位置，那么 Level 15 的从右往左数 64 - 3 - 1 - 14 * 2 = 32位和第33位上填入00 。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#ae81ff>11011010010011110000011101010100000000000000000000000000000000</span>   <span style=color:#ae81ff>14</span> 
<span style=color:#ae81ff>11011010010011110000011101010001000000000000000000000000000000</span>   <span style=color:#ae81ff>15</span>

</code></pre></div><p>由于选择了图0的0号位置，所以下一级的方向对应的是图1 。(注意整个图的方向是向左旋转了90°) 。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_12.png alt></p><p>图1中继续选择0号的位置，所以 Level 16 的从右往左数 64 - 3 - 1 - 15 * 2 = 30位和31位填上00 。那么就可以得到 Level 16 。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>

<span style=color:#ae81ff>11011010010011110000011101010001000000000000000000000000000000</span>   <span style=color:#ae81ff>15</span>
<span style=color:#ae81ff>11011010010011110000011101010000010000000000000000000000000000</span>   <span style=color:#ae81ff>16</span>

</code></pre></div><p>由于选择了图1的0号位置，所以下一级的方向对应的是还是图0。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_13.png alt></p><p>图0中继续选择0号的位置，所以 Level 17 的从右往左数 64 - 3 - 1 - 16 * 2 = 28位和第29位填上00 。那么就可以得到 Level 17 。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#ae81ff>11011010010011110000011101010000010000000000000000000000000000</span>   <span style=color:#ae81ff>16</span>
<span style=color:#ae81ff>11011010010011110000011101010000000100000000000000000000000000</span>   <span style=color:#ae81ff>17</span>

</code></pre></div><p>同理，其他的孩子节点都可以按照这个方法推算得到。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_14.png alt></p><p>从 Level 13 开始，由于 Level 13 对应的方向是图0，当前选择3号位置，就可以得到 Level 14，所以 Level 14 的末尾标志位1前面的两位是 11 。于是就可以从 Level 13 变换到 Level 14 。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#ae81ff>11011010010011110000011101010000000000000000000000000000000000</span>   <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>3932700015901802496</span>
<span style=color:#ae81ff>11011010010011110000011101011100000000000000000000000000000000</span>   <span style=color:#ae81ff>14</span> <span style=color:#ae81ff>3932700028786704384</span>

</code></pre></div><p>由于图0选择了3号位置，那么 Level 14 的方向就是图3 。</p><p>Level 14 对应的方向是图3，当前选择3号位置，就可以得到 Level 15，所以 Level 15 的末尾标志位1前面的两位是 11 。于是就可以从 Level 14 变换到 Level 15 。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#ae81ff>11011010010011110000011101011100000000000000000000000000000000</span>   <span style=color:#ae81ff>14</span> <span style=color:#ae81ff>3932700028786704384</span>
<span style=color:#ae81ff>11011010010011110000011101011111000000000000000000000000000000</span>   <span style=color:#ae81ff>15</span> <span style=color:#ae81ff>3932700032007929856</span>


</code></pre></div><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_15.png alt></p><p>由于图3选择了3号位置，那么 Level 15 的方向就是图0。</p><p>Level 15 对应的方向是图0，当前选择0号位置，就可以得到 Level 16，所以 Level 16 的末尾标志位1前面的两位是 00 。于是就可以从 Level 15 变换到 Level 16 。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#ae81ff>11011010010011110000011101011111000000000000000000000000000000</span>   <span style=color:#ae81ff>15</span> <span style=color:#ae81ff>3932700032007929856</span>
<span style=color:#ae81ff>11011010010011110000011101011110010000000000000000000000000000</span>   <span style=color:#ae81ff>16</span> <span style=color:#ae81ff>3932700031202623488</span>

</code></pre></div><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_16.png alt></p><p>由于图0选择了0号位置，那么 Level 16 的方向就是图1。</p><p>Level 16 对应的方向是图1，当前选择1号位置，就可以得到 Level 17，所以 Level 17 的末尾标志位1前面的两位是 01 。于是就可以从 Level 16 变换到 Level 17 。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#ae81ff>11011010010011110000011101011110010000000000000000000000000000</span>   <span style=color:#ae81ff>16</span> <span style=color:#ae81ff>3932700031202623488</span>
<span style=color:#ae81ff>11011010010011110000011101011110001100000000000000000000000000</span>   <span style=color:#ae81ff>17</span> <span style=color:#ae81ff>3932700031135514624</span>

</code></pre></div><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_17.png alt></p><p>由于图1选择了1号位置，那么 Level 18 的方向还是图1。</p><p>到此读者应该对查找 CellID 孩子节点的流程了然于心了。在 Google S2 中，查找孩子节点的具体实现代码如下。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ci</span> <span style=color:#a6e22e>CellID</span>) <span style=color:#a6e22e>Children</span>() [<span style=color:#ae81ff>4</span>]<span style=color:#a6e22e>CellID</span> {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ch</span> [<span style=color:#ae81ff>4</span>]<span style=color:#a6e22e>CellID</span>
	<span style=color:#a6e22e>lsb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>CellID</span>(<span style=color:#a6e22e>ci</span>.<span style=color:#a6e22e>lsb</span>())
	<span style=color:#a6e22e>ch</span>[<span style=color:#ae81ff>0</span>] = <span style=color:#a6e22e>ci</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>lsb</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>lsb</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>2</span>
	<span style=color:#a6e22e>lsb</span> <span style=color:#f92672>&gt;&gt;=</span> <span style=color:#ae81ff>1</span>
	<span style=color:#a6e22e>ch</span>[<span style=color:#ae81ff>1</span>] = <span style=color:#a6e22e>ch</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>lsb</span>
	<span style=color:#a6e22e>ch</span>[<span style=color:#ae81ff>2</span>] = <span style=color:#a6e22e>ch</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>lsb</span>
	<span style=color:#a6e22e>ch</span>[<span style=color:#ae81ff>3</span>] = <span style=color:#a6e22e>ch</span>[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>lsb</span>
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ch</span>
}

</code></pre></div><p>现在在来看这段代码应该毫无压力了吧。</p><p>这里比较重要的位运算的操作就是 lsb 了。从名字上其实也可以知道它是做什么的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#75715e>// lsb 返回最低有效位
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ci</span> <span style=color:#a6e22e>CellID</span>) <span style=color:#a6e22e>lsb</span>() <span style=color:#66d9ef>uint64</span> { <span style=color:#66d9ef>return</span> uint64(<span style=color:#a6e22e>ci</span>) <span style=color:#f92672>&amp;</span> <span style=color:#f92672>-</span>uint64(<span style=color:#a6e22e>ci</span>) }

</code></pre></div><p>这里需要注意的一点就是负数的存储方式是以原码的补码，即符号位不变，每位取反再加1 。</p><p>举个例子，Level 16 的某个 CellID 如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#ae81ff>11011010010011110000011101011110010000000000000000000000000000</span>   <span style=color:#ae81ff>16</span> <span style=color:#ae81ff>3932700031202623488</span>

</code></pre></div><p>对它进行 lsb 计算：</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_18.png alt></p><p>得到的结果就是最低有效位为1，其他每位都为0 。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#a6e22e>ch</span>[<span style=color:#ae81ff>0</span>] = <span style=color:#a6e22e>ci</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>lsb</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>lsb</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>2</span>

</code></pre></div><p>这一行实际是把 Level 对应的下一级 Level 的末尾标志位1移动到位。即往后挪2位。并且标志位前面2位都为0，所以这步操作完成以后就是0号的孩子。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_19.png alt></p><p>0号孩子找到以后接下来就很好办了。lsb 往右移动一位以后，不断的加上这个值，就可以得到剩下的4个孩子了。如下图：</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_20.png alt></p><p>这样就可以得到4个孩子，上面这一小段程序挺简单的，比前面从地图上解释的更简单，原因是因为没有可视化的4个孩子的相互位置关系，这个关系需要从当前所在的方向来决定。前面地图上也一再强调每一级的方向位置关系也是为了可视化展现在地图上是符合希尔伯特曲线的相对位置。</p><h3 id=2-判断是否是叶子节点>2. 判断是否是叶子节点</h3><p>如果对 CellID 的数据结构很了解，这个判断就很简单了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ci</span> <span style=color:#a6e22e>CellID</span>) <span style=color:#a6e22e>IsLeaf</span>() <span style=color:#66d9ef>bool</span> { <span style=color:#66d9ef>return</span> uint64(<span style=color:#a6e22e>ci</span>)<span style=color:#f92672>&amp;</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> }

</code></pre></div><p>由于 CellID 是64位的，末尾有一个1的标志位，如果这个标志位到了最后一位，那么就肯定是叶子节点了，也就是 Level 30 的 Cell。</p><h3 id=3-查找当前孩子位置关系>3. 查找当前孩子位置关系</h3><p>在前面讲解查找孩子节点的时候，由于是四叉树，每个父亲下面对应4个孩子，00，01，10，11，所以判断4个孩子之间相对的位置关系只需要判断这两个二进制位就可以了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ci</span> <span style=color:#a6e22e>CellID</span>) <span style=color:#a6e22e>ChildPosition</span>(<span style=color:#a6e22e>level</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
	<span style=color:#66d9ef>return</span> int(uint64(<span style=color:#a6e22e>ci</span>)<span style=color:#f92672>&gt;&gt;</span>uint64(<span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>(<span style=color:#a6e22e>maxLevel</span><span style=color:#f92672>-</span><span style=color:#a6e22e>level</span>)<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>3</span>
}

</code></pre></div><p>上面这个函数入参是一个父亲节点的 Level 等级，返回的是这个父亲节点下面孩子节点的位置信息。即是 00，01，10，11 中的一个。</p><h3 id=4-查找父亲节点>4. 查找父亲节点</h3><p>在 Google S2 中，由于默认生成出来的 Cell 就是 Level 30 的，也就是 Level 最低的，位于树的最下层的叶子节点。所以生成 Level 比较低的 Cell 必须只能查找父亲节点。</p><p>由于前面讲解了如何查找孩子节点，查找父亲节点就是逆向的过程。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>lsbForLevel</span>(<span style=color:#a6e22e>level</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>uint64</span> { <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> uint64(<span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>(<span style=color:#a6e22e>maxLevel</span><span style=color:#f92672>-</span><span style=color:#a6e22e>level</span>)) }

</code></pre></div><p>第一步就是先找到最右边的标志位，它决定了 Level 的值。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
(uint64(<span style=color:#a6e22e>ci</span>) <span style=color:#f92672>&amp;</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>lsb</span>)

</code></pre></div><p>第二步是保留住标志位前面所有的二进制位上的值。这里对第一步的 lsb 的相反数进行按位与操作就可以实现。lsb 的相反数其实就是 lsb 低位往左的高位都为1 ，相当于一个掩码。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_21.png alt></p><p>最后一步将标志位1放好就可以了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ci</span> <span style=color:#a6e22e>CellID</span>) <span style=color:#a6e22e>Parent</span>(<span style=color:#a6e22e>level</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>CellID</span> {
	<span style=color:#a6e22e>lsb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lsbForLevel</span>(<span style=color:#a6e22e>level</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>CellID</span>((uint64(<span style=color:#a6e22e>ci</span>) <span style=color:#f92672>&amp;</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>lsb</span>) | <span style=color:#a6e22e>lsb</span>)
}


</code></pre></div><p>以上就是查找父亲节点的具体实现。</p><h2 id=二-lca-查找最近公共祖先>二. LCA 查找最近公共祖先</h2><p>关于 CellID 的计算，还有很关键的一部分就是查找最近公共祖先的问题。问题背景：给定一棵四叉树中任意两个 Level 的 CellID ，如何查询两者的最近公共祖先。</p><p>由 CellID 的数据结构我们知道，想查找两个 Level 的最近公共祖先的问题可以转化为从左往右查找两个二进制串最长公共序列，最长的即是从根节点开始最远的公共祖先，也就是最近公共祖先。</p><p>那么现在问题就转换成从左往右找到第一个不相同的二进制位，或者从右往左找到最后一个不相同的二进制位。</p><p>查找过程中存在一个特殊情况，那就是要查找公共祖先的两个节点本身就在一个分支上，即其中一个 CellID 本来就是另外一个 CellID 的祖先，那么他们俩的公共祖先就直接是 CellID 大的那个。</p><p>那么到此就可以确定出接下来查找的流程。</p><p>第一步，先对两个 CellID 进行异或，找到不同的二进制位分别在那些位置上。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
	<span style=color:#a6e22e>bits</span> <span style=color:#f92672>:=</span> uint64(<span style=color:#a6e22e>ci</span> ^ <span style=color:#a6e22e>other</span>)

</code></pre></div><p>第二步，判断是否存在特殊情况：两个存在祖先关系。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bits</span> &lt; <span style=color:#a6e22e>ci</span>.<span style=color:#a6e22e>lsb</span>() {
		<span style=color:#a6e22e>bits</span> = <span style=color:#a6e22e>ci</span>.<span style=color:#a6e22e>lsb</span>()
	}
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bits</span> &lt; <span style=color:#a6e22e>other</span>.<span style=color:#a6e22e>lsb</span>() {
		<span style=color:#a6e22e>bits</span> = <span style=color:#a6e22e>other</span>.<span style=color:#a6e22e>lsb</span>()
	}


</code></pre></div><p>第三步，查找左边最高位不同的位置。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>findMSBSetNonZero64</span>(<span style=color:#a6e22e>bits</span> <span style=color:#66d9ef>uint64</span>) <span style=color:#66d9ef>int</span> {
	<span style=color:#a6e22e>val</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>uint64</span>{<span style=color:#ae81ff>0x2</span>, <span style=color:#ae81ff>0xC</span>, <span style=color:#ae81ff>0xF0</span>, <span style=color:#ae81ff>0xFF00</span>, <span style=color:#ae81ff>0xFFFF0000</span>, <span style=color:#ae81ff>0xFFFFFFFF00000000</span>}
	<span style=color:#a6e22e>shift</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>uint64</span>{<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>32</span>}
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>msbPos</span> <span style=color:#66d9ef>uint64</span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>5</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>--</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bits</span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>val</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
			<span style=color:#a6e22e>bits</span> <span style=color:#f92672>&gt;&gt;=</span> <span style=color:#a6e22e>shift</span>[<span style=color:#a6e22e>i</span>]
			<span style=color:#a6e22e>msbPos</span> <span style=color:#f92672>|=</span> <span style=color:#a6e22e>shift</span>[<span style=color:#a6e22e>i</span>]
		}
	}
	<span style=color:#66d9ef>return</span> int(<span style=color:#a6e22e>msbPos</span>)
}

</code></pre></div><p>由于 CellID 是 64 位的，所以两者不同的位数可能的范围是 [0，63]。分别准备6种掩码，对应的分别是0x2, 0xC, 0xF0, 0xFF00, 0xFFFF0000, 0xFFFFFFFF00000000。如下图。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/61_22.png alt></p><p>查找的过程就是利用的二分的思想。64位先查找高位32位，如果对高32位的掩码进行按位与运算以后结果不为0，那么就说明高32位是存在不相同的位数的，那么最终结果 msbPos 加上32位，并把数字右移32位。因为高32位存在不同的数，由于我们需要求最左边的，所以低32位就可以直接舍去了，直接右移去掉。</p><p>同理，继续二分，16位，8位，4位，2位，1位，这样循环完，就一定能把最左边的不同的位数找到，并且结果位即为 msbPos。</p><p>第四步，判断 msbPos 的合法性，并输出最终结果。</p><p>如果 msbPos 比60还要大，那么就是非法值，直接返回 false 即可。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
	<span style=color:#a6e22e>msbPos</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>findMSBSetNonZero64</span>(<span style=color:#a6e22e>bits</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msbPos</span> &gt; <span style=color:#ae81ff>60</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>false</span>
	}
	<span style=color:#66d9ef>return</span> (<span style=color:#ae81ff>60</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>msbPos</span>) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>true</span>

</code></pre></div><p>最终输出的为最近公共祖先的 Level 值，所以 60 - msbPos 以后还需要再除以2 。</p><p>完整的算法实现如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ci</span> <span style=color:#a6e22e>CellID</span>) <span style=color:#a6e22e>CommonAncestorLevel</span>(<span style=color:#a6e22e>other</span> <span style=color:#a6e22e>CellID</span>) (<span style=color:#a6e22e>level</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>ok</span> <span style=color:#66d9ef>bool</span>) {
	<span style=color:#a6e22e>bits</span> <span style=color:#f92672>:=</span> uint64(<span style=color:#a6e22e>ci</span> ^ <span style=color:#a6e22e>other</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bits</span> &lt; <span style=color:#a6e22e>ci</span>.<span style=color:#a6e22e>lsb</span>() {
		<span style=color:#a6e22e>bits</span> = <span style=color:#a6e22e>ci</span>.<span style=color:#a6e22e>lsb</span>()
	}
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>bits</span> &lt; <span style=color:#a6e22e>other</span>.<span style=color:#a6e22e>lsb</span>() {
		<span style=color:#a6e22e>bits</span> = <span style=color:#a6e22e>other</span>.<span style=color:#a6e22e>lsb</span>()
	}

	<span style=color:#a6e22e>msbPos</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>findMSBSetNonZero64</span>(<span style=color:#a6e22e>bits</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msbPos</span> &gt; <span style=color:#ae81ff>60</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>false</span>
	}
	<span style=color:#66d9ef>return</span> (<span style=color:#ae81ff>60</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>msbPos</span>) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>true</span>
}

</code></pre></div><p>举个例子：</p><p>在上面的例子中，我们挑选不存在祖先关系的两个 Level 的 CellID。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#ae81ff>11011010010011110000011101010000000100000000000000000000000000</span>   <span style=color:#ae81ff>17</span>
<span style=color:#ae81ff>11011010010011110000011101011111000000000000000000000000000000</span>   <span style=color:#ae81ff>15</span>

</code></pre></div><p>如果从这串二进制里面直接找最近公共祖先，一定可以发现，从左往右最长的公共二进制串是：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#ae81ff>1101101001001111000001110101</span>

</code></pre></div><p>那么他们俩的最近公共祖先就是：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>
<span style=color:#ae81ff>11011010010011110000011101010000000000000000000000000000000000</span>

</code></pre></div><p>对应的 Level 是13，CellID 是 3932700015901802496。</p><hr><p>空间搜索系列文章：</p><p><a href=https://github.com/halfrost/Halfrost-Field/blob/master/contents/Go/n-dimensional_space_and_n-dimensional_space-time.md>如何理解 n 维空间和 n 维时空</a><br><a href=https://github.com/halfrost/Halfrost-Field/blob/master/contents/Go/go_spatial_search.md>高效的多维空间点索引算法 — Geohash 和 Google S2</a><br><a href=https://github.com/halfrost/Halfrost-Field/blob/master/contents/Go/go_s2_lowest_common_ancestor.md>Google S2 中的四叉树求 LCA 最近公共祖先</a></p><blockquote><p>GitHub Repo：<a href=https://github.com/halfrost/Halfrost-Field>Halfrost-Field</a></p><p>Follow: <a href=https://github.com/halfrost>halfrost · GitHub</a></p><p>Source: <a href=https://halfrost.com/go_s2_lowest_common_ancestor/>https://halfrost.com/go_s2_lowest_common_ancestor/</a></p></blockquote><img src=https://img.halfrost.com/wechat-qr-code.png></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=https://books.halfrost.com/>Books</a></li><li><a href=https://github.com/halfrost/Halfrost-Field>Github</a></li><li><a href=https://halfrost.me/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#一-寻找父亲节点和孩子节点>一. 寻找父亲节点和孩子节点</a><ul><li><a href=#1-查找孩子节点>1. 查找孩子节点</a></li><li><a href=#2-判断是否是叶子节点>2. 判断是否是叶子节点</a></li><li><a href=#3-查找当前孩子位置关系>3. 查找当前孩子位置关系</a></li><li><a href=#4-查找父亲节点>4. 查找父亲节点</a></li></ul></li><li><a href=#二-lca-查找最近公共祖先>二. LCA 查找最近公共祖先</a></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f"><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&text=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&title=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&is_video=false&description=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88&body=Check out this article: https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f"><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&title=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&title=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&title=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-stumbleupon fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&title=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-digg fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&name=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88&description=%e4%b8%80.%20%e5%af%bb%e6%89%be%e7%88%b6%e4%ba%b2%e8%8a%82%e7%82%b9%e5%92%8c%e5%ad%a9%e5%ad%90%e8%8a%82%e7%82%b9%20%e9%a6%96%e5%85%88%e9%9c%80%e8%a6%81%e5%9b%9e%e9%a1%be%e4%b8%80%e4%b8%8b%e5%b8%8c%e5%b0%94%e4%bc%af%e7%89%b9%e6%9b%b2%e7%ba%bf%e7%9a%84%e7%94%9f%e6%88%90%e6%96%b9%e5%bc%8f%ef%bc%8c%e5%85%b7%e4%bd%93%e4%bb%a3%e7%a0%81%e8%a7%81%e7%ac%94%e8%80%85%e4%b8%8a%e7%af%87%e6%96%87%e7%ab%a0%e7%9a%84%e5%88%86%e6%9e%90%ef%bc%8c%e5%9c%a8%e8%bf%99%e4%b8%aa%e5%88%86%e6%9e%90%e4%b8%ad%ef%bc%8c%e6%9c%894%e4%b8%aa%e6%96%b9%e5%90%91%e6%af%94%e8%be%83%e9%87%8d%e8%a6%81%ef%bc%8c%e6%8e%a5%e4%b8%8b%e6%9d%a5%e7%9a%84%e5%88%86%e6%9e%90%e9%9c%80%e8%a6%81%ef%bc%8c%e6%89%80%e4%bb%a5%e6%8a%8a%e8%bf%994%e4%b8%aa%e6%96%b9%e5%90%91%e7%9a%84%e5%9b%be%e6%90%ac%e8%bf%87%e6%9d%a5%e3%80%82%0a%e5%9c%a8%e4%b8%be%e4%be%8b%e4%b9%8b%e5%89%8d%e8%bf%98%e9%9c%80%e8%a6%81%e8%af%b4%e6%98%8e%e4%b8%80%e7%82%b9%ef%bc%8c%e6%9c%89%e4%ba%9b%e7%bd%91%e7%ab%99%e6%8f%90%e4%be%9b%e7%9a%84%e4%ba%8c%e8%bf%9b%e5%88%b6%e8%bd%ac%e6%8d%a2%ef%bc%8c%e5%b9%b6%e6%b2%a1%e6%9c%89%e6%a0%87%e6%98%8e%e6%9c%89%e7%ac%a6%e5%8f%b7%e8%bf%98%e6%98%af%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%e8%bd%ac%e6%8d%a2%ef%bc%8c%e8%bf%99%e6%a0%b7%e5%b0%b1%e4%bc%9a%e5%af%bc%e8%87%b4%e4%bd%bf%e7%94%a8%e8%80%85%e7%9a%84%e4%b8%80%e4%ba%9b%e8%af%af%e8%a7%a3%e3%80%82%e7%ac%94%e8%80%85%e5%bc%80%e5%a7%8b%e5%b9%b6%e6%b2%a1%e6%9c%89%e5%8f%91%e7%8e%b0%e8%bf%99%e4%b8%aa%e9%97%ae%e9%a2%98%ef%bc%8c%e5%af%bc%e8%87%b4%e6%8e%89%e5%85%a5%e4%ba%86%e8%bf%99%e4%b8%aa%e5%9d%91%ef%bc%8c%e5%a5%bd%e4%b8%80%e4%bc%9a%e6%89%8d%e8%bd%ac%e8%bf%87%e5%bc%af%e6%9d%a5%e3%80%82%e7%ac%94%e8%80%85%e5%9c%a8%e7%bd%91%e4%b8%8a%e6%9f%a5%e8%af%a2%e4%ba%86%e5%be%88%e5%a4%9a%e5%9c%a8%e7%ba%bf%e8%bd%ac%e6%8d%a2%e8%ae%a1%e7%ae%97%e5%99%a8%e7%9a%84%e5%b7%a5%e5%85%b7%ef%bc%8c%e9%83%bd%e5%8f%91%e7%8e%b0%e4%ba%86%e8%bf%99%e4%b8%aa%e9%97%ae%e9%a2%98%e3%80%82%e6%af%94%e5%a6%82%e5%b8%b8%e8%a7%81%e7%9a%84%e5%9c%a8%e7%ba%bf%e8%bf%9b%e5%88%b6%e8%bd%ac%e6%8d%a2http%3a%2f%2ftool.oschina.net%2fhexconvert%ef%bc%8c%e9%9a%8f%e4%be%bf%e6%89%be%e4%b8%a4%e4%b8%aa64%e4%bd%8d%e7%9a%84%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%95%b0%ef%bc%8c%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%e5%92%8c%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%e5%88%86%e5%88%ab%e8%bd%ac%e6%8d%a2%e6%88%90%e5%8d%81%e8%bf%9b%e5%88%b6%ef%bc%8c%e6%88%96%e8%80%85%e5%8f%8d%e8%bf%87%e6%9d%a5%e8%bd%ac%e6%8d%a2%ef%bc%8c%e4%bd%a0%e4%bc%9a%e6%83%8a%e5%96%9c%e7%9a%84%e5%8f%91%e7%8e%b0%ef%bc%8c%e4%b8%a4%e6%ac%a1%e7%bb%93%e6%9e%9c%e5%b1%85%e7%84%b6%e7%9b%b8%e5%90%8c%ef%bc%81%e4%be%8b%e5%a6%82%e4%bd%a0%e8%be%93%e5%85%a5%203932700003016900608%20%e5%92%8c%203932700003016900600%ef%bc%8c%e4%bd%a0%e4%bc%9a%e5%8f%91%e7%8e%b0%e8%bd%ac%e6%8d%a2%e6%88%90%e4%ba%8c%e8%bf%9b%e5%88%b6%e4%bb%a5%e5%90%8e%e7%bb%93%e6%9e%9c%e9%83%bd%e6%98%af%2011011010010011110000011101000100000000000000000000000000000000%e3%80%82%e4%bd%86%e6%98%af%e5%be%88%e6%98%8e%e6%98%be%e8%bf%99%e4%b8%a4%e4%b8%aa%e6%95%b0%e4%b8%8d%e5%90%8c%e3%80%82%0a%e5%81%87%e5%a6%82%203932700003016900608%20%e6%98%af%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%ef%bc%8c3932700003016900600%20%e6%98%af%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%ef%bc%8c%e6%ad%a3%e7%a1%ae%e7%9a%84%e7%bb%93%e6%9e%9c%e5%ba%94%e8%af%a5%e5%a6%82%e4%b8%8b%ef%bc%9a%0a%2f%2f%203932700003016900608%2011011010010011110000011101000100000000000000000000000000000000%20%2f%2f%203932700003016900600%2011011010010011110000011101000011111111111111111111111111111000%20%e5%b7%ae%e8%b7%9d%e6%98%8e%e6%98%be%e5%be%88%e5%a4%a7%e3%80%82%e8%bf%99%e7%a7%8d%e4%be%8b%e5%ad%90%e5%85%b6%e5%ae%9e%e8%bf%98%e6%9c%89%e5%be%88%e5%a4%9a%ef%bc%8c%e9%9a%8f%e4%be%bf%e5%86%8d%e4%b8%be%e5%87%ba%e5%87%a0%e7%bb%84%ef%bc%9a%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700011606835200%20%e5%92%8c%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700011606835000%ef%bc%9b%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700020196769792%20%e5%92%8c%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700020196770000%ef%bc%9b%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700028786704384%20%e5%92%8c%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%203932700028786704400%e2%80%a6%e2%80%a6%e5%8f%af%e4%bb%a5%e4%b8%be%e7%9a%84%e4%be%8b%e5%ad%90%e5%be%88%e5%a4%9a%ef%bc%8c%e8%bf%99%e9%87%8c%e5%b0%b1%e4%b8%8d%e5%86%8d%e4%b8%be%e4%ba%86%e3%80%82%0a%e5%88%a9%e7%94%a8%e7%bd%91%e4%b8%8a%e7%9a%84%e8%bf%99%e4%b8%aa%e5%b7%a5%e5%85%b7%ef%bc%8c%e5%8d%81%e8%bf%9b%e5%88%b6%e8%bd%ac%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%98%af%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%e8%bd%ac%e6%8d%a2%ef%bc%8c%e4%ba%8c%e8%bf%9b%e5%88%b6%e8%bd%ac%e5%8d%81%e8%bf%9b%e5%88%b6%e5%b0%b1%e4%bc%9a%e5%8f%98%e6%88%90%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%e8%bd%ac%e6%8d%a2%e4%ba%86%e3%80%82%e8%80%8c%20Google%20S2%20%e9%bb%98%e8%ae%a4%e6%98%af%e6%97%a0%e7%ac%a6%e5%8f%b7%e7%9a%84%20CellID%ef%bc%8c%e6%89%80%e4%bb%a5%e7%94%a8%e6%9c%89%e7%ac%a6%e5%8f%b7%e7%9a%84%20CellID%20%e4%bc%9a%e5%87%ba%e7%8e%b0%e9%94%99%e8%af%af%e3%80%82%e6%89%80%e4%bb%a5%e8%bd%ac%e6%8d%a2%e4%b8%ad%e9%9c%80%e8%a6%81%e6%b3%a8%e6%84%8f%e4%b8%80%e4%b8%8b%e3%80%82%e7%ac%94%e8%80%85%e4%b9%8b%e5%89%8d%e6%b2%a1%e6%9c%89%e5%8f%91%e7%8e%b0%e8%bf%99%e4%b8%80%e7%82%b9%e7%9a%84%e6%97%b6%e5%80%99%e5%87%ba%e7%8e%b0%e4%ba%86%e4%b8%80%e4%ba%9b%e9%97%ae%e9%a2%98%ef%bc%8c%e5%90%8e%e6%9d%a5%e7%aa%81%e7%84%b6%e5%8f%91%e7%8e%b0%e4%ba%86%e8%bf%99%e4%b8%80%e7%82%b9%ef%bc%8c%e8%8c%85%e5%a1%9e%e9%a1%bf%e5%bc%80%e3%80%82%0a%e5%a5%bd%e4%ba%86%ef%bc%8c%e8%bf%9b%e5%85%a5%e6%ad%a3%e9%a2%98%e3%80%82%e6%8e%a5%e4%b8%8b%e6%9d%a5%e7%9b%b4%e6%8e%a5%e7%9c%8b%e4%b8%80%e4%b8%aa%e4%be%8b%e5%ad%90%ef%bc%8c%e7%ac%94%e8%80%85%e7%94%a8%e4%be%8b%e5%ad%90%e6%9d%a5%e8%af%b4%e6%98%8e%e6%af%8f%e4%b8%aa%20Cell%20%e4%b9%8b%e9%97%b4%e7%9a%84%e5%85%b3%e7%b3%bb%ef%bc%8c%e4%bb%a5%e5%8f%8a%e5%a6%82%e4%bd%95%e6%9f%a5%e6%89%be%e7%88%b6%e4%ba%b2%e8%8a%82%e7%82%b9%e7%9a%84%e3%80%82%0a%e5%81%87%e8%ae%be%e6%9c%89%e4%b8%8a%e5%9b%be%e8%bf%994%e4%b8%aa%e8%bf%9e%e5%9c%a8%e4%b8%80%e8%b5%b7%e7%9a%84%20Cell%e3%80%82%e5%85%88%e6%a0%b9%e6%8d%ae%e7%bb%8f%e7%ba%ac%e5%ba%a6%e6%8a%8a%20CellID%20%e8%ae%a1%e7%ae%97%e5%87%ba%e6%9d%a5%e3%80%82%0a%e5%af%b9%e5%ba%94%e7%9a%844%e4%b8%aa%20CellID%20%e5%88%86%e5%88%ab%e6%98%af%ef%bc%9a%0a%e7%94%b1%e4%ba%8e%e5%89%8d%e4%b8%a4%e4%bd%8d%e9%83%bd%e6%98%af0%ef%bc%8c%e6%89%80%e4%bb%a5%e5%85%b6%e5%ae%9e%e5%8f%af%e4%bb%a5%e7%9c%81%e7%95%a5%ef%bc%8c%e4%bd%86%e6%98%af%e4%b8%ba%e4%ba%86%e8%af%bb%e8%80%85%e7%9c%8b%e7%9a%84%e6%9b%b4%e6%b8%85%e6%99%b0%ef%bc%8c%e7%ac%94%e8%80%85%e8%bf%98%e6%98%af%e8%a1%a5%e5%85%a8%e4%ba%8664%e4%bd%8d%ef%bc%8c%e5%89%8d%e9%9d%a22%e4%b8%aa0%e8%bf%98%e6%98%af%e8%a1%a5%e4%b8%8a%20%2f%2f%203932700003016900608%20%e5%8f%b3%e4%b8%8a%200011011010010011110000011101000100000000000000000000000000000000%20%2f%2f%203932700011606835200%20%e5%b7%a6%e4%b8%8a%200011011010010011110000011101001100000000000000000000000000000000%20%2f%2f%203932700020196769792%20%e5%b7%a6%e4%b8%8b%200011011010010011110000011101010100000000000000000000000000000000%20%2f%2f%203932700028786704384%20%e5%8f%b3%e4%b8%8b%200011011010010011110000011101011100000000000000000000000000000000%20%e5%9c%a8%e5%89%8d%e7%af%87%e6%96%87%e7%ab%a0%e9%87%8c%e9%9d%a2%e6%88%91%e4%bb%ac%e4%b9%9f%e5%88%86%e6%9e%90%e4%ba%86%20Cell%2064%e4%bd%8d%e7%9a%84%e7%bb%93%e6%9e%84%ef%bc%8c%e8%bf%99%e9%87%8c%e6%98%af4%e4%b8%aa%20Level%2014%e7%9a%84%20Cell%ef%bc%8c%e6%89%80%e4%bb%a5%e6%9c%ab%e5%b0%be%e6%9c%89%2064%20-%203%20-%201%20-%2014%20%2a%202%20%3d%2032%20%e4%b8%aa%200%20%e3%80%82%e4%bb%8e%e6%9c%ab%e5%b0%be%e5%be%80%e5%89%8d%e7%9a%84%e7%ac%ac33%e4%bd%8d%e6%98%af%e4%b8%80%e4%b8%aa1%ef%bc%8c%e7%ac%ac34%e4%bd%8d%ef%bc%8c%e7%ac%ac35%e4%bd%8d%e6%98%af%e6%88%91%e4%bb%ac%e9%87%8d%e7%82%b9%e9%9c%80%e8%a6%81%e5%85%b3%e6%b3%a8%e7%9a%84%e3%80%82%e5%8f%af%e4%bb%a5%e7%9c%8b%e5%88%b0%e5%88%86%e5%88%ab%e6%98%af00%ef%bc%8c01%ef%bc%8c10%ef%bc%8c11%20%e3%80%82%e6%ad%a3%e5%a5%bd%e6%98%af%e8%bf%9e%e7%bb%ad%e7%9a%844%e4%b8%aa%e4%ba%8c%e8%bf%9b%e5%88%b6%e3%80%82"><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fnew.halfrost.com%2fgo_s2_lowest_common_ancestor%2f&t=Google%20S2%20%e4%b8%ad%e7%9a%84%e5%9b%9b%e5%8f%89%e6%a0%91%e6%b1%82%20LCA%20%e6%9c%80%e8%bf%91%e5%85%ac%e5%85%b1%e7%a5%96%e5%85%88"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu class=icon href=# onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden=true></i>Menu</a>
<a id=toc class=icon href=# onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden=true></i>TOC</a>
<a id=share class=icon href=# onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden=true></i>share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i>Top</a></div></div></div><footer id=footer><div class=footer-left><p class=copyright style=float:left;margin-bottom:0><a href=https://github.com/halfrost/Halfrost-Field class=github-repo style=height:18px><span class=gadget-github></span>Star</a>
Copyright &copy;halfrost 2016 - 2021
<a href=http://www.miit.gov.cn/>鄂ICP备16014744号</a></p><br><p class="copyright statistics" style=margin-bottom:20px><span id=busuanzi_container_site_pv>Cumulative Page Views <span id=busuanzi_value_site_pv></span>| Unique Visitors <span id=busuanzi_value_site_uv></span></span></p></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/main.min.f870a4d110314b9e50e65f8ac982dc1c9c376c8f1a5083d39c62cfc49073f011.js></script><script async src=/prism.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}};</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>