<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=theme-color content="#FFFFFF"><meta http-equiv=x-ua-compatible content="IE=edge"><title>HTTPS 温故知新（六） —— TLS 中的 Extensions | prometheus</title><meta name=description content="Explore in every moment of the hard thinking"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="HTTPS 温故知新（六） —— TLS 中的 Extensions"><meta property="og:description" content="扩展是 TLS 比较重要的一个知识点。它的存在能让 Client 和 Server 在不更新 TLS 的基础上，获得新的能力。扩展的官方文档在 [RFC 6066] 中定义。Extension 像 TLS 中的一系列可水平扩展的插件。
Client 在 ClientHello 中申明多个自己可以支持的 Extension，以向 Server 表示自己有以下这些能力，或者向 Server 协商某些协议。Server 收到 ClientHello 以后，依次解析 Extension，有些如果需要立即回应，就在 ServerHello 中作出回应，有些不需要回应，或者 Server 不支持的 Extension 就不用响应，忽略不处理。
TLS 握手中的 Extension 有以下几个特点:
  Extension 不影响 TLS 握手的成功与否。Server 对 ClientHello 中的 Extension 有些不支持，忽略不处理即可，不影响握手的流程。
  ServerHello 中回应 Client 的 Extension 一定要是 ClientHello 中的 Extension 的子集(小于等于)。ServerHello 中禁止出现 ClientHello 中没有出现的 Extension。如果一个 Client 在 ServerHello 中收到一个扩展类型但在相关的 ClientHello 中并没有请求，它必须用一个 unsupported_extension 致命 alert 消息来丢弃握手。"><meta property="og:type" content="article"><meta property="og:url" content="https://new.halfrost.com/https-extensions/"><meta property="article:published_time" content="2019-03-17T03:08:00+00:00"><meta property="article:modified_time" content="2019-03-17T03:08:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="HTTPS 温故知新（六） —— TLS 中的 Extensions"><meta name=twitter:description content="扩展是 TLS 比较重要的一个知识点。它的存在能让 Client 和 Server 在不更新 TLS 的基础上，获得新的能力。扩展的官方文档在 [RFC 6066] 中定义。Extension 像 TLS 中的一系列可水平扩展的插件。
Client 在 ClientHello 中申明多个自己可以支持的 Extension，以向 Server 表示自己有以下这些能力，或者向 Server 协商某些协议。Server 收到 ClientHello 以后，依次解析 Extension，有些如果需要立即回应，就在 ServerHello 中作出回应，有些不需要回应，或者 Server 不支持的 Extension 就不用响应，忽略不处理。
TLS 握手中的 Extension 有以下几个特点:
  Extension 不影响 TLS 握手的成功与否。Server 对 ClientHello 中的 Extension 有些不支持，忽略不处理即可，不影响握手的流程。
  ServerHello 中回应 Client 的 Extension 一定要是 ClientHello 中的 Extension 的子集(小于等于)。ServerHello 中禁止出现 ClientHello 中没有出现的 Extension。如果一个 Client 在 ServerHello 中收到一个扩展类型但在相关的 ClientHello 中并没有请求，它必须用一个 unsupported_extension 致命 alert 消息来丢弃握手。"><link rel=stylesheet href=/css/style-white.min.css><link rel=manifest href=/manifest.json><link rel=stylesheet href=/prism.css><link href=/images/apple-touch-icon-60x60.png rel=apple-touch-icon sizes=60x60><link href=/images/apple-touch-icon-76x76.png rel=apple-touch-icon sizes=76x76><link href=/images/apple-touch-icon-120x120.png rel=apple-touch-icon sizes=120x120><link href=/images/apple-touch-icon-152x152.png rel=apple-touch-icon sizes=152x152><link href=/images/apple-touch-icon-180x180.png rel=apple-touch-icon sizes=180x180><link href=/images/apple-touch-icon-512x512.png rel=apple-touch-icon sizes=512x512><link href=/images/apple-touch-icon-1024x1024.png rel=apple-touch-icon sizes=1024x1024><script async>if('serviceWorker'in navigator){navigator.serviceWorker.register("\/serviceworker-v1.min.a64912b78d282eab1ad3715a0943da21616e5f326f8afea27034784ad445043b.js").then(function(){if(navigator.serviceWorker.controller){console.log('Assets cached by the controlling service worker.');}else{console.log('Please reload this page to allow the service worker to handle network operations.');}}).catch(function(error){console.log('ERROR: '+error);});}else{console.log('Service workers are not supported in the current browser.');}</script><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://new.halfrost.com/images/favicon.ico><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-82753806-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="single-max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a><a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a><a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast');" style=display:none><i class="fas fa-chevron-up fa-lg"></i></a><span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=https://books.halfrost.com/>Books</a></li><li><a href=https://github.com/halfrost/Halfrost-Field>Github</a></li><li><a href=https://halfrost.me/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://new.halfrost.com/https-key-cipher/><i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li><li><a class=icon href=https://new.halfrost.com/http2_begin/><i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li><li><a class=icon href=#><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f"><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&text=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&title=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&is_video=false&description=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions&body=Check out this article: https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f"><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&title=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&title=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&title=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-stumbleupon" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&title=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-digg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&name=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions&description=%e6%89%a9%e5%b1%95%e6%98%af%20TLS%20%e6%af%94%e8%be%83%e9%87%8d%e8%a6%81%e7%9a%84%e4%b8%80%e4%b8%aa%e7%9f%a5%e8%af%86%e7%82%b9%e3%80%82%e5%ae%83%e7%9a%84%e5%ad%98%e5%9c%a8%e8%83%bd%e8%ae%a9%20Client%20%e5%92%8c%20Server%20%e5%9c%a8%e4%b8%8d%e6%9b%b4%e6%96%b0%20TLS%20%e7%9a%84%e5%9f%ba%e7%a1%80%e4%b8%8a%ef%bc%8c%e8%8e%b7%e5%be%97%e6%96%b0%e7%9a%84%e8%83%bd%e5%8a%9b%e3%80%82%e6%89%a9%e5%b1%95%e7%9a%84%e5%ae%98%e6%96%b9%e6%96%87%e6%a1%a3%e5%9c%a8%20%5bRFC%206066%5d%20%e4%b8%ad%e5%ae%9a%e4%b9%89%e3%80%82Extension%20%e5%83%8f%20TLS%20%e4%b8%ad%e7%9a%84%e4%b8%80%e7%b3%bb%e5%88%97%e5%8f%af%e6%b0%b4%e5%b9%b3%e6%89%a9%e5%b1%95%e7%9a%84%e6%8f%92%e4%bb%b6%e3%80%82%0aClient%20%e5%9c%a8%20ClientHello%20%e4%b8%ad%e7%94%b3%e6%98%8e%e5%a4%9a%e4%b8%aa%e8%87%aa%e5%b7%b1%e5%8f%af%e4%bb%a5%e6%94%af%e6%8c%81%e7%9a%84%20Extension%ef%bc%8c%e4%bb%a5%e5%90%91%20Server%20%e8%a1%a8%e7%a4%ba%e8%87%aa%e5%b7%b1%e6%9c%89%e4%bb%a5%e4%b8%8b%e8%bf%99%e4%ba%9b%e8%83%bd%e5%8a%9b%ef%bc%8c%e6%88%96%e8%80%85%e5%90%91%20Server%20%e5%8d%8f%e5%95%86%e6%9f%90%e4%ba%9b%e5%8d%8f%e8%ae%ae%e3%80%82Server%20%e6%94%b6%e5%88%b0%20ClientHello%20%e4%bb%a5%e5%90%8e%ef%bc%8c%e4%be%9d%e6%ac%a1%e8%a7%a3%e6%9e%90%20Extension%ef%bc%8c%e6%9c%89%e4%ba%9b%e5%a6%82%e6%9e%9c%e9%9c%80%e8%a6%81%e7%ab%8b%e5%8d%b3%e5%9b%9e%e5%ba%94%ef%bc%8c%e5%b0%b1%e5%9c%a8%20ServerHello%20%e4%b8%ad%e4%bd%9c%e5%87%ba%e5%9b%9e%e5%ba%94%ef%bc%8c%e6%9c%89%e4%ba%9b%e4%b8%8d%e9%9c%80%e8%a6%81%e5%9b%9e%e5%ba%94%ef%bc%8c%e6%88%96%e8%80%85%20Server%20%e4%b8%8d%e6%94%af%e6%8c%81%e7%9a%84%20Extension%20%e5%b0%b1%e4%b8%8d%e7%94%a8%e5%93%8d%e5%ba%94%ef%bc%8c%e5%bf%bd%e7%95%a5%e4%b8%8d%e5%a4%84%e7%90%86%e3%80%82%0aTLS%20%e6%8f%a1%e6%89%8b%e4%b8%ad%e7%9a%84%20Extension%20%e6%9c%89%e4%bb%a5%e4%b8%8b%e5%87%a0%e4%b8%aa%e7%89%b9%e7%82%b9%3a%0a%20%20Extension%20%e4%b8%8d%e5%bd%b1%e5%93%8d%20TLS%20%e6%8f%a1%e6%89%8b%e7%9a%84%e6%88%90%e5%8a%9f%e4%b8%8e%e5%90%a6%e3%80%82Server%20%e5%af%b9%20ClientHello%20%e4%b8%ad%e7%9a%84%20Extension%20%e6%9c%89%e4%ba%9b%e4%b8%8d%e6%94%af%e6%8c%81%ef%bc%8c%e5%bf%bd%e7%95%a5%e4%b8%8d%e5%a4%84%e7%90%86%e5%8d%b3%e5%8f%af%ef%bc%8c%e4%b8%8d%e5%bd%b1%e5%93%8d%e6%8f%a1%e6%89%8b%e7%9a%84%e6%b5%81%e7%a8%8b%e3%80%82%0a%20%20ServerHello%20%e4%b8%ad%e5%9b%9e%e5%ba%94%20Client%20%e7%9a%84%20Extension%20%e4%b8%80%e5%ae%9a%e8%a6%81%e6%98%af%20ClientHello%20%e4%b8%ad%e7%9a%84%20Extension%20%e7%9a%84%e5%ad%90%e9%9b%86%28%e5%b0%8f%e4%ba%8e%e7%ad%89%e4%ba%8e%29%e3%80%82ServerHello%20%e4%b8%ad%e7%a6%81%e6%ad%a2%e5%87%ba%e7%8e%b0%20ClientHello%20%e4%b8%ad%e6%b2%a1%e6%9c%89%e5%87%ba%e7%8e%b0%e7%9a%84%20Extension%e3%80%82%e5%a6%82%e6%9e%9c%e4%b8%80%e4%b8%aa%20Client%20%e5%9c%a8%20ServerHello%20%e4%b8%ad%e6%94%b6%e5%88%b0%e4%b8%80%e4%b8%aa%e6%89%a9%e5%b1%95%e7%b1%bb%e5%9e%8b%e4%bd%86%e5%9c%a8%e7%9b%b8%e5%85%b3%e7%9a%84%20ClientHello%20%e4%b8%ad%e5%b9%b6%e6%b2%a1%e6%9c%89%e8%af%b7%e6%b1%82%ef%bc%8c%e5%ae%83%e5%bf%85%e9%a1%bb%e7%94%a8%e4%b8%80%e4%b8%aa%20unsupported_extension%20%e8%87%b4%e5%91%bd%20alert%20%e6%b6%88%e6%81%af%e6%9d%a5%e4%b8%a2%e5%bc%83%e6%8f%a1%e6%89%8b%e3%80%82"><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&t=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><a href=#一-tls-12-握手中的-extension>一. TLS 1.2 握手中的 extension</a><ul><li><a href=#1-server_name>1. server_name</a></li><li><a href=#2-extended_master_secret>2. extended_master_secret</a></li><li><a href=#3-renegotiation_info-重协商>3. renegotiation_info 重协商</a></li><li><a href=#4-supported_groups>4. supported_groups</a></li><li><a href=#5-ec_point_formats>5. ec_point_formats</a></li><li><a href=#6-sessionticket-tls>6. SessionTicket TLS</a></li><li><a href=#7-application_layer_protocol_negotiation>7. application_layer_protocol_negotiation</a></li><li><a href=#8-status_request>8. status_request</a></li><li><a href=#9-signature_algorithms>9. signature_algorithms</a></li></ul></li><li><a href=#二-tls-13-握手中的-extension>二. TLS 1.3 握手中的 extension</a><ul><li><a href=#1-signed_certificate_timestamp>1. signed_certificate_timestamp</a></li><li><a href=#2-key_share>2. key_share</a></li><li><a href=#3-psk_key_exchange_modes>3. psk_key_exchange_modes</a></li><li><a href=#4-supported_versions>4. supported_versions</a></li><li><a href=#5-early_data>5. early_data</a></li><li><a href=#6-pre_shared_key>6. pre_shared_key</a></li><li><a href=#7-signature_algorithms_cert>7. signature_algorithms_cert</a></li><li><a href=#8-cookie>8. cookie</a></li><li><a href=#9-certificate_authorities>9. certificate_authorities</a></li><li><a href=#10-oid_filters>10. oid_filters</a></li><li><a href=#11-post_handshake_auth>11. post_handshake_auth</a></li><li><a href=#12-signature_algorithms>12. signature_algorithms</a></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">HTTPS 温故知新（六） —— TLS 中的 Extensions</h1><div class=meta><div class=postdate><time datetime="2019-03-17 03:08:00 +0000 UTC" itemprop=datePublished>Mar 17</time></div><div class=article-category><i class="fas fa-archive"></i><a class=category-link href=/categories/protocol>Protocol</a>
,
<a class=category-link href=/categories/https>HTTPS</a></div><div class=article-tag><i class="fas fa-tag"></i><a class=tag-link href=/tags/protocol rel=tag>Protocol</a>
,
<a class=tag-link href=/tags/https rel=tag>HTTPS</a></div></div></header><div class=content itemprop=articleBody><p>扩展是 TLS 比较重要的一个知识点。它的存在能让 Client 和 Server 在不更新 TLS 的基础上，获得新的能力。扩展的官方文档在 <a href=https://tools.ietf.org/html/rfc6066>[RFC 6066]</a> 中定义。<strong>Extension 像 TLS 中的一系列可水平扩展的插件</strong>。</p><p>Client 在 ClientHello 中申明多个自己可以支持的 Extension，以向 Server 表示自己有以下这些能力，或者向 Server 协商某些协议。Server 收到 ClientHello 以后，依次解析 Extension，有些如果需要立即回应，就在 ServerHello 中作出回应，有些不需要回应，或者 Server 不支持的 Extension 就不用响应，忽略不处理。</p><p>TLS 握手中的 Extension 有以下几个特点:</p><ul><li><p>Extension 不影响 TLS 握手的成功与否。Server 对 ClientHello 中的 Extension 有些不支持，忽略不处理即可，不影响握手的流程。</p></li><li><p>ServerHello 中回应 Client 的 Extension 一定要是 ClientHello 中的 Extension 的子集(小于等于)。ServerHello 中禁止出现 ClientHello 中没有出现的 Extension。如果一个 Client 在 ServerHello 中收到一个扩展类型但在相关的 ClientHello 中并没有请求，它必须用一个 unsupported_extension 致命 alert 消息来丢弃握手。</p></li><li><p>当 ClientHello 或 ServerHello 中有多个不同类型的扩展存在时，这些扩展可能会以任意顺序出现。一个类型不能拥有超过一个扩展。</p></li><li><p>所有的 Extension 都必须考虑会话恢复的情况，保证安全性。</p></li></ul><blockquote><p>&ldquo;面向 Server"的扩展将来可以在 TLS 中提供。这样的一个扩展(比如, 类型 X 的扩展)可能要求 Client 首先发送一个类型 X 的扩展在 ClientHello 中，并且 extension_data 为空以表示它支持扩展类型。在这个例子中，Client 提供了理解扩展类型的能力，Server 基于 Client 提供的内容与其进行通信。</p></blockquote><p>本篇文章，笔者打算对比一下 TLS 1.2 和 TLS 1.3 握手中的 extension。</p><h2 id=一-tls-12-握手中的-extension>一. TLS 1.2 握手中的 extension</h2><p>在 <a href=https://tools.ietf.org/html/rfc6066>[RFC 6066]</a> 中定义了很多 Extension，这些 Extension 在 TLS 1.2 中基本都在使用。</p><table><thead><tr><th align=center>扩展类型名称</th><th align=center>扩展类型编号</th><th align=center>TLS 1.3 中使用情况</th><th align=center>是否推荐</th><th align=center>RFC 文档出处</th></tr></thead><tbody><tr><td align=center>server_name</td><td align=center>0</td><td align=center>CH, EE</td><td align=center>✅</td><td align=center>RFC 6066</td></tr><tr><td align=center>max_fragment_length</td><td align=center>1</td><td align=center>CH, EE</td><td align=center>❌</td><td align=center>RFC 6066</td></tr><tr><td align=center>client_certificate_url</td><td align=center>2</td><td align=center></td><td align=center>✅</td><td align=center>RFC 6066</td></tr><tr><td align=center>trusted_ca_keys</td><td align=center>3</td><td align=center></td><td align=center>✅</td><td align=center>RFC 6066</td></tr><tr><td align=center>truncated_hmac</td><td align=center>4</td><td align=center></td><td align=center>❌</td><td align=center>RFC 6066</td></tr><tr><td align=center>status_request</td><td align=center>5</td><td align=center>CH, CR, CT</td><td align=center>✅</td><td align=center>RFC 6066</td></tr><tr><td align=center>user_mapping</td><td align=center>6</td><td align=center></td><td align=center>✅</td><td align=center>RFC 4681</td></tr><tr><td align=center>client_authz</td><td align=center>7</td><td align=center></td><td align=center>❌</td><td align=center>RFC 5878</td></tr><tr><td align=center>server_authz</td><td align=center>8</td><td align=center></td><td align=center>❌</td><td align=center>RFC 5878</td></tr><tr><td align=center>cert_type</td><td align=center>9</td><td align=center></td><td align=center>❌</td><td align=center>RFC 6091</td></tr><tr><td align=center>supported_groups(renamed from &ldquo;elliptic_curves&rdquo;)</td><td align=center>10</td><td align=center>CH, EE</td><td align=center>✅</td><td align=center>RFC 7919</td></tr><tr><td align=center>ec_point_formats</td><td align=center>11</td><td align=center></td><td align=center>✅</td><td align=center>RFC 8422</td></tr><tr><td align=center>srp</td><td align=center>12</td><td align=center></td><td align=center>❌</td><td align=center>RFC 5054</td></tr><tr><td align=center>signature_algorithms</td><td align=center>13</td><td align=center>CH, CR</td><td align=center>✅</td><td align=center>RFC 5246</td></tr><tr><td align=center>use_srtp</td><td align=center>14</td><td align=center>CH, EE</td><td align=center>✅</td><td align=center>RFC 5764</td></tr><tr><td align=center>heartbeat</td><td align=center>15</td><td align=center>CH, EE</td><td align=center>✅</td><td align=center>RFC 6520</td></tr><tr><td align=center>application_layer_protocol_negotiation</td><td align=center>16</td><td align=center>CH, EE</td><td align=center>✅</td><td align=center>RFC 7301</td></tr><tr><td align=center>status_request_v2</td><td align=center>17</td><td align=center></td><td align=center>✅</td><td align=center>RFC 6961</td></tr><tr><td align=center>signed_certificate_timestamp</td><td align=center>18</td><td align=center>CH, CR, CT</td><td align=center>❌</td><td align=center>RFC 6962</td></tr><tr><td align=center>client_certificate_type</td><td align=center>19</td><td align=center>CH, EE</td><td align=center>✅</td><td align=center>RFC7250</td></tr><tr><td align=center>server_certificate_type</td><td align=center>20</td><td align=center>CH, EE</td><td align=center>✅</td><td align=center>RFC7250</td></tr><tr><td align=center>padding</td><td align=center>21</td><td align=center>CH</td><td align=center>✅</td><td align=center>RFC7685</td></tr><tr><td align=center>encrypt_then_mac</td><td align=center>22</td><td align=center></td><td align=center>✅</td><td align=center>RFC7366</td></tr><tr><td align=center>extended_master_secret</td><td align=center>23</td><td align=center></td><td align=center>✅</td><td align=center>RFC 7627</td></tr><tr><td align=center>token_binding</td><td align=center>24</td><td align=center></td><td align=center>✅</td><td align=center>RFC8472</td></tr><tr><td align=center>cached_info</td><td align=center>25</td><td align=center></td><td align=center>✅</td><td align=center>RFC7924</td></tr><tr><td align=center>tls_lts</td><td align=center>26</td><td align=center></td><td align=center>❌</td><td align=center>draft-gutmann-tls-lts</td></tr><tr><td align=center>compress_certificate (TEMPORARY - registered 2018-05-23, expires 2019-05-23)</td><td align=center>27</td><td align=center>CH, CR</td><td align=center>✅</td><td align=center>draft-ietf-tls-certificate-compression</td></tr><tr><td align=center>record_size_limit</td><td align=center>28</td><td align=center>CH, EE</td><td align=center>✅</td><td align=center>RFC8449</td></tr><tr><td align=center>pwd_protect</td><td align=center>29</td><td align=center>CH</td><td align=center>❌</td><td align=center>RFC-harkins-tls-dragonfly-03</td></tr><tr><td align=center>pwd_clear</td><td align=center>30</td><td align=center>CH</td><td align=center>❌</td><td align=center>RFC-harkins-tls-dragonfly-03</td></tr><tr><td align=center>password_salt</td><td align=center>31</td><td align=center>CH, SH, HRR</td><td align=center>❌</td><td align=center>RFC-harkins-tls-dragonfly-03</td></tr><tr><td align=center>Unassigned</td><td align=center>32</td><td align=center></td><td align=center>❌</td><td align=center></td></tr><tr><td align=center>Unassigned</td><td align=center>33</td><td align=center></td><td align=center>❌</td><td align=center></td></tr><tr><td align=center>Unassigned</td><td align=center>34</td><td align=center></td><td align=center>❌</td><td align=center></td></tr><tr><td align=center>session_ticket (renamed from &ldquo;SessionTicket TLS&rdquo;)</td><td align=center>35</td><td align=center></td><td align=center>✅</td><td align=center>RFC 4507</td></tr><tr><td align=center>Unassigned</td><td align=center>36</td><td align=center></td><td align=center>❌</td><td align=center></td></tr><tr><td align=center>Unassigned</td><td align=center>37</td><td align=center></td><td align=center>❌</td><td align=center></td></tr><tr><td align=center>Unassigned</td><td align=center>38</td><td align=center></td><td align=center>❌</td><td align=center></td></tr><tr><td align=center>Unassigned</td><td align=center>39</td><td align=center></td><td align=center>❌</td><td align=center></td></tr><tr><td align=center>Unassigned</td><td align=center>40</td><td align=center></td><td align=center>❌</td><td align=center></td></tr><tr><td align=center>Unassigned</td><td align=center>52-65279</td><td align=center></td><td align=center>❌</td><td align=center></td></tr><tr><td align=center>renegotiation_info</td><td align=center>65281</td><td align=center></td><td align=center>✅</td><td align=center>RFC 5746</td></tr></tbody></table><blockquote><p>缩写注解: CH: ClientHello，SH: ServerHello，CR: CertificateRequest，EE:EncryptedExtensions，HRR: HelloRetryRequest，CT: Certificate</p></blockquote><p>上面这些 Extension 也有对应的 ExtensionType，这里只列举一些常用的 ExtensionType，并非所有:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>enum</span> {
          server_name(<span style=color:#ae81ff>0</span>), 
          max_fragment_length(<span style=color:#ae81ff>1</span>),
          client_certificate_url(<span style=color:#ae81ff>2</span>), 
          trusted_ca_keys(<span style=color:#ae81ff>3</span>),
          truncated_hmac(<span style=color:#ae81ff>4</span>), 
          status_request(<span style=color:#ae81ff>5</span>), 
          supported_groups(<span style=color:#ae81ff>10</span>),
          ec_point_formats(<span style=color:#ae81ff>11</span>),
          signature_algorithms(<span style=color:#ae81ff>13</span>),
          application_layer_protocol_negotiation(<span style=color:#ae81ff>16</span>),
          signed_certificate_timestamp(<span style=color:#ae81ff>18</span>),
          extended_master_secret(<span style=color:#ae81ff>23</span>),
          SessionTicket TLS(<span style=color:#ae81ff>35</span>),
          renegotiation_info(<span style=color:#ae81ff>65281</span>)
          (<span style=color:#ae81ff>65535</span>)
      } ExtensionType;
</code></pre></div><p>每个 Extension 的数据结构如下:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {
          ExtensionType extension_type;
          opaque extension_data<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
      } Extension;
</code></pre></div><p>Extension 是由 <code>extension_type</code> 和 <code>extension_data</code> 共同构成的。有些 Extension 是没有 <code>extension_data</code> 的。所以 <code>extension_type</code> 占 2 个字节，后面 <code>extension_data</code> 是 &lt;0..2^16-1> 可变长度。</p><p>通常, 每个扩展类型的规范需要描述扩展对全部握手流程和会话恢复的影响。大多数当前的 TLS 扩展仅当一个会话被初始化时才是相关联的: 当一个旧的会话被恢复时，Server 不会处理 Client Hello 中的扩展，也不会将其包含在 Server Hello 中。然而, 一些扩展可以在会话恢复时指定不同的行为.</p><p>在这个协议的新特性与现存特性之间会有一些敏感(以及不很敏感)的交互产生, 这可能会导致整体安全性的显著降低。当设计新的扩展时应考虑下列事项:</p><ul><li><p>一些情况 Server 没有就一个扩展协商一致是错误情况，一些情况下则简单地拒绝支持特定特性。通常，错误警报应该用于前者，Server 扩展中的一个域用于响应后者。</p></li><li><p>扩展应该尽可能在设计上阻止任何通过操纵握手消息来强制使用(或不使用)一个特殊特性进行的攻击。无论这个特性是否被确认会导致安全问题，这个原则都应该被遵循。通常扩展域扩展域都会被包含在 Finished 消息的 hash 输入中，但需要给予极大关注的是在握手阶段扩展改变了发送消息的含义。设计者和实现者应该注意的事实是，握手被认证后，活动的攻击者才能修改消息并插入，移动或替换扩展。</p></li><li><p>使用扩展来改变 TLS 设计的主要方面在技术上是可能的；例如密码套件协商的设计。这种做法并不被推荐；更合适的做法是定义一个新版本的 TLS &ndash; 尤其是 TLS 握手算法有特定的保护方法以防御基于版本号的版本回退攻击，版本回退攻击的可能性应该在任何主要的修改设计中都是一个有意义的考量。</p></li></ul><p>我们知道在 ClientHello 中，Compression Methods 字段之后就是 Extension 了，所以我们从 Compression Methods 字段之后逐一看起。</p><h3 id=1-server_name>1. server_name</h3><p>server_name 扩展比较简单，存储的就是 Server 的名字。</p><p>TLS 没有为 Client 提供一种机制来告诉 Server 它正在建立链接的 Server 的名称。Client 可能希望提供此信息以促进与在单个底层网络地址处托管多个“虚拟”服务的 Server 的安全连接。</p><p>当 Client 连接 HTTPS 网站的时候，解析出 IP 地址以后，就能创建 TLS 连接，在握手完成之前，Server 接收到的消息中并没有 host HTTP 的头部。如果这个 Server 有多个虚拟的服务，每个服务都有一张证书，那么此时 Server 不知道该用哪一张证书。</p><p>于是为了解决这个问题，增加了 SNI 扩展。用这个扩展就能区别出各个服务对应的证书了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {
          NameType name_type;
          select (name_type) {
              <span style=color:#66d9ef>case</span> host_name: HostName;
          } name;
      } ServerName;

      <span style=color:#66d9ef>enum</span> {
          host_name(<span style=color:#ae81ff>0</span>), (<span style=color:#ae81ff>255</span>)
      } NameType;

      opaque HostName<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;

      <span style=color:#66d9ef>struct</span> {
          ServerName server_name_list<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>
      } ServerNameList;
</code></pre></div><p>支持 TLS 1.2 的 Server 在 ServerHello 中响应该扩展，返回如下：</p><p>TLS 1.3 中也同样在 ServerHello 中响应该扩展，返回如下：</p><p>返回的是一个空的扩展即可。</p><h3 id=2-extended_master_secret>2. extended_master_secret</h3><p>这个 Extension 标识 Client 和 Server 使用增强型主密钥计算方式。</p><p>Server 在 ServerHello 中响应该扩展，返回如下：</p><p>Server 返回了一个空的 extended_master_secret 扩展，表明会使用增强型主密钥计算方式。关于增强型主密钥计算方式，见 <a href=https://github.com/halfrost/Halfrost-Field/blob/master/contents/Protocol/HTTPS-key-cipher.md>《HTTPS 温故知新（五） —— TLS 中的密钥计算》</a> 这篇文章。</p><h3 id=3-renegotiation_info-重协商>3. renegotiation_info 重协商</h3><p>在安全性要求比较高的场景中，如果 Server 发现当前加密算法不够安全，或者需要校验 Client 证书的时候，需要建立一个新的链接，这个时候就需要用到重协商。重协商的协议设计初衷是好的，但是由于 2009 年出现了一个针对重协商的漏洞 CVE-2009-3555，导致 Server 和 Client 发起的重协商都是不安全的。出现漏洞的原因是没有校验 Client 和 Server 的身份，因为双方没法判断重协商的链接是不是原有链接的对端。</p><p>为了解决这个问题，所以在 RFC 5746 中增加了这个 Extension，增加了这个 Extension 以后，重协商就安全了。</p><p>这个扩展的数据结构非常简单：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {
          opaque renegotiated_connection<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0.</span>.<span style=color:#ae81ff>.255</span><span style=color:#f92672>&gt;</span>;
      }
</code></pre></div><p>Server 在 ServerHello 中响应该扩展，返回如下：</p><h3 id=4-supported_groups>4. supported_groups</h3><p>这个扩展原名叫 &ldquo;elliptic_curves&rdquo;，后来更名成 &ldquo;supported_groups&rdquo;。从原名的意思就能看出来这个扩展的意义。它标识了 Client 支持的椭圆曲线的种类。</p><p>这个例子中，Client 支持 4 种椭圆曲线，x25519、secp256r1、secp384r1、secp521r1。</p><p>Server 接收到这个扩展会根据这些信息进行选择合适的椭圆曲线。</p><p>TLS 1.3 中支持的所有曲线如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>enum</span> {
          unallocated_RESERVED(<span style=color:#ae81ff>0x0000</span>),

          <span style=color:#75715e>/* Elliptic Curve Groups (ECDHE) */</span>
          obsolete_RESERVED(<span style=color:#ae81ff>0x0001</span>.<span style=color:#ae81ff>.0</span>x0016),
          secp256r1(<span style=color:#ae81ff>0x0017</span>), secp384r1(<span style=color:#ae81ff>0x0018</span>), secp521r1(<span style=color:#ae81ff>0x0019</span>),
          obsolete_RESERVED(<span style=color:#ae81ff>0x001A</span>.<span style=color:#ae81ff>.0</span>x001C),
          x25519(<span style=color:#ae81ff>0x001D</span>), x448(<span style=color:#ae81ff>0x001E</span>),

          <span style=color:#75715e>/* Finite Field Groups (DHE) */</span>
          ffdhe2048(<span style=color:#ae81ff>0x0100</span>), ffdhe3072(<span style=color:#ae81ff>0x0101</span>), ffdhe4096(<span style=color:#ae81ff>0x0102</span>),
          ffdhe6144(<span style=color:#ae81ff>0x0103</span>), ffdhe8192(<span style=color:#ae81ff>0x0104</span>),

          <span style=color:#75715e>/* Reserved Code Points */</span>
          ffdhe_private_use(<span style=color:#ae81ff>0x01FC</span>.<span style=color:#ae81ff>.0</span>x01FF),
          ecdhe_private_use(<span style=color:#ae81ff>0xFE00</span>.<span style=color:#ae81ff>.0</span>xFEFF),
          obsolete_RESERVED(<span style=color:#ae81ff>0xFF01</span>.<span style=color:#ae81ff>.0</span>xFF02),
          (<span style=color:#ae81ff>0xFFFF</span>)
      } NamedGroup;

      <span style=color:#66d9ef>struct</span> {
          NamedGroup named_group_list<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>2..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
      } NamedGroupList;
</code></pre></div><p>标记了 &ldquo;obsolete_RESERVED&rdquo; 的曲线是在以前版本的 TLS 中使用过的，不得由 TLS 1.3 实现提供或协商。因为这些过时的曲线具有各种已知/理论上的弱点或者使用的非常少，它们不再被认为适合一般用途，应该被认为可能不安全。此处指定的曲线集足以与所有当前部署和正确配置的 TLS 实现进行互操作。</p><h3 id=5-ec_point_formats>5. ec_point_formats</h3><p>这个扩展标识了是否能对椭圆曲线参数进行压缩。一般不启用压缩(uncompressed)。</p><p>Server 在 ServerHello 中响应该扩展，返回如下：</p><h3 id=6-sessionticket-tls>6. SessionTicket TLS</h3><p>这个扩展表明了 Client 端是否有上次会话保存的 SessionTicket，如果有，则表明 Client 希望基于 SessionTicket 的方式进行会话恢复。</p><p>Server 在 ServerHello 中响应该扩展，返回如下：</p><p>Server 在 SessionTicket TLS 中返回一个空的扩展，在 NewSessionTicket 中发给 Client 新的 session ticket。</p><h3 id=7-application_layer_protocol_negotiation>7. application_layer_protocol_negotiation</h3><p>Application Layer Protocol Negotiation，ALPN 应用层协议扩展。由于应用层协议存在多个版本，Client 在 TLS 握手的时候想知道应用层用的什么协议。基于这个目的，ALPN 协议就出现了。ALPN 希望能协商出双方都支持的应用层协议，应用层底层还是基于 TLS/SSL 协议的。</p><p>上图中显示 Client 希望协商 HTTP/2 协议。如果不能达成一致，那么接着协商 HTTP/1.1。</p><p>除了 HTTP 这些协议以外，还有一些其他的应用层协议，见下表。</p><table><thead><tr><th align=center>应用层协议</th><th align=center>标识</th><th align=center>RFC 文档出处</th></tr></thead><tbody><tr><td align=center>HTTP/0.9</td><td align=center>0x68 0x74 0x74 0x70 0x2f 0x30 0x2e 0x39 (&ldquo;http/0.9&rdquo;)</td><td align=center>RFC1945</td></tr><tr><td align=center>HTTP/1.0</td><td align=center>0x68 0x74 0x74 0x70 0x2f 0x31 0x2e 0x30 (&ldquo;http/1.0&rdquo;)</td><td align=center>RFC1945</td></tr><tr><td align=center>HTTP/1.1</td><td align=center>0x68 0x74 0x74 0x70 0x2f 0x31 0x2e 0x31 (&ldquo;http/1.1&rdquo;)</td><td align=center>RFC7230</td></tr><tr><td align=center>SPDY/1</td><td align=center>0x73 0x70 0x64 0x79 0x2f 0x31 (&ldquo;spdy/1&rdquo;)</td><td align=center><a href=http://dev.chromium.org/spdy/spdy-protocol/spdy-protocol-draft1>http://dev.chromium.org/spdy/spdy-protocol/spdy-protocol-draft1</a></td></tr><tr><td align=center>SPDY/2</td><td align=center>0x73 0x70 0x64 0x79 0x2f 0x32 (&ldquo;spdy/2&rdquo;)</td><td align=center><a href=http://dev.chromium.org/spdy/spdy-protocol/spdy-protocol-draft2>http://dev.chromium.org/spdy/spdy-protocol/spdy-protocol-draft2</a></td></tr><tr><td align=center>SPDY/3</td><td align=center>0x73 0x70 0x64 0x79 0x2f 0x33 (&ldquo;spdy/3&rdquo;)</td><td align=center><a href=http://dev.chromium.org/spdy/spdy-protocol/spdy-protocol-draft3>http://dev.chromium.org/spdy/spdy-protocol/spdy-protocol-draft3</a></td></tr><tr><td align=center>Traversal Using Relays around NAT (TURN)</td><td align=center>0x73 0x74 0x75 0x6E 0x2E 0x74 0x75 0x72 0x6E (&ldquo;stun.turn&rdquo;)</td><td align=center>RFC7443</td></tr><tr><td align=center>NAT discovery using Session Traversal Utilities for NAT (STUN)</td><td align=center>0x73 0x74 0x75 0x6E 0x2E 0x6e 0x61 0x74 0x2d 0x64 0x69 0x73 0x63 0x6f 0x76 0x65 0x72 0x79 (&ldquo;stun.nat-discovery&rdquo;)</td><td align=center>RFC7443</td></tr><tr><td align=center>HTTP/2 over TLS</td><td align=center>0x68 0x32 (&ldquo;h2&rdquo;)</td><td align=center>RFC7540</td></tr><tr><td align=center>HTTP/2 over TCP</td><td align=center>0x68 0x32 0x63 (&ldquo;h2c&rdquo;)</td><td align=center>RFC7540</td></tr><tr><td align=center>WebRTC Media and Data</td><td align=center>0x77 0x65 0x62 0x72 0x74 0x63 (&ldquo;webrtc&rdquo;)</td><td align=center>RFC-ietf-rtcweb-alpn-04</td></tr><tr><td align=center>Confidential WebRTC Media and Data</td><td align=center>0x63 0x2d 0x77 0x65 0x62 0x72 0x74 0x63 (&ldquo;c-webrtc&rdquo;)</td><td align=center>RFC-ietf-rtcweb-alpn-04</td></tr><tr><td align=center>FTP</td><td align=center>0x66 0x74 0x70 (&ldquo;ftp&rdquo;)</td><td align=center>RFC959、RFC4217</td></tr><tr><td align=center>IMAP</td><td align=center>0x69 0x6d 0x61 0x70 (&ldquo;imap&rdquo;)</td><td align=center>RFC2595</td></tr><tr><td align=center>POP3</td><td align=center>0x70 0x6f 0x70 0x33 (&ldquo;pop3&rdquo;)</td><td align=center>RFC2595</td></tr><tr><td align=center>ManageSieve</td><td align=center>0x6d 0x61 0x6e 0x61 0x67 0x65 0x73 0x69 0x65 0x76 0x65 (&ldquo;managesieve&rdquo;)</td><td align=center>RFC5804</td></tr><tr><td align=center>CoAP</td><td align=center>0x63 0x6f 0x61 0x70 (&ldquo;coap&rdquo;)</td><td align=center>RFC8323</td></tr><tr><td align=center>XMPP jabber:client namespace</td><td align=center>0x78 0x6d 0x70 0x70 0x2d 0x63 0x6c 0x69 0x65 0x6e 0x74 (&ldquo;xmpp-client&rdquo;)</td><td align=center><a href=https://xmpp.org/extensions/xep-0368.html>https://xmpp.org/extensions/xep-0368.html</a></td></tr><tr><td align=center>XMPP jabber:server namespace</td><td align=center>0x78 0x6d 0x70 0x70 0x2d 0x73 0x65 0x72 0x76 0x65 0x72 (&ldquo;xmpp-server&rdquo;)</td><td align=center><a href=https://xmpp.org/extensions/xep-0368.html>https://xmpp.org/extensions/xep-0368.html</a></td></tr></tbody></table><p>支持 TLS 1.2 的 Server 在 ServerHello 中响应该扩展，返回如下：</p><p>TLS 1.3 的情况一样，也在 ServerHello 中响应该扩展，返回如下：</p><p>从这里例子中看到协商 HTTP/2 成功。</p><h3 id=8-status_request>8. status_request</h3><p>当 Client 收到 Server 发来的证书以后，除了校验证书身份以外，还需要校验证书是否有效。有可能证书已经被 CA 刚刚吊销了。所以 Client 必须通过 CRL 和 OCSP 机制校验证书是否还在有效期之内。不管是 CRL 还是 OCSP 机制都会发送一个额外的请求去验证有效期，这个请求可能会阻塞握手下面的流程，为了避免阻塞，一般采用 Server 向 CA 发送 OCSP 请求。</p><p>为了使用 OCSP 封套技术，在 ClientHello 中增加 status_request 扩展，这个扩展内包含了证书状态的请求。</p><p>该扩展的 <code>extension_data</code> 中就包含了 CertificateStatusRequest 信息。对应的数据结构如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {
          CertificateStatusType status_type;
          select (status_type) {
              <span style=color:#66d9ef>case</span> ocsp: OCSPStatusRequest;
          } request;
      } CertificateStatusRequest;

      <span style=color:#66d9ef>enum</span> { ocsp(<span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>255</span>) } CertificateStatusType;

      <span style=color:#66d9ef>struct</span> {
          ResponderID responder_id_list<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
          Extensions  request_extensions;
      } OCSPStatusRequest;

      opaque ResponderID<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
      opaque Extensions<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
</code></pre></div><p>Sever 收到此扩展以后，会发送 CertificateStatus 子消息，这条新增的子消息就是专门针对此扩展的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {
          CertificateStatusType status_type;
          select (status_type) {
              <span style=color:#66d9ef>case</span> ocsp: OCSPResponse;
          } response;
      } CertificateStatus;

      opaque OCSPResponse<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>24</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
</code></pre></div><p>OCSPResponse 中包含了一个完整经过 DER 编码的 OCSP 封套响应。<strong>CertificateStatus 子消息也只能返回 Server 自己证书的 OCSP 信息</strong>。</p><p>Server 在 ServerHello 中响应该扩展，返回如下：</p><p>Server 返回了一个空的 status_request 扩展。</p><p>支持 TLS 1.2 的 Server 返回的 CertificateStatus 子消息内容如下：</p><p>而在支持 TLS 1.3 的 Server 是在 Certificate 子消息中响应该扩展:</p><h3 id=9-signature_algorithms>9. signature_algorithms</h3><p>Client 使用 &ldquo;signature_algorithms&rdquo; 扩展来向 Server 表明哪个签名/ hash 算法对会被用于数字签名。这个扩展的 &ldquo;extension_data&rdquo; 域包含了一个 &ldquo;supported_signature_algorithms&rdquo; 值。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>enum</span> {
          none(<span style=color:#ae81ff>0</span>), md5(<span style=color:#ae81ff>1</span>), sha1(<span style=color:#ae81ff>2</span>), sha224(<span style=color:#ae81ff>3</span>), sha256(<span style=color:#ae81ff>4</span>), sha384(<span style=color:#ae81ff>5</span>),
          sha512(<span style=color:#ae81ff>6</span>), (<span style=color:#ae81ff>255</span>)
      } HashAlgorithm;

      <span style=color:#66d9ef>enum</span> { anonymous(<span style=color:#ae81ff>0</span>), rsa(<span style=color:#ae81ff>1</span>), dsa(<span style=color:#ae81ff>2</span>), ecdsa(<span style=color:#ae81ff>3</span>), (<span style=color:#ae81ff>255</span>) }
        SignatureAlgorithm;

      <span style=color:#66d9ef>struct</span> {
            HashAlgorithm hash;
            SignatureAlgorithm signature;
      } SignatureAndHashAlgorithm;

      SignatureAndHashAlgorithm
        supported_signature_algorithms<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>2..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#f92672>&gt;</span>;
</code></pre></div><p>每个 SignatureAndHashAlgorithm 值都列出了一个 Client 愿意使用的 hash/签名对。这些值根据倾向使用的程度按降序排列。</p><p>注: 由于并不是所有的签名算法和 hash 算法都会被一个实现方所接受(例如: DSA 接受 SHA-1, 不接受 SHA-256), 所有算法是成对列出。</p><ul><li><p>hash:<br>这个字段表明可能使用的 hash 算法。这些值分别表明支持无 hash, MD5, SHA-1, SHA-224, SHA-256, SHA-384, 和 SHA-512。&ldquo;none&rdquo; 值用于将来的可扩展性, 以防止一个签名算法在签名之前不需要 hash。</p></li><li><p>signature:<br>这个字段表明使用哪个签名算法。这些值分别表示匿名签名, RSASSA-PKCS1-v1_5, DSA 和ECDSA。&ldquo;anonymous&rdquo; 值在这个上下文中是无意义的，它不能出现在这个扩展之中。</p></li></ul><p>这个扩展的语义某种程度上有些复杂, 因为密码套件表明允许的签名算法而不是 hash 算法。</p><p>如果 Client 只支持默认的 hash 和签名算法(本节中所列出的)，它可以忽略 signature_algorithms 扩展。如果 Client 不支持默认的算法，或支持其它的 hash 和签名算法(并且它愿意使用他们来验证 Server 发送的消息，如: server certificates 和 server key exchange)，它必须发送 signature_algorithms 扩展，列出它愿意接受的算法。</p><p>如果 Client 不发送 signature_algorithms 扩展，Server 必须执行如下动作:</p><ul><li><p>如果协商后的密钥交换算法是(RSA、DHE_RSA、DH_RSA、RSA_PSK、ECDH_RSA、ECDHE_RSA)中的一个，处理行为同 Client 发送了 {sha1,rsa}；</p></li><li><p>如果协商后的密钥交换算法是(DHE_DSS、DH_DSS)中的一个, 处理行为同 Client 发送了{sha1,dsa}。</p></li><li><p>如果协商后的密钥交换算法是(ECDH_ECDSA,ECDHE_ECDSA)中的一个, 处理行为同 Client 发送了{sha1,ecdsa}。</p></li></ul><p>注: 这个对于 TLS 1.1 是一个变更，且没有显式的规则，但在实现上可以假定对端支持 MD5 和 SHA-1。</p><p>注: 这个扩展对早于 1.2 版本的 TLS 是没有意义的，对于之前的版本 Client 不能这个扩展。然而，即使 Client 提供了这个扩展，[TLSEXT] 中明确的规则要求 Server 如果不能理解扩展则忽略之。</p><p>Server 不能发送此扩展，TLS Server 必须支持接收此扩展。</p><p>当进行会话恢复时，这个扩展不能被包含在 Server Hello 中, 且 Server 会忽略 Client Hello 中的这个扩展(如果有)。</p><h2 id=二-tls-13-握手中的-extension>二. TLS 1.3 握手中的 extension</h2><p>在 TLS 1.3 <a href=https://tools.ietf.org/html/rfc8447>[RFC 8446]</a> 规范中定义了很多 Extension，以下这些 Extension 在 TLS 1.3 中基本都在使用。加上上一章节表格中的 Extension，就是当前最全的 Extension 了。</p><table><thead><tr><th align=center>扩展类型名称</th><th align=center>扩展类型编号</th><th align=center>TLS 1.3 中使用情况</th><th align=center>是否推荐</th><th align=center>RFC 文档出处</th></tr></thead><tbody><tr><td align=center>pre_shared_key</td><td align=center>41</td><td align=center>CH, SH</td><td align=center>✅</td><td align=center>RFC8446</td></tr><tr><td align=center>early_data</td><td align=center>42</td><td align=center>CH, EE, NST</td><td align=center>✅</td><td align=center>RFC8446</td></tr><tr><td align=center>supported_versions</td><td align=center>43</td><td align=center>CH, SH, HRR</td><td align=center>✅</td><td align=center>RFC8446</td></tr><tr><td align=center>cookie</td><td align=center>44</td><td align=center>CH, HRR</td><td align=center>✅</td><td align=center>RFC8446</td></tr><tr><td align=center>psk_key_exchange_modes</td><td align=center>45</td><td align=center>CH</td><td align=center>✅</td><td align=center>RFC8446</td></tr><tr><td align=center>Unassigned</td><td align=center>46</td><td align=center></td><td align=center>❌</td><td align=center></td></tr><tr><td align=center>certificate_authorities</td><td align=center>47</td><td align=center>CH, CR</td><td align=center>✅</td><td align=center>RFC8446</td></tr><tr><td align=center>oid_filters</td><td align=center>48</td><td align=center>CR</td><td align=center>✅</td><td align=center>RFC8446</td></tr><tr><td align=center>post_handshake_auth</td><td align=center>49</td><td align=center>CH</td><td align=center>✅</td><td align=center>RFC8446</td></tr><tr><td align=center>signature_algorithms_cert</td><td align=center>50</td><td align=center>CH, CR</td><td align=center>✅</td><td align=center>RFC8446</td></tr><tr><td align=center>key_share</td><td align=center>51</td><td align=center>CH, SH, HRR</td><td align=center>✅</td><td align=center>RFC8446</td></tr><tr><td align=center>Unassigned</td><td align=center>52-65279</td><td align=center></td><td align=center>❌</td><td align=center></td></tr><tr><td align=center>Reserved for Private Use</td><td align=center>65280</td><td align=center></td><td align=center></td><td align=center>RFC8446</td></tr><tr><td align=center>Reserved for Private Use</td><td align=center>65282-65535</td><td align=center></td><td align=center></td><td align=center>RFC8446</td></tr></tbody></table><blockquote><p>缩写注解: CH: ClientHello，SH: ServerHello，CR: CertificateRequest，EE:EncryptedExtensions，HRR: HelloRetryRequest，CT: Certificate，NST: NewSessionTicket</p></blockquote><p>CH (ClientHello), SH (ServerHello), EE (EncryptedExtensions), CT (Certificate), CR (CertificateRequest), NST (NewSessionTicket), 和 HRR (HelloRetryRequest)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>    <span style=color:#66d9ef>enum</span> {
        server_name(<span style=color:#ae81ff>0</span>),                             <span style=color:#75715e>/* RFC 6066 */</span>
        max_fragment_length(<span style=color:#ae81ff>1</span>),                     <span style=color:#75715e>/* RFC 6066 */</span>
        status_request(<span style=color:#ae81ff>5</span>),                          <span style=color:#75715e>/* RFC 6066 */</span>
        supported_groups(<span style=color:#ae81ff>10</span>),                       <span style=color:#75715e>/* RFC 8422, 7919 */</span>
        signature_algorithms(<span style=color:#ae81ff>13</span>),                   <span style=color:#75715e>/* RFC 8446 */</span>
        use_srtp(<span style=color:#ae81ff>14</span>),                               <span style=color:#75715e>/* RFC 5764 */</span>
        heartbeat(<span style=color:#ae81ff>15</span>),                              <span style=color:#75715e>/* RFC 6520 */</span>
        application_layer_protocol_negotiation(<span style=color:#ae81ff>16</span>), <span style=color:#75715e>/* RFC 7301 */</span>
        signed_certificate_timestamp(<span style=color:#ae81ff>18</span>),           <span style=color:#75715e>/* RFC 6962 */</span>
        client_certificate_type(<span style=color:#ae81ff>19</span>),                <span style=color:#75715e>/* RFC 7250 */</span>
        server_certificate_type(<span style=color:#ae81ff>20</span>),                <span style=color:#75715e>/* RFC 7250 */</span>
        padding(<span style=color:#ae81ff>21</span>),                                <span style=color:#75715e>/* RFC 7685 */</span>
        RESERVED(<span style=color:#ae81ff>40</span>),                               <span style=color:#75715e>/* Used but never
</span><span style=color:#75715e>                                                       assigned */</span>
        pre_shared_key(<span style=color:#ae81ff>41</span>),                         <span style=color:#75715e>/* RFC 8446 */</span>
        early_data(<span style=color:#ae81ff>42</span>),                             <span style=color:#75715e>/* RFC 8446 */</span>
        supported_versions(<span style=color:#ae81ff>43</span>),                     <span style=color:#75715e>/* RFC 8446 */</span>
        cookie(<span style=color:#ae81ff>44</span>),                                 <span style=color:#75715e>/* RFC 8446 */</span>
        psk_key_exchange_modes(<span style=color:#ae81ff>45</span>),                 <span style=color:#75715e>/* RFC 8446 */</span>
        RESERVED(<span style=color:#ae81ff>46</span>),                               <span style=color:#75715e>/* Used but never
</span><span style=color:#75715e>                                                       assigned */</span>
        certificate_authorities(<span style=color:#ae81ff>47</span>),                <span style=color:#75715e>/* RFC 8446 */</span>
        oid_filters(<span style=color:#ae81ff>48</span>),                            <span style=color:#75715e>/* RFC 8446 */</span>
        post_handshake_auth(<span style=color:#ae81ff>49</span>),                    <span style=color:#75715e>/* RFC 8446 */</span>
        signature_algorithms_cert(<span style=color:#ae81ff>50</span>),              <span style=color:#75715e>/* RFC 8446 */</span>
        key_share(<span style=color:#ae81ff>51</span>),                              <span style=color:#75715e>/* RFC 8446 */</span>
        (<span style=color:#ae81ff>65535</span>)
    } ExtensionType;
</code></pre></div><p>在 TLS 1.3 中，相比 TLS 1.2 增加了大量的扩展，当然上一章提到的 TLS 1.2 的扩展也会继续使用。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>   <span style=color:#f92672>+--------------------------------------------------+-------------+</span>
   <span style=color:#f92672>|</span> Extension                                        <span style=color:#f92672>|</span>     TLS <span style=color:#ae81ff>1.3</span> <span style=color:#f92672>|</span>
   <span style=color:#f92672>+--------------------------------------------------+-------------+</span>
   <span style=color:#f92672>|</span> server_name [RFC6066]                            <span style=color:#f92672>|</span>      CH, EE <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> max_fragment_length [RFC6066]                    <span style=color:#f92672>|</span>      CH, EE <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> status_request [RFC6066]                         <span style=color:#f92672>|</span>  CH, CR, CT <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> supported_groups [RFC7919]                       <span style=color:#f92672>|</span>      CH, EE <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> signature_algorithms (RFC <span style=color:#ae81ff>8446</span>)                  <span style=color:#f92672>|</span>      CH, CR <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> use_srtp [RFC5764]                               <span style=color:#f92672>|</span>      CH, EE <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> heartbeat [RFC6520]                              <span style=color:#f92672>|</span>      CH, EE <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> application_layer_protocol_negotiation [RFC7301] <span style=color:#f92672>|</span>      CH, EE <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> signed_certificate_timestamp [RFC6962]           <span style=color:#f92672>|</span>  CH, CR, CT <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> client_certificate_type [RFC7250]                <span style=color:#f92672>|</span>      CH, EE <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> server_certificate_type [RFC7250]                <span style=color:#f92672>|</span>      CH, EE <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> padding [RFC7685]                                <span style=color:#f92672>|</span>          CH <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> key_share (RFC <span style=color:#ae81ff>8446</span>)                             <span style=color:#f92672>|</span> CH, SH, HRR <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> pre_shared_key (RFC <span style=color:#ae81ff>8446</span>)                        <span style=color:#f92672>|</span>      CH, SH <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> psk_key_exchange_modes (RFC <span style=color:#ae81ff>8446</span>)                <span style=color:#f92672>|</span>          CH <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> early_data (RFC <span style=color:#ae81ff>8446</span>)                            <span style=color:#f92672>|</span> CH, EE, NST <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> cookie (RFC <span style=color:#ae81ff>8446</span>)                                <span style=color:#f92672>|</span>     CH, HRR <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> supported_versions (RFC <span style=color:#ae81ff>8446</span>)                    <span style=color:#f92672>|</span> CH, SH, HRR <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> certificate_authorities (RFC <span style=color:#ae81ff>8446</span>)               <span style=color:#f92672>|</span>      CH, CR <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> oid_filters (RFC <span style=color:#ae81ff>8446</span>)                           <span style=color:#f92672>|</span>          CR <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> post_handshake_auth (RFC <span style=color:#ae81ff>8446</span>)                   <span style=color:#f92672>|</span>          CH <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span>                                                  <span style=color:#f92672>|</span>             <span style=color:#f92672>|</span>
   <span style=color:#f92672>|</span> signature_algorithms_cert (RFC <span style=color:#ae81ff>8446</span>)             <span style=color:#f92672>|</span>      CH, CR <span style=color:#f92672>|</span>
   <span style=color:#f92672>+--------------------------------------------------+-------------+</span>
</code></pre></div><p>在 TLS 1.3 中，扩展通常以请求/响应方式构建，虽然有些扩展只是一些标识，并不会有任何响应。Client 只能在 ClientHello 中发送其扩展请求，Server 只能在 ServerHello, EncryptedExtensions, HelloRetryRequest,和 Certificate 消息中发送对应的扩展响应。</p><p>上面 2 张图是 TLS 1.3 中 ClientHello 中的所有扩展。到 signature_algorithms 为止，上面的扩展都在 TLS 1.2 扩展中讲解了。这里就不再赘述了，只是放一下 Wireshake 的截图展示一下。</p><h3 id=1-signed_certificate_timestamp>1. signed_certificate_timestamp</h3><p>这个扩展在 TLS 1.2 中就有了，之所以放在这里，只是因为在 TLS 1.3 的抓包中出现了，在 TLS 1.2 的抓包中没有出现。</p><p>这个扩展与证书透明度有关系，每一张 Server 实体证书都可以由 CA 机构或者 Server 实体提交给 CT 日志服务器从而获得证书的 SCT 信息。</p><p>HTTPS 网站的安全性很大一部分取决于 PKI 设施的可信赖性。CA 如果因为失误导致错误签发了证书，这些错误的证书都能通过证书链的校验，所以这些证书很难被发现，即使被发现，也很难快速消除影响。</p><p>Certificate Transparency 证书透明度就是为了解决这些问题的，由 Google 主导，并由 IETF 标准化为 RFC 6962。Certificate Transparency 的目标是提供一个开放的审计和监控系统，可以让任何域名所有者或者 CA 确定证书是否被错误签发或者被恶意使用，从而提高 HTTPS 网站的安全性。</p><p>Certificate Transparency 整套系统由三部分组成：1）Certificate Logs；2）Certificate Monitors；3）Certificate Auditors。完整的工作原理可以看官方文档：<a href=https://www.certificate-transparency.org/how-ct-works>How Certificate Transparency Works</a></p><p>简单说来，证书所有者或者 CA 都可以主动向 Certificate Logs 服务器提交证书，所有证书记录都会接受审计和监控。支持 CT 的浏览器（目前只有 Chrome）会根据 Certificate Logs 中证书状态，作出不同的反应。CT 不是要替换现有的 CA 设施，而是做为补充，使之更透明、更实时。</p><p>Certificate Logs 服务器由 Google 或 CA 部署，<a href=https://www.certificate-transparency.org/known-logs>这个页面</a>列举了目前已知的服务器。合法的证书提交到 CT Logs 服务器之后，服务器会返回 signed certificate timestamp（SCT），要启用 CT 就必须用到 SCT 信息。</p><p>开启证书透明度有 3 种方法：</p><ul><li><ol><li>通过 X.509v3 扩展</li></ol></li><li><ol start=2><li>通过 TLS 的 <code>signed_certificate_timestamp</code> 扩展</li></ol></li><li><ol start=3><li>通过 OCSP Stapling</li></ol></li></ul><p>这里的方法 2 就是这里所说的扩展。SCT 信息可以通过 X.509v3 扩展嵌入在证书里，方法 1 是以后的趋势。</p><p>Letsencrypt 已经默认在证书中嵌入了 CT 信息。笔者的博客证书就是由 Letsencrypt 签发的，所以证书中也嵌入了 CT 信息了。</p><h3 id=2-key_share>2. key_share</h3><p>在 TLS 1.3 中，之所以能比 TLS 1.2 快的原因，原因之一就在 key_share 这个扩展上。key_share 扩展内包含了 (EC)DHE groups 需要协商密钥参数，这样不需要再次花费 1-RTT 进行协商了。</p><p>&ldquo;supported_groups&rdquo; 的扩展 和 &ldquo;key_share&rdquo; 扩展配合使用。“supported_groups” 这个扩展表明了 Client 支持的 (EC)DHE groups，&ldquo;key_share&rdquo; 扩展表明了 Client 是否包含了一些或者全部的（EC）DHE共享参数。</p><p>KeyShareEntry 数据结构如下:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>    <span style=color:#66d9ef>struct</span> {
        NamedGroup group;
        opaque key_exchange<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
    } KeyShareEntry;

    <span style=color:#66d9ef>struct</span> {
        KeyShareEntry client_shares<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
    } KeyShareClientHello;
</code></pre></div><p>如果 Server 选择了 (EC)DHE 组，并且 Client 在 ClientHello 中没有提供合适的 &ldquo;key_share&rdquo; 扩展， Server 必须用 HelloRetryRequest 消息作为回应。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>    <span style=color:#66d9ef>struct</span> {
        NamedGroup selected_group;
    } KeyShareHelloRetryRequest;
</code></pre></div><p>如果 ClientHello 提供了合适的 &ldquo;key_share&rdquo; 扩展，那么在 Serverhello 中回应 Server 的参数。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>    <span style=color:#66d9ef>struct</span> {
        KeyShareEntry server_share;
    } KeyShareServerHello;
</code></pre></div><p>整个流程见下图:</p><p>上面 2 张图就展示了 Server 和 Client 是如何协商各自的密钥参数的。</p><blockquote><p>这个扩展在 TLS 1.3 中非常关键，TLS 1.3 官方也对它进行了大篇幅的说明，见<a href=https://github.com/halfrost/Halfrost-Field/blob/master/contents/Protocol/TLS_1.3_Handshake_Protocol.md#8-key-share>这篇文章</a></p></blockquote><h3 id=3-psk_key_exchange_modes>3. psk_key_exchange_modes</h3><p>为了使用 PSK，Client 还必须发送一个 &ldquo;psk_key_exchange_modes&rdquo; 扩展。这个扩展语意是 Client 仅支持使用具有这些模式的 PSK。这就限制了在这个 ClientHello 中提供的 PSK 的使用，也限制了 Server 通过 NewSessionTicket 提供的 PSK 的使用。</p><p>如果 Client 提供了 &ldquo;pre_shared_key&rdquo; 扩展，那么它必须也要提供 &ldquo;psk_key_exchange_modes&rdquo; 扩展。如果 Client 发送不带 &ldquo;psk_key_exchange_modes&rdquo; 扩展名的 &ldquo;pre_shared_key&rdquo;，Server 必须立即中止握手。Server 不能选择一个 Client 没有列出的密钥交换模式。此扩展还限制了与 PSK 恢复使用的模式。Server 也不能发送与建议的 modes 不兼容的 NewSessionTicket。不过如果 Server 一定要这样做，影响的只是 Client 在尝试恢复会话的时候会失败。</p><p>Server 不能发送 &ldquo;psk_key_exchange_modes&rdquo; 扩展:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>enum</span> { psk_ke(<span style=color:#ae81ff>0</span>), psk_dhe_ke(<span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>255</span>) } PskKeyExchangeMode;

      <span style=color:#66d9ef>struct</span> {
          PskKeyExchangeMode ke_modes<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1..255</span><span style=color:#f92672>&gt;</span>;
      } PskKeyExchangeModes;
</code></pre></div><ul><li><p>psk_ke:<br>仅 PSK 密钥建立。在这种模式下，Server 不能提供 &ldquo;key_share&rdquo; 值。</p></li><li><p>psk_dhe_ke:<br>PSK 和 (EC)DHE 建立。在这种模式下，Client 和 Server 必须提供 &ldquo;key_share&rdquo; 值。</p></li></ul><p>未来分配的任何值都必须要能保证传输的协议消息可以明确的标识 Server 选择的模式。目前 Server 选择的值由 ServerHello 中存在的 &ldquo;key_share&rdquo; 表示。</p><p>ClientHello 中包含此扩展的消息如下：</p><h3 id=4-supported_versions>4. supported_versions</h3><p>在 TLS 1.3 中，ClientHello 中的 supported_versions 扩展非常重要。因为 TLS 1.3 是根据这个字段的值来协商是否支持 TLS 1.3 。在 TLS 1.3 规范中规定，ClientHello 中的 legacy_version 必须设置为 0x0303，这个值代表的是 TLS 1.2 。这样规定是为了对网络中间件做的一些兼容。如果此时 ClientHello 中不携带 supported_versions 这个扩展，那么注定只能协商 TLS 1.2 了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {
          select (Handshake.msg_type) {
              <span style=color:#66d9ef>case</span> client_hello:
                   ProtocolVersion versions<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>2..254</span><span style=color:#f92672>&gt;</span>;

              <span style=color:#66d9ef>case</span> server_hello: <span style=color:#75715e>/* and HelloRetryRequest */</span>
                   ProtocolVersion selected_version;
          };
      } SupportedVersions;
</code></pre></div><p>Client 在 ClientHello 的 supported_versions 扩展中发送自己所能支持的 TLS 版本。</p><p>Server 收到以后，在 ServerHello 中的 supported_versions 扩展响应 Client，告诉 Client 接下来进行哪个 TLS 版本的握手。</p><p>上面这个例子说明了接下来会进行 TLS 1.3 的握手。哪怕 ClientHello 和 ServerHello 中 version 都是 TLS 1.2 。</p><h3 id=5-early_data>5. early_data</h3><p>当使用 PSK 并且 PSK 允许使用 early_data 的时候，Client 可以在其第一个消息中发送应用数据。如果 Client 选择这么做，则必须发送 &ldquo;pre_shared_key&rdquo; 和 &ldquo;early_data&rdquo; 扩展。</p><p>Early Data Indication 扩展中的 &ldquo;extension_data&rdquo; 字段包含了一个 EarlyDataIndication 值。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {} Empty;

      <span style=color:#66d9ef>struct</span> {
          select (Handshake.msg_type) {
              <span style=color:#66d9ef>case</span> new_session_ticket:   uint32 max_early_data_size;
              <span style=color:#66d9ef>case</span> client_hello:         Empty;
              <span style=color:#66d9ef>case</span> encrypted_extensions: Empty;
          };
      } EarlyDataIndication;
</code></pre></div><p>有关 max_early_data_size 字段的使用请看 <a href=https://github.com/halfrost/Halfrost-Field/blob/master/contents/Protocol/TLS_1.3_Handshake_Protocol.md#1-new-session-ticket-message>New Session Ticket Message</a> 章节。</p><p>0-RTT 数据(版本，对称加密套件，应用层协议协商协议<a href=https://tools.ietf.org/html/rfc7301>[RFC7301]</a>，等等)的参数与使用中的 PSK 参数相关。对于外部配置的 PSK，关联值是由密钥提供的。对于通过 NewSessionTicket 消息建立的 PSK，关联值是在建立 PSK 连接时协商的值。PSK 用来加密 early data 必须是 Client 在 &ldquo;pre_shared_key&rdquo; 扩展中列出的第一个 PSK。</p><p>对于通过 NewSessionTicket 提供的 PSK，Server 必须验证所选 PSK 标识中的 ticket age(从 PskIdentity.obfuscated_ticket_age 取 2^32 模中减去 ticket_age_add)距离 ticket 发出的时间是否有一个很小的公差。如果相差的时间很多，那么 Server 应该继续握手，但是要拒绝 0-RTT，并且还要假定这条 ClientHello 是新的，也不能采取任何其他措施。</p><p>在第一次 flight 中发送的 0-RTT 消息与其他 flight (握手和应用数据)中发送的相同类型的消息具有相同(加密)的内容类型，但受到不同密钥的保护。如果 Server 已经接收了 early data，Client 在收到 Server 的 Finished 消息以后，Client 则会发送 EndOfEarlyData 消息表示密钥更改。这条消息将会使用 0-RTT 的 traffic 密钥进行加密。</p><p>Server 接收 &ldquo;early_data&rdquo; 扩展必须以下面三种方式之一操作：</p><ul><li><p>忽略 &ldquo;early_data&rdquo; 扩展，并返回常规的 1-RTT 响应。Server 尝试通过用握手中的流量密钥(traffic key)解密收到的记录，并忽略掉 early data。丢弃解密失败的记录(取决于配置的 max_early_data_size)。一旦一个记录被解密成功，它将会被 Server 看做 Client 第二次 flight 的开始并且 Server 会把它当做普通的 1-RTT 来处理。</p></li><li><p>通过回应 HelloRetryRequest 来请求 Client 发送另外一个 ClientHello。Client 不能在这个 ClientHello 中包含 &ldquo;early_data&rdquo; 扩展。Server 通过跳过具有外部内容类型的 &ldquo;application_data&rdquo;(说明他们被加密了) 的所有记录来忽略 early data(同样取决于配置的 max_early_data_size)。</p></li><li><p>在 EncryptedExtensions 中返回自己的 &ldquo;early_data&rdquo; 扩展，表明它准备处理 early data。Server 不可能只接受 early data 消息中的一部分。即使 Server 发送了一条接收 early data 的消息，但是实际上 early data 可能在 Server 生成这条消息的时候已经在 flight 了。</p></li></ul><p>为了接受 early data，Server 必须已经接受了 PSK 密码套件并且选择了 Client 的 &ldquo;pre_shared_key&rdquo; 扩展中提供的第一个密钥。此外，Server 还需要验证以下的值和选择的 PSK 关联值一样：</p><ul><li>TLS 版本号</li><li>选择的密码套件</li><li>选择的 ALPN 协议，如果选择了的话</li></ul><p>这些要求是使用相关 PSK 执行 1-RTT 握手所需的超集。对于外部建立的 PSK，关联值是与密钥一起提供的值。对于通过 NewSessionTicket 消息建立的 PSK，关联值是在连接中协商的值，在这期间 ticket 被建立了。</p><p>如果任何检查失败了，Server 不得在响应中附带扩展，并且必须使用上面列出的前两种机制中的一个，丢弃所有 first-flight 数据(因此回落到 1-RTT 或者 2-RTT)。如果 Client 尝试 0-RTT 握手但 Server 拒绝了它，则 Server 通常不会有 0-RTT 记录保护密钥，而必须使用试用解密（使用 1-RTT 握手密钥或者通过在有 HelloRetryRequest 消息的情况下查找明文 ClientHello）找到第一个非 0-RTT 消息。</p><p>如果 Server 选择接受 early_data 扩展，那么在处理 early data 记录的时候，Server 必须遵守用相同的标准(指定的相同错误处理要求)来处理所有记录。具体来说，如果 Server 无法解密已经接受的 &ldquo;early_data&rdquo; 扩展中的记录，则它必须发送 &ldquo;bad_record_mac&rdquo; alert 消息中止握手。</p><p>如果 Server 拒绝 &ldquo;early_data&rdquo; 扩展，则 Client 应用程序可以选择在握手完成后重新发送先前在 early data 中发送的应用数据。请注意，early data 的自动重传可能会导致关于连接状态的误判。例如，当协商连接从用于 early data 的协议中选择不同的 ALPN 协议时，应用程序可能需要构造不同的消息。同样，如果 early data 假定包含有关连接状态的任何内容，则在握手完成后可能会错误地发送这些内容。</p><p>TLS 的实现不应该自动重新发送 early data；应用程序可以很好的决定何时重传。除非协商连接选择相同的 ALPN 协议，否则 TLS 实现绝不能自动重新发送 early data。</p><p>下图是 NewSessionTicket 中的 early_data，表明了 Server 可以接受 0-RTT。</p><h3 id=6-pre_shared_key>6. pre_shared_key</h3><p>&ldquo;pre_shared_key&rdquo; 预共享密钥和 &ldquo;psk_key_exchange_modes&rdquo; 扩展配合使用。预共享密钥扩展包含了 Client 可以识别的对称密钥标识。&ldquo;psk_key_exchange_modes&rdquo; 扩展表明了可能可以和 psk 一起使用的密钥交换模式。</p><p>&ldquo;pre_shared_key&rdquo; 扩展用来协商标识的，这个标识是与 PSK 密钥相关联的给定握手所使用的预共享密钥的标识。</p><p>这个扩展中的 &ldquo;extension_data&rdquo; 字段包含一个 PreSharedKeyExtension 值:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {
          opaque identity<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
          uint32 obfuscated_ticket_age;
      } PskIdentity;

      opaque PskBinderEntry<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>32..255</span><span style=color:#f92672>&gt;</span>;

      <span style=color:#66d9ef>struct</span> {
          PskIdentity identities<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>7..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
          PskBinderEntry binders<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>33..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
      } OfferedPsks;

      <span style=color:#66d9ef>struct</span> {
          select (Handshake.msg_type) {
              <span style=color:#66d9ef>case</span> client_hello: OfferedPsks;
              <span style=color:#66d9ef>case</span> server_hello: uint16 selected_identity;
          };
      } PreSharedKeyExtension;
</code></pre></div><ul><li><p>identity:<br>key 的标签。例如，一个 ticket 或者是一个外部建立的预共享密钥的标签。</p></li><li><p>obfuscated_ticket_age:<br>age of the key 的混淆版本。<a href=https://github.com/halfrost/Halfrost-Field/blob/master/contents/Protocol/TLS_1.3_Handshake_Protocol.md#1-ticket-age>这一章节</a>描述了通过 NewSessionTicket 消息建立，如何为标识(identities)生成这个值。对于外部建立的标识(identities)，应该使用 0 的 obfuscated_ticket_age，并且 Server 也必须忽略这个值。</p></li><li><p>identities:<br>Client 愿意和 Server 协商的 identities 列表。如果和 &ldquo;early_data&rdquo; 一起发送，第一个标识被用来标识 0-RTT 的。</p></li><li><p>binders:<br>一系列的 HMAC 值。和 identities 列表中的每一个值都一一对应，并且顺序一致。</p></li><li><p>selected_identity:<br>Server 选择的标识，这个标识是以 Client 列表中标识表示为基于 0 的索引。</p></li></ul><p>每一个 PSK 都和单个哈希算法相关联。对于通过 ticket 建立的 PSK，当 ticket 在连接中被建立，这时候用的哈希算法是 KDF 哈希算法。对于外部建立的 PSK，当 PSK 建立的时候，哈希算法必须设置，如果没有设置，默认算法是 SHA-256。Server 必须确保它选择的是兼容的 PSK (如果有的话) 和密钥套件。</p><p>实现者请注意：会话恢复是 PSK 最主要的用途，实现 PSK/密钥套件 匹配要求的最直接的方法是先协商密码套件，然后再排除任何不兼容的 PSK。任何未知的 PSK (例如：不在 PSK 数据库中，或者用未知的 key 进行编码的)都必须忽略。如果找不到可接受的 PSK，如果可能，Server 应该执行 non-PSK 握手。如果向后兼容性很重要，Client 提供的，外部建立的 PSK 应该影响密码套件的选择。</p><p>在接受PSK密钥建立之前，Server 必须先验证相应的 binder 值。如果这个值不存在或者未验证，则 Server 必须立即中止握手。Server 不应该尝试去验证多个 binder，而应该选择单个 PSK 并且仅验证对应于该 PSK 的 binder。为了接受 PSK 密钥建立连接，Server 发送 &ldquo;pre_shared_key&rdquo; 扩展，标明它所选择的 identity。</p><p>Client 必须验证 Server 的 selected_identity 是否在 Client 提供的范围之内。Server 选择的加密套件标明了与 PSK 关联的哈希算法，如果 ClientHello &ldquo;psk_key_exchange_modes&rdquo; 有需要，Server 还应该发送 &ldquo;key_share&rdquo; 扩展。如果这些值不一致，Client 必须立即用 &ldquo;illegal_parameter&rdquo; alert 消息中止握手。</p><p>如果 Server 提供了 &ldquo;early_data&rdquo; 扩展，Client 必须验证 Server 的 selected_identity 是否为 0。如果返回任何其他值，Client 必须使用 &ldquo;illegal_parameter&rdquo; alert 消息中止握手。</p><p>&ldquo;pre_shared_key&rdquo; 扩展必须是 ClientHello 中的最后一个扩展(这有利于下面的描述的实现)。Server 必须检查它是最后一个扩展，否则用 &ldquo;illegal_parameter&rdquo; alert 消息中止握手。</p><p>上图是 ClientHello 中的 pre_shared_key 扩展。</p><p>上图是 Server 选择后，返回给 Client 的 pre_shared_key 扩展。它标识了 Server 选择的哪一组密钥参数。</p><h3 id=7-signature_algorithms_cert>7. signature_algorithms_cert</h3><p>&ldquo;signature_algorithms&rdquo; 签名算法和 &ldquo;signature_algorithms_cert&rdquo; 签名证书算法的扩展配合使用。&ldquo;signature_algorithms&rdquo; 这个扩展展示了 Client 可以支持了签名算法有哪些。&ldquo;signature_algorithms_cert&rdquo; 这个扩展展示了具体证书的签名算法。</p><h3 id=8-cookie>8. cookie</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {
          opaque cookie<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
      } Cookie;
</code></pre></div><p>Cookies 有 2 大主要目的：</p><ul><li><p>允许 Server 强制 Client 展示网络地址的可达性(因此提供了一个保护 Dos 的度量方法)，这主要是面向无连接的传输(参考 <a href=https://tools.ietf.org/html/rfc6347>RFC 6347</a> 中的例子)</p></li><li><p>允许 Server 卸载状态。从而允许 Server 在向 Client 发送 HelloRetryRequest 消息的时候，不存储任何状态。为了实现这一点，可以通过 Server 把 ClientHello 的哈希存储在 HelloRetryRequest 的 cookie 中(用一些合适的完整性算法保护)。</p></li></ul><p>当发送 HelloRetryRequest 消息时，Server 可以向 Client 提供 “cookie” 扩展(这是常规中的一个例外，常规约定是：只能是可能被发送的扩展才可以出现在 ClientHello 中)。当发送新的 ClientHello 消息时，Client 必须将 HelloRetryRequest 中收到的扩展的内容复制到新 ClientHello 中的 “cookie” 扩展中。Client 不得在后续连接中使用首次 ClientHello 中的 Cookie。</p><p>当 Server 在无状态运行的时候，在第一个和第二个 ClientHello 之间可能会收到不受保护的 change_cipher_spec 消息。由于 Server 没有存储任何状态，它会表现出像到达的第一条消息一样。无状态的 Server 必须忽略这些记录。</p><h3 id=9-certificate_authorities>9. certificate_authorities</h3><p>&ldquo;certificate_authorities&rdquo; 扩展用于表示终端支持的 CA, 并且接收的端点应该使用它来指导证书的选择。</p><p>&ldquo;certificate_authorities&rdquo; 扩展的主体包含了一个 CertificateAuthoritiesExtension 结构：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      opaque DistinguishedName<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;

      <span style=color:#66d9ef>struct</span> {
          DistinguishedName authorities<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>3..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
      } CertificateAuthoritiesExtension;
</code></pre></div><ul><li>authorities:<br>可接受证书颁发机构的一个可分辨名字 <a href=https://tools.ietf.org/html/rfc8446#ref-X501>X501</a> 的列表 ，这个列表是以 DER <a href=https://tools.ietf.org/html/rfc8446#ref-X690>X690</a> 编码格式表示的。这些可分辨的名称为，信任锚或从属的 CA 指定所需的可分辨的名称。因此，可以使用此消息描述已知的信任锚以及所需的授权空间。</li></ul><p>Client 可能会在 ClientHello 消息中发送 &ldquo;certificate_authorities&rdquo; 扩展，Server 可能会在 CertificateRequest 消息中发送 &ldquo;certificate_authorities&rdquo; 扩展。</p><p>&ldquo;trusted_ca_keys&rdquo; 扩展和 &ldquo;certificate_authorities&rdquo; 扩展有相同的目的，但是更加复杂。&ldquo;trusted_ca_keys&rdquo; 扩展不能在 TLS 1.3 中使用，但是它在 TLS 1.3 之前的版本中，可能出现在 Client 的 ClientHello 消息中。</p><h3 id=10-oid_filters>10. oid_filters</h3><p>&ldquo;oid_filters&rdquo; 扩展允许 Server 提供一组 OID/value 对，用来匹配 Client 的证书。如果 Server 想要发送这个扩展，有且仅有在 CertificateRequest 消息中才能发送。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {
          opaque certificate_extension_oid<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>8</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
          opaque certificate_extension_values<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
      } OIDFilter;

      <span style=color:#66d9ef>struct</span> {
          OIDFilter filters<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>;
      } OIDFilterExtension;
</code></pre></div><ul><li>filters:<br>一个有允许值的证书扩展 OID <a href=https://tools.ietf.org/html/rfc5280>RFC 5280</a> 列表，以 DER 编码 <a href=https://tools.ietf.org/html/rfc8446#ref-X690>X690</a> 格式表示。一些证书扩展 OID 允许多个值(例如，Extended Key Usage)。如果 Server 包含非空的 filters 列表，则响应中包含的 Client 证书必须包含 Client 识别的所有指定的扩展 OID。对于 Client 识别的每个扩展 OID，所有指定的值必须存在于 Client 证书中（但是证书也可以具有其他值）。然而，Client 必须忽略并跳过任何无法识别的证书扩展 OID。如果 Client 忽略了一些所需的证书扩展 OID 并提供了不满足请求的证书。Server 可以自行决定是继续与没有身份认证的 Client 保持连接，还是用 &ldquo;unsupported_certificate&rdquo; alert 消息中止握手。任何给定的 OID 都不能在 filters 列表中出现多次。</li></ul><p>PKIX RFC 定义了各种证书扩展 OID 及其对应的值类型。根据类型，匹配的证书扩展值不一定是按位相等的。期望 TLS 实现将依靠它们的 PKI 库，使用证书扩展 OID 来做证书的选择。</p><p>TLS 1.3 规范中定义了 <a href=https://tools.ietf.org/html/rfc5280>RFC5280</a> 中定义的两个标准证书扩展的匹配规则：</p><ul><li><p>当请求中声明的所有 Key Usage 位也同样在 Key Usage 证书扩展声明了，那么证书中的 Key Usage 扩展匹配了请求。</p></li><li><p>当请求中所有的密钥 OIDs 在 Extended Key Usage 证书扩展中也存在，那么证书中的 Extended Key Usage 匹配了请求。特殊的 anyExtendedKeyUsage OID 一定不能在请求中使用。</p></li></ul><p>单独的规范可以为其他证书扩展的规则定义匹配规则。</p><h3 id=11-post_handshake_auth>11. post_handshake_auth</h3><p>&ldquo;post_handshake_auth&rdquo; 扩展用于表明 Client 愿意握手后再认证。Server 不能向没有提供此扩展的 Client 发送握手后再认证的 CertificateRequest 消息。Server 不能发送此扩展。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {} PostHandshakeAuth;
</code></pre></div><p>&ldquo;post_handshake_auth&rdquo; 扩展名中的 &ldquo;extension_data&rdquo; 字段为零长度。</p><p>当 Client 发送了 &ldquo;post_handshake_auth&rdquo; 扩展时，Server 可以在握手完成后随时通过发送 CertificateRequest 消息来请求客户端身份验证。Client 必须使用适当的验证消息进行响应。如果 Client 选择进行身份验证，则必须发送 Certificate，CertificateVerify，Finished 消息。如果 Client 拒绝身份验证，它必须发送一个 Certificate 证书消息，其中不包含证书，然后是 Finished 消息。响应 Server 的所有 Client 消息必须连续出现在线路上，中间不能有其他类型的消息。</p><p>在没有发送 &ldquo;post_handshake_auth&rdquo; 扩展的情况下接收 CertificateRequest 消息的 Client 必须发送 &ldquo;unexpected_message&rdquo; alert 消息。</p><p>注意：由于 Client 身份验证可能涉及提示用户，因此 Server 必须做好一些延迟的准备，包括在发送 CertificateRequest 和接收响应之间接收任意数量的其他消息。此外，Client 如果连续接收到了多个 CertificateRequests 消息，Client 可能会以不同于它们的顺序响应它们(certificate_request_context 值允许服务器消除响应的歧义)</p><h3 id=12-signature_algorithms>12. signature_algorithms</h3><p>这个扩展在 TLS 1.2 中就存在，只不过在 TLS 1.3 中数据结构发生了变化，所以这个扩展还是需要提一下。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>struct</span> {
          SignatureScheme supported_signature_algorithms<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>2..2</span><span style=color:#f92672>^</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#f92672>&gt;</span>;
      } SignatureSchemeList;
</code></pre></div><p>SignatureScheme 有以下一些枚举值：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>      <span style=color:#66d9ef>enum</span> {
          <span style=color:#75715e>/* RSASSA-PKCS1-v1_5 algorithms */</span>
          rsa_pkcs1_sha256(<span style=color:#ae81ff>0x0401</span>),
          rsa_pkcs1_sha384(<span style=color:#ae81ff>0x0501</span>),
          rsa_pkcs1_sha512(<span style=color:#ae81ff>0x0601</span>),

          <span style=color:#75715e>/* ECDSA algorithms */</span>
          ecdsa_secp256r1_sha256(<span style=color:#ae81ff>0x0403</span>),
          ecdsa_secp384r1_sha384(<span style=color:#ae81ff>0x0503</span>),
          ecdsa_secp521r1_sha512(<span style=color:#ae81ff>0x0603</span>),

          <span style=color:#75715e>/* RSASSA-PSS algorithms with public key OID rsaEncryption */</span>
          rsa_pss_rsae_sha256(<span style=color:#ae81ff>0x0804</span>),
          rsa_pss_rsae_sha384(<span style=color:#ae81ff>0x0805</span>),
          rsa_pss_rsae_sha512(<span style=color:#ae81ff>0x0806</span>),

          <span style=color:#75715e>/* EdDSA algorithms */</span>
          ed25519(<span style=color:#ae81ff>0x0807</span>),
          ed448(<span style=color:#ae81ff>0x0808</span>),

          <span style=color:#75715e>/* RSASSA-PSS algorithms with public key OID RSASSA-PSS */</span>
          rsa_pss_pss_sha256(<span style=color:#ae81ff>0x0809</span>),
          rsa_pss_pss_sha384(<span style=color:#ae81ff>0x080a</span>),
          rsa_pss_pss_sha512(<span style=color:#ae81ff>0x080b</span>),

          <span style=color:#75715e>/* Legacy algorithms */</span>
          rsa_pkcs1_sha1(<span style=color:#ae81ff>0x0201</span>),
          ecdsa_sha1(<span style=color:#ae81ff>0x0203</span>),

          <span style=color:#75715e>/* Reserved Code Points */</span>
          obsolete_RESERVED(<span style=color:#ae81ff>0x0000</span>.<span style=color:#ae81ff>.0</span>x0200),
          dsa_sha1_RESERVED(<span style=color:#ae81ff>0x0202</span>),
          obsolete_RESERVED(<span style=color:#ae81ff>0x0204</span>.<span style=color:#ae81ff>.0</span>x0400),
          dsa_sha256_RESERVED(<span style=color:#ae81ff>0x0402</span>),
          obsolete_RESERVED(<span style=color:#ae81ff>0x0404</span>.<span style=color:#ae81ff>.0</span>x0500),
          dsa_sha384_RESERVED(<span style=color:#ae81ff>0x0502</span>),
          obsolete_RESERVED(<span style=color:#ae81ff>0x0504</span>.<span style=color:#ae81ff>.0</span>x0600),
          dsa_sha512_RESERVED(<span style=color:#ae81ff>0x0602</span>),
          obsolete_RESERVED(<span style=color:#ae81ff>0x0604</span>.<span style=color:#ae81ff>.0</span>x06FF),
          private_use(<span style=color:#ae81ff>0xFE00</span>.<span style=color:#ae81ff>.0</span>xFFFF),
          (<span style=color:#ae81ff>0xFFFF</span>)
      } SignatureScheme;
</code></pre></div><hr><p>Reference：</p><p><a href=https://tools.ietf.org/html/rfc6066>RFC 6066</a></p><blockquote><p>GitHub Repo：<a href=https://github.com/halfrost/Halfrost-Field>Halfrost-Field</a></p><p>Follow: <a href=https://github.com/halfrost>halfrost · GitHub</a></p><p>Source: <a href=https://halfrost.com/https-extensions/>https://halfrost.com/HTTPS-extensions/</a></p></blockquote><img src=https://img.halfrost.com/wechat-qr-code.png></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=https://books.halfrost.com/>Books</a></li><li><a href=https://github.com/halfrost/Halfrost-Field>Github</a></li><li><a href=https://halfrost.me/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#一-tls-12-握手中的-extension>一. TLS 1.2 握手中的 extension</a><ul><li><a href=#1-server_name>1. server_name</a></li><li><a href=#2-extended_master_secret>2. extended_master_secret</a></li><li><a href=#3-renegotiation_info-重协商>3. renegotiation_info 重协商</a></li><li><a href=#4-supported_groups>4. supported_groups</a></li><li><a href=#5-ec_point_formats>5. ec_point_formats</a></li><li><a href=#6-sessionticket-tls>6. SessionTicket TLS</a></li><li><a href=#7-application_layer_protocol_negotiation>7. application_layer_protocol_negotiation</a></li><li><a href=#8-status_request>8. status_request</a></li><li><a href=#9-signature_algorithms>9. signature_algorithms</a></li></ul></li><li><a href=#二-tls-13-握手中的-extension>二. TLS 1.3 握手中的 extension</a><ul><li><a href=#1-signed_certificate_timestamp>1. signed_certificate_timestamp</a></li><li><a href=#2-key_share>2. key_share</a></li><li><a href=#3-psk_key_exchange_modes>3. psk_key_exchange_modes</a></li><li><a href=#4-supported_versions>4. supported_versions</a></li><li><a href=#5-early_data>5. early_data</a></li><li><a href=#6-pre_shared_key>6. pre_shared_key</a></li><li><a href=#7-signature_algorithms_cert>7. signature_algorithms_cert</a></li><li><a href=#8-cookie>8. cookie</a></li><li><a href=#9-certificate_authorities>9. certificate_authorities</a></li><li><a href=#10-oid_filters>10. oid_filters</a></li><li><a href=#11-post_handshake_auth>11. post_handshake_auth</a></li><li><a href=#12-signature_algorithms>12. signature_algorithms</a></li></ul></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f"><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&text=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&title=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&is_video=false&description=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions&body=Check out this article: https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f"><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&title=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&title=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&title=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-stumbleupon fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&title=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-digg fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&name=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions&description=%e6%89%a9%e5%b1%95%e6%98%af%20TLS%20%e6%af%94%e8%be%83%e9%87%8d%e8%a6%81%e7%9a%84%e4%b8%80%e4%b8%aa%e7%9f%a5%e8%af%86%e7%82%b9%e3%80%82%e5%ae%83%e7%9a%84%e5%ad%98%e5%9c%a8%e8%83%bd%e8%ae%a9%20Client%20%e5%92%8c%20Server%20%e5%9c%a8%e4%b8%8d%e6%9b%b4%e6%96%b0%20TLS%20%e7%9a%84%e5%9f%ba%e7%a1%80%e4%b8%8a%ef%bc%8c%e8%8e%b7%e5%be%97%e6%96%b0%e7%9a%84%e8%83%bd%e5%8a%9b%e3%80%82%e6%89%a9%e5%b1%95%e7%9a%84%e5%ae%98%e6%96%b9%e6%96%87%e6%a1%a3%e5%9c%a8%20%5bRFC%206066%5d%20%e4%b8%ad%e5%ae%9a%e4%b9%89%e3%80%82Extension%20%e5%83%8f%20TLS%20%e4%b8%ad%e7%9a%84%e4%b8%80%e7%b3%bb%e5%88%97%e5%8f%af%e6%b0%b4%e5%b9%b3%e6%89%a9%e5%b1%95%e7%9a%84%e6%8f%92%e4%bb%b6%e3%80%82%0aClient%20%e5%9c%a8%20ClientHello%20%e4%b8%ad%e7%94%b3%e6%98%8e%e5%a4%9a%e4%b8%aa%e8%87%aa%e5%b7%b1%e5%8f%af%e4%bb%a5%e6%94%af%e6%8c%81%e7%9a%84%20Extension%ef%bc%8c%e4%bb%a5%e5%90%91%20Server%20%e8%a1%a8%e7%a4%ba%e8%87%aa%e5%b7%b1%e6%9c%89%e4%bb%a5%e4%b8%8b%e8%bf%99%e4%ba%9b%e8%83%bd%e5%8a%9b%ef%bc%8c%e6%88%96%e8%80%85%e5%90%91%20Server%20%e5%8d%8f%e5%95%86%e6%9f%90%e4%ba%9b%e5%8d%8f%e8%ae%ae%e3%80%82Server%20%e6%94%b6%e5%88%b0%20ClientHello%20%e4%bb%a5%e5%90%8e%ef%bc%8c%e4%be%9d%e6%ac%a1%e8%a7%a3%e6%9e%90%20Extension%ef%bc%8c%e6%9c%89%e4%ba%9b%e5%a6%82%e6%9e%9c%e9%9c%80%e8%a6%81%e7%ab%8b%e5%8d%b3%e5%9b%9e%e5%ba%94%ef%bc%8c%e5%b0%b1%e5%9c%a8%20ServerHello%20%e4%b8%ad%e4%bd%9c%e5%87%ba%e5%9b%9e%e5%ba%94%ef%bc%8c%e6%9c%89%e4%ba%9b%e4%b8%8d%e9%9c%80%e8%a6%81%e5%9b%9e%e5%ba%94%ef%bc%8c%e6%88%96%e8%80%85%20Server%20%e4%b8%8d%e6%94%af%e6%8c%81%e7%9a%84%20Extension%20%e5%b0%b1%e4%b8%8d%e7%94%a8%e5%93%8d%e5%ba%94%ef%bc%8c%e5%bf%bd%e7%95%a5%e4%b8%8d%e5%a4%84%e7%90%86%e3%80%82%0aTLS%20%e6%8f%a1%e6%89%8b%e4%b8%ad%e7%9a%84%20Extension%20%e6%9c%89%e4%bb%a5%e4%b8%8b%e5%87%a0%e4%b8%aa%e7%89%b9%e7%82%b9%3a%0a%20%20Extension%20%e4%b8%8d%e5%bd%b1%e5%93%8d%20TLS%20%e6%8f%a1%e6%89%8b%e7%9a%84%e6%88%90%e5%8a%9f%e4%b8%8e%e5%90%a6%e3%80%82Server%20%e5%af%b9%20ClientHello%20%e4%b8%ad%e7%9a%84%20Extension%20%e6%9c%89%e4%ba%9b%e4%b8%8d%e6%94%af%e6%8c%81%ef%bc%8c%e5%bf%bd%e7%95%a5%e4%b8%8d%e5%a4%84%e7%90%86%e5%8d%b3%e5%8f%af%ef%bc%8c%e4%b8%8d%e5%bd%b1%e5%93%8d%e6%8f%a1%e6%89%8b%e7%9a%84%e6%b5%81%e7%a8%8b%e3%80%82%0a%20%20ServerHello%20%e4%b8%ad%e5%9b%9e%e5%ba%94%20Client%20%e7%9a%84%20Extension%20%e4%b8%80%e5%ae%9a%e8%a6%81%e6%98%af%20ClientHello%20%e4%b8%ad%e7%9a%84%20Extension%20%e7%9a%84%e5%ad%90%e9%9b%86%28%e5%b0%8f%e4%ba%8e%e7%ad%89%e4%ba%8e%29%e3%80%82ServerHello%20%e4%b8%ad%e7%a6%81%e6%ad%a2%e5%87%ba%e7%8e%b0%20ClientHello%20%e4%b8%ad%e6%b2%a1%e6%9c%89%e5%87%ba%e7%8e%b0%e7%9a%84%20Extension%e3%80%82%e5%a6%82%e6%9e%9c%e4%b8%80%e4%b8%aa%20Client%20%e5%9c%a8%20ServerHello%20%e4%b8%ad%e6%94%b6%e5%88%b0%e4%b8%80%e4%b8%aa%e6%89%a9%e5%b1%95%e7%b1%bb%e5%9e%8b%e4%bd%86%e5%9c%a8%e7%9b%b8%e5%85%b3%e7%9a%84%20ClientHello%20%e4%b8%ad%e5%b9%b6%e6%b2%a1%e6%9c%89%e8%af%b7%e6%b1%82%ef%bc%8c%e5%ae%83%e5%bf%85%e9%a1%bb%e7%94%a8%e4%b8%80%e4%b8%aa%20unsupported_extension%20%e8%87%b4%e5%91%bd%20alert%20%e6%b6%88%e6%81%af%e6%9d%a5%e4%b8%a2%e5%bc%83%e6%8f%a1%e6%89%8b%e3%80%82"><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fnew.halfrost.com%2fhttps-extensions%2f&t=HTTPS%20%e6%b8%a9%e6%95%85%e7%9f%a5%e6%96%b0%ef%bc%88%e5%85%ad%ef%bc%89%20%e2%80%94%e2%80%94%20TLS%20%e4%b8%ad%e7%9a%84%20Extensions"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu class=icon href=# onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden=true></i>Menu</a>
<a id=toc class=icon href=# onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden=true></i>TOC</a>
<a id=share class=icon href=# onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden=true></i>share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i>Top</a></div></div></div><footer id=footer><div class=footer-left><p class=copyright style=float:left;margin-bottom:0><a href=https://github.com/halfrost/Halfrost-Field class=github-repo style=height:18px><span class=gadget-github></span>Star</a>
Copyright &copy;halfrost 2016 - 2021
<a href=http://www.miit.gov.cn/>鄂ICP备16014744号</a></p><br><p class="copyright statistics" style=margin-bottom:20px><span id=busuanzi_container_site_pv>Cumulative Page Views <span id=busuanzi_value_site_pv></span>| Unique Visitors <span id=busuanzi_value_site_uv></span></span></p></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/main.min.f870a4d110314b9e50e65f8ac982dc1c9c376c8f1a5083d39c62cfc49073f011.js></script><script async src=/prism.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}};</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>