<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=theme-color content="#FFFFFF"><meta http-equiv=x-ua-compatible content="IE=edge"><title>深入研究 Block 捕获外部变量和 __block 实现原理 | prometheus</title><meta name=description content="Explore in every moment of the hard thinking"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="深入研究 Block 捕获外部变量和 __block 实现原理"><meta property="og:description" content="前言 Blocks是C语言的扩充功能，而Apple 在OS X Snow Leopard 和 iOS 4中引入了这个新功能“Blocks”。从那开始，Block就出现在iOS和Mac系统各个API中，并被大家广泛使用。一句话来形容Blocks，带有自动变量（局部变量）的匿名函数。
Block在OC中的实现如下：
struct Block_layout { void *isa; int flags; int reserved; void (*invoke)(void *, ...); struct Block_descriptor *descriptor; /* Imported variables. */ }; struct Block_descriptor { unsigned long int reserved; unsigned long int size; void (*copy)(void *dst, void *src); void (*dispose)(void *); }; 从结构图中很容易看到isa，所以OC处理Block是按照对象来处理的。在iOS中，isa常见的就是_NSConcreteStackBlock，_NSConcreteMallocBlock，_NSConcreteGlobalBlock这3种(另外只在GC环境下还有3种使用的_NSConcreteFinalizingBlock，_NSConcreteAutoBlock，_NSConcreteWeakBlockVariable，本文暂不谈论这3种，有兴趣的看看官方文档)
以上介绍是Block的简要实现，接下来我们来仔细研究一下Block的捕获外部变量的特性以及__block的实现原理。
研究工具：clang 为了研究编译器的实现原理，我们需要使用 clang 命令。clang 命令可以将 Objetive-C 的源码改写成 C / C++ 语言的，借此可以研究 block 中各个特性的源码实现方式。该命令是
clang -rewrite-objc block.c####目录
 1."><meta property="og:type" content="article"><meta property="og:url" content="https://new.halfrost.com/ios_block/"><meta property="article:published_time" content="2016-08-27T06:54:28+00:00"><meta property="article:modified_time" content="2016-08-27T06:54:28+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入研究 Block 捕获外部变量和 __block 实现原理"><meta name=twitter:description content="前言 Blocks是C语言的扩充功能，而Apple 在OS X Snow Leopard 和 iOS 4中引入了这个新功能“Blocks”。从那开始，Block就出现在iOS和Mac系统各个API中，并被大家广泛使用。一句话来形容Blocks，带有自动变量（局部变量）的匿名函数。
Block在OC中的实现如下：
struct Block_layout { void *isa; int flags; int reserved; void (*invoke)(void *, ...); struct Block_descriptor *descriptor; /* Imported variables. */ }; struct Block_descriptor { unsigned long int reserved; unsigned long int size; void (*copy)(void *dst, void *src); void (*dispose)(void *); }; 从结构图中很容易看到isa，所以OC处理Block是按照对象来处理的。在iOS中，isa常见的就是_NSConcreteStackBlock，_NSConcreteMallocBlock，_NSConcreteGlobalBlock这3种(另外只在GC环境下还有3种使用的_NSConcreteFinalizingBlock，_NSConcreteAutoBlock，_NSConcreteWeakBlockVariable，本文暂不谈论这3种，有兴趣的看看官方文档)
以上介绍是Block的简要实现，接下来我们来仔细研究一下Block的捕获外部变量的特性以及__block的实现原理。
研究工具：clang 为了研究编译器的实现原理，我们需要使用 clang 命令。clang 命令可以将 Objetive-C 的源码改写成 C / C++ 语言的，借此可以研究 block 中各个特性的源码实现方式。该命令是
clang -rewrite-objc block.c####目录
 1."><link rel=stylesheet href=/css/style-white.min.css><link rel=manifest href=/manifest.json><link rel=stylesheet href=/prism.css><link href=/images/apple-touch-icon-60x60.png rel=apple-touch-icon sizes=60x60><link href=/images/apple-touch-icon-76x76.png rel=apple-touch-icon sizes=76x76><link href=/images/apple-touch-icon-120x120.png rel=apple-touch-icon sizes=120x120><link href=/images/apple-touch-icon-152x152.png rel=apple-touch-icon sizes=152x152><link href=/images/apple-touch-icon-180x180.png rel=apple-touch-icon sizes=180x180><link href=/images/apple-touch-icon-512x512.png rel=apple-touch-icon sizes=512x512><link href=/images/apple-touch-icon-1024x1024.png rel=apple-touch-icon sizes=1024x1024><script async>if('serviceWorker'in navigator){navigator.serviceWorker.register("\/serviceworker-v1.min.a64912b78d282eab1ad3715a0943da21616e5f326f8afea27034784ad445043b.js").then(function(){if(navigator.serviceWorker.controller){console.log('Assets cached by the controlling service worker.');}else{console.log('Please reload this page to allow the service worker to handle network operations.');}}).catch(function(error){console.log('ERROR: '+error);});}else{console.log('Service workers are not supported in the current browser.');}</script><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://new.halfrost.com/images/favicon.ico><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-82753806-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="single-max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a><a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a><a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast');" style=display:none><i class="fas fa-chevron-up fa-lg"></i></a><span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=https://books.halfrost.com/>Books</a></li><li><a href=https://github.com/halfrost/Halfrost-Field>Github</a></li><li><a href=https://halfrost.me/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://new.halfrost.com/ios_simulator_ios_sim/><i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li><li><a class=icon href=https://new.halfrost.com/ios_block_retain_circle/><i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li><li><a class=icon href=#><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fnew.halfrost.com%2fios_block%2f"><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&text=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&title=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&is_video=false&description=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86&body=Check out this article: https%3a%2f%2fnew.halfrost.com%2fios_block%2f"><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&title=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&title=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&title=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-stumbleupon" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&title=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-digg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&name=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86&description=%e5%89%8d%e8%a8%80%20Blocks%e6%98%afC%e8%af%ad%e8%a8%80%e7%9a%84%e6%89%a9%e5%85%85%e5%8a%9f%e8%83%bd%ef%bc%8c%e8%80%8cApple%20%e5%9c%a8OS%20X%20Snow%20Leopard%20%e5%92%8c%20iOS%204%e4%b8%ad%e5%bc%95%e5%85%a5%e4%ba%86%e8%bf%99%e4%b8%aa%e6%96%b0%e5%8a%9f%e8%83%bd%e2%80%9cBlocks%e2%80%9d%e3%80%82%e4%bb%8e%e9%82%a3%e5%bc%80%e5%a7%8b%ef%bc%8cBlock%e5%b0%b1%e5%87%ba%e7%8e%b0%e5%9c%a8iOS%e5%92%8cMac%e7%b3%bb%e7%bb%9f%e5%90%84%e4%b8%aaAPI%e4%b8%ad%ef%bc%8c%e5%b9%b6%e8%a2%ab%e5%a4%a7%e5%ae%b6%e5%b9%bf%e6%b3%9b%e4%bd%bf%e7%94%a8%e3%80%82%e4%b8%80%e5%8f%a5%e8%af%9d%e6%9d%a5%e5%bd%a2%e5%ae%b9Blocks%ef%bc%8c%e5%b8%a6%e6%9c%89%e8%87%aa%e5%8a%a8%e5%8f%98%e9%87%8f%ef%bc%88%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%ef%bc%89%e7%9a%84%e5%8c%bf%e5%90%8d%e5%87%bd%e6%95%b0%e3%80%82%0aBlock%e5%9c%a8OC%e4%b8%ad%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%a6%82%e4%b8%8b%ef%bc%9a%0astruct%20Block_layout%20%7b%20void%20%2aisa%3b%20int%20flags%3b%20int%20reserved%3b%20void%20%28%2ainvoke%29%28void%20%2a%2c%20...%29%3b%20struct%20Block_descriptor%20%2adescriptor%3b%20%2f%2a%20Imported%20variables.%20%2a%2f%20%7d%3b%20struct%20Block_descriptor%20%7b%20unsigned%20long%20int%20reserved%3b%20unsigned%20long%20int%20size%3b%20void%20%28%2acopy%29%28void%20%2adst%2c%20void%20%2asrc%29%3b%20void%20%28%2adispose%29%28void%20%2a%29%3b%20%7d%3b%20%e4%bb%8e%e7%bb%93%e6%9e%84%e5%9b%be%e4%b8%ad%e5%be%88%e5%ae%b9%e6%98%93%e7%9c%8b%e5%88%b0isa%ef%bc%8c%e6%89%80%e4%bb%a5OC%e5%a4%84%e7%90%86Block%e6%98%af%e6%8c%89%e7%85%a7%e5%af%b9%e8%b1%a1%e6%9d%a5%e5%a4%84%e7%90%86%e7%9a%84%e3%80%82%e5%9c%a8iOS%e4%b8%ad%ef%bc%8cisa%e5%b8%b8%e8%a7%81%e7%9a%84%e5%b0%b1%e6%98%af_NSConcreteStackBlock%ef%bc%8c_NSConcreteMallocBlock%ef%bc%8c_NSConcreteGlobalBlock%e8%bf%993%e7%a7%8d%28%e5%8f%a6%e5%a4%96%e5%8f%aa%e5%9c%a8GC%e7%8e%af%e5%a2%83%e4%b8%8b%e8%bf%98%e6%9c%893%e7%a7%8d%e4%bd%bf%e7%94%a8%e7%9a%84_NSConcreteFinalizingBlock%ef%bc%8c_NSConcreteAutoBlock%ef%bc%8c_NSConcreteWeakBlockVariable%ef%bc%8c%e6%9c%ac%e6%96%87%e6%9a%82%e4%b8%8d%e8%b0%88%e8%ae%ba%e8%bf%993%e7%a7%8d%ef%bc%8c%e6%9c%89%e5%85%b4%e8%b6%a3%e7%9a%84%e7%9c%8b%e7%9c%8b%e5%ae%98%e6%96%b9%e6%96%87%e6%a1%a3%29%0a%e4%bb%a5%e4%b8%8a%e4%bb%8b%e7%bb%8d%e6%98%afBlock%e7%9a%84%e7%ae%80%e8%a6%81%e5%ae%9e%e7%8e%b0%ef%bc%8c%e6%8e%a5%e4%b8%8b%e6%9d%a5%e6%88%91%e4%bb%ac%e6%9d%a5%e4%bb%94%e7%bb%86%e7%a0%94%e7%a9%b6%e4%b8%80%e4%b8%8bBlock%e7%9a%84%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e7%9a%84%e7%89%b9%e6%80%a7%e4%bb%a5%e5%8f%8a__block%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e3%80%82%0a%e7%a0%94%e7%a9%b6%e5%b7%a5%e5%85%b7%ef%bc%9aclang%20%e4%b8%ba%e4%ba%86%e7%a0%94%e7%a9%b6%e7%bc%96%e8%af%91%e5%99%a8%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%ef%bc%8c%e6%88%91%e4%bb%ac%e9%9c%80%e8%a6%81%e4%bd%bf%e7%94%a8%20clang%20%e5%91%bd%e4%bb%a4%e3%80%82clang%20%e5%91%bd%e4%bb%a4%e5%8f%af%e4%bb%a5%e5%b0%86%20Objetive-C%20%e7%9a%84%e6%ba%90%e7%a0%81%e6%94%b9%e5%86%99%e6%88%90%20C%20%2f%20C%2b%2b%20%e8%af%ad%e8%a8%80%e7%9a%84%ef%bc%8c%e5%80%9f%e6%ad%a4%e5%8f%af%e4%bb%a5%e7%a0%94%e7%a9%b6%20block%20%e4%b8%ad%e5%90%84%e4%b8%aa%e7%89%b9%e6%80%a7%e7%9a%84%e6%ba%90%e7%a0%81%e5%ae%9e%e7%8e%b0%e6%96%b9%e5%bc%8f%e3%80%82%e8%af%a5%e5%91%bd%e4%bb%a4%e6%98%af%0aclang%20-rewrite-objc%20block.c%23%23%23%23%e7%9b%ae%e5%bd%95%0a%201."><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&t=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div><div id=toc><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#前言>前言</a></li><li><a href=#一block捕获外部变量实质>一.Block捕获外部变量实质</a></li><li><a href=#二block的copy和dispose>二.Block的copy和dispose</a></li><li><a href=#三block中__block实现原理>三.Block中__block实现原理</a></li><li><a href=#最后>最后</a></li></ul></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">深入研究 Block 捕获外部变量和 __block 实现原理</h1><div class=meta><div class=postdate><time datetime="2016-08-27 06:54:28 +0000 UTC" itemprop=datePublished>Aug 27</time></div><div class=article-category><i class="fas fa-archive"></i><a class=category-link href=/categories/ios>iOS</a>
,
<a class=category-link href=/categories/block>Block</a>
,
<a class=category-link href=/categories/__block>__block</a></div><div class=article-tag><i class="fas fa-tag"></i><a class=tag-link href=/tags/ios rel=tag>iOS</a>
,
<a class=tag-link href=/tags/block rel=tag>Block</a>
,
<a class=tag-link href=/tags/__block rel=tag>__block</a></div></div></header><div class=content itemprop=articleBody><h4 id=前言>前言</h4><p>Blocks是C语言的扩充功能，而Apple 在OS X Snow Leopard 和 iOS 4中引入了这个新功能“Blocks”。从那开始，Block就出现在iOS和Mac系统各个API中，并被大家广泛使用。一句话来形容Blocks，带有自动变量（局部变量）的匿名函数。</p><p>Block在OC中的实现如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>struct</span> Block_layout {
    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>isa;
    <span style=color:#66d9ef>int</span> flags;
    <span style=color:#66d9ef>int</span> reserved;
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>invoke)(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>, ...);
    <span style=color:#66d9ef>struct</span> Block_descriptor <span style=color:#f92672>*</span>descriptor;
    <span style=color:#75715e>/* Imported variables. */</span>
};

<span style=color:#66d9ef>struct</span> Block_descriptor {
    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>int</span> reserved;
    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>int</span> size;
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span><span style=color:#66d9ef>copy</span>)(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>dst, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>src);
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>dispose)(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
};
</code></pre></div><p><img src=https://img.halfrost.com/Blog/ArticleImage/21_1.png alt></p><p>从结构图中很容易看到isa，所以OC处理Block是按照对象来处理的。在iOS中，isa常见的就是_NSConcreteStackBlock，_NSConcreteMallocBlock，_NSConcreteGlobalBlock这3种(另外只在GC环境下还有3种使用的_NSConcreteFinalizingBlock，_NSConcreteAutoBlock，_NSConcreteWeakBlockVariable，本文暂不谈论这3种，有兴趣的看看官方文档)</p><p>以上介绍是Block的简要实现，接下来我们来仔细研究一下Block的捕获外部变量的特性以及__block的实现原理。</p><p><strong>研究工具：clang</strong>
为了研究编译器的实现原理，我们需要使用 clang 命令。clang 命令可以将 Objetive-C 的源码改写成 C / C++ 语言的，借此可以研究 block 中各个特性的源码实现方式。该命令是</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#a6e22e>clang</span> -<span style=color:#a6e22e>rewrite</span>-<span style=color:#a6e22e>objc</span> <span style=color:#a6e22e>block</span>.<span style=color:#a6e22e>c</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>####目录</p><ul><li>1.Block捕获外部变量实质</li><li>2.Block的copy和release</li><li>3.Block中__block实现原理</li></ul><h4 id=一block捕获外部变量实质>一.Block捕获外部变量实质</h4><p><img src=https://img.halfrost.com/Blog/ArticleImage/21_2.png alt></p><p>拿起我们的Block一起来捕捉外部变量吧。</p><p>说到外部变量，我们要先说一下C语言中变量有哪几种。一般可以分为一下5种：</p><ul><li>自动变量</li><li>函数参数</li><li>静态变量</li><li>静态全局变量</li><li>全局变量</li></ul><p>研究Block的捕获外部变量就要除去函数参数这一项，下面一一根据这4种变量类型的捕获情况进行分析。</p><p>我们先根据这4种类型</p><ul><li>自动变量</li><li>静态变量</li><li>静态全局变量</li><li>全局变量</li></ul><p>写出Block测试代码。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/21_3.png alt></p><p>这里很快就出现了一个错误，提示说自动变量没有加__block，由于__block有点复杂，我们先实验静态变量，静态全局变量，全局变量这3类。测试代码如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>#import &lt;Foundation/Foundation.h&gt;
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> global_i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> static_global_j <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
   
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> static_k <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
    <span style=color:#66d9ef>int</span> val <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
    
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>{
        global_i <span style=color:#f92672>++</span>;
        static_global_j <span style=color:#f92672>++</span>;
        static_k <span style=color:#f92672>++</span>;
        NSLog(<span style=color:#e6db74>@&#34;Block中 global_i = %d,static_global_j = %d,static_k = %d,val = %d&#34;</span>,global_i,static_global_j,static_k,val);
    };
    
    global_i <span style=color:#f92672>++</span>;
    static_global_j <span style=color:#f92672>++</span>;
    static_k <span style=color:#f92672>++</span>;
    val <span style=color:#f92672>++</span>;
    NSLog(<span style=color:#e6db74>@&#34;Block外 global_i = %d,static_global_j = %d,static_k = %d,val = %d&#34;</span>,global_i,static_global_j,static_k,val);
    
    myBlock();
    
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}

</code></pre></div><p>运行结果</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#a6e22e>Block</span> <span style=color:#a6e22e>外</span>  <span style=color:#a6e22e>global_i</span> = <span style=color:#ae81ff>2</span>,<span style=color:#a6e22e>static_global_j</span> = <span style=color:#ae81ff>3</span>,<span style=color:#a6e22e>static_k</span> = <span style=color:#ae81ff>4</span>,<span style=color:#a6e22e>val</span> = <span style=color:#ae81ff>5</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>Block</span> <span style=color:#a6e22e>中</span>  <span style=color:#a6e22e>global_i</span> = <span style=color:#ae81ff>3</span>,<span style=color:#a6e22e>static_global_j</span> = <span style=color:#ae81ff>4</span>,<span style=color:#a6e22e>static_k</span> = <span style=color:#ae81ff>5</span>,<span style=color:#a6e22e>val</span> = <span style=color:#ae81ff>4</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>这里就有2点需要弄清楚了<br>1.为什么在Block里面不加__bolck不允许更改变量？
2.为什么自动变量的值没有增加，而其他几个变量的值是增加的？自动变量是什么状态下被block捕获进去的？</p><p>为了弄清楚这2点，我们用clang转换一下源码出来分析分析。</p><p>（main.m代码行37行，文件大小832bype， 经过clang转换成main.cpp以后，代码行数飙升至104810行，文件大小也变成了3.1MB）</p><p>源码如下</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>int</span> global_i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> static_global_j <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;

<span style=color:#66d9ef>struct</span> __main_block_impl_0 {
  <span style=color:#66d9ef>struct</span> __block_impl impl;
  <span style=color:#66d9ef>struct</span> __main_block_desc_0<span style=color:#f92672>*</span> Desc;
  <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>static_k;
  <span style=color:#66d9ef>int</span> val;
  __main_block_impl_0(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>fp, <span style=color:#66d9ef>struct</span> __main_block_desc_0 <span style=color:#f92672>*</span>desc, <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>_static_k, <span style=color:#66d9ef>int</span> _val, <span style=color:#66d9ef>int</span> flags<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) <span style=color:#f92672>:</span> static_k(_static_k), val(_val) {
    impl.isa <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>_NSConcreteStackBlock;
    impl.Flags <span style=color:#f92672>=</span> flags;
    impl.FuncPtr <span style=color:#f92672>=</span> fp;
    Desc <span style=color:#f92672>=</span> desc;
  }
};
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_func_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0 <span style=color:#f92672>*</span>__cself) {
  <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>static_k <span style=color:#f92672>=</span> __cself<span style=color:#f92672>-&gt;</span>static_k; <span style=color:#75715e>// bound by copy
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> val <span style=color:#f92672>=</span> __cself<span style=color:#f92672>-&gt;</span>val; <span style=color:#75715e>// bound by copy
</span><span style=color:#75715e></span>
        global_i <span style=color:#f92672>++</span>;
        static_global_j <span style=color:#f92672>++</span>;
        (<span style=color:#f92672>*</span>static_k) <span style=color:#f92672>++</span>;
        NSLog((NSString <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>__NSConstantStringImpl__var_folders_45_k1d9q7c52vz50wz1683_hk9r0000gn_T_main_6fe658_mi_0,global_i,static_global_j,(<span style=color:#f92672>*</span>static_k),val);
    }

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
} __main_block_desc_0_DATA <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0)};


<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {

    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> static_k <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
    <span style=color:#66d9ef>int</span> val <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;

    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)())<span style=color:#f92672>&amp;</span>__main_block_impl_0((<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)__main_block_func_0, <span style=color:#f92672>&amp;</span>__main_block_desc_0_DATA, <span style=color:#f92672>&amp;</span>static_k, val));

    global_i <span style=color:#f92672>++</span>;
    static_global_j <span style=color:#f92672>++</span>;
    static_k <span style=color:#f92672>++</span>;
    val <span style=color:#f92672>++</span>;
    NSLog((NSString <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>__NSConstantStringImpl__var_folders_45_k1d9q7c52vz50wz1683_hk9r0000gn_T_main_6fe658_mi_1,global_i,static_global_j,static_k,val);

    ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)(__block_impl <span style=color:#f92672>*</span>))((__block_impl <span style=color:#f92672>*</span>)myBlock)<span style=color:#f92672>-&gt;</span>FuncPtr)((__block_impl <span style=color:#f92672>*</span>)myBlock);

    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>首先全局变量global_i和静态全局变量static_global_j的值增加，以及它们被Block捕获进去，这一点很好理解，因为是全局的，作用域很广，所以Block捕获了它们进去之后，在Block里面进行++操作，Block结束之后，它们的值依旧可以得以保存下来。</p><p>接下来仔细看看自动变量和静态变量的问题。<br>在__main_block_impl_0中，可以看到静态变量static_k和自动变量val，被Block从外面捕获进来，成为__main_block_impl_0这个结构体的成员变量了。</p><p>接着看构造函数，</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
__main_block_impl_0(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>fp, <span style=color:#66d9ef>struct</span> __main_block_desc_0 <span style=color:#f92672>*</span>desc, <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>_static_k, <span style=color:#66d9ef>int</span> _val, <span style=color:#66d9ef>int</span> flags<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) <span style=color:#f92672>:</span> static_k(_static_k), val(_val)

</code></pre></div><p>这个构造函数中，自动变量和静态变量被捕获为成员变量追加到了构造函数中。</p><p>main里面的myBlock闭包中的__main_block_impl_0结构体，初始化如下</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)())<span style=color:#f92672>&amp;</span>__main_block_impl_0((<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)__main_block_func_0, <span style=color:#f92672>&amp;</span>__main_block_desc_0_DATA, <span style=color:#f92672>&amp;</span>static_k, val));


impl.isa <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>_NSConcreteStackBlock;
impl.Flags <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
impl.FuncPtr <span style=color:#f92672>=</span> __main_block_impl_0; 
Desc <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>__main_block_desc_0_DATA;
<span style=color:#f92672>*</span>_static_k <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span><span style=color:#960050;background-color:#1e0010>；</span>
val <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>; 
</code></pre></div><p>到此，__main_block_impl_0结构体就是这样把自动变量捕获进来的。也就是说，在执行Block语法的时候，Block语法表达式所使用的自动变量的值是被保存进了Block的结构体实例中，也就是Block自身中。</p><p>这里值得说明的一点是，如果Block外面还有很多自动变量，静态变量，等等，这些变量在Block里面并不会被使用到。那么这些变量并不会被Block捕获进来，也就是说并不会在构造函数里面传入它们的值。</p><p>Block捕获外部变量仅仅只捕获Block闭包里面会用到的值，其他用不到的值，它并不会去捕获。</p><p>再研究一下源码，我们注意到__main_block_func_0这个函数的实现</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_func_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0 <span style=color:#f92672>*</span>__cself) {
  <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>static_k <span style=color:#f92672>=</span> __cself<span style=color:#f92672>-&gt;</span>static_k; <span style=color:#75715e>// bound by copy
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> val <span style=color:#f92672>=</span> __cself<span style=color:#f92672>-&gt;</span>val; <span style=color:#75715e>// bound by copy
</span><span style=color:#75715e></span>
        global_i <span style=color:#f92672>++</span>;
        static_global_j <span style=color:#f92672>++</span>;
        (<span style=color:#f92672>*</span>static_k) <span style=color:#f92672>++</span>;
        NSLog((NSString <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>__NSConstantStringImpl__var_folders_45_k1d9q7c52vz50wz1683_hk9r0000gn_T_main_6fe658_mi_0,global_i,static_global_j,(<span style=color:#f92672>*</span>static_k),val);
    }
</code></pre></div><p>我们可以发现，系统自动给我们加上的注释，bound by copy，自动变量val虽然被捕获进来了，但是是用 __cself->val来访问的。Block仅仅捕获了val的值，并没有捕获val的内存地址。所以在__main_block_func_0这个函数中即使我们重写这个自动变量val的值，依旧没法去改变Block外面自动变量val的值。</p><p>OC可能是基于这一点，在编译的层面就防止开发者可能犯的错误，因为自动变量没法在Block中改变外部变量的值，所以编译过程中就报编译错误。错误就是最开始的那张截图。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#a6e22e>Variable</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>not</span> <span style=color:#a6e22e>assignable</span>(<span style=color:#a6e22e>missing</span> <span style=color:#a6e22e>__block</span> <span style=color:#a6e22e>type</span> <span style=color:#a6e22e>specifier</span>)<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>小结一下：<br>到此为止，上面提出的第二个问题就解开答案了。自动变量是以值传递方式传递到Block的构造函数里面去的。Block只捕获Block中会用到的变量。由于只捕获了自动变量的值，并非内存地址，所以Block内部不能改变自动变量的值。Block捕获的外表变量可以改变值的是静态变量，静态全局变量，全局变量。上面例子也都证明过了。</p><p>剩下问题一我们还没有解决。</p><p>回到上面的例子上面来，4种变量里面只有静态变量，静态全局变量，全局变量这3种是可以在Block里面被改变值的。仔细观看源码，我们能看出这3个变量可以改变值的原因。</p><ol><li><p>静态全局变量，全局变量由于作用域的原因，于是可以直接在Block里面被改变。他们也都存储在全局区。 <img src=https://img.halfrost.com/Blog/ArticleImage/21_4.png alt></p></li><li><p>静态变量传递给Block是内存地址值，所以能在Block里面直接改变值。</p></li></ol><p>根据<a href=developer.apple.com/library/ios/documentation/Cocoa/Conceptual/Blocks/Articles/bxVariables.html#//apple_ref/doc/uid/TP40007502-CH6-SW1>官方文档</a>我们可以了解到，苹果要求我们在自动变量前加入 <strong>__block</strong>关键字(__block storage-class-specifier存储域类说明符)，就可以在Block里面改变外部自动变量的值了。</p><p>总结一下在Block中改变变量值有2种方式，一是传递内存地址指针到Block中，二是改变存储区方式(__block)。</p><p>先来实验一下第一种方式，传递内存地址到Block中，改变变量的值。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>#import &lt;Foundation/Foundation.h&gt;
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
    
  NSMutableString <span style=color:#f92672>*</span> str <span style=color:#f92672>=</span> [[NSMutableString alloc]initWithString:<span style=color:#e6db74>@&#34;Hello,&#34;</span>];
    
        <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>{
            [str appendString:<span style=color:#e6db74>@&#34;World!&#34;</span>];
            NSLog(<span style=color:#e6db74>@&#34;Block中 str = %@&#34;</span>,str);
        };
    
    NSLog(<span style=color:#e6db74>@&#34;Block外 str = %@&#34;</span>,str);
    
    myBlock();
    
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}

</code></pre></div><p>控制台输出：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#a6e22e>Block</span> <span style=color:#a6e22e>外</span>  <span style=color:#a6e22e>str</span> = <span style=color:#a6e22e>Hello</span>,<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>Block</span> <span style=color:#a6e22e>中</span>  <span style=color:#a6e22e>str</span> = <span style=color:#a6e22e>Hello</span>,<span style=color:#a6e22e>World</span>!<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>看结果是成功改变了变量的值了，转换一下源码。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>struct</span> __main_block_impl_0 {
  <span style=color:#66d9ef>struct</span> __block_impl impl;
  <span style=color:#66d9ef>struct</span> __main_block_desc_0<span style=color:#f92672>*</span> Desc;
  NSMutableString <span style=color:#f92672>*</span>str;
  __main_block_impl_0(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>fp, <span style=color:#66d9ef>struct</span> __main_block_desc_0 <span style=color:#f92672>*</span>desc, NSMutableString <span style=color:#f92672>*</span>_str, <span style=color:#66d9ef>int</span> flags<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) <span style=color:#f92672>:</span> str(_str) {
    impl.isa <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>_NSConcreteStackBlock;
    impl.Flags <span style=color:#f92672>=</span> flags;
    impl.FuncPtr <span style=color:#f92672>=</span> fp;
    Desc <span style=color:#f92672>=</span> desc;
  }
};
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_func_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0 <span style=color:#f92672>*</span>__cself) {
  NSMutableString <span style=color:#f92672>*</span>str <span style=color:#f92672>=</span> __cself<span style=color:#f92672>-&gt;</span>str; <span style=color:#75715e>// bound by copy
</span><span style=color:#75715e></span>
            ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>SEL</span>, NSString <span style=color:#f92672>*</span>))(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)objc_msgSend)((<span style=color:#66d9ef>id</span>)str, sel_registerName(<span style=color:#e6db74>&#34;appendString:&#34;</span>), (NSString <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>__NSConstantStringImpl__var_folders_45_k1d9q7c52vz50wz1683_hk9r0000gn_T_main_33ff12_mi_1);
            NSLog((NSString <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>__NSConstantStringImpl__var_folders_45_k1d9q7c52vz50wz1683_hk9r0000gn_T_main_33ff12_mi_2,str);
        }
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_copy_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>dst, <span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>src) {_Block_object_assign((<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dst<span style=color:#f92672>-&gt;</span>str, (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)src<span style=color:#f92672>-&gt;</span>str, <span style=color:#ae81ff>3</span><span style=color:#75715e>/*BLOCK_FIELD_IS_OBJECT*/</span>);}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_dispose_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>src) {_Block_object_dispose((<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)src<span style=color:#f92672>-&gt;</span>str, <span style=color:#ae81ff>3</span><span style=color:#75715e>/*BLOCK_FIELD_IS_OBJECT*/</span>);}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span><span style=color:#66d9ef>copy</span>)(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>, <span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>);
  <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>dispose)(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>);
} __main_block_desc_0_DATA <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0};

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
    NSMutableString <span style=color:#f92672>*</span> str <span style=color:#f92672>=</span> ((NSMutableString <span style=color:#f92672>*</span>(<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>SEL</span>, NSString <span style=color:#f92672>*</span>))(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)objc_msgSend)((<span style=color:#66d9ef>id</span>)((NSMutableString <span style=color:#f92672>*</span>(<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>SEL</span>))(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)objc_msgSend)((<span style=color:#66d9ef>id</span>)objc_getClass(<span style=color:#e6db74>&#34;NSMutableString&#34;</span>), sel_registerName(<span style=color:#e6db74>&#34;alloc&#34;</span>)), sel_registerName(<span style=color:#e6db74>&#34;initWithString:&#34;</span>), (NSString <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>__NSConstantStringImpl__var_folders_45_k1d9q7c52vz50wz1683_hk9r0000gn_T_main_33ff12_mi_0);

        <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)())<span style=color:#f92672>&amp;</span>__main_block_impl_0((<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)__main_block_func_0, <span style=color:#f92672>&amp;</span>__main_block_desc_0_DATA, str, <span style=color:#ae81ff>570425344</span>));

    NSLog((NSString <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>__NSConstantStringImpl__var_folders_45_k1d9q7c52vz50wz1683_hk9r0000gn_T_main_33ff12_mi_3,str);

    ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)(__block_impl <span style=color:#f92672>*</span>))((__block_impl <span style=color:#f92672>*</span>)myBlock)<span style=color:#f92672>-&gt;</span>FuncPtr)((__block_impl <span style=color:#f92672>*</span>)myBlock);

    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>在__main_block_func_0里面可以看到传递的是指针。所以成功改变了变量的值。</p><p>至于源码里面的copy和dispose下一节会讲到。</p><p>改变外部变量值的第二种方式是加 __block这个放在第三章里面讨论，接下来我们先讨论一下Block的copy的问题，因为这个问题会关系到 __block存储域的问题。</p><h4 id=二block的copy和dispose>二.Block的copy和dispose</h4><p><img src=https://img.halfrost.com/Blog/ArticleImage/21_5.jpg alt></p><p>OC中，一般Block就分为以下3种，_NSConcreteStackBlock，_NSConcreteMallocBlock，_NSConcreteGlobalBlock。先来说明一下3者的区别。</p><h5 id=1从捕获外部变量的角度上来看>1.从捕获外部变量的角度上来看</h5><ul><li><p>_NSConcreteStackBlock：
只用到外部局部变量、成员属性变量，且没有强指针引用的block都是StackBlock。
StackBlock的生命周期由系统控制的，一旦返回之后，就被系统销毁了。</p></li><li><p>_NSConcreteMallocBlock：
有强指针引用或copy修饰的成员属性引用的block会被复制一份到堆中成为MallocBlock，没有强指针引用即销毁，生命周期由程序员控制</p></li><li><p>_NSConcreteGlobalBlock：
没有用到外界变量或只用到全局变量、静态变量的block为_NSConcreteGlobalBlock，生命周期从创建到应用程序结束。</p></li></ul><p>没有用到外部变量肯定是_NSConcreteGlobalBlock，这点很好理解。不过只用到全局变量、静态变量的block也是_NSConcreteGlobalBlock。举例如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>#import &lt;Foundation/Foundation.h&gt;
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> global_i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> static_global_j <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
   
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> static_k <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;

    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>{
            NSLog(<span style=color:#e6db74>@&#34;Block中 变量 = %d %d %d&#34;</span>,static_global_j ,static_k, global_i);
        };
    
    NSLog(<span style=color:#e6db74>@&#34;%@&#34;</span>,myBlock);
    
    myBlock();
    
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}

</code></pre></div><p>输出：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim>&lt;<span style=color:#a6e22e>__NSGlobalBlock__</span>: <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>100001050</span>&gt;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>Block中</span> <span style=color:#a6e22e>变量</span> = <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>可见，只用到全局变量、静态变量的block也可以是_NSConcreteGlobalBlock。</p><p>所以在ARC环境下，3种类型都可以捕获外部变量。</p><h5 id=2从持有对象的角度上来看>2.从持有对象的角度上来看：</h5><ul><li>_NSConcreteStackBlock是不持有对象的。</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>//以下是在MRC下执行的
</span><span style=color:#75715e></span>    NSObject <span style=color:#f92672>*</span> obj <span style=color:#f92672>=</span> [[NSObject alloc]init];
    NSLog(<span style=color:#e6db74>@&#34;1.Block外 obj = %lu&#34;</span>,(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)obj.retainCount);
    
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>{
        NSLog(<span style=color:#e6db74>@&#34;Block中 obj = %lu&#34;</span>,(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)obj.retainCount);
    };
    
    NSLog(<span style=color:#e6db74>@&#34;2.Block外 obj = %lu&#34;</span>,(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)obj.retainCount);
    
    myBlock();
</code></pre></div><p>输出：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#ae81ff>1</span>.<span style=color:#a6e22e>Block外</span> <span style=color:#a6e22e>obj</span> = <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#ae81ff>2</span>.<span style=color:#a6e22e>Block外</span> <span style=color:#a6e22e>obj</span> = <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>Block中</span> <span style=color:#a6e22e>obj</span> = <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><ul><li>_NSConcreteMallocBlock是持有对象的。</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=color:#75715e>//以下是在MRC下执行的
</span><span style=color:#75715e></span>    NSObject <span style=color:#f92672>*</span> obj <span style=color:#f92672>=</span> [[NSObject alloc]init];
    NSLog(<span style=color:#e6db74>@&#34;1.Block外 obj = %lu&#34;</span>,(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)obj.retainCount);
    
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> [<span style=color:#f92672>^</span>{
        NSLog(<span style=color:#e6db74>@&#34;Block中 obj = %lu&#34;</span>,(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)obj.retainCount);
    }<span style=color:#66d9ef>copy</span>];
    
    NSLog(<span style=color:#e6db74>@&#34;2.Block外 obj = %lu&#34;</span>,(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)obj.retainCount);
    
    myBlock();
    
    [myBlock <span style=color:#66d9ef>release</span>];
    
    NSLog(<span style=color:#e6db74>@&#34;3.Block外 obj = %lu&#34;</span>,(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)obj.retainCount);
</code></pre></div><p>输出：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#ae81ff>1</span>.<span style=color:#a6e22e>Block外</span> <span style=color:#a6e22e>obj</span> = <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#ae81ff>2</span>.<span style=color:#a6e22e>Block外</span> <span style=color:#a6e22e>obj</span> = <span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>Block中</span> <span style=color:#a6e22e>obj</span> = <span style=color:#ae81ff>2</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#ae81ff>3</span>.<span style=color:#a6e22e>Block外</span> <span style=color:#a6e22e>obj</span> = <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><ul><li>_NSConcreteGlobalBlock也不持有对象</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=color:#75715e>//以下是在MRC下执行的
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>{
        
        NSObject <span style=color:#f92672>*</span> obj <span style=color:#f92672>=</span> [[NSObject alloc]init];
        NSLog(<span style=color:#e6db74>@&#34;Block中 obj = %lu&#34;</span>,(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)obj.retainCount);
    };
    
    myBlock();

</code></pre></div><p>输出：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>Block</span> <span style=color:#a6e22e>中</span> <span style=color:#a6e22e>obj</span> = <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>由于_NSConcreteStackBlock所属的变量域一旦结束，那么该Block就会被销毁。在ARC环境下，编译器会自动的判断，把Block自动的从栈copy到堆。比如当Block作为函数返回值的时候，肯定会copy到堆上。</p><p>1.手动调用copy
2.Block是函数的返回值
3.Block被强引用，Block被赋值给__strong或者id类型
4.调用系统API入参中含有usingBlcok的方法</p><p>以上4种情况，系统都会默认调用copy方法把Block赋复制</p><p>但是当Block为函数参数的时候，就需要我们手动的copy一份到堆上了。这里除去系统的API我们不需要管，比如GCD等方法中本身带usingBlock的方法，其他我们自定义的方法传递Block为参数的时候都需要手动copy一份到堆上。</p><p>copy函数把Block从栈上拷贝到堆上，dispose函数是把堆上的函数在废弃的时候销毁掉。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>#define Block_copy(...) ((__typeof(__VA_ARGS__))_Block_copy((const void *)(__VA_ARGS__)))
</span><span style=color:#75715e>#define Block_release(...) _Block_release((const void *)(__VA_ARGS__))
</span><span style=color:#75715e></span>
<span style=color:#75715e>// Create a heap based copy of a Block or simply add a reference to an existing one.
</span><span style=color:#75715e>// This must be paired with Block_release to recover memory, even when running
</span><span style=color:#75715e>// under Objective-C Garbage Collection.
</span><span style=color:#75715e></span>BLOCK_EXPORT <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>_Block_copy</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>aBlock)
    __OSX_AVAILABLE_STARTING(__MAC_10_6, __IPHONE_3_2);

<span style=color:#75715e>// Lose the reference, and if heap based and last reference, recover the memory
</span><span style=color:#75715e></span>BLOCK_EXPORT <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>_Block_release</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>aBlock)
    __OSX_AVAILABLE_STARTING(__MAC_10_6, __IPHONE_3_2);

<span style=color:#75715e>// Used by the compiler. Do not call this function yourself.
</span><span style=color:#75715e></span>BLOCK_EXPORT <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>_Block_object_assign</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span>)
    __OSX_AVAILABLE_STARTING(__MAC_10_6, __IPHONE_3_2);

<span style=color:#75715e>// Used by the compiler. Do not call this function yourself.
</span><span style=color:#75715e></span>BLOCK_EXPORT <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>_Block_object_dispose</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span>)
    __OSX_AVAILABLE_STARTING(__MAC_10_6, __IPHONE_3_2);
</code></pre></div><p>上面是源码中2个常用的宏定义和4个常用的方法，一会我们就会看到这4个方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>_Block_copy_internal</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> flags) {
    <span style=color:#66d9ef>struct</span> Block_layout <span style=color:#f92672>*</span>aBlock;
    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>bool</span> wantsOne <span style=color:#f92672>=</span> (WANTS_ONE <span style=color:#f92672>&amp;</span> flags) <span style=color:#f92672>==</span> WANTS_ONE;
    
    <span style=color:#75715e>// 1
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>arg) <span style=color:#66d9ef>return</span> NULL;
    
    <span style=color:#75715e>// 2
</span><span style=color:#75715e></span>    aBlock <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> Block_layout <span style=color:#f92672>*</span>)arg;
    
    <span style=color:#75715e>// 3
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (aBlock<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;</span> BLOCK_NEEDS_FREE) {
        <span style=color:#75715e>// latches on high
</span><span style=color:#75715e></span>        latching_incr_int(<span style=color:#f92672>&amp;</span>aBlock<span style=color:#f92672>-&gt;</span>flags);
        <span style=color:#66d9ef>return</span> aBlock;
    }
    
    <span style=color:#75715e>// 4
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (aBlock<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;</span> BLOCK_IS_GLOBAL) {
        <span style=color:#66d9ef>return</span> aBlock;
    }
    
    <span style=color:#75715e>// 5
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>struct</span> Block_layout <span style=color:#f92672>*</span>result <span style=color:#f92672>=</span> malloc(aBlock<span style=color:#f92672>-&gt;</span>descriptor<span style=color:#f92672>-&gt;</span>size);
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>result) <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)<span style=color:#ae81ff>0</span>;
    
    <span style=color:#75715e>// 6
</span><span style=color:#75715e></span>    memmove(result, aBlock, aBlock<span style=color:#f92672>-&gt;</span>descriptor<span style=color:#f92672>-&gt;</span>size); <span style=color:#75715e>// bitcopy first
</span><span style=color:#75715e></span>    
    <span style=color:#75715e>// 7
</span><span style=color:#75715e></span>    result<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;=</span> <span style=color:#f92672>~</span>(BLOCK_REFCOUNT_MASK);    <span style=color:#75715e>// XXX not needed
</span><span style=color:#75715e></span>    result<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>|=</span> BLOCK_NEEDS_FREE <span style=color:#f92672>|</span> <span style=color:#ae81ff>1</span>;
    
    <span style=color:#75715e>// 8
</span><span style=color:#75715e></span>    result<span style=color:#f92672>-&gt;</span>isa <span style=color:#f92672>=</span> _NSConcreteMallocBlock;
    
    <span style=color:#75715e>// 9
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (result<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;</span> BLOCK_HAS_COPY_DISPOSE) {
        (<span style=color:#f92672>*</span>aBlock<span style=color:#f92672>-&gt;</span>descriptor<span style=color:#f92672>-&gt;</span><span style=color:#66d9ef>copy</span>)(result, aBlock); <span style=color:#75715e>// do fixup
</span><span style=color:#75715e></span>    }
    
    <span style=color:#66d9ef>return</span> result;
}
</code></pre></div><p>上面这一段是Block_copy的一个实现，实现了从_NSConcreteStackBlock复制到_NSConcreteMallocBlock的过程。对应有9个步骤。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>_Block_release</span>(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>arg) {
    <span style=color:#75715e>// 1
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>struct</span> Block_layout <span style=color:#f92672>*</span>aBlock <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> Block_layout <span style=color:#f92672>*</span>)arg;
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>aBlock) <span style=color:#66d9ef>return</span>;
    
    <span style=color:#75715e>// 2
</span><span style=color:#75715e></span>    int32_t newCount;
    newCount <span style=color:#f92672>=</span> latching_decr_int(<span style=color:#f92672>&amp;</span>aBlock<span style=color:#f92672>-&gt;</span>flags) <span style=color:#f92672>&amp;</span> BLOCK_REFCOUNT_MASK;
    
    <span style=color:#75715e>// 3
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (newCount <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span>;
    
    <span style=color:#75715e>// 4
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (aBlock<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;</span> BLOCK_NEEDS_FREE) {
        <span style=color:#66d9ef>if</span> (aBlock<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;</span> BLOCK_HAS_COPY_DISPOSE)(<span style=color:#f92672>*</span>aBlock<span style=color:#f92672>-&gt;</span>descriptor<span style=color:#f92672>-&gt;</span>dispose)(aBlock);
        _Block_deallocator(aBlock);
    }
    
    <span style=color:#75715e>// 5
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (aBlock<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>&amp;</span> BLOCK_IS_GLOBAL) {
        ;
    }
    
    <span style=color:#75715e>// 6
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>else</span> {
        printf(<span style=color:#e6db74>&#34;Block_release called upon a stack Block: %p, ignored</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, (<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)aBlock);
    }
}
</code></pre></div><p>上面这一段是Block_release的一个实现，实现了怎么释放一个Block。对应有6个步骤。</p><p>上述2个方法的详细解析可以看这篇<a href=http://www.galloway.me.uk/2013/05/a-look-inside-blocks-episode-3-block-copy/>文章</a></p><p>回到上一章节中最后的例子，字符串的例子中来，转换源码之后，我们会发现多了一个copy和dispose方法。</p><p>因为在C语言的结构体中，编译器没法很好的进行初始化和销毁操作。这样对内存管理来说是很不方便的。所以就在 __main_block_desc_0结构体中间增加成员变量 void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*)和void (*dispose)(struct __main_block_impl_0*)，利用OC的Runtime进行内存管理。</p><p>相应的增加了2个方法。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_copy_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>dst, <span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>src) {_Block_object_assign((<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dst<span style=color:#f92672>-&gt;</span>str, (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)src<span style=color:#f92672>-&gt;</span>str, <span style=color:#ae81ff>3</span><span style=color:#75715e>/*BLOCK_FIELD_IS_OBJECT*/</span>);}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_dispose_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>src) {_Block_object_dispose((<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)src<span style=color:#f92672>-&gt;</span>str, <span style=color:#ae81ff>3</span><span style=color:#75715e>/*BLOCK_FIELD_IS_OBJECT*/</span>);}

</code></pre></div><p>这里的_Block_object_assign和_Block_object_dispose就对应着retain和release方法。</p><p>BLOCK_FIELD_IS_OBJECT 是Block截获对象时候的特殊标示，如果是截获的__block，那么是BLOCK_FIELD_IS_BYREF。</p><h4 id=三block中__block实现原理>三.Block中__block实现原理</h4><p>我们继续研究一下__block实现原理。</p><h5 id=1普通非对象的变量>1.普通非对象的变量</h5><p>先来看看普通变量的情况。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>#import &lt;Foundation/Foundation.h&gt;
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
    
    <span style=color:#66d9ef>__block</span> <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>{
        i <span style=color:#f92672>++</span>;
        NSLog(<span style=color:#e6db74>@&#34;%d&#34;</span>,i);
    };
    
    myBlock();
    
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>把上述代码用clang转换成源码。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>struct</span> __Block_byref_i_0 {
  <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>__isa;
__Block_byref_i_0 <span style=color:#f92672>*</span>__forwarding;
 <span style=color:#66d9ef>int</span> __flags;
 <span style=color:#66d9ef>int</span> __size;
 <span style=color:#66d9ef>int</span> i;
};

<span style=color:#66d9ef>struct</span> __main_block_impl_0 {
  <span style=color:#66d9ef>struct</span> __block_impl impl;
  <span style=color:#66d9ef>struct</span> __main_block_desc_0<span style=color:#f92672>*</span> Desc;
  __Block_byref_i_0 <span style=color:#f92672>*</span>i; <span style=color:#75715e>// by ref
</span><span style=color:#75715e></span>  __main_block_impl_0(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>fp, <span style=color:#66d9ef>struct</span> __main_block_desc_0 <span style=color:#f92672>*</span>desc, __Block_byref_i_0 <span style=color:#f92672>*</span>_i, <span style=color:#66d9ef>int</span> flags<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) <span style=color:#f92672>:</span> i(_i<span style=color:#f92672>-&gt;</span>__forwarding) {
    impl.isa <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>_NSConcreteStackBlock;
    impl.Flags <span style=color:#f92672>=</span> flags;
    impl.FuncPtr <span style=color:#f92672>=</span> fp;
    Desc <span style=color:#f92672>=</span> desc;
  }
};
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_func_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0 <span style=color:#f92672>*</span>__cself) {
  __Block_byref_i_0 <span style=color:#f92672>*</span>i <span style=color:#f92672>=</span> __cself<span style=color:#f92672>-&gt;</span>i; <span style=color:#75715e>// bound by ref
</span><span style=color:#75715e></span>
        (i<span style=color:#f92672>-&gt;</span>__forwarding<span style=color:#f92672>-&gt;</span>i) <span style=color:#f92672>++</span>;
        NSLog((NSString <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>__NSConstantStringImpl__var_folders_45_k1d9q7c52vz50wz1683_hk9r0000gn_T_main_3b0837_mi_0,(i<span style=color:#f92672>-&gt;</span>__forwarding<span style=color:#f92672>-&gt;</span>i));
    }
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_copy_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>dst, <span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>src) {_Block_object_assign((<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dst<span style=color:#f92672>-&gt;</span>i, (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)src<span style=color:#f92672>-&gt;</span>i, <span style=color:#ae81ff>8</span><span style=color:#75715e>/*BLOCK_FIELD_IS_BYREF*/</span>);}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_dispose_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>src) {_Block_object_dispose((<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)src<span style=color:#f92672>-&gt;</span>i, <span style=color:#ae81ff>8</span><span style=color:#75715e>/*BLOCK_FIELD_IS_BYREF*/</span>);}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span><span style=color:#66d9ef>copy</span>)(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>, <span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>);
  <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>dispose)(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>);
} __main_block_desc_0_DATA <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0};
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
    __attribute__((__blocks__(byref))) __Block_byref_i_0 i <span style=color:#f92672>=</span> {(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#ae81ff>0</span>,(__Block_byref_i_0 <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>i, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(__Block_byref_i_0), <span style=color:#ae81ff>0</span>};

    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)())<span style=color:#f92672>&amp;</span>__main_block_impl_0((<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)__main_block_func_0, <span style=color:#f92672>&amp;</span>__main_block_desc_0_DATA, (__Block_byref_i_0 <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>i, <span style=color:#ae81ff>570425344</span>));

    ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)(__block_impl <span style=color:#f92672>*</span>))((__block_impl <span style=color:#f92672>*</span>)myBlock)<span style=color:#f92672>-&gt;</span>FuncPtr)((__block_impl <span style=color:#f92672>*</span>)myBlock);

    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>从源码我们能发现，带有 __block的变量也被转化成了一个结构体__Block_byref_i_0,这个结构体有5个成员变量。第一个是isa指针，第二个是指向自身类型的__forwarding指针，第三个是一个标记flag，第四个是它的大小，第五个是变量值，名字和变量名同名。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>__attribute__((__blocks__(byref))) __Block_byref_i_0 i <span style=color:#f92672>=</span> {(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#ae81ff>0</span>,(__Block_byref_i_0 <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>i, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(__Block_byref_i_0), <span style=color:#ae81ff>0</span>};

</code></pre></div><p>源码中是这样初始化的。__forwarding指针初始化传递的是自己的地址。然而这里__forwarding指针真的永远指向自己么？我们来做一个实验。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>//以下代码在MRC中运行
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>__block</span> <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    NSLog(<span style=color:#e6db74>@&#34;%p&#34;</span>,<span style=color:#f92672>&amp;</span>i);
    
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> [<span style=color:#f92672>^</span>{
        i <span style=color:#f92672>++</span>;
        NSLog(<span style=color:#e6db74>@&#34;这是Block 里面%p&#34;</span>,<span style=color:#f92672>&amp;</span>i);
    }<span style=color:#66d9ef>copy</span>];

</code></pre></div><p>我们把Block拷贝到了堆上，这个时候打印出来的2个i变量的地址就不同了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>7</span>fff<span style=color:#ae81ff>5</span>fbff<span style=color:#ae81ff>818</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>&lt;<span style=color:#a6e22e>__NSMallocBlock__</span>: <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>100203</span>cc<span style=color:#ae81ff>0</span>&gt;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>这是Block</span> <span style=color:#a6e22e>里面</span> <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>1002038</span>a<span style=color:#ae81ff>8</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>地址不同就可以很明显的说明__forwarding指针并没有指向之前的自己了。那__forwarding指针现在指向到哪里了呢？</p><p>Block里面的__block的地址和Block的地址就相差1052。我们可以很大胆的猜想，__block现在也在堆上了。</p><p>出现这个不同的原因在于这里把Block拷贝到了堆上。</p><p>由第二章里面详细分析的，堆上的Block会持有对象。我们把Block通过copy到了堆上，堆上也会重新复制一份Block，并且该Block也会继续持有该__block。当Block释放的时候，__block没有被任何对象引用，也会被释放销毁。</p><p>__forwarding指针这里的作用就是针对堆的Block，把原来__forwarding指针指向自己，换成指向_NSConcreteMallocBlock上复制之后的__block自己。然后堆上的变量的__forwarding再指向自己。这样不管__block怎么复制到堆上，还是在栈上，都可以通过(i->__forwarding->i)来访问到变量值。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/21_6.jpg alt></p><p>所以在__main_block_func_0函数里面就是写的(i->__forwarding->i)。</p><p>这里还有一个需要注意的地方。还是从例子说起：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec><span style=color:#75715e>//以下代码在MRC中运行
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>__block</span> <span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    NSLog(<span style=color:#e6db74>@&#34;%p&#34;</span>,<span style=color:#f92672>&amp;</span>i);
    
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>{
        i <span style=color:#f92672>++</span>;
        NSLog(<span style=color:#e6db74>@&#34;Block 里面的%p&#34;</span>,<span style=color:#f92672>&amp;</span>i);
    };
    
    
    NSLog(<span style=color:#e6db74>@&#34;%@&#34;</span>,myBlock);
    
    myBlock();

</code></pre></div><p>结果和之前copy的例子完全不同。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span> <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>7</span>fff<span style=color:#ae81ff>5</span>fbff<span style=color:#ae81ff>818</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>&lt;<span style=color:#a6e22e>__NSStackBlock__</span>: <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>7</span>fff<span style=color:#ae81ff>5</span>fbff<span style=color:#ae81ff>7</span>c<span style=color:#ae81ff>0</span>&gt;**<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span> <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>7</span>fff<span style=color:#ae81ff>5</span>fbff<span style=color:#ae81ff>818</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>Block在捕获住__block变量之后，并不会复制到堆上，所以地址也一直都在栈上。这与ARC环境下的不一样。</p><p><del>ARC环境下，不管有没有copy，__block都会变copy到堆上，Block也是__NSMallocBlock。</del></p><p>感谢@酷酷的哀殿 指出错误，感谢@bestswifter 指点。上述说法有点不妥，详细见文章末尾更新。</p><p>ARC环境下，一旦Block赋值就会触发copy，__block就会copy到堆上，Block也是__NSMallocBlock。ARC环境下也是存在__NSStackBlock的时候，这种情况下，__block就在栈上。</p><p>MRC环境下，只有copy，__block才会被复制到堆上，否则，__block一直都在栈上，block也只是__NSStackBlock，这个时候__forwarding指针就只指向自己了。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/21_7.jpg alt></p><p>至此，文章开头提出的问题一，也解答了。__block的实现原理也已经明了。</p><h5 id=2对象的变量>2.对象的变量</h5><p>还是先举一个例子：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>//以下代码是在ARC下执行的
</span><span style=color:#75715e></span><span style=color:#75715e>#import &lt;Foundation/Foundation.h&gt;
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
     
    <span style=color:#66d9ef>__block</span> <span style=color:#66d9ef>id</span> block_obj <span style=color:#f92672>=</span> [[NSObject alloc]init];
    <span style=color:#66d9ef>id</span> obj <span style=color:#f92672>=</span> [[NSObject alloc]init];

    NSLog(<span style=color:#e6db74>@&#34;block_obj = [%@ , %p] , obj = [%@ , %p]&#34;</span>,block_obj , <span style=color:#f92672>&amp;</span>block_obj , obj , <span style=color:#f92672>&amp;</span>obj);
    
    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>^</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>^</span>{
        NSLog(<span style=color:#e6db74>@&#34;***Block中****block_obj = [%@ , %p] , obj = [%@ , %p]&#34;</span>,block_obj , <span style=color:#f92672>&amp;</span>block_obj , obj , <span style=color:#f92672>&amp;</span>obj);
    };
    
    myBlock();
   
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}

</code></pre></div><p>输出</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>block_obj</span> = [&lt;<span style=color:#a6e22e>NSObject</span>: <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>100</span>b<span style=color:#ae81ff>027</span>d<span style=color:#ae81ff>0</span>&gt; , <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>7</span>fff<span style=color:#ae81ff>5</span>fbff<span style=color:#ae81ff>7</span>e<span style=color:#ae81ff>8</span>] , <span style=color:#a6e22e>obj</span> = [&lt;<span style=color:#a6e22e>NSObject</span>: <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>100</span>b<span style=color:#ae81ff>03</span>b<span style=color:#ae81ff>50</span>&gt; , <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>7</span>fff<span style=color:#ae81ff>5</span>fbff<span style=color:#ae81ff>7</span>b<span style=color:#ae81ff>8</span>]<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#a6e22e>Block</span>****<span style=color:#a6e22e>中</span>********<span style=color:#a6e22e>block_obj</span> = [&lt;<span style=color:#a6e22e>NSObject</span>: <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>100</span>b<span style=color:#ae81ff>027</span>d<span style=color:#ae81ff>0</span>&gt; , <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>100</span>f<span style=color:#ae81ff>000</span>a<span style=color:#ae81ff>8</span>] , <span style=color:#a6e22e>obj</span> = [&lt;<span style=color:#a6e22e>NSObject</span>: <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>100</span>b<span style=color:#ae81ff>03</span>b<span style=color:#ae81ff>50</span>&gt; , <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>100</span>f<span style=color:#ae81ff>00070</span>]<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>我们把上面的代码转换成源码研究一下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>struct</span> __Block_byref_block_obj_0 {
  <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>__isa;
__Block_byref_block_obj_0 <span style=color:#f92672>*</span>__forwarding;
 <span style=color:#66d9ef>int</span> __flags;
 <span style=color:#66d9ef>int</span> __size;
 <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>__Block_byref_id_object_copy)(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>, <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>);
 <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>__Block_byref_id_object_dispose)(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>);
 <span style=color:#66d9ef>id</span> block_obj;
};

<span style=color:#66d9ef>struct</span> __main_block_impl_0 {
  <span style=color:#66d9ef>struct</span> __block_impl impl;
  <span style=color:#66d9ef>struct</span> __main_block_desc_0<span style=color:#f92672>*</span> Desc;
  <span style=color:#66d9ef>id</span> obj;
  __Block_byref_block_obj_0 <span style=color:#f92672>*</span>block_obj; <span style=color:#75715e>// by ref
</span><span style=color:#75715e></span>  __main_block_impl_0(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>fp, <span style=color:#66d9ef>struct</span> __main_block_desc_0 <span style=color:#f92672>*</span>desc, <span style=color:#66d9ef>id</span> _obj, __Block_byref_block_obj_0 <span style=color:#f92672>*</span>_block_obj, <span style=color:#66d9ef>int</span> flags<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) <span style=color:#f92672>:</span> obj(_obj), block_obj(_block_obj<span style=color:#f92672>-&gt;</span>__forwarding) {
    impl.isa <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>_NSConcreteStackBlock;
    impl.Flags <span style=color:#f92672>=</span> flags;
    impl.FuncPtr <span style=color:#f92672>=</span> fp;
    Desc <span style=color:#f92672>=</span> desc;
  }
};
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_func_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0 <span style=color:#f92672>*</span>__cself) {
  __Block_byref_block_obj_0 <span style=color:#f92672>*</span>block_obj <span style=color:#f92672>=</span> __cself<span style=color:#f92672>-&gt;</span>block_obj; <span style=color:#75715e>// bound by ref
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>id</span> obj <span style=color:#f92672>=</span> __cself<span style=color:#f92672>-&gt;</span>obj; <span style=color:#75715e>// bound by copy
</span><span style=color:#75715e></span>
        NSLog((NSString <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>__NSConstantStringImpl__var_folders_45_k1d9q7c52vz50wz1683_hk9r0000gn_T_main_e64910_mi_1,(block_obj<span style=color:#f92672>-&gt;</span>__forwarding<span style=color:#f92672>-&gt;</span>block_obj) , <span style=color:#f92672>&amp;</span>(block_obj<span style=color:#f92672>-&gt;</span>__forwarding<span style=color:#f92672>-&gt;</span>block_obj) , obj , <span style=color:#f92672>&amp;</span>obj);
    }
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_copy_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>dst, <span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>src) {_Block_object_assign((<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dst<span style=color:#f92672>-&gt;</span>block_obj, (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)src<span style=color:#f92672>-&gt;</span>block_obj, <span style=color:#ae81ff>8</span><span style=color:#75715e>/*BLOCK_FIELD_IS_BYREF*/</span>);_Block_object_assign((<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dst<span style=color:#f92672>-&gt;</span>obj, (<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)src<span style=color:#f92672>-&gt;</span>obj, <span style=color:#ae81ff>3</span><span style=color:#75715e>/*BLOCK_FIELD_IS_OBJECT*/</span>);}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__main_block_dispose_0</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>src) {_Block_object_dispose((<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)src<span style=color:#f92672>-&gt;</span>block_obj, <span style=color:#ae81ff>8</span><span style=color:#75715e>/*BLOCK_FIELD_IS_BYREF*/</span>);_Block_object_dispose((<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)src<span style=color:#f92672>-&gt;</span>obj, <span style=color:#ae81ff>3</span><span style=color:#75715e>/*BLOCK_FIELD_IS_OBJECT*/</span>);}

<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>struct</span> __main_block_desc_0 {
  size_t reserved;
  size_t Block_size;
  <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span><span style=color:#66d9ef>copy</span>)(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>, <span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>);
  <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>dispose)(<span style=color:#66d9ef>struct</span> __main_block_impl_0<span style=color:#f92672>*</span>);
} __main_block_desc_0_DATA <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0};


<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {

    __attribute__((__blocks__(byref))) __Block_byref_block_obj_0 block_obj <span style=color:#f92672>=</span> {(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span>)<span style=color:#ae81ff>0</span>,(__Block_byref_block_obj_0 <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>block_obj, <span style=color:#ae81ff>33554432</span>, <span style=color:#66d9ef>sizeof</span>(__Block_byref_block_obj_0), __Block_byref_id_object_copy_131, __Block_byref_id_object_dispose_131, ((NSObject <span style=color:#f92672>*</span>(<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>SEL</span>))(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)objc_msgSend)((<span style=color:#66d9ef>id</span>)((NSObject <span style=color:#f92672>*</span>(<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>SEL</span>))(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)objc_msgSend)((<span style=color:#66d9ef>id</span>)objc_getClass(<span style=color:#e6db74>&#34;NSObject&#34;</span>), sel_registerName(<span style=color:#e6db74>&#34;alloc&#34;</span>)), sel_registerName(<span style=color:#e6db74>&#34;init&#34;</span>))};

    <span style=color:#66d9ef>id</span> obj <span style=color:#f92672>=</span> ((NSObject <span style=color:#f92672>*</span>(<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>SEL</span>))(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)objc_msgSend)((<span style=color:#66d9ef>id</span>)((NSObject <span style=color:#f92672>*</span>(<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>id</span>, <span style=color:#66d9ef>SEL</span>))(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)objc_msgSend)((<span style=color:#66d9ef>id</span>)objc_getClass(<span style=color:#e6db74>&#34;NSObject&#34;</span>), sel_registerName(<span style=color:#e6db74>&#34;alloc&#34;</span>)), sel_registerName(<span style=color:#e6db74>&#34;init&#34;</span>));
    NSLog((NSString <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>__NSConstantStringImpl__var_folders_45_k1d9q7c52vz50wz1683_hk9r0000gn_T_main_e64910_mi_0,(block_obj.__forwarding<span style=color:#f92672>-&gt;</span>block_obj) , <span style=color:#f92672>&amp;</span>(block_obj.__forwarding<span style=color:#f92672>-&gt;</span>block_obj) , obj , <span style=color:#f92672>&amp;</span>obj);

    <span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>myBlock)(<span style=color:#66d9ef>void</span>) <span style=color:#f92672>=</span> ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)())<span style=color:#f92672>&amp;</span>__main_block_impl_0((<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)__main_block_func_0, <span style=color:#f92672>&amp;</span>__main_block_desc_0_DATA, obj, (__Block_byref_block_obj_0 <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>block_obj, <span style=color:#ae81ff>570425344</span>));

    ((<span style=color:#66d9ef>void</span> (<span style=color:#f92672>*</span>)(__block_impl <span style=color:#f92672>*</span>))((__block_impl <span style=color:#f92672>*</span>)myBlock)<span style=color:#f92672>-&gt;</span>FuncPtr)((__block_impl <span style=color:#f92672>*</span>)myBlock);

    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>首先需要说明的一点是对象在OC中，默认声明自带__strong所有权修饰符的，所以main开头我们声明的</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>__block</span> <span style=color:#66d9ef>id</span> block_obj <span style=color:#f92672>=</span> [[NSObject alloc]init];
<span style=color:#66d9ef>id</span> obj <span style=color:#f92672>=</span> [[NSObject alloc]init];

</code></pre></div><p>等价于</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#66d9ef>__block</span> <span style=color:#66d9ef>id</span> <span style=color:#66d9ef>__strong</span> block_obj <span style=color:#f92672>=</span> [[NSObject alloc]init];
<span style=color:#66d9ef>id</span> <span style=color:#66d9ef>__strong</span> obj <span style=color:#f92672>=</span> [[NSObject alloc]init];
</code></pre></div><p>在转换出来的源码中，我们也可以看到，Block捕获了__block，并且强引用了，因为在__Block_byref_block_obj_0结构体中，有一个变量是id block_obj，这个默认也是带__strong所有权修饰符的。</p><p>根据打印出来的结果来看，ARC环境下，Block捕获外部对象变量，是都会copy一份的，地址都不同。只不过带有__block修饰符的变量会被捕获到Block内部持有。</p><p>我们再来看看MRC环境下的情况，还是将上述代码的例子运行在MRC中。</p><p>输出：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
block_obj <span style=color:#f92672>=</span> [<span style=color:#f92672>&lt;</span>NSObject: <span style=color:#ae81ff>0x100b001b0</span><span style=color:#f92672>&gt;</span> , <span style=color:#ae81ff>0x7fff5fbff7e8</span>] , obj <span style=color:#f92672>=</span> [<span style=color:#f92672>&lt;</span>NSObject: <span style=color:#ae81ff>0x100b001c0</span><span style=color:#f92672>&gt;</span> , <span style=color:#ae81ff>0x7fff5fbff7b8</span>]
Block<span style=color:#f92672>****</span><span style=color:#960050;background-color:#1e0010>中</span><span style=color:#f92672>********</span>block_obj <span style=color:#f92672>=</span> [<span style=color:#f92672>&lt;</span>NSObject: <span style=color:#ae81ff>0x100b001b0</span><span style=color:#f92672>&gt;</span> , <span style=color:#ae81ff>0x7fff5fbff7e8</span>] , obj <span style=color:#f92672>=</span> [<span style=color:#f92672>&lt;</span>NSObject: <span style=color:#ae81ff>0x100b001c0</span><span style=color:#f92672>&gt;</span> , <span style=color:#ae81ff>0x7fff5fbff790</span>]

</code></pre></div><p>这个时候block在栈上，__NSStackBlock__，可以打印出来retainCount值都是1。当把这个block copy一下，就变成__NSMallocBlock__，对象的retainCount值就会变成2了。</p><p>总结：</p><p>在MRC环境下，__block根本不会对指针所指向的对象执行copy操作，而只是把指针进行的复制。
而在ARC环境下，对于声明为__block的外部对象，在block内部会进行retain，以至于在block环境内能安全的引用外部对象，所以才会产生循环引用的问题！</p><p>在ARC环境下，对于没有声明为__block的外部对象，也会被retain。</p><p>(感谢@南栀倾寒 指点。由于之前结论只说了ARC环境下__block的外部对象的情况，没有说明非__block的外部对象的情况，所以可能会引起歧义，特此说明一下。在ARC环境下，不仅仅是声明了__block的外部对象，没有加__block的对象，在block内部也会被retain。因为加了__block，只是对一个自动变量有影响，它们是指针， 相当于延长了指针变量的声明周期，只要访问对象的话还是会retain。)</p><h4 id=最后>最后</h4><p>关于Block捕获外部变量有很多用途，用途也很广，只有弄清了捕获变量和持有的变量的概念以后，之后才能清楚的解决Block循环引用的问题。</p><p>再次回到文章开头，5种变量，自动变量，函数参数 ，静态变量，静态全局变量，全局变量，如果严格的来说，捕获是必须在Block结构体__main_block_impl_0里面有成员变量的话，Block能捕获的变量就只有带有自动变量和静态变量了。捕获进Block的对象会被Block持有。</p><p>对于非对象的变量来说，</p><p>自动变量的值，被copy进了Block，不带__block的自动变量只能在里面被访问，并不能改变值。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/21_8.jpg alt></p><p>带__block的自动变量 和 静态变量 就是直接地址访问。所以在Block里面可以直接改变变量的值。</p><p><img src=https://img.halfrost.com/Blog/ArticleImage/21_9.jpg alt></p><p>而剩下的静态全局变量，全局变量，函数参数，也是可以在直接在Block中改变变量值的，但是他们并没有变成Block结构体__main_block_impl_0的成员变量，因为他们的作用域大，所以可以直接更改他们的值。</p><p>值得注意的是，静态全局变量，全局变量，函数参数他们并不会被Block持有，也就是说不会增加retainCount值。</p><p>对于对象来说，</p><p>在MRC环境下，__block根本不会对指针所指向的对象执行copy操作，而只是把指针进行的复制。
而在ARC环境下，对于声明为__block的外部对象，在block内部会进行retain，以至于在block环境内能安全的引用外部对象。对于没有声明__block的外部对象，在block中也会被retain。</p><p>请大家多多指点。</p><p><strong>更新</strong></p><p>在ARC环境下，Block也是存在__NSStackBlock的时候的，平时见到最多的是_NSConcreteMallocBlock，是因为我们会对Block有赋值操作，所以ARC下，block 类型通过=进行传递时，会导致调用objc_retainBlock->_Block_copy->_Block_copy_internal方法链。并导致 __NSStackBlock__ 类型的 block 转换为 __NSMallocBlock__ 类型。</p><p>举例如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objectivec data-lang=objectivec>
<span style=color:#75715e>#import &lt;Foundation/Foundation.h&gt;
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> argv[]) {
    
    <span style=color:#66d9ef>__block</span> <span style=color:#66d9ef>int</span> temp <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
    
    NSLog(<span style=color:#e6db74>@&#34;%@&#34;</span>,<span style=color:#f92672>^</span>{NSLog(<span style=color:#e6db74>@&#34;*******%d %p&#34;</span>,temp <span style=color:#f92672>++</span>,<span style=color:#f92672>&amp;</span>temp);});
   
    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>输出</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim>&lt;<span style=color:#a6e22e>__NSStackBlock__</span>: <span style=color:#ae81ff>0</span>x<span style=color:#ae81ff>7</span>fff<span style=color:#ae81ff>5</span>fbff<span style=color:#ae81ff>768</span>&gt;<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>这种情况就是ARC环境下Block是__NSStackBlock的类型。</p><img src=https://img.halfrost.com/wechat-qr-code.png></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=https://books.halfrost.com/>Books</a></li><li><a href=https://github.com/halfrost/Halfrost-Field>Github</a></li><li><a href=https://halfrost.me/>About</a></li><li><a href=/index.xml>RSS</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#前言>前言</a></li><li><a href=#一block捕获外部变量实质>一.Block捕获外部变量实质</a></li><li><a href=#二block的copy和dispose>二.Block的copy和dispose</a></li><li><a href=#三block中__block实现原理>三.Block中__block实现原理</a></li><li><a href=#最后>最后</a></li></ul></li></ul></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fnew.halfrost.com%2fios_block%2f"><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&text=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&title=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&is_video=false&description=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86&body=Check out this article: https%3a%2f%2fnew.halfrost.com%2fios_block%2f"><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&title=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&title=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&title=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-stumbleupon fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://digg.com/submit?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&title=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-digg fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&name=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86&description=%e5%89%8d%e8%a8%80%20Blocks%e6%98%afC%e8%af%ad%e8%a8%80%e7%9a%84%e6%89%a9%e5%85%85%e5%8a%9f%e8%83%bd%ef%bc%8c%e8%80%8cApple%20%e5%9c%a8OS%20X%20Snow%20Leopard%20%e5%92%8c%20iOS%204%e4%b8%ad%e5%bc%95%e5%85%a5%e4%ba%86%e8%bf%99%e4%b8%aa%e6%96%b0%e5%8a%9f%e8%83%bd%e2%80%9cBlocks%e2%80%9d%e3%80%82%e4%bb%8e%e9%82%a3%e5%bc%80%e5%a7%8b%ef%bc%8cBlock%e5%b0%b1%e5%87%ba%e7%8e%b0%e5%9c%a8iOS%e5%92%8cMac%e7%b3%bb%e7%bb%9f%e5%90%84%e4%b8%aaAPI%e4%b8%ad%ef%bc%8c%e5%b9%b6%e8%a2%ab%e5%a4%a7%e5%ae%b6%e5%b9%bf%e6%b3%9b%e4%bd%bf%e7%94%a8%e3%80%82%e4%b8%80%e5%8f%a5%e8%af%9d%e6%9d%a5%e5%bd%a2%e5%ae%b9Blocks%ef%bc%8c%e5%b8%a6%e6%9c%89%e8%87%aa%e5%8a%a8%e5%8f%98%e9%87%8f%ef%bc%88%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%ef%bc%89%e7%9a%84%e5%8c%bf%e5%90%8d%e5%87%bd%e6%95%b0%e3%80%82%0aBlock%e5%9c%a8OC%e4%b8%ad%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%a6%82%e4%b8%8b%ef%bc%9a%0astruct%20Block_layout%20%7b%20void%20%2aisa%3b%20int%20flags%3b%20int%20reserved%3b%20void%20%28%2ainvoke%29%28void%20%2a%2c%20...%29%3b%20struct%20Block_descriptor%20%2adescriptor%3b%20%2f%2a%20Imported%20variables.%20%2a%2f%20%7d%3b%20struct%20Block_descriptor%20%7b%20unsigned%20long%20int%20reserved%3b%20unsigned%20long%20int%20size%3b%20void%20%28%2acopy%29%28void%20%2adst%2c%20void%20%2asrc%29%3b%20void%20%28%2adispose%29%28void%20%2a%29%3b%20%7d%3b%20%e4%bb%8e%e7%bb%93%e6%9e%84%e5%9b%be%e4%b8%ad%e5%be%88%e5%ae%b9%e6%98%93%e7%9c%8b%e5%88%b0isa%ef%bc%8c%e6%89%80%e4%bb%a5OC%e5%a4%84%e7%90%86Block%e6%98%af%e6%8c%89%e7%85%a7%e5%af%b9%e8%b1%a1%e6%9d%a5%e5%a4%84%e7%90%86%e7%9a%84%e3%80%82%e5%9c%a8iOS%e4%b8%ad%ef%bc%8cisa%e5%b8%b8%e8%a7%81%e7%9a%84%e5%b0%b1%e6%98%af_NSConcreteStackBlock%ef%bc%8c_NSConcreteMallocBlock%ef%bc%8c_NSConcreteGlobalBlock%e8%bf%993%e7%a7%8d%28%e5%8f%a6%e5%a4%96%e5%8f%aa%e5%9c%a8GC%e7%8e%af%e5%a2%83%e4%b8%8b%e8%bf%98%e6%9c%893%e7%a7%8d%e4%bd%bf%e7%94%a8%e7%9a%84_NSConcreteFinalizingBlock%ef%bc%8c_NSConcreteAutoBlock%ef%bc%8c_NSConcreteWeakBlockVariable%ef%bc%8c%e6%9c%ac%e6%96%87%e6%9a%82%e4%b8%8d%e8%b0%88%e8%ae%ba%e8%bf%993%e7%a7%8d%ef%bc%8c%e6%9c%89%e5%85%b4%e8%b6%a3%e7%9a%84%e7%9c%8b%e7%9c%8b%e5%ae%98%e6%96%b9%e6%96%87%e6%a1%a3%29%0a%e4%bb%a5%e4%b8%8a%e4%bb%8b%e7%bb%8d%e6%98%afBlock%e7%9a%84%e7%ae%80%e8%a6%81%e5%ae%9e%e7%8e%b0%ef%bc%8c%e6%8e%a5%e4%b8%8b%e6%9d%a5%e6%88%91%e4%bb%ac%e6%9d%a5%e4%bb%94%e7%bb%86%e7%a0%94%e7%a9%b6%e4%b8%80%e4%b8%8bBlock%e7%9a%84%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e7%9a%84%e7%89%b9%e6%80%a7%e4%bb%a5%e5%8f%8a__block%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%e3%80%82%0a%e7%a0%94%e7%a9%b6%e5%b7%a5%e5%85%b7%ef%bc%9aclang%20%e4%b8%ba%e4%ba%86%e7%a0%94%e7%a9%b6%e7%bc%96%e8%af%91%e5%99%a8%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86%ef%bc%8c%e6%88%91%e4%bb%ac%e9%9c%80%e8%a6%81%e4%bd%bf%e7%94%a8%20clang%20%e5%91%bd%e4%bb%a4%e3%80%82clang%20%e5%91%bd%e4%bb%a4%e5%8f%af%e4%bb%a5%e5%b0%86%20Objetive-C%20%e7%9a%84%e6%ba%90%e7%a0%81%e6%94%b9%e5%86%99%e6%88%90%20C%20%2f%20C%2b%2b%20%e8%af%ad%e8%a8%80%e7%9a%84%ef%bc%8c%e5%80%9f%e6%ad%a4%e5%8f%af%e4%bb%a5%e7%a0%94%e7%a9%b6%20block%20%e4%b8%ad%e5%90%84%e4%b8%aa%e7%89%b9%e6%80%a7%e7%9a%84%e6%ba%90%e7%a0%81%e5%ae%9e%e7%8e%b0%e6%96%b9%e5%bc%8f%e3%80%82%e8%af%a5%e5%91%bd%e4%bb%a4%e6%98%af%0aclang%20-rewrite-objc%20block.c%23%23%23%23%e7%9b%ae%e5%bd%95%0a%201."><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fnew.halfrost.com%2fios_block%2f&t=%e6%b7%b1%e5%85%a5%e7%a0%94%e7%a9%b6%20Block%20%e6%8d%95%e8%8e%b7%e5%a4%96%e9%83%a8%e5%8f%98%e9%87%8f%e5%92%8c%20__block%20%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu class=icon href=# onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden=true></i>Menu</a>
<a id=toc class=icon href=# onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden=true></i>TOC</a>
<a id=share class=icon href=# onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden=true></i>share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i>Top</a></div></div></div><footer id=footer><div class=footer-left><p class=copyright style=float:left;margin-bottom:0><a href=https://github.com/halfrost/Halfrost-Field class=github-repo style=height:18px><span class=gadget-github></span>Star</a>
Copyright &copy;halfrost 2016 - 2021
<a href=http://www.miit.gov.cn/>鄂ICP备16014744号</a></p><br><p class="copyright statistics" style=margin-bottom:20px><span id=busuanzi_container_site_pv>Cumulative Page Views <span id=busuanzi_value_site_pv></span>| Unique Visitors <span id=busuanzi_value_site_uv></span></span></p></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/main.min.f870a4d110314b9e50e65f8ac982dc1c9c376c8f1a5083d39c62cfc49073f011.js></script><script async src=/prism.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}};</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>